var m=[20,120,20,120],canvas_w=1160-m[1]-m[3],canvas_h=svgHeight-m[0]-m[2],i=0,mode="redundancy",root;$(document).ready(function(){$("#mode").change(function(){mode=$(this).val();$(".mode_key").hide();"redundancy"==mode?$("#redundancy_key").show():"visibility"==mode?$("#visibility_key").show():"privacy"==mode&&$("#privacy_key").show();update(root)})});var tree,diagonal,vis,tree_svg;
function resizeTreeSVG(b,e){canvas_h=e;canvas_w=b;tree.size([canvas_h,canvas_w]);tree_svg.attr("width",canvas_w+m[1]+m[3]).attr("height",canvas_h+m[0]+m[2])}
function createTreeSVG(b,e){canvas_h=e;canvas_w=b;var f=document.getElementById("body"),c=document.createElement("div");f.parentNode.replaceChild(c,f);c.id="body";tree=d3.layout.tree();diagonal=d3.svg.diagonal().projection(function(d){return[d.y,d.x]});tree_svg=d3.select("#body").append("svg:svg");vis=tree_svg.append("svg:g").attr("transform","translate("+m[3]+","+m[0]+")");resizeTreeSVG(b,e)}createTreeSVG(canvas_w,canvas_h);
var tooltip=d3.select("body").append("div").style("position","absolute").style("z-index","10").style("visibility","hidden").style("background-color","white").style("font-size","11px").style("font-family","verdana");d3.json(JSONURL,function(b){root=b;root.x0=0;root.y0=0;toggleAll(root,2,0);update(root)});
function update(b){for(var e=d3.event&&d3.event.altKey?5E3:500,f,c,d=0;2>d;++d){f=tree.nodes(root).reverse();c=[0];var l=[0];f.forEach(function(a,h){if(a.depth>=c.length)for(h=c.length;h<=a.depth;++h)c.push(40),l.push(0);++l[a.depth];a.name&&(h=(a.name.length+2)*(40<a.name.length?5:8),h>c[a.depth]&&(c[a.depth]=h))});if(0==d){var g=0,p=0,k=0;k=0;for(var q=l.length;k<q;++k)l[k]>g&&(g=l[k]),p+=c[k];k=34*g;(p>canvas_w||k>canvas_h||canvas_h-k>k/3)&&resizeTreeSVG(p,k)}}for(var n in c)0<n&&(c[n]+=c[n-1]);
f.forEach(function(a){a.y=a.depth?c[a.depth-1]:-c[a.depth]});d=vis.selectAll("g.node").data(f,function(a){return a.id||(a.id=++i)});g=d.enter().append("svg:g").attr("class","node").attr("transform",function(a){return"translate("+b.y0+","+b.x0+")"}).on("click",function(a){toggle(a);update(a);tooltip.text("")});g.append("svg:circle").attr("r",1E-6).on("mouseover",function(a){tooltip.style("visibility","visible");tooltip.text(function(){return a.children?"Click to hide child menu nodes":a._children?
"Click to show child menu nodes":"There are no child menu nodes"});return!0}).on("mousemove",function(a){tooltip.style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+10+"px");return!0}).on("mouseout",function(a){tooltip.style("visibility","hidden");return!0});g.append("svg:circle").attr("r",2).attr("class","child_circle").attr("cx",-5);g.append("svg:circle").attr("r",2).attr("class","child_circle");g.append("svg:circle").attr("r",2).attr("class","child_circle").attr("cx",5);g.append("svg:rect").attr("id",
function(a){return"menu_node_"+a.mID}).attr("width",6).attr("height",9).attr("x",12).attr("y",-4).attr("class","rect_page").style("display",function(a){return void 0==a.target_loc||"none"==a.target_loc?"none":"block"});g.append("a").attr("xlink:href",function(a){if(a.content_href)return a.content_href}).on("click",function(a){a.organizer_href&&window.parent.zenarioO.go(a.organizer_href);return!1}).attr("xlink:show","new").attr("xlink:target","_blank").style("display",function(a){return void 0==a.content_href&&
void 0===a.organizer_href?"none":"block"}).append("svg:text").attr("x",function(a){return 20}).attr("dy",".35em").text(function(a){return a.name}).style("fill-opacity",1E-6).on("mousemove",function(){tooltip.style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+10+"px");return!0});g=d.transition().duration(e).attr("transform",function(a){return"translate("+a.y+","+a.x+")"});g.select("circle").attr("r",9).attr("class",function(a){var h=!1;if(!a.section){"redundancy"==mode?h="primary"==a.redundancy?
"node_menu_node_primary":"node_menu_node_secondary":"visibility"==mode?h="visible"==a.visibility?"node_menu_node_visible":"node_menu_node_invisible":"privacy"==mode&&(h="node_menu_node_privacy_"+a.hide_private_item);if(a.children||a._children)h+=" children";return h}});g.select("text").style("fill-opacity",1);d=d.exit().transition().duration(e).attr("transform",function(a){return"translate("+b.y+","+b.x+")"}).remove();d.select("circle").attr("r",1E-6);d.select("text").style("fill-opacity",1E-6);d=
vis.selectAll("path.link").data(tree.links(f),function(a){return a.target.id});d.enter().insert("svg:path","g").attr("class","link").attr("d",function(a){a={x:b.x0,y:b.y0};return diagonal({source:a,target:a})}).transition().duration(e).attr("d",diagonal);d.transition().duration(e).attr("d",diagonal);d.exit().transition().duration(e).attr("d",function(a){a={x:b.x,y:b.y};return diagonal({source:a,target:a})}).remove();f.forEach(function(a){a.x0=a.x;a.y0=a.y})}
function toggle(b){b.children?closeAll(b):(b.children=b._children,b._children=null)}function closeAll(b){if(b.children||b._children){b.children&&(b._children=b.children,b.children=null);for(var e in b._children)closeAll(b._children[e])}}function toggleAll(b,e,f){if(b.children||b._children)if(f++,f>=e&&(b._children=b.children,b.children=null),b.children)for(var c in b.children)toggleAll(b.children[c],e,f);else if(b._children)for(c in b._children)toggleAll(b._children[c],e,f)};
