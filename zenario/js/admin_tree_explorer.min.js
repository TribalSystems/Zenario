var m=[20,120,20,120],canvas_w=1160-m[1]-m[3],canvas_h=svgHeight-m[0]-m[2],i=0,mode="redundancy",root;$(document).ready(function(){$("#mode").change(function(){mode=$(this).val();$(".mode_key").hide();"redundancy"==mode?$("#redundancy_key").show():"visibility"==mode?$("#visibility_key").show():"privacy"==mode&&$("#privacy_key").show();update(root)})});var tree,diagonal,vis,tree_svg;
function resizeTreeSVG(b,c){canvas_h=c;canvas_w=b;tree.size([canvas_h,canvas_w]);tree_svg.attr("width",canvas_w+m[1]+m[3]).attr("height",canvas_h+m[0]+m[2])}
function createTreeSVG(b,c){canvas_h=c;canvas_w=b;var e=document.getElementById("body"),d=document.createElement("div");e.parentNode.replaceChild(d,e);d.id="body";tree=d3.layout.tree();diagonal=d3.svg.diagonal().projection(function(b){return[b.y,b.x]});tree_svg=d3.select("#body").append("svg:svg");vis=tree_svg.append("svg:g").attr("transform","translate("+m[3]+","+m[0]+")");resizeTreeSVG(b,c)}createTreeSVG(canvas_w,canvas_h);
var tooltip=d3.select("body").append("div").style("position","absolute").style("z-index","10").style("visibility","hidden").style("background-color","white").style("font-size","11px").style("font-family","verdana");d3.json(JSONURL,function(b){root=b;root.x0=0;root.y0=0;toggleAll(root,2,0);update(root)});
function update(b){for(var c=d3.event&&d3.event.altKey?5E3:500,e,d,f=0;2>f;++f){e=tree.nodes(root).reverse();d=[0];var k=[0];e.forEach(function(a,b){if(a.depth>=d.length)for(var c=d.length;c<=a.depth;++c)d.push(40),k.push(0);++k[a.depth];a.name&&(c=(a.name.length+2)*(40<a.name.length?5:8),c>d[a.depth]&&(d[a.depth]=c))});if(0==f){for(var g=0,l=0,h=0,h=0,n=k.length;h<n;++h)k[h]>g&&(g=k[h]),l+=d[h];h=34*g;(l>canvas_w||h>canvas_h||canvas_h-h>h/3)&&resizeTreeSVG(l,h)}}for(idx in d)0<idx&&(d[idx]+=d[idx-
1]);e.forEach(function(a){a.y=a.depth?d[a.depth-1]:-d[a.depth]});f=vis.selectAll("g.node").data(e,function(a){return a.id||(a.id=++i)});g=f.enter().append("svg:g").attr("class","node").attr("transform",function(a){return"translate("+b.y0+","+b.x0+")"}).on("click",function(a){toggle(a);update(a);tooltip.text("")});g.append("svg:circle").attr("r",1E-6).on("mouseover",function(a){tooltip.style("visibility","visible");tooltip.text(function(){return a.children?"Click to hide child menu nodes":a._children?
"Click to show child menu nodes":"There are no child menu nodes"});return!0}).on("mousemove",function(a){tooltip.style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+10+"px");return!0}).on("mouseout",function(a){tooltip.style("visibility","hidden");return!0});g.append("svg:circle").attr("r",2).attr("class","child_circle").attr("cx",-5);g.append("svg:circle").attr("r",2).attr("class","child_circle");g.append("svg:circle").attr("r",2).attr("class","child_circle").attr("cx",5);g.append("svg:rect").attr("id",
function(a){return"menu_node_"+a.mID}).attr("width",6).attr("height",9).attr("x",12).attr("y",-4).attr("class","rect_page").style("display",function(a){return void 0==a.target_loc||"none"==a.target_loc?"none":"block"});g.append("a").attr("xlink:href",function(a){if(a.content_href)return a.content_href}).on("click",function(a){a.storekeeper_href&&window.parent.zenarioO.go(a.storekeeper_href);return!1}).attr("xlink:show","new").attr("xlink:target","_blank").style("display",function(a){return void 0==
a.content_href&&void 0===a.storekeeper_href?"none":"block"}).append("svg:text").attr("x",function(a){return 20}).attr("dy",".35em").text(function(a){return a.name}).style("fill-opacity",1E-6).on("mousemove",function(){tooltip.style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+10+"px");return!0});g=f.transition().duration(c).attr("transform",function(a){return"translate("+a.y+","+a.x+")"});g.select("circle").attr("r",9).attr("class",function(a){var b=!1;if(!a.section){"redundancy"==mode?
b="primary"==a.redundancy?"node_menu_node_primary":"node_menu_node_secondary":"visibility"==mode?b="visible"==a.visibility?"node_menu_node_visible":"node_menu_node_invisible":"privacy"==mode&&(b="node_menu_node_privacy_"+a.hide_private_item);if(a.children||a._children)b+=" children";return b}});g.select("text").style("fill-opacity",1);f=f.exit().transition().duration(c).attr("transform",function(a){return"translate("+b.y+","+b.x+")"}).remove();f.select("circle").attr("r",1E-6);f.select("text").style("fill-opacity",
1E-6);f=vis.selectAll("path.link").data(tree.links(e),function(a){return a.target.id});f.enter().insert("svg:path","g").attr("class","link").attr("d",function(a){a={x:b.x0,y:b.y0};return diagonal({source:a,target:a})}).transition().duration(c).attr("d",diagonal);f.transition().duration(c).attr("d",diagonal);f.exit().transition().duration(c).attr("d",function(a){a={x:b.x,y:b.y};return diagonal({source:a,target:a})}).remove();e.forEach(function(a){a.x0=a.x;a.y0=a.y})}
function toggle(b){b.children?closeAll(b):(b.children=b._children,b._children=null)}function closeAll(b){if(b.children||b._children)for(childId in b.children&&(b._children=b.children,b.children=null),b._children)closeAll(b._children[childId])}
function toggleAll(b,c,e){if(b.children||b._children)if(e++,e>=c&&(b._children=b.children,b.children=null),b.children)for(childId in b.children)toggleAll(b.children[childId],c,e);else if(b._children)for(childId in b._children)toggleAll(b._children[childId],c,e)};
