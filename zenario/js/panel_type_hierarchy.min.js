zenario.lib(function(m,t,f,w,x,y,q,r,z,A,h,u,B,C,D,E,F,v,n,l,p){f=n(p.hierarchy=v(p.list,function(){this.openItemsInHierarchy={}}));f.returnPageSize=function(){return!1};f.returnInspectionViewEnabled=function(){return!1};f.parentIdColumn=function(){return this.tuix.hierarchy&&this.tuix.hierarchy.column||"parent_id"};f.showPanel=function(b,c,d){var e={},a,k,g,f=this.getItems(),h=this.ordinalColumn(),m=this.parentIdColumn();this.itemsById={};this.parentIdOf={};this.ordinals={};this.changingHierarchy=
!1;this.setHeader(b);for(a in f.items)l(f.items,a)&&(k=f.items[a],k.items=[],this.itemsById[k.id]=k);for(a=f.items.length-1;0<=a;--a)k=f.items[a],g=k.tuix[m],q.engToBoolean(g)?(f.items.splice(a,1),this.itemsById[g]&&(this.itemsById[g].items.splice(0,0,k),this.parentIdOf[k.id]=g)):g=0,h&&(e[g]||(e[g]=[],this.ordinals[g]={}),e[g].push(this.ordinals[g][k.id]={id:k.id,ord:k.tuix[h]}),k.canDrag=!0);for(g in e)if(l(e,g))for(k=e[g],k.sort(r.sortArrayByOrd),a=0;a<k.length;++a)k[a].normOrd=a+1;e=this.getHierarchyMicroTemplateHTML(f);
c.html(e);c.show();this.setScroll(c);this.setupHierarchy(b,c,d);d.html("").show();this.setTooltips(b,c,d)};f.getHierarchyMicroTemplateHTML=function(b){return this.microTemplate("zenario_organizer_hierarchy",b)};f.getItems=function(){return this.getMergeFieldsForItemsAndColumns()};f.setupHierarchy=function(b,c,d){var e=this,a;d=!0;b={};c=c.find(".dd");c.nestable({maxDepth:this.tuix.hierarchy&&this.tuix.hierarchy.depth||99});if(this.searchTerm===m){c.nestable("collapseAll");if(this.openItemsInHierarchy)for(a in this.openItemsInHierarchy)l(this.openItemsInHierarchy,
a)&&(b[a]=!0);for(a in this.selectedItems)l(this.selectedItems,a)&&this.parentIdOf[a]&&(b[this.parentIdOf[a]]=!0);for(;d;)for(a in d=!1,b)l(b,a)&&this.parentIdOf[a]&&!b[this.parentIdOf[a]]&&(d=b[this.parentIdOf[a]]=!0);for(a in b)l(b,a)&&(d=$(u("organizer_item_"+a)).parent(),d.length&&c.nestable("expandItem",d))}c.on("collapseItem",function(){e.collapseItem()});c.on("expandItem",function(){e.expandItem()});if(this.ordinalColumn()&&this.searchTerm===m)c.on("change",function(){(e.changingHierarchy=
e.scanNewHier(!1))?h.disableInteraction():h.enableInteraction();h.setButtons()});this.$dd=c};f.collapseItem=function(){this.recordOpenItems();var b=!1,c;for(c in this.selectedItems)l(this.selectedItems,c)&&!this.openItemsInHierarchy[c]&&(delete this.selectedItems[c],b=!0);b&&(h.setButtons(!0),h.setHash())};f.expandItem=function(){this.recordOpenItems()};f.showButtons=function(b){var c=this;this.changingHierarchy?(b.html(this.microTemplate("zenario_organizer_apply_cancel_buttons",{})),b.find("#organizer_applyButton").click(function(){c.scanNewHier(!0)}),
b.find("#organizer_cancelButton").click(function(){h.enableInteraction();h.reload()})):n(p.list).showButtons.call(this,b)};f.scanNewHier=function(b){var c=this.$dd.nestable("serialize_zenario_modified_version"),d,e,a,f=!1,g={},p=this.ordinalColumn();for(e in c)if(l(c,e)){var n=!1,s=c[e].length;for(a=1;a<=s;++a)if(d=c[e][a-1],d!==m)if(this.ordinals&&this.ordinals[e]&&this.ordinals[e][d]&&this.ordinals[e][d].normOrd==a)this.ordinals[e][d].ord!=a&&(n=!0);else if(f=!0,b&&n){for(a=1;a<=s;++a)d=c[e][a-
1],d!==m&&(g[d]={parentId:e,ordinal:a});break}else g[d]={parentId:e,ordinal:a}}if(!b)return f;if(f){b=h.getKey();c="";b.hierarchy=!0;b.ordinals={};b.parent_ids={};for(d in g)l(g,d)&&(c+=(c?",":"")+d,b.parent_ids[d]=g[d].parentId,b.ordinals[d]=g[d].ordinal,b.reorder=!0,this.tuix.items[d][p]=g[d].ordinal);b.id=c;d="zenario/ajax.php?__pluginClassName__="+this.tuix.class_name+"&__path__="+h.path+"&method_call=handleOrganizerPanelAJAX";delete q.rev;q.ajax(t+d,b).after(function(a){a&&r.showMessage(a);h.enableInteraction();
h.reload()})}};f.recordOpenItems=function(){var b=this;this.openItemsInHierarchy={};$("#organizer_hierarchy_view li.dd-item[data-id]:visible").each(function(c,d){var e,a=$(d);a.find("ol.dd-list:visible").size()&&(e=a.data("id"))&&(b.openItemsInHierarchy[e]=!0)})};f.returnDoSortingAndSearchingOnServer=function(){return!1};f.sortAndSearchItems=function(b){var c,d=this.sortItems(),e=this.searchItems(_.clone(d),b),a=_.object(e,e),f=this.parentIdColumn();h.nonSearchMatches={};for(b=0;b<e.length;++b)c=
e[b],(c=this.tuix.items[c]&&this.tuix.items[c][f])&&a[c]===m&&(e.push(c),a[c]=c,h.nonSearchMatches[c]=!0);for(b=d.length;0<=b;--b)c=d[b],a[c]===m&&d.splice(b,1);return d}},zenarioO.panelTypes);
