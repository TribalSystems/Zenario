zenario.lib(function(m,r,f,u,v,w,l,q,x,y,k,s,z,A,B,C,D,t,p,n){f=p(n.hierarchy=t(n.list,function(){this.openItemsInHierarchy={}}));f.returnPageSize=function(){return!1};f.returnInspectionViewEnabled=function(){return!1};f.parentIdColumn=function(){return this.tuix.hierarchy&&this.tuix.hierarchy.column||"parent_id"};f.showPanel=function(b,c,d){var e={},a,h,g,f=this.getMergeFieldsForItemsAndColumns(),k=this.ordinalColumn(),m=this.parentIdColumn();this.itemsById={};this.parentIdOf={};this.ordinals={};
this.changingHierarchy=!1;this.setHeader(b);for(a in f.items)l.has(f.items,a)&&(h=f.items[a],h.items=[],this.itemsById[h.id]=h);for(a=f.items.length-1;0<=a;--a)h=f.items[a],g=h.tuix[m],l.engToBoolean(g)?(f.items.splice(a,1),this.itemsById[g]&&(this.itemsById[g].items.splice(0,0,h),this.parentIdOf[h.id]=g)):g=0,k&&(e[g]||(e[g]=[],this.ordinals[g]={}),e[g].push(this.ordinals[g][h.id]={id:h.id,ord:h.tuix[k]}),h.canDrag=!0);for(g in e)if(l.has(e,g))for(h=e[g],h.sort(q.sortArrayByOrd),a=0;a<h.length;++a)h[a].normOrd=
a+1;c.html(q.microTemplate("zenario_organizer_hierarchy",f));c.show();this.setScroll(c);this.setupHierarchy(b,c,d);d.html("").show();this.setTooltips(b,c,d)};f.setupHierarchy=function(b,c,d){var e=this,a;d=!0;b={};c=c.find(".dd");c.nestable({maxDepth:this.tuix.hierarchy&&this.tuix.hierarchy.depth||99});if(this.searchTerm===m){c.nestable("collapseAll");if(this.openItemsInHierarchy)for(a in this.openItemsInHierarchy)l.has(this.openItemsInHierarchy,a)&&(b[a]=!0);for(a in this.selectedItems)l.has(this.selectedItems,
a)&&this.parentIdOf[a]&&(b[this.parentIdOf[a]]=!0);for(;d;)for(a in d=!1,b)l.has(b,a)&&this.parentIdOf[a]&&!b[this.parentIdOf[a]]&&(d=b[this.parentIdOf[a]]=!0);for(a in b)l.has(b,a)&&(d=$(s("organizer_item_"+a)).parent(),d.length&&c.nestable("expandItem",d))}c.on("collapseItem",function(){e.collapseItem()});c.on("expandItem",function(){e.expandItem()});if(this.ordinalColumn()&&this.searchTerm===m)c.on("change",function(){(e.changingHierarchy=e.scanNewHier(!1))?k.disableInteraction():k.enableInteraction();
k.setButtons()});this.$dd=c};f.collapseItem=function(){this.recordOpenItems();var b=!1,c;for(c in this.selectedItems)l.has(this.selectedItems,c)&&!this.openItemsInHierarchy[c]&&(delete this.selectedItems[c],b=!0);b&&(k.setButtons(!0),k.setHash())};f.expandItem=function(){this.recordOpenItems()};f.showButtons=function(b){var c=this;this.changingHierarchy?(b.html(q.microTemplate("zenario_organizer_apply_cancel_buttons",{})),b.find("#organizer_applyButton").click(function(){c.scanNewHier(!0)}),b.find("#organizer_cancelButton").click(function(){k.enableInteraction();
k.reload()})):p(n.list).showButtons.call(this,b)};f.scanNewHier=function(b){var c=this.$dd.nestable("serialize_zenario_modified_version"),d,e,a,h=!1,g={},f=this.ordinalColumn();for(e in c)if(l.has(c,e)){var n=!1,p=c[e].length;for(a=1;a<=p;++a)if(d=c[e][a-1],d!==m)if(this.ordinals&&this.ordinals[e]&&this.ordinals[e][d]&&this.ordinals[e][d].normOrd==a)this.ordinals[e][d].ord!=a&&(n=!0);else if(h=!0,b&&n){for(a=1;a<=p;++a)d=c[e][a-1],d!==m&&(g[d]={parentId:e,ordinal:a});break}else g[d]={parentId:e,ordinal:a}}if(!b)return h;
if(h){b=k.getKey();c="";b.hierarchy=!0;b.ordinals={};b.parent_ids={};for(d in g)l.has(g,d)&&(c+=(c?",":"")+d,b.parent_ids[d]=g[d].parentId,b.ordinals[d]=g[d].ordinal,b.reorder=!0,this.tuix.items[d][f]=g[d].ordinal);b.id=c;d="zenario/ajax.php?__pluginClassName__="+this.tuix.class_name+"&__path__="+k.path+"&method_call=handleOrganizerPanelAJAX";delete l.rev;l.ajax(r+d,b).after(function(a){a&&q.showMessage(a);k.enableInteraction();k.reload()})}};f.recordOpenItems=function(){var b=this;this.openItemsInHierarchy=
{};$("#organizer_hierarchy_view li.dd-item[data-id]:visible").each(function(c,d){var e,a=$(d);a.find("ol.dd-list:visible").size()&&(e=a.data("id"))&&(b.openItemsInHierarchy[e]=!0)})};f.returnDoSortingAndSearchingOnServer=function(){return!1};f.sortAndSearchItems=function(b){var c,d=this.sortItems(),e=this.searchItems(_.clone(d),b),a=_.object(e,e),f=this.parentIdColumn();k.nonSearchMatches={};for(b=0;b<e.length;++b)c=e[b],(c=this.tuix.items[c]&&this.tuix.items[c][f])&&a[c]===m&&(e.push(c),a[c]=c,k.nonSearchMatches[c]=
!0);for(b=d.length;0<=b;--b)c=d[b],a[c]===m&&d.splice(b,1);return d}},zenarioO.panelTypes);
