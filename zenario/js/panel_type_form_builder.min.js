zenario.lib(function(l,g,x,t,y,z,u,n,p,A,q,B,C,D,E,F,G,v,w,m,r){g=w(r.form_builder=v(r.form_builder_base_class));g.init=function(){this.saveChangesWarningMessage="You are currently editing this form. If you leave now you will lose any unsaved changes.";this.valuesChanged=this.changingForm=!1;this.formatOnChange="values_source readonly_or_mandatory mandatory_condition_field_id visibility visible_condition_field_id field_validation default_value_options send_to_crm restatement_field autocomplete autocomplete_options filter_on_field".split(" ");
this.formEditorSelector="#organizer_form_builder";this.formFieldsSelector="#organizer_form_fields .form_field";this.formFieldInlineButtonsSelector="#organizer_form_fields .form_field_inline_buttons";this.pageBreakCount=0;this.saveButtonText="Save changes";this.cancelButtonText="Reset";this.noTransition=this.dropItem=!1};g.getOrderedItems=function(b){var a,d,c,e=[];for(a in b)if(m(b,a)){d=b[a];var f=_._cl(d);if(!d.remove){if(f.lov){var h=[];for(c in f.lov)m(f.lov,c)&&(d=f.lov[c],h.push(d));h.sort(this.sortByOrd);
f.lov=h}e.push(f)}}e.sort(this.sortByOrd);return e};g.getOrderedItemCRMLOV=function(b,a){var d,c,e=[];for(d in b)m(b,d)&&(c=b[d],c.remove||(c=_._cl(c),c.id=d,a&&isNaN(parseInt(d))&&(c.crm_value=c.label),e.push(c)));e.sort(this.sortByOrd);return e};g.getOrderedTranslations=function(b){var a,d,c=[],e=this.tuix.items[this.current.id],f=this.getOrderedItems(this.tuix.languages);for(a in b)if(m(b,a)){d=b[a];var h=this.tuix.translatable_fields[a],g=!1;h.value=e[h.column];h.value||(h.value="(No text is defined in the default language)",
g=!0);h.phrases=[];var k,l;for(k in f)m(f,k)&&(l=f[k],parseInt(l.translate_phrases)&&h.phrases.push({field_column:h.column,language_id:l.id,language_name:l.english_name,phrase:d.phrases[l.id]&&!g?d.phrases[l.id]:"",disabled:g}));c.push(h)}c.sort(this.sortByOrd);return c};g.getOrderedDatasetFields=function(b){var a,d,c,e,f,h,g=[],k={};for(h in this.tuix.items)m(this.tuix.items,h)&&(f=this.tuix.items[h],f.dataset_field_id&&(k[f.dataset_field_id]=!0));for(d in b)if(m(b,d)){c=b[d];a={};for(e in c)m(c,
e)&&(f=c[e],"fields"!=e&&(a[e]=f));if(c.fields){a.fields=[];for(h in c.fields)m(c.fields,h)&&(f=c.fields[h],!0!==k[h]&&a.fields.push(f));a.fields.sort(this.sortByOrd)}g.push(a)}g.sort(this.sortByOrd);return g};g.showPanel=function(b,a,d){b.html("").hide();this.changesSaved&&(this.changesSaved=!1,n._t({message_type:"success",message:"Your changes have been saved!"}));var c=this;b=_._cl(this.tuix.items);var e={items:{},field:{},details_section:"field_type_list",form_title:this.tuix.form.title};this.currentFieldTab=
this.currentFieldTab?this.currentFieldTab:"details";"translations"!=this.currentFieldTab||this.tuix.show_translation_tab||(this.currentFieldTab="details");this.current&&this.current.id&&this.tuix.items[this.current.id]?(e.items=this.getOrderedItems(b),!this.tuix.items[this.current.id]&&this.currentFieldOrd!==l&&e.items[this.currentFieldOrd]&&(this.current.id=e.items[this.currentFieldOrd].id),e.details_section="field_details",e.field=this.getCurrentFieldDetailsMergeFields(),b[this.current.id].selected=
!0):this.current={id:!1,type:!1};e.items=this.getOrderedItems(b);b=this.microTemplate("zenario_organizer_form_builder",e);a.html(b).show();this.current&&this.initCurrentFieldDetails();this.maxNewCustomFieldValue=this.maxNewCustomField=this.maxNewCustomTab=1;this.deleting=!1;this.pageBreakCount=this.tuix.pageBreakCount;this.initSection();$("#organizer_field_type_list div.field_type, #organizer_centralised_field_type_list div.field_type").draggable({connectToSortable:"#organizer_form_fields",appendTo:"#organizer_form_builder",
helper:"clone",drag:function(a,b){if(c.dropItem)return c.dropItem=!1}});this.initLinkedFieldsAdder();$(this.formFieldsSelector).on("click",function(){c.fieldClick($(this))});this.initDeleteButtons();this.initFormSettingsButton();d.html("").show();this.updateFieldsContainerHeight()};g.initLinkedFieldsAdder=function(){for(var b=this.getOrderedDatasetFields(this.tuix.dataset_fields),a=0;a<b.length;a++)for(var d=0;d<b[a].fields.length;d++)b[a].fields[d].readableType=this.getFieldReadableType(b[a].fields[d].type);
b=this.microTemplate("zenario_organizer_form_builder_dataset_tab",b);$("#organizer_linked_field_type_list").html(b);$("#organizer_linked_field_type_list div.dataset_field").draggable({connectToSortable:"#organizer_form_fields",appendTo:"#organizer_form_builder",helper:"clone"})};g.initDeleteButtons=function(){var b=this;$("#organizer_form_fields .delete_icon").off().on("click",function(a){var d=$(this).data("id");if("registration"==b.tuix.form.type&&"email"==b.tuix.items[d].db_column)return n._sM("You cannot delete the email field from a registration form.",
!0,"warning"),!1;a={};var c=b.tuix.items[d].type,e,f;for(e in b.tuix.items)m(b.tuix.items,e)&&(f=b.tuix.items[e],f.type==c&&e!=d&&(a[e]=f.name));e={id:d,field_name:b.tuix.items[d].name,field_type:c,field_english_type:b.getFieldReadableType(c),responses_transfer_fields:JSON.stringify(a)};b.noTransition=!0;p.open("zenario_delete_form_field",e,l,l,function(a,c){"delete_field_but_migrate_data"==c.details.delete_field_options&&c.details.migration_field&&b.tuix.items[c.details.migration_field]&&(b.tuix.items[c.details.migration_field]._migrate_responses_from=
d);var f=!0;setTimeout(function(){!0==f&&b.deleteField(d);f=!1})})})};g.deleteField=function(b){var a=this,d=function(c){if(_._isEm(c)){var d,f;b===l&&(b=a.current.id);c=a.tuix.items[b];if("page_break"==c.type)a.pageBreakCount--;else if("repeat_start"==c.type)for(var h=!1,g=a.getOrderedItems(a.tuix.items),k=0;k<g.length;k++)if(g[k].id==b)h=!0;else if(h&&"repeat_end"==g[k].type){a.deleteField(g[k].id);break}a.tuix.items[b]={remove:!0};d=$("#organizer_form_field_"+b);c.dataset_field_id&&a.initLinkedFieldsAdder();
d&&(f=a.selectNextField(d),a.changeMadeToPanel(),d.animate({height:0,opacity:0},500,function(){d.remove();!1===f&&a.showNoFieldsMessage()}));a.updateFieldsContainerHeight()}};(cb=this.validate(!0))?cb.after(d):d([])};g.selectNextField=function(b){for($next=b.prev();1==$next.length;)if(this.tuix.items[$next.data("id")]&&this.tuix.items[$next.data("id")].remove)$next=$next.prev();else break;if(0==$next.length)for($next=b.next();1==$next.length;)if(this.tuix.items[$next.data("id")]&&this.tuix.items[$next.data("id")].remove)$next=
$next.next();else break;return 1==$next.length?(this.fieldClick($next),$next):!1};g.showNoFieldsMessage=function(){$("#organizer_section_"+this.currentTab).addClass("empty").html('<span class="no_fields_message">There are no fields on this form</span>');this.showDetailsSection("organizer_field_type_list")};g.initSection=function(){var b=this;$("#organizer_form_fields").sortable({items:"div.form_field:not(.page_end)",placeholder:"preview",containment:"#organizer_form_fields",scroll:!0,scrollSensitivity:150,
receive:function(a,d){$(this).find("div.field_type, div.dataset_field").each(function(){b.addNewField($(this))})},start:function(a,d){b.startIndex=d.item.index()},stop:function(a,d){b.startIndex!=d.item.index()&&("field"==b.current.type&&(b.currentFieldOrd=$("#organizer_form_field_"+b.current.id).index()),b.changeMadeToPanel())}})};g.removeNoItemsMessage=function(b){$("#organizer_section_"+b).removeClass("empty").find("span.no_fields_message").remove()};g.addNewField=function(b){this.changeMadeToPanel();
this.removeNoItemsMessage(this.currentTab);var a=b.data("type"),d=b.data("id"),c=b.data("tab_name"),e=this.createNewField(a,d,c),f=!1;"repeat_start"==a&&(f=this.createNewField("repeat_end"));mergeFields=_._cl(e);mergeFields.form_type=this.tuix.form.type;e.lov&&(mergeFields.lov=this.getOrderedItemCRMLOV(e.lov));a=this.microTemplate("zenario_organizer_form_builder_field",mergeFields);f&&(a+=this.microTemplate("zenario_organizer_form_builder_field",f));var h=$("#organizer_form_fields").children().length;
b.index()==h-1&&$("#organizer_form_field_page_end").length?($("#organizer_form_field_page_end").before(a),b.remove()):b.replaceWith(a);this.tuix.items[e.id]=e;b=$("#organizer_form_field_"+e.id);b.effect({effect:"highlight",duration:1E3});this.initField(b);f&&(this.tuix.items[f.id]=f,f=$("#organizer_form_field_"+f.id),f.effect({effect:"highlight",duration:1E3}),this.initField(f));this.fieldClick(b);d!==l&&c!==l&&this.initLinkedFieldsAdder();this.updateFieldsContainerHeight()};g.updateFieldsContainerHeight=
function(){$container=$("#organizer_form_fields");$container.height("auto");$container.height($container.height()+500)};g.createNewField=function(b,a,d){var c={};c.id="t"+this.maxNewCustomField++;c.label="Untitled";c.values_source="";c._translations={};c.is_new_field=!0;c.just_added=!0;c.readonly_or_mandatory="none";c.default_value_mode="none";c.visibility="visible";c.remove=!1;c._crm_data={};a&&d?(datasetField=this.tuix.dataset_fields[d].fields[a],c.type=datasetField.type,c.name=datasetField.label,
c.label=datasetField.label,c.dataset_field_id=a,c.lov=datasetField.lov,c.preload_dataset_field_user_data=!0):(c.type=b,c.name="Untitled "+this.getFieldReadableType(c.type).toLowerCase());if(!c.lov&&-1<$.inArray(c.type,["checkboxes","radios","select"]))for(c.lov={},b=1;3>=b;b++)a="t"+this.maxNewCustomFieldValue++,c.lov[a]={is_new_value:!0,id:a,ord:b,label:"Option "+b};else if(a||"centralised_radios"!=c.type&&"centralised_select"!=c.type)"page_break"==c.type?(c.next_button_text="Next",c.previous_button_text=
"Previous",c.name="Page break "+ ++this.pageBreakCount):"repeat_start"==c.type&&(c.min_rows=3,c.max_rows=10);else{for(var e in this.tuix.centralised_lists.values)if(m(this.tuix.centralised_lists.values,e)){c.values_source=e;break}c.lov=_._cl(this.tuix.centralised_lists.initial_lov)}if(this.tuix.show_translation_tab){c._translations.label={phrases:{}};"section_description"==c.type&&(c._translations.description={phrases:{}});if("text"==c.type||"textarea"==c.type)"text"==c.type&&(c._translations.field_validation_error_message=
{phrases:{}}),c._translations.placeholder={phrases:{}};if("page_break"!=c.type||"section_description"!=c.type)c._translations.note_to_user={phrases:{}},c._translations.required_error_message={phrases:{}}}return c};g.fieldClick=function(b,a){var d=this,c=function(c){_._isEm(c)&&(d.valuesChanged=!1,d.current={type:"field",id:e},d.currentFieldOrd=b.index(),$(d.formFieldsSelector).removeClass("selected"),b.addClass("selected"),d.currentFieldTab=a?a:"details",d.setCurrentFieldDetails(),$(d.formFieldInlineButtonsSelector).hide(),
$("#organizer_form_field_inline_buttons_"+d.current.id).show(),d.showDetailsSection("organizer_field_details",!!a))},e=b.data("id");"repeat_end"!=this.tuix.items[e].type&&(this.save(),(cb=this.validate())?cb.after(c):c([]))};g.setCurrentFieldDetails=function(){var b=this.getCurrentFieldDetailsMergeFields(),b=this.microTemplate("zenario_organizer_form_builder_field_details",b);$("#organizer_field_details_inner").html(b);this.initCurrentFieldDetails()};g.getCurrentFieldDetailsMergeFields=function(){var b=
this.tuix.items[this.current.id]||{},a=_._cl(b);a.currentFieldTab=this.currentFieldTab;a.formattedType=this.getFieldReadableType(a.type);a.dataset_field_id&&(a.formattedType+=", dataset field");a.crm_enabled=this.tuix.crm_enabled;var d,c,e={},f={},h={};for(d in this.tuix.items)m(this.tuix.items,d)&&(c=this.tuix.items[d],-1!=["integer","number","floating_point"].indexOf(c.field_validation)&&_._cl(c),-1!=["text","calculated","select","centralised_select"].indexOf(c.type)&&(e[d]=_._cl(c)),("centralised_select"==
c.type||"text"==c.type&&1==c.autocomplete&&!1!=c.values_source)&&d!=this.current.id&&(f[d]=_._cl(c)),-1!="checkbox group radios select centralised_radios centralised_select".split(" ").indexOf(c.type)&&d!=this.current.id&&(h[d]={label:c.name,ord:c.ord}));"calculated"==b.type&&(c="",c=Array.isArray(b.calculation_code)?b.calculation_code:$.map(b.calculation_code,function(a){return a}),a.calculation_code_display=this.getCalculationCodeDisplay(c));c={};var g=1,k,s;for(k in this.tuix.centralised_lists.values)m(this.tuix.centralised_lists.values,
k)&&(s=this.tuix.centralised_lists.values[k],c[k]={ord:g++,label:s.label});a.values_source_options=this.createSelectList(c,a.values_source);this.tuix.centralised_lists.values[a.values_source]&&this.tuix.centralised_lists.values[a.values_source].info.can_filter&&(a.show_source_filter=!0,a.source_filter_label=this.tuix.centralised_lists.values[a.values_source].info.filter_label);k={};for(d in f)m(f,d)&&(c=f[d],k[d]={ord:c.ord,label:c.name});a.filter_on_field_options=this.createSelectList(k,a.filter_on_field,
!0);a.readonly_or_mandatory_options=this.createSelectList({none:{ord:1,label:"None"},mandatory:{ord:2,label:"Mandatory"},readonly:{ord:3,label:"Read-only"},conditional_mandatory:{ord:4,label:"Mandatory on condition"}},a.readonly_or_mandatory);a.mandatory_condition_field_id_options=this.createSelectList(h,a.mandatory_condition_field_id,!0);f=this.tuix.items[a.mandatory_condition_field_id];k={};c=!0;f&&("checkbox"==f.type||"group"==f.type?k={0:{label:"Unchecked",ord:1},1:{label:"Checked",ord:2}}:(k=
f.lov,c="-- Any value --"));""!==a.mandatory_condition_field_id&&a.mandatory_condition_field_id!==l&&(a.mandatory_condition_field_value_options=this.createSelectList(k,a.mandatory_condition_field_value,c));f={visible:{ord:1,label:"Visible"},hidden:{ord:2,label:"Hidden"},visible_on_condition:{ord:3,label:"Visible on condition"}};"page_break"==b.type&&delete f.hidden;a.visibility_options=this.createSelectList(f,a.visibility);a.visible_condition_field_id_options=this.createSelectList(h,a.visible_condition_field_id,
!0);f=this.tuix.items[a.visible_condition_field_id];k={};c=!0;f&&("checkbox"==f.type||"group"==f.type?k={0:{label:"Unchecked",ord:1},1:{label:"Checked",ord:2}}:(k=f.lov,c="-- Any value --"));""!==a.visible_condition_field_id&&a.visible_condition_field_id!==l&&(a.visible_condition_field_value_options=this.createSelectList(k,a.visible_condition_field_value,c));a.validation_options=this.createSelectList({none:{ord:1,label:"None"},email:{ord:2,label:"Email"},URL:{ord:3,label:"URL"},number:{ord:4,label:"Number"},
integer:{ord:5,label:"Integer"},floating_point:{ord:6,label:"Floating point"}},a.field_validation);a.size_options=this.createSelectList({small:{ord:1,label:"Small"},medium:{ord:2,label:"Medium"},large:{ord:3,label:"Large"}},a.size,!0);h={};for(d in e)m(e,d)&&(c=e[d],h[d]={ord:c.ord,label:c.name});a.restatement_field_options=this.createSelectList(h,a.restatement_field,!0);"restatement"==a.type&&a.restatement_field&&this.tuix.items[a.restatement_field]&&(a.mirrorFieldType=this.tuix.items[a.restatement_field].type);
a.value_field_columns_options=this.createSelectList({1:{ord:1,label:"1"},2:{ord:2,label:"2"},3:{ord:3,label:"3"},4:{ord:4,label:"4"},5:{ord:5,label:"5"},6:{ord:6,label:"6"}},a.value_field_columns);a.default_value_mode_options=this.createRadioList({none:{ord:1,label:"Don't pre-populate"},value:{ord:2,label:"Pre-populate with value"},method:{ord:3,label:"Call a module's static method to get the value"}},a.default_value_mode,"default_value_mode");d={};"checkbox"==a.type||"group"==a.type?d={0:{ord:1,
label:0},1:{ord:2,label:1}}:-1!=["radios","centralised_radios","select","centralised_select"].indexOf(a.type)&&(d=a.lov);a.default_value_lov_options=this.createSelectList(d,a.default_value);a.autocomplete_options||a.autocomplete_class_name||(a.autocomplete_options="centralised_list");a.autocomplete_options_lov=this.createRadioList({centralised_list:{ord:1,label:"Centralised list"},method:{ord:2,label:"Call a modue's static method to get a list"}},a.autocomplete_options,"autocomplete_options");a.translatable_fields=
this.getOrderedTranslations(a._translations);a.hasCRMValues=this.fieldCanHaveCRMValues(a.type);a.hasCRMValues&&("checkbox"==a.type?(b={0:{ord:1,label:0,crm_value:0},1:{ord:2,label:1,crm_value:1}},a._crm_data&&a._crm_data.values&&(b=a._crm_data.values),a.crm_values=this.getOrderedItemCRMLOV(b)):a.crm_values=this.getOrderedItemCRMLOV(b.lov,!a.dataset_field_id&&("select"==a.type||"radios"==a.type)));a.showDetailsTab=!0;a.showAdvancedTab=-1==["page_break","page_end"].indexOf(a.type);a.showValuesTab=-1!=
["select","radios","checkboxes"].indexOf(a.type);a.showTranslationsTab=this.tuix.show_translation_tab&&-1==["page_break","page_end"].indexOf(a.type);a.showCRMTab=a.crm_enabled&&-1==["page_break","page_end","section_description"].indexOf(a.type);return a};g.initCurrentFieldDetails=function(){var b=this,a=this.tuix.items[this.current.id]||{};$("#field__field_label").on("keyup",function(){var c=$(this).val();$("#organizer_form_field_"+b.current.id+" .label").text(c);a.just_added&&$("#field__name").val(c)});
$("#field__css_classes").on("keyup",function(){var a=$(this).val();$("#organizer_form_field_"+b.current.id+" .form_field_classes .css").toggle(!!a)});$("#field__div_wrap_class").on("keyup",function(){var a=$(this).val();$("#organizer_form_field_"+b.current.id+" .form_field_classes .div").toggle(!!a)});$("#zenario_field_details_header_content .edit_field_name_button").off().on("click",function(){$("#zenario_field_details_header_content .view_mode").hide();$("#zenario_field_details_header_content .edit_mode").show()});
$("#zenario_field_details_header_content .done_field_name_button").off().on("click",function(){$("#zenario_field_details_header_content .edit_mode").hide();$("#zenario_field_details_header_content .view_mode").show();var a=$('#zenario_field_details_header_content .edit_mode input[name="name"]').val();$("#zenario_field_details_header_content .view_mode h5").text(a)});$("#field__note_to_user").on("keyup",function(){var a=$(this).val(),c=$("#organizer_form_field_note_below_"+b.current.id);$("#organizer_form_field_note_below_"+
b.current.id+" div.zenario_note_content").html(a);c.toggle(""!==a)});if("text"==a.type||"textarea"==a.type)$("#field__placeholder").on("keyup",function(){$("#organizer_form_field_"+b.current.id+" :input").prop("placeholder",$(this).val())});else if("section_description"==a.type)$("#field__description").on("keyup",function(){$("#organizer_form_field_"+b.current.id+" .description").text($(this).val())});$("#field_container__values_source :input").on("change",function(){$("#field_container__values_source_filter :input").val("");
var a=$(this).val();b.centralisedListUpdated(b.current.id,a,"")});var d=function(){var a=0;return function(b,c){clearTimeout(a);a=setTimeout(b,c)}}();$("#field_container__values_source_filter :input").on("keyup",function(){var a=$("#field_container__values_source :input").val(),c=$(this).val();d(function(){b.centralisedListUpdated(b.current.id,a,c)},1E3)});for(var c="",e=0;e<this.formatOnChange.length;e++)0!=e&&(c+=", "),c+="#field_container__"+this.formatOnChange[e]+" :input";$(c).on("change",function(){b.formatFieldDetails()});
c=this.getOrderedItems(a.lov);if(a.dataset_field_id)for(e in c)c[e].disabled=!0;e=this.microTemplate("zenario_organizer_admin_box_builder_field_value",c);c=$("#field_values_list");c.html(e);a.dataset_field_id||(c.sortable({axis:"y",start:function(a,c){b.startIndex=c.item.index()},stop:function(c,d){b.startIndex!=d.item.index()&&(b.save(),b.setCurrentFieldValues(a),b.changeMadeToPanel())}}),this.initFieldValues(a),this.initAddNewFieldValuesButton(a));if("centralised_select"==a.type||"centralised_radios"==
a.type)$("#organizer_crm_button__set_labels").on("click",function(){$("#field_section__crm input.crm_value_input").each(function(a,c){var d=$(this).data("id"),e="";b.tuix.items[b.current.id].lov&&b.tuix.items[b.current.id].lov[d]&&(e=b.tuix.items[b.current.id].lov[d].label);$(this).val(e)})}),$("#organizer_crm_button__set_values").on("click",function(){$("#field_section__crm input.crm_value_input").each(function(a,b){var c=$(this).data("id");$(this).val(c)})});else if("calculated"==a.type)$("#edit_field_calculation").on("click",
function(){b.saveItemsOrder();var a,c,d={};for(a in b.tuix.items)m(b.tuix.items,a)&&(c=b.tuix.items[a],"text"==c.type&&"number"==c.field_validation||"calculated"==c.type&&b.current.id!=a)&&(d[a]={label:c.name,ord:c.ord});a=[];b.tuix.items[b.current.id]&&b.tuix.items[b.current.id].calculation_code&&(a=b.tuix.items[b.current.id].calculation_code,Array.isArray(a)||(a=$.map(a,function(a){return a})));c="";b.tuix.items[b.current.id]&&b.tuix.items[b.current.id].name&&(c=b.tuix.items[b.current.id].name);
p.open("zenario_field_calculation",{id:b.current.id,title:'Editing the calculation for the field "'+c+'"',numeric_fields:JSON.stringify(d),calculation_code:JSON.stringify(a)},l,l,function(a,c){b.tuix.items[a.id]&&(b.tuix.items[a.id].calculation_code=JSON.parse(c.details.calculation_code),b.changeMadeToPanel(),b.noTransition=!0,b.fieldClick($("#organizer_form_field_"+a.id)))})});$("#organizer_field_details :input").on("change",function(){b.changeMadeToPanel()});$('#organizer_field_details input[type="text"], #organizer_field_details textarea, #zenario_field_details_header_content input[type="text"]').on("keyup",
function(){b.changeMadeToPanel()});this.initAddNewFieldsButton();this.initFormSettingsButton()};g.calculationAdminBoxAddSomthing=function(b,a){var d=!1;switch(b){case "operation_addition":case "operation_subtraction":case "operation_multiplication":case "operation_division":case "parentheses_open":case "parentheses_close":d={type:b};break;case "static_value":""===a||isNaN(+a)||(d={type:b,value:+a},$("#static_value").val(""));break;case "field":this.tuix.items[a]&&(d={type:b,value:a}),$("#numeric_field").val("")}if(d){var c=
[];$("#calculation_code").val()&&(c=JSON.parse($("#calculation_code").val()));c.push(d);$("#calculation_code").val(JSON.stringify(c));this.calculationAdminBoxUpdateDisplay(c)}};g.calculationAdminBoxDelete=function(){var b=[];$("#calculation_code").val()&&(b=JSON.parse($("#calculation_code").val()))&&(b.pop(),$("#calculation_code").val(JSON.stringify(b)));this.calculationAdminBoxUpdateDisplay(b)};g.calculationAdminBoxUpdateDisplay=function(b){b=this.getCalculationCodeDisplay(b);$("#zenario_calculation_display").text(b)};
g.getCalculationCodeDisplay=function(b){var a="";if(b)for(var d=!1,c=0;c<b.length;c++){d||"parentheses_close"==b[c].type?d&&(d=!1):a+=" ";switch(b[c].type){case "operation_addition":a+="+";break;case "operation_subtraction":a+="-";break;case "operation_multiplication":a+="\u00d7";break;case "operation_division":a+="\u00f7";break;case "parentheses_open":a+="(";d=!0;break;case "parentheses_close":a+=")";break;case "static_value":a+=b[c].value;break;case "field":var e="",e=this.tuix.items[b[c].value]?
this.tuix.items[b[c].value].name:"UNKNOWN FIELD",a=a+('"'+e+'"')}a=a.trim()}return a};g.fieldCanHaveCRMValues=function(b){return-1!="select radios checkboxes centralised_select centralised_radios checkbox".split(" ").indexOf(b)};g.getFieldReadableType=function(b){switch(b){case "checkbox":return"Checkbox";case "checkboxes":return"Checkboxes";case "date":return"Date";case "editor":return"Editor";case "radios":return"Radios";case "centralised_radios":return"Centralised radios";case "select":return"Select";
case "centralised_select":return"Centralised select";case "text":return"Text";case "textarea":return"Textarea";case "url":return"URL";case "attachment":return"Attachment";case "page_break":return"Page break";case "section_description":return"Subheading";case "calculated":return"Calculated";case "restatement":return"Mirror";case "group":return"Group";case "file_picker":return"File picker";case "repeat_start":return"Start of repeating section";case "repeat_end":return"End of repeating section";case "page_end":return"";
default:return"Unknown"}};g.centralisedListUpdated=function(b,a,d){var c=this;this.sendAJAXRequest({mode:"get_centralised_lov",method:a,filter:d,type:"object"}).after(function(a){a=JSON.parse(a);c.tuix.items[b].lov=a;c.valuesChanged=!0;a=c.getOrderedItemCRMLOV(a);a=c.microTemplate("zenario_organizer_admin_box_builder_radio_values_preview",a);$("#organizer_form_field_values_"+b).html(a)})};g.getCurrentFieldDetails=function(){var b={},a=this.tuix.items[this.current.id];$.each($("#organizer_field_details_form :input:not([disabled], [type=button], .crm_value_input, .translation)").serializeArray(),
function(a,c){c.name&&(b[c.name]=c.value)});$("#organizer_field_details_form input[type=checkbox]").map(function(a,c){b[c.name]=c.checked?1:0});b.default_value_lov!==l?b.default_value=b.default_value_lov:b.default_value_text!==l&&(b.default_value=b.default_value_text);-1==["select","radios","checkboxes"].indexOf(a.type)||a.dataset_field_id||(b.lov=this.getCurrentFieldValues(a));this.tuix.show_translation_tab&&$("#field_section__translations input.translation").map(function(b,c){var e=$(this).data("language_id"),
f=$(this).data("field_column");a._translations&&a._translations[f]&&(a._translations[f].phrases[e]=c.value)});this.fieldCanHaveCRMValues(a.type)&&(b.lov||(b.lov=a.lov?_._cl(a.lov):{}),"checkbox"==a.type&&(a._crm_data.values={0:{ord:1,label:0,crm_value:0},1:{ord:2,label:1,crm_value:1}}),$("#field_section__crm input.crm_value_input").map(function(d,c){var e=$(this).data("id");"checkbox"==a.type?a._crm_data.values[e].crm_value=$(this).val():b.lov[e]&&!b.lov[e].remove&&(b.lov[e].crm_value=$(this).val())}));
return b};g.save=function(){var b={},a,d;if(this.current.id){b=this.getCurrentFieldDetails();if(!this.tuix.items[this.current.id])this.tuix.items[this.current.id]={};else if(this.tuix.items[this.current.id].remove)return;for(a in b)m(b,a)&&(d=b[a],"field_crm_name"==a||"send_to_crm"==a?this.tuix.items[this.current.id]._crm_data[a]=d:this.tuix.items[this.current.id][a]=d)}};g.validate=function(b){var a=this,d,c,e=new u.callback,f={mode:"validate_field",id:this.current.id,field_tab:this.currentFieldTab,
items:JSON.stringify(this.tuix.items)};!0===b&&(f.removingField=!0);return this.current.id&&!this.tuix.items[this.current.id].remove?(this.sendAJAXRequest(f).after(function(b){b=JSON.parse(b);$("#organizer_form_field_error").remove();if(0<b.length){var f=$('<div id="organizer_form_field_error"></div>');for(d in b)m(b,d)&&(c=b[d],f.append('<p class="error">'+c+"</p>"));$("#organizer_field_details").prepend(f);a.shakeBox("#organizer_form_builder .form_fields_palette")}else delete a.tuix.items[a.current.id].just_added;
e.call(b)}),e):!1};g.saveItemsOrder=function(){var b=this;$(this.formFieldsSelector).each(function(a,d){var c=$(d).data("id");b.tuix.items[c].ord=a+1})};g.saveChanges=function(){this.saveItemsOrder();var b=this,a={mode:"save",data:JSON.stringify(this.tuix.items)};this.sendAJAXRequest(a).after(function(a){var c=!1;b.changesSaved=!0;a&&(a=JSON.parse(a))&&a.error&&(c="Unknown error","invalid_type_in_repeat_block"==a.error.code&&a.error.type?c='Field type "'+b.getFieldReadableType(a.error.type).toLowerCase()+
'" is not allowed in repeat blocks.':"invalid_repeat_block_end"==a.error.code&&(c="You cannot have a Repeat End before a Repeat Start."),$("#organizer_fields_error").show().text(c),c=!0,b.changesSaved=!1);n._nDS();c||(b.changingForm=!1,q._eI(),t.onbeforeunload=!1,q._r());b.saveLock=!1})};g.initFormSettingsButton=function(){$("input.form_settings").off().on("click",function(){p.open("zenario_user_admin_box_form",{id:q.pi.refiner.id},l,l,function(b,a){var d="";a.details.show_title&&(d=a.details.title);
this.tuix.title=d;$("#organizer_form_builder .form_outer .form_header h5").text(d)})})};g.showFieldDetailsSection=function(b,a){var d=this,c,e=function(a){_._isEm(a)&&(d.currentFieldTab=b,$("#organizer_field_details_tabs div.tab").removeClass("on"),$("#field_tab__"+b).addClass("on"),$("#organizer_field_details div.section").hide(),$("#field_section__"+b).show())};if(this.valuesChanged&&"crm"==b)this.fieldClick($("#organizer_form_field_"+this.current.id),"crm");else if(this.changingForm&&"translations"==
b)this.fieldClick($("#organizer_form_field_"+this.current.id),"translations");else{if(!a&&(this.save(),c=this.validate())){c.after(e);return}e([])}}},zenarioO.panelTypes);
