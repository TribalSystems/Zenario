zenario.lib(function(k,e,q,r,s,t,g,h,u,v,w,x,y,z,A,B,C,n,p,l){e=p(l.form_builder=n(l.form_builder_base_class));e.init=function(){this.saveChangesWarningMessage="You are currently editing this form. If you leave now you will lose any unsaved changes.";this.changingForm=!1;this.formatOnChange="readonly_or_mandatory mandatory_condition_field_id visibility visible_condition_field_id validation default_value_options".split(" ");this.formFieldsSelector="#organizer_form_fields .form_field";this.formFieldInlineButtonsSelector=
"#organizer_form_fields .form_field_inline_buttons"};e.getOrderedItems=function(b){var a,c,d=[];for(a in b)if(g.has(b,a)){c=b[a];var f=_.clone(c);if(!c.remove){if(f.lov){c=[];for(a in f.lov)g.has(f.lov,a)&&(value=f.lov[a],c.push(value));c.sort(this.sortByOrd);f.lov=c}d.push(f)}}d.sort(this.sortByOrd);return d};e.getOrderedDatasetFields=function(b){var a={};for(id in this.tuix.items)g.has(this.tuix.items,id)&&(field=this.tuix.items[id],field.field_id&&(a[field.field_id]=!0));var c,d=[];for(tabName in b)if(g.has(b,
tabName)){tab=b[tabName];c={};for(key in tab)g.has(tab,key)&&(value=tab[key],"fields"!=key&&(c[key]=value));if(tab.fields){c.fields=[];for(id in tab.fields)g.has(tab.fields,id)&&(field=tab.fields[id],!0!==a[id]&&c.fields.push(field));c.fields.sort(this.sortByOrd)}d.push(c)}d.sort(this.sortByOrd);return d};e.showPanel=function(b,a,c){var d=this,f=this.getOrderedItems(this.tuix.items),e=h.microTemplate("zenario_organizer_form_builder",{items:f});this.currentFieldTab="details";this.currentFieldTypeTab=
"unlinked";this.maxNewCustomFieldValue=this.maxNewCustomField=this.maxNewCustomTab=1;this.current={id:!1,type:!1};this.current_db_columns=this.tuix.existing_db_columns;this.deleting=!1;b.html("").hide();a.html(e).show();c.html("").show();this.initSection();this.orderedItems=f;$("#organizer_field_type_list div.field_type, #organizer_centralised_field_type_list div.field_type").draggable({connectToSortable:"#organizer_form_fields",helper:function(){var a=$(this).data("type");return $("<div>[---PLACEHOLDER---]</div>").data("type",
a).addClass("preview preview_"+a)}});this.initLinkedFieldsAdder();$(this.formFieldsSelector).on("click",function(){d.fieldClick($(this))});this.initDeleteButtons()};e.initLinkedFieldsAdder=function(){var b=this;dataset_fields=this.getOrderedDatasetFields(this.tuix.dataset_fields);var a=h.microTemplate("zenario_organizer_form_builder_dataset_tab",dataset_fields);$("#organizer_linked_field_type_list").html(a);$("#organizer_linked_field_type_list div.dataset_field").draggable({connectToSortable:"#organizer_form_fields",
helper:function(){var a=$(this).data("id"),d=$(this).data("tab_name"),f=b.tuix.dataset_fields[d].fields[a].type;return $("<div>[---PLACEHOLDER---]</div>").data("type",f).data("id",a).data("tab_name",d).addClass("preview preview_"+f)}})};e.initDeleteButtons=function(){var b=this;$("#organizer_form_fields .delete_icon").off().on("click",function(a){b.deleting=!0;h.showMessage("Are you sure you want to delete this Field?","Delete","warning",!0);b.listenForDelete($(this).data("id"));a.stopPropagation()})};
e.listenForDelete=function(b){var a=this;$("#zenario_fbMessageButtons input.submit_selected").on("click",function(){setTimeout(function(){!0==a.deleting&&a.deleteField(b);a.deleting=!1})})};e.deleteField=function(b){var a=this,c=function(c){if(_.isEmpty(c)){var f,e;b===k&&(b=a.current.id);c=a.tuix.items[b].field_id;a.tuix.items[b]={remove:!0};f=$("#organizer_form_field_"+b);c&&a.initLinkedFieldsAdder();f&&(e=a.selectNextField(f),a.changeMadeToPanel(),f.animate({height:0,opacity:0},500,function(){f.remove();
!1===e&&a.showNoFieldsMessage()}))}};(cb=this.validate(!0))?cb.after(c):c([])};e.selectNextField=function(b){for($next=b.prev();1==$next.length;)if(this.tuix.items[$next.data("id")]&&this.tuix.items[$next.data("id")].remove)$next=$next.prev();else break;if(0==$next.length)for($next=b.next();1==$next.length;)if(this.tuix.items[$next.data("id")]&&this.tuix.items[$next.data("id")].remove)$next=$next.next();else break;return 1==$next.length?(this.fieldClick($next),$next):!1};e.showNoFieldsMessage=function(){$("#organizer_section_"+
this.currentTab).addClass("empty").html('<span class="no_fields_message">There are no fields on this form</span>');this.showDetailsSection("organizer_field_type_list")};e.initSection=function(){var b=this;$("#organizer_form_fields").sortable({items:"div.form_field",receive:function(a,c){$(this).find("div.preview").each(function(){b.addNewField($(this))})},start:function(a,c){b.startIndex=c.item.index()},stop:function(a,c){b.startIndex!=c.item.index()&&b.changeMadeToPanel()}})};e.removeNoItemsMessage=
function(b){$("#organizer_section_"+b).removeClass("empty").find("span.no_fields_message").remove()};e.addNewField=function(b){var a="t"+this.maxNewCustomField++,c=b.data("type"),d=b.data("id"),f=b.data("tab_name"),e={form_field_id:a,type:c,field_label:"Untitled"},l="";d!==k&&f!==k&&(datasetField=this.tuix.dataset_fields[f].fields[d],e.field_label=datasetField.label,e.name=datasetField.label,e.field_id=d);this.removeNoItemsMessage(this.currentTab);if(-1<$.inArray(c,["checkboxes","radios","select"])){e.lov=
[];for(var m=1;3>=m;m++){var n={is_new_value:!0,id:"t"+this.maxNewCustomFieldValue++,ord:m,label:"Option "+m};e.lov[m]=n}}if("centralised_radios"==c){for(method in this.tuix.centralised_lists.values)if(g.has(this.tuix.centralised_lists.values,method)){l=method;break}e.lov=_.toArray(this.tuix.centralised_lists.initial_lov)}c=h.microTemplate("zenario_organizer_form_builder_field",e);b.replaceWith(c);$.extend(e,{is_new_field:!0,just_added:!0,values_source:l,readonly_or_mandatory:"none",default_value_mode:"none",
remove:!1});this.tuix.items[a]=e;b=$("#organizer_form_field_"+a);b.effect({effect:"highlight",duration:1E3});this.initField(b);this.fieldClick(b);d!==k&&f!==k&&this.initLinkedFieldsAdder()};e.fieldClick=function(b){var a=this,c=function(c){_.isEmpty(c)&&(c=b.data("id"),a.current={type:"field",id:c},$(a.formFieldsSelector).removeClass("selected"),b.addClass("selected"),a.currentFieldTab="details",a.setCurrentFieldDetails(),$(a.formFieldInlineButtonsSelector).hide(),$("#organizer_form_field_inline_buttons_"+
a.current.id).show(),a.showDetailsSection("organizer_field_details"))};this.save();(cb=this.validate())?cb.after(c):c([])};e.setCurrentFieldDetails=function(){var b=this,a=_.clone(this.tuix.items[this.current.id]||{});a.currentFieldTab=this.currentFieldTab;a.centralised_lists=this.tuix.centralised_lists;a.readonly_or_mandatory_options=this.createSelectList({none:{ord:1,label:"None"},mandatory:{ord:2,label:"Mandatory"},readonly:{ord:3,label:"Read-only"},conditional_mandatory:{ord:4,label:"Mandatory on condition"}},
a.readonly_or_mandatory);a.mandatory_condition_field_id_options=this.createSelectList(this.tuix.conditional_fields,a.mandatory_condition_field_id,!0);a.mandatory_condition_field_id&&this.tuix.conditional_fields_values[a.mandatory_condition_field_id]&&(a.mandatory_condition_field_value_options=this.createSelectList(this.tuix.conditional_fields_values[a.mandatory_condition_field_id],a.mandatory_condition_field_value,!0));a.visibility_options=this.createSelectList({visible:{ord:1,label:"Visible"},hidden:{ord:2,
label:"Hidden"},visible_on_condition:{ord:3,label:"Visible on condition"}},a.visibility);a.visible_condition_field_id_options=this.createSelectList(this.tuix.conditional_fields,a.visible_condition_field_id,!0);a.visible_condition_field_id&&this.tuix.conditional_fields_values[a.visible_condition_field_id]&&(a.visible_condition_field_value_options=this.createSelectList(this.tuix.conditional_fields_values[a.visible_condition_field_id],a.visible_condition_field_value,!0));a.validation_options=this.createSelectList({none:{ord:1,
label:"None"},email:{ord:2,label:"Email"},URL:{ord:3,label:"URL"},number:{ord:4,label:"Number"},integer:{ord:5,label:"Integer"},floating_point:{ord:6,label:"Floating point"}},a.field_validation);a.size_options=this.createSelectList({small:{ord:1,label:"Small"},medium:{ord:2,label:"Medium"},large:{ord:3,label:"Large"}},a.size,!0);var c=this.getFloatingPointFields(),d={};for(id in c)g.has(c,id)&&(floatingPointField=c[id],d[id]={ord:floatingPointField.ord,label:floatingPointField.name});a.numeric_field_1_options=
this.createSelectList(d,a.numeric_field_1,!0);a.numeric_field_2_options=this.createSelectList(d,a.numeric_field_2,!0);a.calculation_type_options=this.createSelectList({"+":{ord:1,label:"+"},"-":{ord:2,label:"-"}},a.calculation_type);c=this.getMirroredFields();d={};for(id in c)g.has(c,id)&&(mirroredField=c[id],d[id]={ord:mirroredField.ord,label:mirroredField.name});a.restatement_field_options=this.createSelectList(d,a.restatement_field);a.default_value_mode_options=this.createRadioList({none:{ord:1,
label:"No default value"},value:{ord:2,label:"Enter a default value"},method:{ord:3,label:"Call a modules static method to get the default value"}},a.default_value_mode,"default_value_mode");a.default_value_lov_options=this.createSelectList(a.lov,a.default_value);c=h.microTemplate("zenario_organizer_form_builder_field_details",a);$("#organizer_field_details_inner").html(c);$("#organizer_field_details :input").off().on("change",function(){b.changeMadeToPanel()});$('#organizer_field_details input[type="text"]').on("keyup",
function(){b.changeMadeToPanel()});$("#field__field_label").on("keyup",function(){$("#organizer_form_field_"+b.current.id+" .label").text($(this).val())});c="";for(d=0;d<this.formatOnChange.length;d++)0!=d&&(c+=", "),c+="#field__"+this.formatOnChange[d]+" :input";$(c).on("change",function(){b.formatFieldDetails()});this.initAddNewFieldsButton();a=this.getOrderedItems(a.lov);c=h.microTemplate("zenario_organizer_admin_box_builder_field_value",a);$("#field_values_list").html(c).sortable({start:function(a,
c){b.startIndex=c.item.index()},stop:function(a,c){b.save();b.setCurrentFieldValues();b.startIndex!=c.item.index()&&b.changeMadeToPanel()}});this.initFieldValues();this.initAddNewFieldValuesButton()};e.initAddNewFieldValuesButton=function(){var b=this;$("#organizer_add_a_field_value").on("click",function(){b.save();var a=b.tuix.items[b.current.id],c="t"+b.maxNewCustomFieldValue++,d={id:c,label:"Untitled",ord:_.size(a.lov)+100,is_new_value:!0};a.lov[c]=d;b.setCurrentFieldValues();b.initFieldValues();
b.changeMadeToPanel()})};e.getFloatingPointFields=function(){var b={};for(id in this.tuix.items)g.has(this.tuix.items,id)&&(field=this.tuix.items[id],-1!=["integer","number","floating_point"].indexOf(field.field_validation)&&(b[id]=_.clone(field)));return b};e.getMirroredFields=function(){var b={};for(id in this.tuix.items)g.has(this.tuix.items,id)&&(field=this.tuix.items[id],-1!="checkbox checkboxes date editor radios centralised_radios select centralised_select text textarea url attachment calculated".split(" ").indexOf(field.type)&&
(b[id]=_.clone(field)));return b};e.updateCentralisedRadioValues=function(b,a,c,d){b={mode:"get_centralised_lov",method:b.val()};b.method&&c.is(":visible")&&(b.filter=a.val());this.sendAJAXRequest(b).after(function(a){a=JSON.parse(a);a=h.microTemplate("zenario_organizer_admin_box_builder_radio_values_disabled",a);$("#organizer_form_field_values_"+d.id).html(a)})};e.setCurrentFieldValues=function(){var b=this.current.id,a=this.tuix.items[b],c=this.getOrderedItems(a.lov),d="",d=h.microTemplate("zenario_organizer_admin_box_builder_field_value",
c);$("#field_values_list").html(d);-1<$.inArray(a.type,["checkboxes","radios"])&&("checkboxes"==a.type?d=h.microTemplate("zenario_organizer_admin_box_builder_checkbox_values",c):"radios"==a.type&&(d=h.microTemplate("zenario_organizer_admin_box_builder_radio_values_disabled",c)),$("#organizer_form_field_values_"+b).html(d))};e.initFieldValues=function(){var b=this;$("#field_values_list div.remove").off().on("click",function(){var a=$(this).data("id");b.tuix.items[b.current.id].lov[a]={remove:!0};$("#organizer_field_value_"+
a).remove();$(this).parent().remove();b.changeMadeToPanel()});$("#field_values_list input").off().on("keyup",function(){var a=$(this).data("id");$("#organizer_field_value_"+a+" label").text($(this).val());b.changeMadeToPanel()})};e.getCurrentFieldValues=function(){var b=this.tuix.items[this.current.id];lov=b.lov;$("#field_values_list div.field_value").each(function(a,c){var d=$(this).data("id");lov[d]={id:d,label:$(c).find("input").val(),ord:a+1};b.lov[d]&&b.lov[d].is_new_value&&(lov[d].is_new_value=
!0)});return lov};e.getCurrentFieldDetails=function(){var b={},a=this.tuix.items[this.current.id];$.each($("#organizer_field_details_form").serializeArray(),function(a,d){b[d.name]=d.value});b.default_value_lov!==k?b.default_value=b.default_value_lov:b.default_value_text!==k&&(b.default_value=b.default_value_text);-1==["select","radios","checkboxes"].indexOf(a.type)||a.field_id||(b.lov=this.getCurrentFieldValues());return b};e.save=function(){var b={};if(this.current.id)for(id in b=this.getCurrentFieldDetails(),
this.tuix.items[this.current.id]||(this.tuix.items[this.current.id]={}),b)g.has(b,id)&&(value=b[id],this.tuix.items[this.current.id][id]=value)};e.validate=function(b){var a=this,c=new g.callback,d={mode:"validate_field",id:this.current.id,items:JSON.stringify(this.tuix.items)};!0===b&&(d.removingField=!0);return this.current.id&&!this.tuix.items[this.current.id].remove?(this.sendAJAXRequest(d).after(function(b){b=JSON.parse(b);if(0<b.length){var d=$('<div id="organizer_form_field_error" class="error"></div>');
for(index in b)g.has(b,index)&&(message=b[index],d.append("<p>"+message+"</p>"));$("#organizer_form_field_error").html("");$("#organizer_field_details").prepend(d)}else $("#organizer_form_field_error").remove(),delete a.tuix.items[a.current.id].just_added;c.call(b)}),c):!1};e.saveItemsOrder=function(){var b=this;$(this.formFieldsSelector).each(function(a,c){var d=$(c).data("id");b.tuix.items[d].ord=a+1})}},zenarioO.panelTypes);
