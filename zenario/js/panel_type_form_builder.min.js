zenario.lib(function(u,g,D,z,E,F,G,x,H,y,I,s,J,K,L,M,N,O,B,C,m,A,P,p,Q,R,S,T,n){g=C(A.form_builder=B(A.form_builder_base_class));g.showPanel=function(b,a,d){b.html("").hide();d.html("").show();this.sortOutItems();b=this.loadPanelHTML();a.html(b).show();this.currentTabId||(a=this.getOrderedTabs(),0<a.length&&(this.currentTabId=a[0].id));this.deletedFields=[];this.changeDetected=!1;this.maxNewCustomFieldValue=this.maxNewCustomField=1;this.selectedDetailsTab=this.selectedDetailsTab?this.selectedDetailsTab:
!1;this.selectedFieldId=this.selectedFieldId?this.selectedFieldId:!1;this.selectedTabId=this.selectedTabId?this.selectedTabId:!1;this.loadTabsList(this.currentTabId);this.loadFieldsList(this.currentTabId);this.selectedFieldId?(this.loadFieldDetailsPanel(this.selectedFieldId,!0),this.highlightField(this.selectedFieldId)):this.selectedTabId?this.loadTabDetailsPanel(this.selectedTabId,!0):this.loadNewFieldsPanel(!0);this.changesSaved&&(this.changesSaved=!1,x._t({message_type:"success",message:"Your changes have been saved!"}))};
g.sortOutItems=function(){var b,a,d,c;for(b in this.tuix.items)if(m(this.tuix.items,b))for(d in a=this.tuix.items[b],a.fields)m(a.fields,d)&&(c=a.fields[d],c.invalid_responses&&(c.invalid_responses=_._tA(c.invalid_responses)),c.visible_condition_checkboxes_field_value&&(c.visible_condition_checkboxes_field_value=_._tA(c.visible_condition_checkboxes_field_value)),c.mandatory_condition_checkboxes_field_value&&(c.mandatory_condition_checkboxes_field_value=_._tA(c.mandatory_condition_checkboxes_field_value)))};
g.loadPanelHTML=function(){return this.microTemplate(p+"organizer_form_builder",{form_title:this.tuix.form_title})};g.loadTabDetailsPanel=function(b,a){this.loadFieldDetailsPanel(b,a,!0);var d=this,c,e,f,q;$("#field__name").on("keyup",function(){c=d.getTabLabel($(this).val());$("#organizer_form_tab_"+b+" span").text(c)});$("#organizer_remove_form_tab").on("click",function(a){if(e=d.tuix.items[b])f="<p>Are you sure you want to delete this page?</p>",q=d.getOrderedFields(b),q.length&&(f+="<p>All fields on this page will be moved onto the previous page.</p>"),
x._flBo(f,"Delete","warning",!0,!1,function(){d.deleteTab(b)})})};g.loadFieldDetailsPanel=function(b,a,d){var c;c=d?this.tuix.items[b]:this.tuix.items[this.currentTabId].fields[b];d={mode:"field_details",name:c.name,type:this.getFieldReadableType(c.type),just_added:c.just_added,hide_tab_bar:this.tuix.field_details.hide_tab_bar,is_tab:d};c.dataset_field_id&&(d.type+=", dataset field",c.db_column&&(d.type+=" ("+c.db_column+")"));d=this.microTemplate(p+"organizer_form_builder_left_panel",d);d=$("#organizer_form_builder .form_fields_palette .form_fields_palette_outer").html(d);
a||d.hide().show("drop",{direction:"left"},200);a=this.sortAndLoadTUIXTabs(this.tuix.field_details.tabs,c,this.selectedDetailsTab);d=this.getTUIXTabsHTML(a);$("#organizer_field_details_tabs").html(d);var e=this;$("#organizer_field_details_tabs .tab").on("click",function(){var a=$(this).data("name");a&&a!=e.selectedDetailsTab&&(e.saveCurrentOpenDetails()||e.loadFieldDetailsTab(a,b))});this.loadFieldDetailsTab(this.selectedDetailsTab,b);$("#organizer_field_details_inner span.add_new_field").on("click",
function(){e.saveCurrentOpenDetails()||(e.highlightField(!1),e.loadNewFieldsPanel())});$(n+"field_details_header_content .edit_field_name_button").on("click",function(){$(n+"field_details_header_content .view_mode").hide();$(n+"field_details_header_content .edit_mode").show()});$(n+"field_details_header_content .done_field_name_button").on("click",function(){$(n+"field_details_header_content .edit_mode").hide();$(n+"field_details_header_content .view_mode").show();var a=$(n+'field_details_header_content .edit_mode input[name="name"]').val();
c.name=a;$(n+"field_details_header_content .view_mode h5").text(a)});$("#field__name").on("keyup",function(){e.changeMadeToPanel()});$("input.form_settings").on("click",function(){e.openFormSettings()})};g.openFormSettings=function(){y.open(p+"user_form",{id:s.pi.refiner.id},u,u,function(b,a){var d="";a.details.show_title&&(d=a.details.title);this.tuix.title=d;$("#organizer_form_builder .form_outer .form_header h5").text(d)})};g.loadTabDetailsTab=function(b,a,d){this.loadFieldDetailsTab(b,a,d)};g.loadFieldDetailsTab=
function(b,a,d){this.selectedDetailsTab=b;var c;if(this.selectedFieldId&&this.tuix.items[this.currentTabId].fields[a])c=this.tuix.items[this.currentTabId].fields[a];else if(this.selectedTabId&&this.tuix.items[a]){c=this.tuix.items[a];for(var e=this.getOrderedTabs(),f=0;f<e.length;f++)if(e[f].id==c.id){f==e.length-1&&(c.visibility="visible");break}}var e=this.tuix.field_details.tabs[b].fields,q=this.loadFields("field_details/"+b,e,c),q=this.formatFieldDetails(q,c,"field",b),h=this.sortFields(q,c),
e="";if(!_._isEm(d))for(d=this.sortErrors(d),f=0;f<d.length;f++)e+='<p class="error">'+d[f]+"</p>";e+=this.getTUIXFieldsHTML(h);$("#organizer_field_details").html(e);$("#organizer_field_details_tabs .tab").removeClass("on");$("#field_tab__"+b).addClass("on");_._isEm(d)||$("#organizer_field_details_form").effect({effect:"bounce",duration:125,direction:"right",times:2,distance:5,mode:"effect"});var k=this;if("details"==b)if($("#field__field_label").on("keyup",function(){$("#organizer_form_field_"+a+
" .label").text($(this).val());c.just_added&&$("#field__name").val($(this).val())}),$("#field__note_to_user").on("keyup",function(){var b=$(this).val().trim();$("#organizer_form_field_note_below_"+a+" div.zenario_note_content").text(b);$("#organizer_form_field_note_below_"+a).toggle(""!==b)}),"text"==c.type||"textarea"==c.type)$("#field__placeholder").on("keyup",function(){$("#organizer_form_field_"+a+" :input").prop("placeholder",$(this).val())});else if("section_description"==c.type)$("#field__description").on("keyup",
function(){$("#organizer_form_field_"+a+" .description").text($(this).val())});else{if("calculated"==c.type)$("#edit_field_calculation").on("click",function(){var b={},d;for(d in k.tuix.items)if(m(k.tuix.items,d)){tTab=k.tuix.items[d];for(var e in tTab.fields)if(m(tTab.fields,e)){var f=tTab.fields[e];if("text"==f.type&&-1!=["number","integer","floating_point"].indexOf(f.field_validation)||"calculated"==f.type&&a!=e)b[e]={label:f.name,ord:f.ord}}}d={id:a,title:'Editing the calculation for the field "'+
c.name+'"',calculation_code:JSON.stringify(c.calculation_code)};b={details:{dummy_field:JSON.stringify(b)}};y.open(p+"field_calculation",d,u,b,function(b,d){c.calculation_code=d.details.calculation_code?JSON.parse(d.details.calculation_code):"";k.changeMadeToPanel();k.saveCurrentOpenDetails();k.loadFieldDetailsTab("details",a)})})}else if("advanced"==b)$("#field__css_classes").on("keyup",function(){$("#organizer_form_field_"+a+" .form_field_classes .css").toggle(!!$(this).val()).prop("title",$(this).val())}),
$("#field__div_wrap_class").on("keyup",function(){$("#organizer_form_field_"+a+" .form_field_classes .div").toggle(!!$(this).val()).prop("title",$(this).val())});else if("values"==b)q.values&&!q.values._hidden&&(f=this.getOrderedFieldValues(this.currentTabId,a),e=this.microTemplate(p+"organizer_admin_box_builder_field_value",f),$("#field_values_list").html(e).sortable({containment:"parent",tolerance:"pointer",axis:"y",start:function(a,b){k.startIndex=b.item.index()},stop:function(b,d){k.startIndex!=
d.item.index()&&(k.saveFieldListOfValues(a),k.loadFieldValuesListPreview(a),k.changeMadeToPanel())}}),$("#field_values_list input").on("keyup",function(){var a=$(this).data("id");$("#organizer_field_value_"+a+" label").text($(this).val());k.changeMadeToPanel()}),$("#organizer_add_a_field_value").on("click",function(){k.addFieldValue(c);k.saveItemTUIXTab("field_details",b,c);k.loadFieldDetailsTab(b,a);k.loadFieldValuesListPreview(a);k.changeMadeToPanel()}),$("#field_values_list .delete_icon").on("click",
function(){var d=$(this).data("id");c.lov[d]&&(c._deleted_lov||(c._deleted_lov=[]),c._deleted_lov.push(d),delete c.lov[d]);k.saveItemTUIXTab("field_details",b,c);k.loadFieldDetailsTab(b,a);k.loadFieldValuesListPreview(a);k.changeMadeToPanel()}));else if("translations"==b){e=_._tA(this.tuix.field_details.tabs[b].translatable_fields);d={};for(f=0;f<e.length;f++)d[e[f]]=!0;b="details";var e=this.tuix.field_details.tabs[b].fields,q=this.loadFields("field_details/"+b,e,c),q=this.formatFieldDetails(q,c,
"field",b),h=this.sortFields(q,c),l=[];for(f in h)if(m(h,f)){var g=h[f];d[g.id]&&!g._hidden&&l.push(g.id)}h=this.sortLanguages(this.tuix.languages);d=[];for(f in l)if(m(l,f)&&(g=l[f],q[g]&&!q[g]._hidden)){var n={};c._translations&&c._translations[g]&&(n=c._translations[g]);var r={};e[g]&&e[g].label&&(r.label=e[g].label);c[g]?r.value=c[g]:(r.value="(No text is defined in the default language)",r.disabled=!0);r.phrases=[];for(var t in h)if(m(h,t)){var w=h[t];parseInt(w.translate_phrases)&&r.phrases.push({field_column:g,
language_id:w.id,language_name:w.english_name,phrase:n.phrases&&n.phrases[w.id]&&!r.disabled?n.phrases[w.id]:"",disabled:r.disabled})}d.push(r)}e=this.microTemplate(p+"organizer_form_builder_translatable_field",d);$("#organizer_field_translations").html(e);$("#organizer_field_translations input").on("keyup",function(){k.changeMadeToPanel()})}else if("crm"==b){$("#organizer_crm_button__set_labels").on("click",function(){$("#organizer_field_crm_values input.crm_value_input").each(function(b,d){var c=
$(this).data("id"),e="";k.tuix.items[k.currentTabId].fields[a].lov&&k.tuix.items[k.currentTabId].fields[a].lov[c]&&(e=k.tuix.items[k.currentTabId].fields[a].lov[c].label);$(this).val(e)})});$("#organizer_crm_button__set_values").on("click",function(){$("#organizer_field_crm_values input.crm_value_input").each(function(a,b){var d=$(this).data("id");$(this).val(d)})});t={values:[]};if("checkbox"==c.type){f={unchecked:{label:0,ord:1},checked:{label:1,ord:2}};if(c._crm_data&&c._crm_data.values)for(l in c._crm_data.values)m(c._crm_data.values,
l)&&(e=c._crm_data.values[l],f[l]&&e.crm_value!==u&&(f[l].crm_value=e.crm_value));for(l in f)m(f,l)&&(e=f[l],e.id=l,t.values.push(e));t.values.sort(this.sortByOrd)}else t.values=this.getOrderedFieldValues(this.currentTabId,a);e=this.microTemplate(p+"organizer_form_builder_crm_values",t);$("#organizer_field_crm_values").html(e);$("#organizer_field_crm_values input.crm_value_input").on("keyup",function(){k.changeMadeToPanel()})}};g.calculationAdminBoxAddSomthing=function(b,a){var d=!1;switch(b){case "operation_addition":case "operation_subtraction":case "operation_multiplication":case "operation_division":case "parentheses_open":case "parentheses_close":d=
{type:b};break;case "static_value":""===a||isNaN(+a)||(d={type:b,value:+a},$("#static_value").val(""));break;case "field":d={type:b,value:a},$("#numeric_field").val("")}if(d){var c=[];$("#calculation_code").val()&&(c=JSON.parse($("#calculation_code").val()));c.push(d);$("#calculation_code").val(JSON.stringify(c));this.calculationAdminBoxUpdateDisplay(c)}};g.calculationAdminBoxDelete=function(){var b=[];$("#calculation_code").val()&&(b=JSON.parse($("#calculation_code").val()))&&(b.pop(),$("#calculation_code").val(JSON.stringify(b)));
this.calculationAdminBoxUpdateDisplay(b)};g.calculationAdminBoxUpdateDisplay=function(b){b=this.getCalculationCodeDisplay(b);$(n+"calculation_display").text(b)};g.getCalculationCodeDisplay=function(b){var a="";if(b){var d={},c;for(c in this.tuix.items)if(m(this.tuix.items,c)){var e=this.tuix.items[c],f;for(f in e.fields)m(e.fields,f)&&(d[f]=e.fields[f])}c=!1;for(e=0;e<b.length;e++){c||"parentheses_close"==b[e].type?c&&(c=!1):a+=" ";switch(b[e].type){case "operation_addition":a+="+";break;case "operation_subtraction":a+=
"-";break;case "operation_multiplication":a+="\u00d7";break;case "operation_division":a+="\u00f7";break;case "parentheses_open":a+="(";c=!0;break;case "parentheses_close":a+=")";break;case "static_value":a+=b[e].value;break;case "field":f="",f=d[b[e].value]?d[b[e].value].name:"UNKNOWN FIELD",a+='"'+f+'"'}a=a.trim()}}return a};g.formatFieldDetails=function(b,a,d,c){if("field"==d)if("details"==c)if(a.dataset_field_id&&(b.values_source._disabled=!0,b.values_source_filter._readonly=!0),(d=b.values_source._value)&&
this.tuix.centralised_lists.values[d]&&(d=this.tuix.centralised_lists.values[d],d.info.can_filter?b.values_source_filter.label=d.info.filter_label:b.values_source_filter._hidden=!0),"visible_on_condition"==a.visibility&&a.visible_condition_field_id&&(d=this.getField(a.visible_condition_field_id))&&("checkboxes"==d.type?(b.visible_condition_checkboxes_field_value.values=d.lov,b.visible_condition_field_value._hidden=!0,b.visible_condition_checkboxes_operator._hidden=!1):("checkbox"!=d.type&&"group"!=
d.type&&(b.visible_condition_field_value.values=d.lov,b.visible_condition_field_value.empty_value="-- Any value --"),b.visible_condition_checkboxes_field_value._hidden=!0)),"conditional_mandatory"==a.readonly_or_mandatory&&a.mandatory_condition_field_id&&(d=this.getField(a.mandatory_condition_field_id),"checkboxes"==d.type?(b.mandatory_condition_checkboxes_field_value.values=d.lov,b.mandatory_condition_field_value._hidden=!0,b.mandatory_condition_checkboxes_operator._hidden=!1):(d&&"checkbox"!=d.type&&
"group"!=d.type&&(b.mandatory_condition_field_value.values=d.lov,b.mandatory_condition_field_value.empty_value="-- Any value --"),b.mandatory_condition_checkboxes_field_value._hidden=!0)),"repeat_start"==a.type)b.field_label.label="Section heading:",b.field_label.note_below="This will be the heading at the start of the repeating section.";else if("calculated"==a.type)a.calculation_code&&(Array.isArray(a.calculation_code)||(a.calculation_code=$.map(a.calculation_code,function(a){return a})),b.calculation_code._value=
this.getCalculationCodeDisplay(a.calculation_code));else{if("page_break"==a.type)for(d=this.getOrderedTabs(),c=0;c<d.length;c++)if(d[c].id==a.id){0==c?b.previous_button_text._hidden=!0:c==d.length-1&&(b.next_button_text._hidden=!0,b.visibility._disabled=!0);break}}else"advanced"==c&&"value"==a.default_value_options&&-1!=["radios","centralised_radios","select","centralised_select"].indexOf(a.type)&&(b.default_value_lov.values=a.lov);return b};g.getField=function(b){for(var a in this.tuix.items)if(m(this.tuix.items,
a)){var d=this.tuix.items[a],c;for(c in d.fields)if(m(d.fields,c)){var e=d.fields[c];if(c==b)return e}}return!1};g.getFieldValuesList=function(b){var a=[],d=b.id,c=b.values,e=b._value,f=b._disabled,g=!1;if("object"==typeof c){var h=0,k;for(k in c)if(m(c,k)){var l=c[k],l={label:l.label,value:k,ord:++h};a.push(l)}}else if("centralised_lists"==c){var h=0,v;for(v in this.tuix.centralised_lists.values)m(this.tuix.centralised_lists.values,v)&&(c=this.tuix.centralised_lists.values[v],l={ord:++h,label:c.label,
value:v},a.push(l))}else if("centralised_list_filter_fields"==c||"conditional_fields"==c||"mirror_fields"==c)for(k=this.getOrderedTabs(),g=1<k.length,v=1,h=0;h<k.length;h++)for(var p=this.getOrderedFields(k[h].id),r=!1,t=k[h],n=0;n<p.length;n++)l=p[n],this.canAddFieldToList(c,l)&&(!1===r&&g&&(r=a.push({ord:v++,label:t.name,hasChildren:!0,options:[]})-1),l={ord:v++,label:l.name,value:l.id,parent:r},a.push(l));else if("field_lov"==c&&this.tuix.items[this.currentTabId].fields[this.selectedFieldId]&&
this.tuix.items[this.currentTabId].fields[this.selectedFieldId].lov)for(k in this.tuix.items[this.currentTabId].fields[this.selectedFieldId].lov)m(this.tuix.items[this.currentTabId].fields[this.selectedFieldId].lov,k)&&(l=this.tuix.items[this.currentTabId].fields[this.selectedFieldId].lov[k],l={ord:l.ord,label:l.label,value:k},a.push(l));for(var s in a)m(a,s)&&(l=a[s],"checkboxes"==b.type?e&&-1!=e.indexOf(l.value)&&(l.selected=!0):l.value==e&&(l.selected=!0),f&&(l.disabled=!0),l.name=d,l.path=b.path,
g&&l.parent!==u&&(a[l.parent].options.push(l),delete a[s]));a.sort(this.sortByOrd);return a};g.canAddFieldToList=function(b,a){return"centralised_list_filter_fields"==b?a.id!=this.selectedFieldId&&("centralised_select"==a.type||"text"==a.type&&a.autocomplete&&a.values_source):"conditional_fields"==b?a.id!=this.selectedFieldId&&-1!="checkbox group radios select centralised_radios centralised_select checkboxes".split(" ").indexOf(a.type):"mirror_fields"==b?a.id!=this.selectedFieldId&&-1!=["text","calculated",
"select","centralised_select"].indexOf(a.type):!1};g.loadNewFieldsPanel=function(b){this.selectedFieldId=this.selectedTabId=!1;var a={mode:"new_fields",datasetTabs:this.getOrderedDatasetTabsAndFields()},a=this.microTemplate(p+"organizer_form_builder_left_panel",a),a=$("#organizer_form_builder .form_fields_palette .form_fields_palette_outer").html(a);b||a.hide().show("drop",{direction:"right"},200);var d=this;$("#organizer_field_type_list div.field_type, #organizer_centralised_field_type_list div.field_type, #organizer_linked_field_type_list div.dataset_field").draggable({connectToSortable:"#organizer_form_fields .form_section",
appendTo:"#organizer_form_builder",helper:"clone"});$("input.form_settings").on("click",function(){d.openFormSettings()})};g.loadTabsList=function(b){for(var a in this.tuix.items)if(m(this.tuix.items,a)){var d=this.tuix.items[a];b==a?d._selected=!0:delete d._selected}b=this.getOrderedTabs();1>=b.length&&(b=!1);b=this.microTemplate(p+"organizer_form_builder_tabs",{tabs:b});$("#organizer_form_tabs").html(b);var c=this;$("#organizer_form_tabs .tab").on("click",function(){var a=$(this).data("id");c.tuix.items[a]&&
c.clickTab(a)});$("#organizer_add_new_tab").on("click",function(){c.saveCurrentOpenDetails()||(c.addNewTab(),c.changeMadeToPanel())});$("#organizer_form_tabs").sortable({containment:"parent",tolerance:"pointer",items:"div.sort",start:function(a,b){c.startIndex=b.item.index()},stop:function(a,b){c.startIndex!=b.item.index()&&($("#organizer_form_tabs .tab.sort").each(function(a){var b=$(this).data("id");c.tuix.items[b].ord=a+1}),c.changeMadeToPanel(),c.selectedTabId&&(c.saveCurrentOpenDetails(),c.loadTabDetailsPanel(c.selectedTabId,
!0)))}});$("#organizer_form_tabs .tab").droppable({accept:"div.form_field:not(.repeat_end)",greedy:!0,hoverClass:"ui-state-hover",tolerance:"pointer",drop:function(a,b){var d=$(this).data("id"),g=$(b.draggable).data("id");c.moveFieldToTab(c.currentTabId,d,g);g==c.selectedFieldId&&c.loadNewFieldsPanel();c.loadFieldsList(c.currentTabId)}})};g.moveFieldToTab=function(b,a,d,c){if(b!=a&&this.tuix.items[a]&&this.tuix.items[b]&&this.tuix.items[b].fields[d]&&"repeat_end"!=this.tuix.items[b].fields[d].type){var e=
1,f=this.getOrderedFields(a);f.length&&(e=c?f[0].ord-1:f[f.length-1].ord+1);"repeat_start"==this.tuix.items[b].fields[d].type&&(c=this.getMatchingRepeatEnd(d),this.tuix.items[a].fields[c]=this.tuix.items[b].fields[c],this.tuix.items[a].fields[c].ord=e+0.001,delete this.tuix.items[b].fields[c]);this.tuix.items[a].fields[d]=this.tuix.items[b].fields[d];this.tuix.items[a].fields[d].ord=e;delete this.tuix.items[b].fields[d];this.changeMadeToPanel()}};g.addNewTab=function(){var b=1,a=this.getOrderedTabs();
a.length&&(b=a[a.length-1].ord+1);this.addNewField("page_break",b)};g.clickTab=function(b,a){this.selectedTabId==b||this.saveCurrentOpenDetails()||(this.currentTabId==b?(this.selectedFieldId=!1,this.selectedTabId=b,this.selectedDetailsTab=!1,this.loadTabDetailsPanel(b)):this.clickTab2(b,a))};g.clickTab2=function(b,a){this.currentTabId=b;if(a)this.selectedTabId=b,this.loadTabDetailsPanel(b);else{var d=!1;this.selectedFieldId||this.selectedTabId||(d=!0);this.loadNewFieldsPanel(d)}this.selectedFieldId=
!1;this.loadTabsList(b);this.loadFieldsList(b)};g.getOrderedTabs=function(){var b=[],a;for(a in this.tuix.items)m(this.tuix.items,a)&&b.push(this.tuix.items[a]);b.sort(this.sortByOrd);return b};g.fieldDetailsChanged=function(b,a){b=b.split("/");var d=b[0],c=b[1],e,f,g,h;c&&d&&this.tuix[d]&&this.tuix[d].tabs[c]&&this.tuix[d].tabs[c].fields[a]&&(this.changeMadeToPanel(),e=this.tuix[d].tabs[c].fields[a],e.format_onchange&&"field_details"==d&&(h=this.selectedFieldId?this.tuix.items[this.currentTabId].fields[this.selectedFieldId]:
this.tuix.items[this.selectedTabId],this.saveItemTUIXTab(d,this.selectedDetailsTab,h),"details"==c&&"field_validation"==a&&("email"==h.field_validation?h.field_validation_error_message="The email address you have entered is not valid, please enter a valid email address.":"URL"==h.field_validation?h.field_validation_error_message="Please enter a valid URL.":"number"==h.field_validation?h.field_validation_error_message="Please enter a valid number.":"integer"==h.field_validation?h.field_validation_error_message=
"Please enter a valid integer.":"floating_point"==h.field_validation&&(h.field_validation_error_message="Please enter a valid floating point number.")),this.loadFieldDetailsTab(this.selectedDetailsTab,h.id),"details"==c&&("visibility"==a?(d=$("#field__visibility").val(),"hidden"==d?f="Hidden":"visible_on_condition"==d&&(f="Visible on condition"),$("#organizer_form_field_"+this.selectedFieldId+" .form_field_classes .not_visible").toggle("visible"!=d).prop("title",f)):"readonly_or_mandatory"==a?(d=
$("#field__readonly_or_mandatory").val(),"mandatory"==d?f="Mandatory":"conditional_mandatory"==d&&(f="Mandatory on condition"),$("#organizer_form_field_"+this.selectedFieldId+" .form_field_classes .mandatory").toggle("mandatory"==d||"conditional_mandatory"==d).prop("title",f)):"field_validation"==a?(d=$("#field__field_validation").val(),$("#organizer_form_field_"+this.selectedFieldId+" .form_field_classes .validation").toggle("none"!=d)):"values_source"==a&&((f=$("#field__values_source").val())?(f=
{mode:"get_centralised_lov",method:f,filter:$("#field__values_source_filter").val()},g=this,this.sendAJAXRequest(f).after(function(a){a=JSON.parse(a);h.lov=a;g.loadFieldValuesListPreview(g.selectedFieldId)})):(h.lov={},this.loadFieldValuesListPreview(this.selectedFieldId))))))};g.loadFieldValuesListPreview=function(b){var a=this.currentTabId;if(this.tuix.items[a].fields[b]){var d=this.tuix.items[a].fields[b],a=this.getOrderedFieldValues(a,b,!0),c=!1;"select"==d.type||"centralised_select"==d.type?
(c=this.microTemplate(p+"organizer_admin_box_builder_select_values",a),$("#organizer_form_field_"+b+" select").html(c)):"radios"==d.type||"centralised_radios"==d.type?(c=this.microTemplate(p+"organizer_admin_box_builder_radio_values_preview",a),$("#organizer_form_field_values_"+b).html(c)):"checkboxes"==d.type&&(c=this.microTemplate(p+"organizer_admin_box_builder_checkbox_values_preview",a),$("#organizer_form_field_values_"+b).html(c))}};g.loadFieldsList=function(b){var a={fields:this.getOrderedFields(b,
!0)},a=this.microTemplate(p+"organizer_form_builder_section",a);$("#organizer_form_fields").html(a);var d=this;$("#organizer_form_fields div.form_field").on("click",function(){var a=$(this).data("id");d.tuix.items[d.currentTabId].fields[a]&&d.clickField(a)});var c;$("#organizer_form_fields div.form_field").hover(function(){var a=this;c||(c=setTimeout(function(){c=null;var b=$(a).data("id");$("#organizer_form_field_"+b+" .form_field_classes").show()},200))},function(){if(c)clearTimeout(c),c=null;else{var a=
$(this).data("id");a!=d.selectedFieldId&&$("#organizer_form_field_"+a+" .form_field_classes").hide()}});$("#organizer_form_fields").tooltip();$("#organizer_form_fields .form_section").sortable({items:"div.form_field",tolerance:"pointer",placeholder:"preview",receive:function(a,c){$(this).find("div.field_type, div.dataset_field").each(function(){var a=$(this).data("type"),c=$(this).data("id"),e=$(this).data("tab_name"),f=0.1,g=$(this).prev().data("id");g&&d.tuix.items[b].fields[g]?f=d.tuix.items[b].fields[g].ord+
0.1:(g=$(this).next().data("id"))&&d.tuix.items[b].fields[g]&&(f=d.tuix.items[b].fields[g].ord-0.1);d.addNewField(a,f,c,e);d.updateFieldOrds()})},start:function(a,b){d.startIndex=b.item.index()},stop:function(a,b){d.startIndex!=b.item.index()&&d.updateFieldOrds()}});$("#organizer_form_fields .delete_icon").on("click",function(a){a.stopPropagation();var b=$(this).data("id");if(d.tuix.items[d.currentTabId].fields[b]&&!d.saveCurrentOpenDetails(!0)){var c=d.tuix.items[d.currentTabId].fields[b];a={};for(var g in d.tuix.items)if(m(d.tuix.items,
g)){var k=d.tuix.items[g],l;for(l in k.fields)if(m(k.fields,l)){var n=k.fields[l];n.type==c.type&&l!=b&&(a[g+"__"+l]=n.name)}}g={id:b,field_name:c.name,field_type:c.type,field_english_type:d.getFieldReadableType(c.type)};a={details:{dummy_field:JSON.stringify(a)}};y.open(p+"delete_form_field",g,u,a,function(a,c){if("delete_field_but_migrate_data"==c.details.delete_field_options&&c.details.migration_field){var e=c.details.migration_field.split("__");2==e.length&&d.tuix.items[e[0]]&&d.tuix.items[e[0]].fields[e[1]]&&
(d.tuix.items[e[0]].fields[e[1]]._migrate_responses_from=b)}d.deleteField(b)})}})};g.updateFieldOrds=function(){var b=this;$("#organizer_form_fields div.form_field").each(function(a){var d=$(this).data("id");b.tuix.items[b.currentTabId].fields[d].ord=a+1});this.changeMadeToPanel()};g.deleteTab=function(b){var a=this.getOrderedTabs(),d,c;if(2<=a.length)for(d=this.getOrderedFields(b),c=0;c<a.length;c++)if(a[c].id==b){if(a[c-1])for(c=a[c-1].id,a=0;a<d.length;a++)this.moveFieldToTab(b,c,d[a].id);else for(c=
a[c+1].id,a=d.length-1;0<=a;a--)this.moveFieldToTab(b,c,d[a].id,!0);this.deletedFields.push(b);delete this.tuix.items[b];this.clickTab(c);this.changeMadeToPanel();break}};g.deleteField=function(b){tabId=this.currentTabId;if(this.tuix.items[tabId].fields[b]){this.changeMadeToPanel();this.deletedFields.push(b);var a=this.tuix.items[tabId].fields[b];if("repeat_start"==a.type){var d=this.getMatchingRepeatEnd(b);d&&(this.deletedFields.push(d),delete this.tuix.items[tabId].fields[d])}for(var d=this.getOrderedFields(tabId),
c=!1,e=!1,f=0;f<d.length;f++)if(d[f].id==a.id&&(c=f),!1!==c)if(0<c&&"repeat_end"!=d[c-1].type){e=d[c-1].id;break}else if(b!=d[f].id){e=d[f].id;break}delete this.tuix.items[tabId].fields[b];this.loadFieldsList(tabId);e?this.clickField(e):this.loadNewFieldsPanel()}};g.getMatchingRepeatEnd=function(b){var a=!1,d=!1,c=this.getOrderedFields(this.currentTabId),e;for(e=0;e<c.length;e++)if("repeat_end"==c[e].type&&(a=c[e].id),c[e].id==b)d=e;else if(!1!==d&&"repeat_end"==c[e].type){a=c[e].id;break}return a};
g.addNewField=function(b,a,d,c){var e="t"+this.maxNewCustomField++,f=!1;if(d&&this.tuix.dataset_fields[c]&&this.tuix.dataset_fields[c].fields[d])c=this.tuix.dataset_fields[c].fields[d],f={type:c.type,name:c.label,field_label:c.label,dataset_field_id:d,values_source:c.values_source,values_source_filter:c.values_source_filter,db_column:c.db_column},c.lov&&(f.lov=c.lov);else if(b)if(f={type:b,field_label:"Untitled",name:"Untitled "+this.getFieldReadableType(b).toLowerCase()},"checkboxes"==b||"radios"==
b||"select"==b)for(f.lov={},d=1;3>=d;d++)this.addFieldValue(f,"Option "+d);else"repeat_start"==b&&this.addNewField("repeat_end",a+0.01);for(var g in this.tuix.field_details.tabs)if(m(this.tuix.field_details.tabs,g)&&(tab=this.tuix.field_details.tabs[g],tab.fields))for(var h in tab.fields)m(tab.fields,h)&&(d=tab.fields[h],d.value!==u&&f[h]===u&&(f[h]=d.value));f&&(f.id=e,f.ord=a,f.is_new_field=!0,f.just_added=!0,"page_break"==b?(b=this.getOrderedTabs(),f.name="Page "+(b.length+1),f.fields={},this.tuix.items[e]=
f,this.clickTab(e,!0)):(this.tuix.items[this.currentTabId].fields[e]=f,this.loadFieldsList(this.currentTabId),this.clickField(e)))};g.clickField=function(b){this.selectedFieldId!=b&&this.tuix.items[this.currentTabId]&&this.tuix.items[this.currentTabId].fields[b]&&"repeat_end"!=this.tuix.items[this.currentTabId].fields[b].type&&!this.saveCurrentOpenDetails()&&(this.highlightField(b),this.selectedFieldId=b,this.selectedDetailsTab=this.selectedTabId=!1,this.loadFieldDetailsPanel(b))};g.saveCurrentOpenDetails=
function(b){var a=!1;this.selectedFieldId&&this.tuix.items[this.currentTabId]&&this.tuix.items[this.currentTabId].fields[this.selectedFieldId]?(a=$("#field__name"),a.length&&(this.tuix.items[this.currentTabId].fields[this.selectedFieldId].name=a.val()),b?a=this.getDeleteFieldErrors(this.selectedFieldId):(b=this.tuix.items[this.currentTabId].fields[this.selectedFieldId],a=this.saveItemTUIXTab("field_details",this.selectedDetailsTab,b)),_._isEm(a)||this.loadFieldDetailsTab(this.selectedDetailsTab,this.selectedFieldId,
a)):this.selectedTabId&&this.tuix.items[this.selectedTabId]&&(a=$("#field__name"),a.length&&(this.tuix.items[this.selectedTabId].name=a.val()),b=this.tuix.items[this.selectedTabId],a=this.saveItemTUIXTab("field_details",this.selectedDetailsTab,b),_._isEm(a)||this.loadTabDetailsTab(this.selectedDetailsTab,this.selectedTabId,a));return!_._isEm(a)};g.displayGlobalErrors=function(){for(var b={},a=this.getOrderedFields(),d=!1,c=0;c<a.length;c++){var e=a[c];d&&-1!=["page_break","repeat_start","calculated",
"restatement","file_picker"].indexOf(e.type)&&(b[e.id]='Field type "'+this.getFieldReadableType(e.type).toLowerCase()+'" is not allowed in repeat blocks.');if("repeat_start"==e.type)d=!0;else if("repeat_end"==e.type){if(!d){b[e.id]="You cannot have a Repeat End before a Repeat Start.";break}d=!1}}a=$("#organizer_fields_error");a.html("");for(c in b)m(b,c)&&a.append('<p class="error">'+b[c]+"</p>");a.show().delay(3E3).fadeOut(function(){$(this).html("")});return!_._isEm(b)};g.getDeleteFieldErrors=
function(b){var a={},d;for(d in this.tuix.items[this.currentTabId].fields)if(m(this.tuix.items[this.currentTabId].fields,d)){var c=this.tuix.items[this.currentTabId].fields[d];if(b!=d){var e=!1;if("calculated"==c.type&&c.calculation_code)for(var f in c.calculation_code)if(m(c.calculation_code,f)){var g=c.calculation_code[f];if("field"==g.type&&g.value==b){e=!0;break}}if(c.visibility&&"visible_on_condition"==c.visibility&&c.visible_condition_field_id==b||c.readonly_or_mandatory&&"conditional_mandatory"==
c.readonly_or_mandatory&&c.mandatory_condition_field_id==b||e)a[d]='Unable to delete field because the field "'+c.name+'" depends on it.'}}return a};g.validateFieldDetails=function(b,a,d,c,e){var f,g,h;if("field_details"==d)if(a.name||(e.name="Please enter a name for this form field."),"details"==c){if("checkbox"==a.type||"group"==a.type)a.field_label||(e.field_label="Please enter a label for this checkbox.");else if("repeat_start"==a.type){if(!a.min_rows)e.min_rows="Please enter the minimum rows.";
else if(+a.min_rows!=a.min_rows)e.min_rows="Please a valid number for mininum rows.";else if(1>a.min_rows||10<a.min_rows)e.min_rows="Mininum rows must be between 1 and 10.";if(!a.max_rows)e.max_rows="Please enter the maximum rows.";else if(+a.max_rows!=a.max_rows)e.max_rows="Please a valid number for maximum rows.";else if(1>a.max_rows||20<a.max_rows)e.max_rows="Maximum rows must be between 1 and 20.";!e.min_rows&&!e.max_rows&&+a.min_rows>+a.max_rows&&(e.min_rows="Minimum rows cannot be greater than maximum rows.")}else"restatement"==
a.type?a.restatement_field||(e.restatement_field="Please select the field to mirror."):"centralised_radios"!=a.type&&"centralised_select"!=a.type||a.values_source||(e.values_source="Please select a values source.");a.visibility&&"visible_on_condition"==a.visibility&&(a.visible_condition_field_id?a.visible_condition_field_value||(f=this.getField(a.visible_condition_field_id))&&-1!=["checkbox","group"].indexOf(f.type)&&(e.visible_condition_field_value="Please select a visible on condition form field value."):
e.visible_condition_field_id="Please select a visible on conditional form field.");a.readonly_or_mandatory&&(("mandatory"!=a.readonly_or_mandatory&&"conditional_mandatory"!=a.readonly_or_mandatory||a.required_error_message||(e.required_error_message="Please enter an error message when this field is incomplete."),"mandatory"==a.readonly_or_mandatory)?"hidden"==a.visibility?e.readonly_or_mandatory="A field cannot be mandatory while hidden.":"visible_on_condition"==a.visibility&&(e.readonly_or_mandatory=
"This field is always mandatory but is conditionally visible. You must change this field to be either visible all the time or conditionally mandatory with the same condition as it's visibility."):"conditional_mandatory"==a.readonly_or_mandatory&&(a.mandatory_condition_field_id?a.mandatory_condition_field_value||(f=this.getField(a.mandatory_condition_field_id))&&-1!=["checkbox","group"].indexOf(f.type)&&(e.mandatory_condition_field_value="Please select a mandatory on condition form field value."):
e.mandatory_condition_field_id="Please select a mandatory on condition form field.","hidden"==a.visibility?e.visibility="A field cannot be mandatory while hidden.":"visible_on_condition"==a.visibility&&"conditional_mandatory"==a.readonly_or_mandatory&&a.visible_condition_field_id&&a.mandatory_condition_field_id&&(a.visible_condition_field_id!=a.mandatory_condition_field_id||"visible_if"==a.visible_condition_field_type&&"mandatory_if_not"==a.mandatory_condition_field_type||"visible_if_not"==a.visible_condition_field_type&&
"mandatory_if"==a.mandatory_condition_field_type||(f=this.getField(a.mandatory_condition_field_id))&&"checkboxes"!=f.type&&a.visible_condition_field_value!=a.mandatory_condition_field_value||"checkboxes"==f.type&&(a.visible_condition_checkboxes_operator!=a.mandatory_condition_checkboxes_operator||!_._isEq(a.visible_condition_checkboxes_field_value,a.mandatory_condition_checkboxes_field_value)))&&(e.visibility="A field cannot be mandatory while hidden. If this field is both mandatory and visible on a condition, both fields and values must be the same.")));
a.field_validation&&"none"!=a.field_validation&&!a.field_validation_error_message&&(e.field_validation_error_message="Please enter a validation error message for this field.");for(g in this.tuix.items)if(m(this.tuix.items,g))for(h in b=this.tuix.items[g],b.fields)if(m(b.fields,h)&&(d=b.fields[h],"calculated"==d.type&&d.calculation_code&&a.field_validation&&-1==["number","integer","floating_point"].indexOf(a.field_validation)))for(c=0;c<d.calculation_code.length;c++)if("field"==d.calculation_code[c].type&&
d.calculation_code[c].value==a.id){e.field_validation='The field "'+d.name+'" requires this field to be numeric. You must first remove this from that field.';break}}else if("advanced"==c){a.default_value_options&&("value"==a.default_value_options?a.default_value_lov||a.default_value_text||(e.default_value="Please enter a default value."):"method"==a.default_value_options&&(a.default_value_class_name||(e.default_value_class_name="Please enter a class name."),a.default_value_method_name||(e.default_value_method_name=
"Please enter the name of a static method.")));if(a.custom_code_name)for(g in this.tuix.items)if(m(this.tuix.items,g))for(h in b=this.tuix.items[g],b.fields)m(b.fields,h)&&(d=b.fields[h],h!=a.id&&a.custom_code_name==d.custom_code_name&&(e.custom_code_name="Another field already has that code name on this form."));a.autocomplete&&("method"==a.autocomplete_options?(a.autocomplete_class_name||(e.autocomplete_class_name="Please enter a class name."),a.autocomplete_method_name||(e.autocomplete_method_name=
"Please enter the name of a static method.")):"centralised_list"!=a.autocomplete_options||a.values_source||(e.values_source="Please select a value source for the autocomplete lists."));a.invalid_responses&&a.invalid_responses.length&&!a.invalid_field_value_error_message&&(e.invalid_field_value_error_message="Please enter an error message when an invalid response is chosen.");"textarea"==a.type&&a.word_limit&&(+a.word_limit!=a.word_limit?e.word_limit="Please a valid number for word count.":1>a.word_limit&&
(e.word_limit="Word count must be greater than 0."))}else"crm"==c&&a.send_to_crm&&!a.field_crm_name&&(e.field_crm_name="Please enter a CRM field name.")};g.highlightField=function(b){$("#organizer_form_fields .form_field .form_field_classes").hide();$("#organizer_form_fields .form_field .form_field_inline_buttons").hide();$("#organizer_form_fields .form_field").removeClass("selected");b&&($("#organizer_form_field_"+b).addClass("selected"),$("#organizer_form_field_"+b+" .form_field_classes").show(),
$("#organizer_form_field_"+b+" .form_field_inline_buttons").show());this.selectedFieldId&&this.tuix.items[this.currentTabId].fields[this.selectedFieldId]&&delete this.tuix.items[this.currentTabId].fields[this.selectedFieldId].just_added};g.getFieldReadableType=function(b){switch(b){case "checkbox":return"Checkbox";case "checkboxes":return"Checkboxes";case "date":return"Date";case "editor":return"Editor";case "radios":return"Radios";case "centralised_radios":return"Centralised radios";case "select":return"Select";
case "centralised_select":return"Centralised select";case "text":return"Text";case "textarea":return"Textarea";case "url":return"URL";case "attachment":return"Attachment";case "page_break":return"Page";case "section_description":return"Subheading";case "calculated":return"Calculated";case "restatement":return"Mirror";case "group":return"Group";case "file_picker":return"File picker";case "repeat_start":return"Start of repeating section";case "repeat_end":return"End of repeating section";default:return"Unknown"}};
g.getOrderedFields=function(b,a){var d=[],c,e;if(this.tuix.items[b]&&this.tuix.items[b].fields)for(c in this.tuix.items[b].fields)m(this.tuix.items[b].fields,c)&&(e=this.tuix.items[b].fields[c],e=_._cl(e),a&&(e.lov=this.getOrderedFieldValues(b,c,!0)),d.push(e));d.sort(this.sortByOrd);return d};g.getOrderedFieldValues=function(b,a,d){var c=[],e,f;if(this.tuix.items[b]&&this.tuix.items[b].fields&&this.tuix.items[b].fields[a]&&this.tuix.items[b].fields[a].lov){for(e in this.tuix.items[b].fields[a].lov)m(this.tuix.items[b].fields[a].lov,
e)&&(f=this.tuix.items[b].fields[a].lov[e],c.push(f));b=this.tuix.items[b].fields[a].type;!d||"select"!=b&&"centralised_select"!=b||c.push({id:"empty_value",label:"-- Select --",ord:-1})}c.sort(this.sortByOrd);return c};g.sortErrors=function(b){var a=[],d;for(d in b)m(b,d)&&a.push(b[d]);return a};g.sortLanguages=function(b){var a=[],d;for(d in b)m(b,d)&&a.push(b[d]);return a};g.getOrderedDatasetTabsAndFields=function(){var b=[],a={},d;for(d in this.tuix.items)if(m(this.tuix.items,d)){var c=this.tuix.items[d],
e;for(e in c.fields)if(m(c.fields,e)){var f=c.fields[e];f.dataset_field_id&&(a[f.dataset_field_id]=!0)}}for(var g in this.tuix.dataset_fields)if(m(this.tuix.dataset_fields,g)){d=this.tuix.dataset_fields[g];c=_._cl(d);c.fields=[];if(d.fields){for(var h in d.fields)m(d.fields,h)&&(e=d.fields[h],e.readableType=this.getFieldReadableType(e.type),a[h]||c.fields.push(e));c.fields.sort(this.sortByOrd)}b.push(c)}b.sort(this.sortByOrd);return b};g.changeMadeToPanel=function(){this.changeDetected||(this.changeDetected=
!0,z.onbeforeunload=function(){return"You are currently editing this form. If you leave now you will lose any unsaved changes."},s._dI("Please either save your changes, or click Reset to discard them, before exiting the form editor."),s._sB())};g.saveChanges=function(){var b=this,a={mode:"save",data:JSON.stringify(this.tuix.items),deletedFields:JSON.stringify(this.deletedFields),currentTabId:this.currentTabId};this.selectedTabId&&(a.selectedTabId=this.selectedTabId);this.selectedFieldId&&(a.selectedFieldId=
this.selectedFieldId);this.sendAJAXRequest(a).after(function(a){if(a){a=JSON.parse(a);if(a.errors){for(var c="",e=0;e<a.errors.length;e++)c+=a.errors[e]+"<br>";c&&x._flBo(c)}b.currentTabId=a.currentTabId;b.selectedTabId=a.selectedTabId;b.selectedFieldId=a.selectedFieldId}x._nDS();z.onbeforeunload=!1;s._eI();b.changeDetected=!1;b.changesSaved=!0;s._r()})}},zenarioO.panelTypes);
