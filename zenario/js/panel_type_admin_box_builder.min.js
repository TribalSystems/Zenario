zenario.lib(function(g,w,x,q,y,z,A,m,t,B,C,p,D,r,E,F,G,H,I,u,v,n,s){g=v(s.admin_box_builder=u(s.form_builder_base_class));g.showPanel=function(b,a,c){b.html("").hide();c.html("").show();b=this.getMainPanelHTML();a.html(b).show();this.currentPageId=this.currentPageId?this.currentPageId:!1;this.editingThing=this.editingThing?this.editingThing:!1;this.editingThingId=this.editingThingId?this.editingThingId:!1;this.editingThingTUIXTabId=this.editingThingTUIXTabId?this.editingThingTUIXTabId:!1;this.deletedPages=
[];this.deletedFields=[];this.deletedValues=[];this.pagesReordered=this.changeMadeOnPanel=!1;this.newItemCount=0;this.fixTUIXData();this.loadPagesList();this.loadFieldsList(this.currentPageId);"field"==this.editingThing?this.openFieldEdit(this.editingThingId,this.editingThingTUIXTabId,!0):"page"==this.editingThing?this.openPageEdit(this.editingThingId,this.editingThingTUIXTabId,!0):this.loadNewFieldsPanel(!0);this.changesSaved&&(this.changesSaved=!1,m._t({message_type:"success",message:"Your changes have been saved!"}))};
g.fixTUIXData=function(){for(var b in this.tuix.dataset_fields_in_forms)this.tuix.dataset_fields_in_forms[b]=t._tTA(this.tuix.dataset_fields_in_forms[b])};g.getMainPanelHTML=function(){return this.microTemplate("zenario_organizer_admin_box_builder",{dataset_label:this.tuix.dataset.label})};g.openEdit=function(b,a,c,d){var e=this,f=e.getItem(b,a),h=e.getTUIXModeForItemType(b),h=e.tuix[h],k={hide_tab_bar:h.hide_tab_bar,is_system_field:f.is_system_field};"page"==b?(k.mode="edit_page",k.label=e.formatPageLabel(f.label)):
"field"==b&&(k.mode="edit_field",k.label=f.label,k.record_count="("+(f.record_count?f.record_count:0)+" record"+(1==f.record_count?"":"s")+")",k.type=e.getFieldReadableType(f.type),f.is_system_field&&(k.type+=", system field"));var g=e.microTemplate("zenario_organizer_admin_box_builder_left_panel",k),k=$("#organizer_admin_form_builder .form_fields_palette .form_fields_palette_outer").html(g),f=e.getTUIXTabs(h,c,f);c=e.editingThingTUIXTabId;g=e.getTUIXTabsHTML(f);$("#organizer_field_details_tabs").html(g);
e.openItemTUIXTab(b,a,c);d||k.hide().show("drop",{direction:"left"},200);$("#organizer_field_details_tabs .tab").on("click",function(){var d=$(this).data("id");d&&d!=c&&e.saveCurrentOpenDetails()&&e.openEdit(b,a,d,!0)});$("#organizer_field_details_inner span.add_new_field").on("click",function(){e.saveCurrentOpenDetails()&&(e.loadNewFieldsPanel(),e.loadFieldsList(e.currentPageId))})};g.addTUIXTabEvents=function(b,a,c){var d=this,e=d.getItem(b,a);if("page"==b)$("#organizer_remove_form_tab").on("click",
function(b){if(!e.is_system_field){var c=!1;b=0;for(var f=d.getOrderedFields(a),g=0;g<f.length;g++)f[g].is_protected&&(c||(c=f[g]),b++);b?(c='<p>This tab has the protected field "'+c.label+'"',b--,0<b&&(c+=" and "+b+" other protected field"+(1==b?"":"s")),m._flBo(c+" on it and cannot be deleted.</p>",!0,"warning",!0)):(c="<p>Are you sure you want to delete this tab?</p>",0<f.length&&(c+="<p>All fields on this tab will also be deleted.</p>"),m._flBo(c,"Delete tab","warning",!0,!1,function(){d.deletePage(a);
d.changeMadeToPanel()}))}}),$("#field__label").on("keyup",function(){var b=d.formatPageLabel($(this).val());$("#zenario_field_details_header_content .field_name h5, #organizer_form_tab_"+a+" span").text(b)});else if("field"==b)if("details"==c)$("#field__label").on("keyup",function(){$("#organizer_form_field_"+a+" .label, #zenario_field_details_header_content .field_name h5").text($(this).val());if(e._just_added){var b=$(this).val().toLowerCase().r(/[\s-]+/g,"_").r(/[^a-z_0-9]/g,"");$("#field__db_column").val(b)}}),
$("#field__note_below").on("keyup",function(){var b=$(this).val().trim();$("#organizer_form_field_note_below_"+a+" div.zenario_note_content").text(b);$("#organizer_form_field_note_below_"+a).toggle(""!==b)}),$("#field__side_note").on("keyup",function(){var b=$(this).val().trim();$("#organizer_form_field_side_note_"+a+" div.zenario_note_content").text(b);$("#organizer_form_field_side_note_"+a).toggle(""!==b)});else if("values"==c){var f=d.tuix[d.getTUIXModeForItemType(b)];$("#field_values_list").sortable({containment:"parent",
tolerance:"pointer",axis:"y",start:function(a,b){d.startIndex=b.item.index()},stop:function(b,c){d.startIndex!=c.item.index()&&(d.saveFieldListOfValues(a),d.loadFieldValuesListPreview(a),d.changeMadeToPanel())}});$("#field_values_list input").on("keyup",function(){var a=$(this).data("id");$("#organizer_field_value_"+a+" label").text($(this).val());d.changeMadeToPanel()});$("#organizer_add_a_field_value").on("click",function(){d.addFieldValue(e);d.saveTUIXTab(f,c,e);d.openItemTUIXTab(b,a,c);d.loadFieldValuesListPreview(a);
d.changeMadeToPanel()});$("#field_values_list .delete_icon").on("click",function(){var h=$(this).data("id");e.lov[h]&&(d.deletedValues.push(h),delete e.lov[h]);d.saveTUIXTab(f,c,e);d.openItemTUIXTab(b,a,c);d.loadFieldValuesListPreview(a);d.changeMadeToPanel()})}};g.loadNewFieldsPanel=function(b){this.editingThing=!1;var a=this.microTemplate("zenario_organizer_admin_box_builder_left_panel",{mode:"new_fields",use_groups_field:this.tuix.use_groups_field}),a=$("#organizer_admin_form_builder .form_fields_palette .form_fields_palette_outer").html(a);
b||a.hide().show("drop",{direction:"right"},200);$("#organizer_field_type_list_outer div.field_type_list div.field_type").draggable({connectToSortable:"#organizer_form_fields .form_section",appendTo:"#organizer_admin_form_builder",helper:"clone"})};g.getTUIXModeForItemType=function(b){return"page"==b?"dataset_page_details":"field"==b?"dataset_field_details":!1};g.getFieldReadableType=function(b,a,c){switch(b){case "group":return"Group";case "checkbox":return"Checkbox";case "consent":return"Consent";
case "checkboxes":return"Checkbox group";case "date":return"Date";case "editor":return"Editor";case "radios":return"Radios";case "centralised_radios":return"Centralised radios";case "select":return"Select";case "centralised_select":return"Centralised select";case "text":return"Text";case "textarea":return"Textarea";case "url":return"URL";case "other_system_field":if(c)switch(a){case "html_snippet":return"HTML snippet";case "pick_items":return"Item picker";case "upload":return"Upload";case "toggle":return"Toggle";
case "grouping":return"Grouping";case "submit":return"Submit";case "hidden":return"Hidden";default:return this.getFieldReadableType(a)}else return"Other system field";case "dataset_select":return"Dataset select";case "dataset_picker":return"Dataset picker";case "file_picker":return"File picker";case "repeat_start":return"Start of repeating section";case "repeat_end":return"End of repeating section";default:return"Unknown"}};g.saveCurrentOpenDetails=function(b){var a=[],c=this.editingThing,d=this.editingThingId;
if(c&&d&&this.editingThingTUIXTabId){var e=this.getTUIXModeForItemType(c),f=this.tuix[e],h=this.getItem(c,d);if(h){this.saveTUIXTab(f,this.editingThingTUIXTabId,h);if(b)a=this.getDeleteErrors(c,d);else{b=this.getTUIXTags(e,h,c);this.validateTUIX(c,h,this.editingThingTUIXTabId,b);for(var g in b.tabs)if(n(b.tabs,g)){var h=b.tabs[g],l;for(l in h.fields)n(h.fields,l)&&(tuixField=h.fields[l],tuixField.error&&a.push(tuixField.error))}}a.length&&this.openItemTUIXTab(c,d,this.editingThingTUIXTabId,a)}}return 0==
a.length};g.displayPageFieldOrderErrors=function(){if(!this.getItem("page",this.currentPageId))return!0;for(var b=[],a=this.getOrderedFields(this.currentPageId),c="checkbox group date radios select text textarea url".split(" "),d=!1,e=!1,f=0;f<a.length;f++)if(field=a[f],"repeat_start"!=field.type||d)if("repeat_end"==field.type)d?d=e=!1:b.push("Repeat ends must be placed after repeat starts.");else{if(d&&-1==c.indexOf(field.type)&&b.push('Field type "'+this.getFieldReadableType(field.type).toLowerCase()+
'" is not allowed in a repeat block.'),this.tuix.dataset_fields_in_forms[field.id]&&!d&&field.repeat_start_id&&field.repeat_start_id!=e){for(var h=this.tuix.dataset_fields_in_forms[field.id],g=[],l=0;l<h.length;l++)this.tuix.forms_with_dataset_fields[h[l]]&&g.push(this.tuix.forms_with_dataset_fields[h[l]]);b.push('The field "'+field.label+'" is used on '+h.length+" form"+(1==h.length?"":"s")+" ("+g.join(", ")+") in a dataset repeat block. You must remove this repeat block from forms before this field can be moved out.")}}else e=
field.id,d=!0;a=0<b.length;c=$("#organizer_fields_error");c.html("");for(f=0;f<b.length;f++)c.append('<p class="error">'+b[f]+"</p>");c.toggle(a);return!a};g.getDeleteErrors=function(b,a){var c=[];if("field"==b){this.getItem(b,a);for(var d=this.getOrderedPages(),e=0;e<d.length;e++)d[e].parent_field_id==a&&c.push('Unable to delete the field because the tab "'+d[e].label+'" depends on it.');d=this.getOrderedFields();for(e=0;e<d.length;e++)a!=d[e].id&&a==d[e].parent_id&&c.push('Unable to delete the field because the field "'+
d[e].label+'" depends on it.');if(this.tuix.dataset_fields_in_forms[a]){for(var d=this.tuix.dataset_fields_in_forms[a],f=[],e=0;e<d.length;e++)this.tuix.forms_with_dataset_fields[d[e]]&&f.push(this.tuix.forms_with_dataset_fields[d[e]]);c.push("This field is used on "+d.length+" form"+(1==d.length?"":"s")+" ("+f.join(", ")+"). You must remove this field from all forms before you can delete it.")}}return c};g.formatTUIX=function(b,a,c,d,e){var f=this;if("field"==b)if("details"==c){a.tuix_type&&(b=f.getFieldReadableType(a.type,
a.tuix_type,!0),d.tabs[c].fields.message.snippet.html='This is a field of type "'+b+"\". You cannot edit this field's details.");if(a.is_protected||a.is_system_field)d.tabs[c].fields.db_column.readonly=!0;a.values_source&&f.tuix.centralised_lists.values[a.values_source]&&(b=f.tuix.centralised_lists.values[a.values_source],b.info.can_filter?d.tabs[c].fields.values_source_filter.label=b.info.filter_label:d.tabs[c].fields.values_source_filter.hidden=!0);"values_source"==e&&(a.values_source?(actionRequests=
{mode:"get_centralised_lov",method:a.values_source},f.tuix.centralised_lists.values[a.values_source].info.can_filter&&(actionRequests.filter=a.values_source_filter),f.sendAJAXRequest(actionRequests).after(function(b){a.lov=b;f.loadFieldValuesListPreview(a.id)})):(a.lov={},f.loadFieldValuesListPreview(a.id)));a.is_system_field&&(d.tabs[c].fields.is_protected.note_below="System fields cannot be deleted",d.tabs[c].fields.is_protected.readonly=!0,d.tabs[c].fields.is_protected.value=!0);-1!=["editor",
"textarea","file_picker"].indexOf(a.type)&&(d.tabs[c].fields.include_in_export.note_below="You cannot export this kind of field",d.tabs[c].fields.include_in_export.readonly=!0,d.tabs[c].fields.include_in_export.value=!1);a.is_system_field&&!a.allow_admin_to_change_visibility&&(d.tabs[c].fields.admin_box_visibility.note_below="Only specific system fields marked with a special property can have their visibility changed.",d.tabs[c].fields.admin_box_visibility.hidden=!0);"repeat_start"==a.type&&(d.tabs[c].fields.label.label=
"Section heading:",d.tabs[c].fields.label.note_below="This will be the heading at the start of the repeating section.");f.loadFieldsList(f.currentPageId)}else if("organizer"==c)a.allow_admin_to_change_visibility||(d.tabs[c].fields.hide_in_organizer.note_below="Only specific system fields marked with a special property can have their visibility changed.",d.tabs[c].fields.hide_in_organizer.readonly=!0,d.tabs[c].fields.hide_in_organizer.value=!1),-1!="checkbox group radios select dataset_select dataset_picker file_picker centralised_radios centralised_select".split(" ").indexOf(a.type)&&
(d.tabs[c].fields.create_index.value="index",d.tabs[c].fields.create_index.readonly=!0);else if("values"==c)if(a.is_system_field)d.tabs[c].fields.message.snippet.html="You cannot change the values of a system field.";else if("centralised_radios"==a.type||"centralised_select"==a.type)d.tabs[c].fields.message.snippet.html="You cannot change the values of a centralised list."};g.validateTUIX=function(b,a,c,d){if("page"==b)"details"!=c||a.label.trim()||(d.tabs[c].fields.label.error="Please enter a label");
else if("field"==b)if("details"==c){if(!a.is_system_field){if("repeat_start"!=a.type)if(a.db_column)if(a.db_column.m(/[^a-z0-9_-]/))d.tabs[c].fields.db_column.error="Code name can only use characters a-z 0-9 _-.";else{b=!0;for(var e=this.getOrderedFields(),f=0;f<e.length;f++)if(e[f].id!=a.id&&e[f].db_column==a.db_column){b=!1;break}b?a.db_column.m(/\_\_(\d+|rows)$/)&&(d.tabs[c].fields.db_column.error="That code name is invalid."):d.tabs[c].fields.db_column.error='The code name "'+a.db_column+'" is already in use.'}else d.tabs[c].fields.db_column.error=
"Please enter a code name.";a.admin_box_visibility&&"show_on_condition"==a.admin_box_visibility&&!a.parent_id&&(d.tabs[c].fields.parent_id.error="Please select a conditional display field.");"file_picker"!=a.type||a.store_file||(d.tabs[c].fields.store_file.error="Please select a file storage method.");"centralised_radios"!=a.type&&"centralised_select"!=a.type||a.values_source||(d.tabs[c].fields.values_source.error="Please select a source for this list.");if("repeat_start"==a.type)if(a.min_rows?+a.min_rows!=
a.min_rows?d.tabs[c].fields.min_rows.error="Please a valid number for mininum rows.":1>a.min_rows||10<a.min_rows?d.tabs[c].fields.min_rows.error="Mininum rows must be between 1 and 10.":+a.min_rows>+a.max_rows&&(d.tabs[c].fields.min_rows.error="Minimum rows cannot be greater than maximum rows."):d.tabs[c].fields.min_rows.error="Please enter the minimum rows.",!a.max_rows)d.tabs[c].fields.max_rows.error="Please enter the maximum rows.";else if(+a.max_rows!=a.max_rows)d.tabs[c].fields.max_rows.error=
"Please a valid number for maximum rows.";else if(2>a.max_rows||20<a.max_rows)d.tabs[c].fields.max_rows.error="Maximum rows must be between 2 and 20."}}else"validation"!=c||a.is_system_field||(a.required&&!a.required_message&&(d.tabs[c].fields.required_message.error="Please enter a message if not complete."),a.validation&&"none"!=a.validation&&!a.validation_message&&(d.tabs[c].fields.validation_message.error="Please enter a message if not valid."))};g.getTUIXFieldCustomValues=function(b){var a={};
if("centralised_lists"==b)a=JSON.parse(JSON.stringify(this.tuix.centralised_lists.values));else if("datasets"==b)a=JSON.parse(JSON.stringify(this.tuix.datasets));else if("boolean_fields"==b){b=this.getOrderedPages();for(var c=1<b.length,d=0,e=0;e<b.length;e++)for(var f=b[e],g=this.getOrderedFields(b[e].id),k=0;k<g.length;k++){var l=g[k];if(!("checkbox"!=l.type&&"group"!=l.type||"field"==this.editingThing&&l.id==this.editingThingId)&&(a[l.id]={label:l.label,ord:++d},c)){var m="page_"+f.id;a[l.id].parent=
m;a[m]||(a[m]={label:f.label,ord:++d})}}}return a};g.loadPagesList=function(){var b=this,a=b.getOrderedPages();!b.currentPageId&&0<a.length&&(b.currentPageId=a[0].id);for(var c=0;c<a.length;c++)b.currentPageId==a[c].id&&(a[c]._is_current_page=!0),a[c].label=b.formatPageLabel(a[c].label);a=b.microTemplate("zenario_organizer_admin_box_builder_tabs",{pages:a});$("#organizer_form_tabs").html(a);$("#organizer_form_tabs .tab").on("click",function(){var a=$(this).data("id");b.tuix.pages[a]&&b.clickPage(a)});
$("#organizer_add_new_tab").on("click",function(){if(b.saveCurrentOpenDetails()){var a=b.createPage();b.clickPage(a,!0);b.changeMadeToPanel()}});$("#organizer_form_tabs").sortable({containment:"parent",tolerance:"pointer",items:"div.sort",start:function(a,c){b.startIndex=c.item.index()},stop:function(a,c){b.startIndex!=c.item.index()&&($("#organizer_form_tabs .tab.sort").each(function(a){var c=$(this).data("id");b.tuix.pages[c].ord=a+1}),b.pagesReordered=!0,b.changeMadeToPanel())}});$("#organizer_form_tabs .tab").droppable({accept:"div.is_sortable:not(.system_field)",
greedy:!0,hoverClass:"ui-state-hover",tolerance:"pointer",drop:function(a,c){if(b.saveCurrentOpenDetails()){var f=$(this).data("id"),g=$(c.draggable).data("id");b.moveFieldToPage(b.currentPageId,f,g);"field"==b.editingThing&&b.editingThingId==g&&b.loadNewFieldsPanel();b.loadFieldsList(b.currentPageId)}}})};g.createPage=function(){var b="t"+this.newItemCount++,a=1,c=this.getOrderedPages();c.length&&(a=c[c.length-1].ord+1);c={};c.id=b;c.ord=a;c._just_added=!0;c.fields={};c.label="Untitled page";for(var d in this.tuix.dataset_page_details.tabs)if(n(this.tuix.dataset_page_details.tabs,
d)&&(a=this.tuix.dataset_page_details.tabs[d],a.fields))for(var e in a.fields)if(n(a.fields,e)){var f=a.fields[e];r(f.value)&&!r(c[e])&&(c[e]=f.value)}this.tuix.pages[b]=c;return b};g.clickPage=function(b,a){var c=this;if(("page"!=c.editingThing||c.editingThingId!=b)&&c.saveCurrentOpenDetails()&&c.displayPageFieldOrderErrors())if(c.currentPageId!=b){var d=!c.editingThing;c.currentPageId=b;c.editingThing=!1;c.loadPagesList();c.loadFieldsList(b);c.loadNewFieldsPanel(d);var e=c.getItem("page",b);a?c.clickPage(b):
e.record_counts_fetched||c.sendAJAXRequest({mode:"get_tab_field_record_counts",pageId:b}).after(function(a){e.record_counts_fetched=!0;if(a)for(fieldId in a)n(a,fieldId)&&(recordCount=a[fieldId],c.getItem("field",fieldId).record_count=recordCount)})}else c.editingThing="page",c.editingThingId=b,c.editingThingTUIXTabId=!1,c.openPageEdit(b)};g.clickField=function(b,a){if(("field"!=this.editingThing||this.editingThingId!=b)&&"repeat_end"!=this.tuix.items[b].type&&this.saveCurrentOpenDetails()){var c=
this.getItem("field",b);!a&&c._just_added&&delete c._just_added;this.editingThing="field";this.editingThingId=b;this.editingThingTUIXTabId=!1;this.loadFieldsList(this.currentPageId);this.openFieldEdit(b)}};g.loadFieldsList=function(b){var a=this,c={fields:a.getOrderedMergeFieldsForFields(b)},c=a.microTemplate("zenario_organizer_admin_box_builder_section",c);$("#organizer_form_fields").html(c);$("#organizer_form_fields div.form_field").on("click",function(){var b=$(this).data("id");a.tuix.items[b]&&
a.clickField(b)});$("#organizer_form_fields .form_section").sortable({items:"div.is_sortable",tolerance:"pointer",placeholder:"preview",receive:function(b,c){$(this).find("div.field_type").each(function(){var b=$(this).data("type"),c=0.1,d=$(this).prev().data("id");d&&a.tuix.items[d]?c=a.tuix.items[d].ord+0.1:(d=$(this).next().data("id"))&&a.tuix.items[d]&&(c=a.tuix.items[d].ord-0.1);b=a.createField(b,c);a.clickField(b,!0);a.updateFieldOrds()})},start:function(b,c){a.startIndex=c.item.index()},stop:function(c,
e){a.startIndex!=e.item.index()&&(a.tuix.pages[b].fields_reordered=!0,a.updateFieldOrds(),a.loadFieldsList(b))}});$("#organizer_form_fields .delete_icon").on("click",function(b){b.stopPropagation();var c=$(this).data("id");a.saveCurrentOpenDetails(!0)&&(b=a.tuix.items[c],b.is_protected?(message="<p>This field is protected, and might be important to your site!</p>",message+="<p>If you're sure you want to delete this field then first unprotect it.</p>",m._flBo(message,!0,"warning",!0)):(b.record_count&&
1<=b.record_count?(message="<p><strong>This field contains data on "+b.record_count+" record"+(1==b.record_count?"":"s")+".</strong></p>",message+="<p>When you save changes to this dataset, this data will be deleted.</p>"):message="<p>This field doesn't contain any data for any user/contact records.</p>",message+="<p>Delete this dataset field?</p>",m._flBo(message,"Delete dataset field","warning",!0,!1,function(){a.deleteField(c,!0)})))})};g.checkParentHasParent=function(b,a){var c=_._cl(this.tuix.items[b]),
d=a;c.parent_id&&a++;d!=a&&(a=this.checkParentHasParent(c.parent_id,a));return a};g.getOrderedMergeFieldsForFields=function(b){var a=[],c=[],d={},e;for(e in this.tuix.pages[b].fields)if(n(this.tuix.pages[b].fields,e)){var f=_._cl(this.tuix.items[e]);f.lov=this.getOrderedFieldValues(e);"show"==f.admin_box_visibility?f.indent=0:f.parent_id&&"show_on_condition"==f.admin_box_visibility&&(f.indent=1,f.indent=this.checkParentHasParent(f.parent_id,f.indent));"field"==this.editingThing&&this.editingThingId==
f.id&&(f._is_current_field=!0);f.grouping_name?(f.fields=[],d[f.grouping_name]=f):f.grouping?c.push(f):(f._is_sortable=!0,a.push(f))}if(0<c.length)for(b=0;b<c.length;b++)d[c[b].grouping]&&d[c[b].grouping].fields.push(c[b]);for(groupName in d)n(d,groupName)&&(group=d[groupName],group.fields.sort(this.sortByOrd),group.fields.length&&(group._is_sortable=!0,group.fields[0].first_in_grouping=!0,a.push(group)));a.sort(this.sortByOrd);c=!1;for(b=0;b<a.length;b++)"repeat_start"==a[b].type?c=!0:"repeat_end"==
a[b].type?c=!1:c&&(a[b]._is_repeat_field=!0);return a};g.updateFieldOrds=function(){var b=this;$("#organizer_form_fields div.form_field").each(function(a){var c=$(this).data("id");b.tuix.items[c].ord=a+1});b.changeMadeToPanel()};g.deletePage=function(b){var a=this.getOrderedPages();if(!(2>a.length))for(var c=this.getOrderedFields(b),d=0;d<a.length;d++)if(a[d].id==b){for(var e=0;e<c.length;e++)this.deleteField(c[e].id);a=a[d-1]?a[d-1].id:a[d+1].id;this.deletedPages.push(b);delete this.tuix.pages[b];
this.clickPage(a);this.changeMadeToPanel();break}};g.deleteField=function(b,a){var c=this.tuix.items[b];if(c){var d=this.getOrderedFields(c.page_id);if("repeat_start"==c.type){var e=this.getMatchingRepeatEnd(b);if(e){var f=this.tuix.items[e];this.deletedFields.push(e);delete this.tuix.pages[f.page_id].fields[e];delete this.tuix.items[e]}}for(var f=e=!1,g=0;g<d.length;g++)if(d[g].id==b&&(e=g),!1!==e)if(0<e){f=d[e-1].id;break}else if(b!=d[g].id){f=d[g].id;break}f&&"repeat_end"==this.tuix.items[f].type&&
(f=!1);this.deletedFields.push(b);delete this.tuix.pages[c.page_id].fields[b];delete this.tuix.items[b];this.changeMadeToPanel();a&&(this.loadFieldsList(c.page_id),f?this.clickField(f):this.loadNewFieldsPanel())}};g.createField=function(b,a){var c="t"+ ++this.newItemCount,d={};d.id=c;d.page_id=this.currentPageId;d.type=b;d.ord=a;d.label="Untitled";d._just_added=!0;if("checkboxes"==b||"radios"==b||"select"==b){d.lov={};for(var e=1;3>=e;e++)this.addFieldValue(d,"Option "+e)}else"repeat_start"==b&&this.createField("repeat_end",
a+0.01);this.tuix.pages[this.currentPageId].fields[c]=1;this.tuix.items[c]=d;this.loadFieldsList(this.currentPageId);return c};g.changeMadeToPanel=function(){this.changeMadeOnPanel||(this.changeMadeOnPanel=!0,q.onbeforeunload=function(){return"You are currently editing this dataset. If you leave now you will lose any unsaved changes."},p._dI("Please either save your changes, or click Reset to discard them, before exiting the form editor."),p._sB())};g.saveChanges=function(){var b=this,a={mode:"save",
pages:JSON.stringify(b.tuix.pages),fields:JSON.stringify(b.tuix.items),pagesReordered:b.pagesReordered,deletedPages:JSON.stringify(b.deletedPages),deletedFields:JSON.stringify(b.deletedFields),deletedValues:JSON.stringify(b.deletedValues),currentPageId:b.currentPageId,editingThing:b.editingThing,editingThingId:b.editingThingId};m._nDS("saving",!0);b.sendAJAXRequest(a).after(function(a){m._nDS();if(a){if(a.errors){for(var d="",e=0;e<a.errors.length;e++)d+=a.errors[e]+"<br>";d&&m._flBo(d)}b.currentPageId=
a.currentPageId;b.editingThing=a.editingThing;b.editingThingId=a.editingThingId}q.onbeforeunload=!1;p._eI();b.changeMadeOnPanel=!1;b.changesSaved=!0;p._r()})}},zenarioO.panelTypes);
