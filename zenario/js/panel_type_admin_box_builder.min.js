zenario.lib(function(f,v,w,r,x,y,z,n,A,B,C,q,D,E,F,G,H,I,J,t,u,m,s){f=u(s.admin_box_builder=t(s.form_builder_base_class));f.showPanel=function(a,b,d){a.html("").hide();d.html("").show();a=this.loadPanelHTML();b.html(a).show();this.currentPageId||(b=this.getOrderedPages(),0<b.length&&(this.currentPageId=b[0].name));this.pagesReordered=!1;this.deletedPages=[];this.deletedFields=[];this.changeDetected=!1;this.maxNewCustomFieldValue=this.maxNewCustomField=this.maxNewCustomPage=1;this.selectedDetailsPage=
this.selectedDetailsPage?this.selectedDetailsPage:!1;this.selectedFieldId=this.selectedFieldId?this.selectedFieldId:!1;this.selectedPageId=this.selectedPageId?this.selectedPageId:!1;this.loadPagesList(this.currentPageId);this.loadFieldsList(this.currentPageId);this.selectedFieldId?this.loadFieldDetailsPanel(this.selectedFieldId,!0):this.selectedPageId?this.loadPageDetailsPanel(this.selectedPageId,!0):this.loadNewFieldsPanel(!0);this.changesSaved&&(this.changesSaved=!1,n._t({message_type:"success",
message:"Your changes have been saved!"}))};f.loadPanelHTML=function(){return this.microTemplate("zenario_organizer_admin_box_builder",{dataset_label:this.tuix.dataset.label})};f.loadFieldDetailsPanel=function(a,b){var d=this.tuix.items[this.currentPageId].fields[a],c={mode:"field_details",field_label:d.field_label,hide_tab_bar:this.tuix.field_details.hide_tab_bar};c.record_count="("+(d.record_count?d.record_count:0)+" record"+(1==d.record_count?"":"s")+")";c.type=this.getFieldReadableType(this.currentPageId,
a);d.is_system_field&&(c.type+=", system field");c=this.microTemplate("zenario_organizer_admin_box_builder_left_panel",c);c=$("#organizer_admin_form_builder .form_fields_palette .form_fields_palette_outer").html(c);b||c.hide().show("drop",{direction:"left"},200);d=this.sortAndLoadTUIXPages(this.tuix.field_details.tabs,d,this.selectedDetailsPage);c=this.getTUIXPagesHTML(d);$("#organizer_field_details_tabs").html(c);var e=this;$("#organizer_field_details_tabs .tab").on("click",function(){var b=$(this).data("name");
b&&b!=e.selectedDetailsPage&&(e.saveCurrentOpenDetails()||e.loadFieldDetailsPage(b,a))});this.loadFieldDetailsPage(this.selectedDetailsPage,a);$("#organizer_field_details_inner span.add_new_field").on("click",function(){e.saveCurrentOpenDetails()||(e.selectedFieldId=!1,e.loadNewFieldsPanel(),e.highlightField(!1))})};f.getFieldReadableType=function(a,b,d){a=this.tuix.items[a].fields[b];switch(a.type){case "group":return"Group";case "checkbox":return"Flag";case "checkboxes":return"Checkboxes";case "date":return"Date";
case "editor":return"Editor";case "radios":return"Radios";case "centralised_radios":return"Centralised radios";case "select":return"Select";case "centralised_select":return"Centralised select";case "text":return"Text";case "textarea":return"Textarea";case "url":return"URL";case "other_system_field":if(d)switch(a.tuix_type){case "html_snippet":return"HTML snippet";case "pick_items":return"Item picker";case "toggle":return"Toggle";case "grouping":return"Grouping";default:return"Unknown"}else return"Other system field";
case "dataset_select":return"Dataset select";case "dataset_picker":return"Dataset picker";case "file_picker":return"File picker";case "repeat_start":return"Start of repeating section";case "repeat_end":return"End of repeating section";default:return"Unknown"}};f.highlightField=function(a){$("#organizer_form_fields .form_field .form_field_inline_buttons").hide();$("#organizer_form_fields .form_field").removeClass("selected");a&&($("#organizer_form_field_"+a).addClass("selected"),$("#organizer_form_field_"+
a+" .form_field_inline_buttons").show())};f.loadFieldDetailsPage=function(a,b,d){this.selectedDetailsPage=a;var c=this.tuix.items[this.currentPageId].fields[b],e=this.loadFields("field_details/"+a,this.tuix.field_details.tabs[a].fields,c),e=this.formatFieldDetails(e,c,"field",this.selectedDetailsPage),h=this.sortFields(e,c),l="";if(!_._isEm(d)){d=this.sortErrors(d);for(var k=0;k<d.length;k++)l+='<p class="error">'+d[k]+"</p>"}l+=this.getTUIXFieldsHTML(h);$("#organizer_field_details_form").html(l);
$("#organizer_field_details_tabs .tab").removeClass("on");$("#field_tab__"+a).addClass("on");_._isEm(d)||$("#organizer_field_details_form").effect({effect:"bounce",duration:125,direction:"right",times:2,distance:5,mode:"effect"});var g=this;"details"==a?($("#field__field_label").on("keyup",function(){$("#organizer_form_field_"+b+" .label, #zenario_field_details_header_content .field_name h5").text($(this).val());if(c._is_new){var a=$(this).val().toLowerCase().replace(/[\s-]+/g,"_").replace(/[^a-z_0-9]/g,
"");$("#field__db_column").val(a)}}),$("#field__note_below").on("keyup",function(){var a=$(this).val().trim();$("#organizer_form_field_note_below_"+b+" div.zenario_note_content").text(a);$("#organizer_form_field_note_below_"+b).toggle(""!==a)}),$("#field__side_note").on("keyup",function(){var a=$(this).val().trim();$("#organizer_form_field_side_note_"+b+" div.zenario_note_content").text(a);$("#organizer_form_field_side_note_"+b).toggle(""!==a)})):"values"==a&&e.values&&!e.values._hidden&&(d=this.getOrderedFieldValues(this.currentPageId,
b),l=this.microTemplate("zenario_organizer_admin_box_builder_field_value",d),$("#field_values_list").html(l).sortable({containment:"parent",tolerance:"pointer",axis:"y",start:function(a,b){g.startIndex=b.item.index()},stop:function(a,c){g.startIndex!=c.item.index()&&(g.saveFieldListOfValues(g.tuix.fields[b]),g.loadFieldValuesListPreview(b),g.changeMadeToPanel())}}),$("#field_values_list input").on("keyup",function(){var a=$(this).data("id");$("#organizer_field_value_"+a+" label").text($(this).val());
g.changeMadeToPanel()}),$("#organizer_add_a_field_value").on("click",function(){g.addFieldValue(c);g.saveItemTUIXPage("field_details",a,c);g.loadFieldDetailsPage(a,b);g.loadFieldValuesListPreview(b);g.changeMadeToPanel()}),$("#field_values_list .delete_icon").on("click",function(){var d=$(this).data("id");c.lov[d]&&(c._deleted_lov||(c._deleted_lov=[]),c._deleted_lov.push(d),delete c.lov[d]);g.saveItemTUIXPage("field_details",a,c);g.loadFieldDetailsPage(a,b);g.loadFieldValuesListPreview(b);g.changeMadeToPanel()}))};
f.loadFieldValuesListPreview=function(a){if(this.tuix.items[this.currentPageId]&&this.tuix.items[this.currentPageId].fields[a]){var b=this.tuix.items[this.currentPageId].fields[a],d=this.getOrderedFieldValues(this.currentPageId,a,!0),c=!1;"select"==b.type||"centralised_select"==b.type?(c=this.microTemplate("zenario_organizer_admin_box_builder_select_values",d),$("#organizer_form_field_"+a+" select").html(c)):"radios"==b.type||"centralised_radios"==b.type?(c=this.microTemplate("zenario_organizer_admin_box_builder_radio_values_preview",
d),$("#organizer_form_field_values_"+a).html(c)):"checkboxes"==b.type&&(c=this.microTemplate("zenario_organizer_admin_box_builder_checkbox_values_preview",d),$("#organizer_form_field_values_"+a).html(c))}};f.saveCurrentOpenDetails=function(a){var b=!1;this.selectedFieldId&&this.tuix.items[this.currentPageId]&&this.tuix.items[this.currentPageId].fields[this.selectedFieldId]?(a?b=this.getDeleteFieldErrors(this.selectedFieldId):(a=this.tuix.items[this.currentPageId].fields[this.selectedFieldId],b=this.saveItemTUIXPage("field_details",
this.selectedDetailsPage,a)),_._isEm(b)||this.loadFieldDetailsPage(this.selectedDetailsPage,this.selectedFieldId,b)):this.selectedPageId&&this.tuix.items[this.selectedPageId]&&(a=this.tuix.items[this.selectedPageId],b=this.saveItemTUIXPage("tab_details",this.selectedDetailsPage,a),_._isEm(b)||this.loadPageDetailsPage(this.selectedDetailsPage,this.selectedPageId,b));return!_._isEm(b)};f.displayPageFieldStructureErrors=function(a){var b=[],d=this.getOrderedFields(a),c=!1,e,h="checkbox group date radios select text textarea url".split(" ");
for(a=0;a<d.length;a++)if(e=d[a],"repeat_start"!=e.type||c)if("repeat_end"==e.type)c?c=repeatStartFieldId=!1:b.push("Repeat ends must be placed after repeat starts.");else{if(c&&-1==h.indexOf(e.type)&&b.push('Field type "'+this.getFieldReadableType(e.type).toLowerCase()+'" is not allowed in a repeat block.'),this.tuix.dataset_fields_in_forms[e.id]&&!c&&e.repeat_start_id&&e.repeat_start_id!=repeatStartFieldId){formIds=_._tA(this.tuix.dataset_fields_in_forms[e.id]);plural=1==formIds.length?"":"s";e=
'The field "'+e.field_label+'" is used on '+formIds.length+" form"+plural+" (";for(var l=[],k=0;k<formIds.length;k++)this.tuix.forms_with_dataset_fields[formIds[k]]&&l.push(this.tuix.forms_with_dataset_fields[formIds[k]]);e+=l.join(", ")+") in a dataset repeat block. You must remove this repeat block from forms before this field can be moved out.";b.push(e)}}else repeatStartFieldId=e.id,c=!0;d=0<b.length;c=$("#organizer_fields_error");c.html("");for(a=0;a<b.length;a++)c.append('<p class="error">'+
b[a]+"</p>");c.toggle(d);return d};f.getDeleteFieldErrors=function(a){var b={},d,c,e,h;for(d in this.tuix.items)if(m(this.tuix.items,d))for(e in c=this.tuix.items[d],c.parent_field_id==a&&(b[d]='Unable to delete the field because the page "'+c.tab_label+'" depends on it.'),c.fields)m(c.fields,e)&&(h=c.fields[e],a!=e&&h.parent_id==a&&(b[e]='Unable to delete the field because the field "'+h.field_label+'" depends on it.'));if(this.tuix.dataset_fields_in_forms[a]){formIds=_._tA(this.tuix.dataset_fields_in_forms[a]);
plural=1==formIds.length?"":"s";b[a]="This field is used on "+formIds.length+" form"+plural+" (";formNames=[];for(d=0;d<formIds.length;d++)this.tuix.forms_with_dataset_fields[formIds[d]]&&formNames.push(this.tuix.forms_with_dataset_fields[formIds[d]]);b[a]+=formNames.join(", ")+"). You must remove this field from all forms before you can delete it."}return b};f.validateFieldDetails=function(a,b,d,c,e){if("field_details"==d)if("details"==c){if(!b.is_system_field){if("repeat_start"!=b.type)if(b.db_column)if(b.db_column.match(/[^a-z0-9_-]/))e.db_column=
"Code name can only use characters a-z 0-9 _-.";else{a=!0;for(var h in this.tuix.items)if(m(this.tuix.items,h)&&(c=this.tuix.items[h],c.fields))for(var l in c.fields)if(m(c.fields,l)&&(d=c.fields[l],l!=b.id&&d.db_column==b.db_column)){a=!1;break}a||(e.db_column='The code name "'+b.db_column+'" is already in use.');b.db_column.match(/\_\_(\d+|rows)$/)&&(e.db_column="That code name is invalid.")}else e.db_column="Please enter a code name.";b.admin_box_visibility&&"show_on_condition"==b.admin_box_visibility&&
!b.parent_id&&(e.parent_id="Please select a conditional display field.");"file_picker"!=b.type||b.store_file||(e.store_file="Please select a file storage method.");"centralised_radios"!=b.type&&"centralised_select"!=b.type||b.values_source||(e.values_source="Please select a source for this list.");if("repeat_start"==b.type){if(!b.min_rows)e.min_rows="Please enter the minimum rows.";else if(+b.min_rows!=b.min_rows)e.min_rows="Please a valid number for mininum rows.";else if(1>b.min_rows||10<b.min_rows)e.min_rows=
"Mininum rows must be between 1 and 10.";if(!b.max_rows)e.max_rows="Please enter the maximum rows.";else if(+b.max_rows!=b.max_rows)e.max_rows="Please a valid number for maximum rows.";else if(2>b.max_rows||20<b.max_rows)e.max_rows="Maximum rows must be between 2 and 20.";!e.min_rows&&!e.max_rows&&+b.min_rows>+b.max_rows&&(e.min_rows="Minimum rows cannot be greater than maximum rows.")}}}else"validation"!=c||b.is_system_field||(b.required&&!b.required_message&&(e.required_message="Please enter a message if not complete."),
b.validation&&"none"!=b.validation&&!b.validation_message&&(e.validation_message="Please enter a message if not valid."))};f.loadPageDetailsPanel=function(a,b){var d=this,c={mode:"tab_details",tab_label:this.getPageLabel(this.tuix.items[a].tab_label),is_system_field:this.tuix.items[a].is_system_field,hide_tab_bar:this.tuix.tab_details.hide_tab_bar},c=this.microTemplate("zenario_organizer_admin_box_builder_left_panel",c),c=$("#organizer_admin_form_builder .form_fields_palette .form_fields_palette_outer").html(c);
b||c.hide().show("drop",{direction:"left"},200);c=this.sortAndLoadTUIXPages(this.tuix.tab_details.tabs,this.tuix.items[a],this.selectedDetailsPage);c=this.getTUIXPagesHTML(c);$("#organizer_tab_details_tabs").html(c);$("#organizer_tab_details_tabs .tab").on("click",function(){var b=$(this).data("id");b&&b!=d.selectedDetailsPage&&(d.saveCurrentOpenDetails()||d.loadPageDetailsPage(b,a))});this.loadPageDetailsPage(this.selectedDetailsPage,a);$("#organizer_tab_details_inner span.add_new_field").on("click",
function(){d.saveCurrentOpenDetails()||d.loadNewFieldsPanel()});$("#organizer_remove_form_tab").on("click",function(a){if((a=d.tuix.items[d.selectedPageId])&&!a.is_system_field){var b=!1,c=0;if(a.fields)for(var k in a.fields)if(m(a.fields,k)){var g=a.fields[k];g.is_protected&&(b||(b=g),c++)}c?(k='<p>This page has the protected field "'+b.field_label+'"',c--,0<c&&(k+=" and "+c+" other protected field"+(1==c?"":"s")),n._flBo(k+" on it and cannot be deleted.</p>",!0,"warning",!0)):(k="<p>Are you sure you want to delete this Page?</p>",
_._isEm(a.fields)||(k+="<p>All fields on this page will also be deleted.</p>"),n._flBo(k,"Delete","warning",!0,!1,function(){d.deletePage(d.selectedPageId);d.changeMadeToPanel()}))}})};f.loadPageDetailsPage=function(a,b,d){this.selectedDetailsPage=a;var c=this.tuix.items[b],e=this.loadFields("tab_details/"+a,this.tuix.tab_details.tabs[a].fields,c);formattedFields=this.formatFieldDetails(e,c,"page",this.selectedDetailsPage);sortedFields=this.sortFields(formattedFields,c);c="";if(!_._isEm(d))for(d=
this.sortErrors(d),e=0;e<d.length;e++)c+='<p class="error">'+d[e]+"</p>";c+=this.getTUIXFieldsHTML(sortedFields);$("#organizer_tab_details_form").html(c);$("#organizer_tab_details_tabs .tab").removeClass("on");$("#field_tab__"+a).addClass("on");_._isEm(d)||$("#organizer_tab_details_form").effect({effect:"bounce",duration:125,direction:"right",times:2,distance:5,mode:"effect"});var h=this;if("details"==a)$("#field__tab_label").on("keyup",function(){var a=h.getPageLabel($(this).val());$("#zenario_tab_details_header_content .field_name h5, #organizer_form_tab_"+
b+" span").text(a)})};f.formatFieldDetails=function(a,b,d,c){if("field"==d)if("details"==c)b.tuix_type&&(d=this.getFieldReadableType(this.currentPageId,b.id,!0),a.message.snippet.html='This is a field of type "'+d+"\". You cannot edit this field's details."),(d=a.values_source._value)&&this.tuix.centralised_lists.values[d]&&(d=this.tuix.centralised_lists.values[d],d.info.can_filter?a.values_source_filter.label=d.info.filter_label:a.values_source_filter._hidden=!0),b.is_system_field&&(a.is_protected.note_below=
"System fields cannot be deleted",a.is_protected._disabled=!0,a.is_protected._value=!0),-1!=["editor","textarea","file_picker"].indexOf(b.type)&&(a.include_in_export.note_below="You cannot export this kind of field",a.include_in_export._disabled=!0,a.include_in_export._value=!1),b.is_system_field&&!b.allow_admin_to_change_visibility&&(a.admin_box_visibility.note_below="Only specific system fields marked with a special property can have their visibility changed.",a.admin_box_visibility._disabled=!0),
"repeat_start"==b.type&&(a.field_label.label="Section heading:",a.field_label.note_below="This will be the heading at the start of the repeating section.");else if("organizer"==c)b.allow_admin_to_change_visibility||(a.hide_in_organizer.note_below="Only specific system fields marked with a special property can have their visibility changed.",a.hide_in_organizer._disabled=!0,a.hide_in_organizer._value=!1),-1!="checkbox group radios select dataset_select dataset_picker file_picker centralised_radios centralised_select".split(" ").indexOf(b.type)&&
(a.create_index._value="index",a.create_index._disabled=!0);else if("values"==c)if(b.is_system_field)a.message.snippet.html="You cannot change the values of a system field.";else if("centralised_radios"==b.type||"centralised_select"==b.type)a.message.snippet.html="You cannot change the values of a centralised list.";return a};f.fieldDetailsChanged=function(a,b){a=a.split("/");var d=a[0],c=a[1],e,h;c&&d&&this.tuix[d]&&this.tuix[d].tabs[c]&&this.tuix[d].tabs[c].fields[b]&&(this.changeMadeToPanel(),
e=this.tuix[d].tabs[c].fields[b],e.format_onchange&&("field_details"==d?(e=this.tuix.items[this.currentPageId].fields[this.selectedFieldId],this.saveItemTUIXPage(d,this.selectedDetailsPage,e),this.loadFieldDetailsPage(this.selectedDetailsPage,this.selectedFieldId),"details"==c&&"values_source"==b&&((d=$("#field__values_source").val())?(d={mode:"get_centralised_lov",method:d,filter:$("#field__values_source_filter").val()},h=this,this.sendAJAXRequest(d).after(function(a){a=JSON.parse(a);h.tuix.items[h.currentPageId].fields[h.selectedFieldId].lov=
a;h.loadFieldValuesListPreview(h.selectedFieldId)})):(this.tuix.items[this.currentPageId].fields[this.selectedFieldId].lov={},this.loadFieldValuesListPreview(this.selectedFieldId)))):"tab_details"==d&&(e=this.tuix.items[this.selectedPageId],this.saveItemTUIXPage(d,this.selectedDetailsPage,e),this.loadPageDetailsPage(this.selectedDetailsPage,this.selectedPageId))))};f.getFieldValuesList=function(a){var b=[],d=a.id,c=a.values,e=a._value,h=a._disabled;if("object"==typeof c){var l=0,k;for(k in c)if(m(c,
k)){var g=c[k],g={ord:++l,name:d,label:g.label,value:k,path:a.path};k==e&&(g.selected=!0);h&&(g.disabled=!0);b.push(g)}}else if("boolean_fields"==c)for(l in this.tuix.items){if(m(this.tuix.items,l)&&(a=this.tuix.items[l],a.fields)){var d=[],f;for(f in a.fields)m(a.fields,f)&&(g=a.fields[f],!g.type||"checkbox"!=g.type&&"group"!=g.type||g.id==this.selectedFieldId||(g={ord:g.ord,label:g.field_label,value:f},f==e&&(g.selected=!0),d.push(g)));d.sort(this.sortByOrd);d.length&&b.push({ord:a.ord,label:a.tab_label,
hasChildren:!0,options:d})}}else if("centralised_lists"==c){var l=0,p;for(p in this.tuix.centralised_lists.values)m(this.tuix.centralised_lists.values,p)&&(g=this.tuix.centralised_lists.values[p],g={ord:++l,label:g.label,value:p},p==e&&(g.selected=!0),b.push(g))}else if("datasets"==c){var l=0,n;for(n in this.tuix.datasets)m(this.tuix.datasets,n)&&(g=this.tuix.datasets[n],g={ord:++l,label:g.label,value:n},n==e&&(g.selected=!0),b.push(g))}b.sort(this.sortByOrd);return b};f.loadNewFieldsPanel=function(a){this.selectedFieldId=
this.selectedPageId=!1;var b=this.microTemplate("zenario_organizer_admin_box_builder_left_panel",{mode:"new_fields",use_groups_field:this.tuix.use_groups_field}),b=$("#organizer_admin_form_builder .form_fields_palette .form_fields_palette_outer").html(b);a||b.hide().show("drop",{direction:"right"},200);$("#organizer_field_type_list_outer div.field_type_list div.field_type").draggable({connectToSortable:"#organizer_form_fields .form_section",appendTo:"#organizer_admin_form_builder",helper:"clone"})};
f.loadPagesList=function(a){for(var b in this.tuix.items)if(m(this.tuix.items,b)){var d=this.tuix.items[b];b==a?d._selected=!0:delete d._selected}a={tabs:this.getOrderedPages()};a=this.microTemplate("zenario_organizer_admin_box_builder_tabs",a);$("#organizer_form_tabs").html(a);var c=this;$("#organizer_form_tabs .tab").on("click",function(){var a=$(this).data("id");c.tuix.items[a]&&c.clickPage(a)});$("#organizer_add_new_tab").on("click",function(){c.saveCurrentOpenDetails()||(c.addNewPage(),c.changeMadeToPanel())});
$("#organizer_form_tabs").sortable({axis:"x",containment:"parent",tolerance:"pointer",items:"div.sort",start:function(a,b){c.startIndex=b.item.index()},stop:function(a,b){c.startIndex!=b.item.index()&&($("#organizer_form_tabs .tab.sort").each(function(a){var b=$(this).data("id");c.tuix.items[b].ord=a+1}),c.pagesReordered=!0,c.changeMadeToPanel())}});$("#organizer_form_tabs .tab").droppable({accept:"div.is_sortable:not(.system_field)",greedy:!0,hoverClass:"ui-state-hover",tolerance:"pointer",drop:function(a,
b){if(!c.saveCurrentOpenDetails()){var d=$(this).data("id"),f=$(b.draggable).data("id");d==c.currentPageId||c.tuix.items[c.currentPageId].fields[f].is_system_field||(c.moveFieldToPage(c.currentPageId,d,f),f==c.selectedFieldId&&c.loadNewFieldsPanel(),c.loadFieldsList(c.currentPageId))}}})};f.moveFieldToPage=function(a,b,d,c){if(a!=b&&this.tuix.items[b]&&this.tuix.items[a]&&this.tuix.items[a].fields[d]&&"repeat_end"!=this.tuix.items[a].fields[d].type){this.tuix.items[b]._tabFieldsReordered=!0;this.tuix.items[a]._tabFieldsReordered=
!0;var e=1,h=this.getOrderedFields(b);h.length&&(e=c?h[0].ord-1:h[h.length-1].ord+1);"repeat_start"==this.tuix.items[a].fields[d].type&&(c=this.getMatchingRepeatEnd(d),this.tuix.items[b].fields[c]=this.tuix.items[a].fields[c],this.tuix.items[b].fields[c].ord=e+0.001,delete this.tuix.items[a].fields[c]);this.tuix.items[b].fields[d]=this.tuix.items[a].fields[d];this.tuix.items[b].fields[d].ord=e;delete this.tuix.items[a].fields[d];this.changeMadeToPanel()}};f.addNewPage=function(){var a="__custom_tab_t"+
this.maxNewCustomPage++,b=1;for(name in this.tuix.items)m(this.tuix.items,name)&&++b;this.tuix.items[a]={ord:b,name:a,tab_label:"Untitled page",fields:{},_is_new:!0};this.clickPage(a,!0)};f.clickPage=function(a,b){if(this.selectedPageId!=a){var d=this.saveCurrentOpenDetails(),c=this.displayPageFieldStructureErrors(this.currentPageId);if(!d&&!c)if(this.currentPageId==a)this.selectedFieldId=!1,this.selectedPageId=a,this.selectedDetailsPage=!1,this.loadPageDetailsPanel(a);else{var e=this.tuix.items[a];
if(e.record_counts_fetched||e._is_new)this.clickPage2(a,b);else{var h=this;this.sendAJAXRequest({mode:"get_tab_field_record_counts",pageId:a}).after(function(c){e.record_counts_fetched=!0;if(c=JSON.parse(c))for(fieldId in c)m(c,fieldId)&&(recordCount=c[fieldId],e.fields&&e.fields[fieldId]&&(e.fields[fieldId].record_count=recordCount));h.clickPage2(a,b)})}}}};f.clickPage2=function(a,b){this.currentPageId=a;if(b)this.selectedPageId=a,this.loadPageDetailsPanel(a);else{var d=!1;this.selectedFieldId||
this.selectedPageId||(d=!0);this.loadNewFieldsPanel(d)}this.selectedFieldId=!1;this.loadPagesList(a);this.loadFieldsList(a)};f.clickField=function(a){this.selectedFieldId!=a&&this.tuix.items[this.currentPageId]&&this.tuix.items[this.currentPageId].fields[a]&&"repeat_end"!=this.tuix.items[this.currentPageId].fields[a].type&&!this.saveCurrentOpenDetails()&&(this.highlightField(a),this.selectedFieldId=a,this.selectedDetailsPage=this.selectedPageId=!1,this.loadFieldDetailsPanel(a))};f.loadFieldsList=
function(a){var b={fields:this.getOrderedFields(a,!0,!0)},b=this.microTemplate("zenario_organizer_admin_box_builder_section",b);$("#organizer_form_fields").html(b);this.selectedFieldId&&this.highlightField(this.selectedFieldId);var d=this;$("#organizer_form_fields div.form_field").on("click",function(){var a=$(this).data("id");d.tuix.items[d.currentPageId].fields[a]&&d.clickField(a)});$("#organizer_form_fields .form_section").sortable({items:"div.is_sortable",tolerance:"pointer",placeholder:"preview",
receive:function(a,b){$(this).find("div.field_type").each(function(){var a=$(this).data("type"),b=1,c=$(this).prev().data("id");c&&d.tuix.items[d.currentPageId].fields[c]&&(b=d.tuix.items[d.currentPageId].fields[c].ord+1);d.addNewField(a,b);d.updateFieldOrds()})},start:function(a,b){d.startIndex=b.item.index()},stop:function(b,e){d.startIndex!=e.item.index()&&(d.tuix.items[a]._tabFieldsReordered=!0,d.updateFieldOrds(),d.loadFieldsList(a))}});$("#organizer_form_fields .delete_icon").on("click",function(a){a.stopPropagation();
var b=$(this).data("id");if(d.tuix.items[d.currentPageId].fields[b]&&!d.saveCurrentOpenDetails(!0)){a=d.tuix.items[d.currentPageId].fields[b];var h;a.is_protected?(message="<p>This field is protected, and might be important to your site!</p>",message+="<p>If you're sure you want to delete this field then first unprotect it.</p>",n._flBo(message,!0,"warning",!0)):(a.record_count&&1<=a.record_count?(h=1==a.record_count?"":"s",message="<p><strong>This field contains data on "+a.record_count+" record"+
h+".</strong></p>",message+="<p>When you save changes to this dataset, that data will be deleted.</p>"):message="<p>This field doesn't contain any data for any user/contact records.</p>",message+="<p>Delete this dataset field?</p>",n._flBo(message,"Delete","warning",!0,!1,function(){d.deleteField(b)}))}})};f.updateFieldOrds=function(){var a=this;$("#organizer_form_fields div.is_sortable").each(function(b){var d=$(this).data("id");a.tuix.items[a.currentPageId].fields[d].ord=b+1});this.changeMadeToPanel()};
f.deletePage=function(a){for(var b=this.getOrderedPages(),d=0,c=0;c<b.length;c++)if(b[c].name==a){d=0<c?c-1:1;this.deletedPages.push(a);if(this.tuix.items[a].fields)for(var e in this.tuix.items[a].fields)m(this.tuix.items[a].fields,e)&&(field=this.tuix.items[a].fields[e],this.deletedFields.push(e));delete this.tuix.items[a];this.clickPage(b[d].name)}};f.deleteField=function(a){pageId=this.currentPageId;if(this.tuix.items[pageId].fields[a]){this.changeMadeToPanel();this.deletedFields.push(a);var b=
this.tuix.items[pageId].fields[a];if("repeat_start"==b.type){var d=this.getMatchingRepeatEnd(a);d&&(this.deletedFields.push(d),delete this.tuix.items[pageId].fields[d])}for(var d=this.getOrderedFields(pageId,!1,!0),c=!1,e=!1,h=e=!1,f=0;f<d.length;f++)if(d[f].id==b.id&&(c=f),!1!==c)if(0<c){h=c-1;e=d[c-1];break}else if(a!=d[f].id){h=f;e=d[f];break}delete this.tuix.items[pageId].fields[a];(e=e._fields&&e._fields.length?h<c?e._fields[e._fields.length-1].id:e._fields[0].id:e.id)&&"repeat_end"==this.tuix.items[pageId].fields[e].type&&
(e=!1);this.loadFieldsList(pageId);e?this.clickField(e):this.loadNewFieldsPanel()}};f.addNewField=function(a,b){var d="t"+this.maxNewCustomField++,c={id:d,type:a,ord:b,field_label:"Untitled",_is_new:!0},e;for(e in this.tuix.items[this.currentPageId].fields)if(m(this.tuix.items[this.currentPageId].fields,e)){var f=this.tuix.items[this.currentPageId].fields[e];f.ord>=b&&f.ord++}if("checkboxes"==a||"radios"==a||"select"==a)for(c.lov={},e=1;3>=e;e++)this.addFieldValue(c,"Option "+e);else"repeat_start"==
a&&this.addNewField("repeat_end",b+0.01);this.tuix.items[this.currentPageId].fields[d]=c;this.loadFieldsList(this.currentPageId);this.clickField(d)};f.getOrderedPages=function(){var a=[],b;for(b in this.tuix.items)m(this.tuix.items,b)&&a.push(this.tuix.items[b]);a.sort(this.sortByOrd);return a};f.getOrderedFields=function(a,b,d){var c=[],e=[],f={},l,k,g,n,p=!1;if(this.tuix.items[a]&&this.tuix.items[a].fields)for(l in this.tuix.items[a].fields)m(this.tuix.items[a].fields,l)&&(k=this.tuix.items[a].fields[l],
g=_._cl(k),b&&(g.lov=this.getOrderedFieldValues(a,l,!0)),d&&k.grouping_name?(g._fields=[],f[k.grouping_name]=g):d&&k.grouping?e.push(g):(g._isSortable=!0,c.push(g)));if(0<e.length)for(a=0;a<e.length;a++)f[e[a].grouping]&&f[e[a].grouping]._fields.push(e[a]);for(n in f)m(f,n)&&(e=f[n],e._fields.sort(this.sortByOrd),e._fields.length&&(e._isSortable=!0,c.push(e)));c.sort(this.sortByOrd);for(a=0;a<c.length;a++)"repeat_start"==c[a].type?p=!0:"repeat_end"==c[a].type?p=!1:p&&(c[a]._inRepeat=!0);return c};
f.getOrderedFieldValues=function(a,b,d){var c=[],e,f;if(this.tuix.items[a]&&this.tuix.items[a].fields&&this.tuix.items[a].fields[b]&&this.tuix.items[a].fields[b].lov){for(e in this.tuix.items[a].fields[b].lov)m(this.tuix.items[a].fields[b].lov,e)&&(f=this.tuix.items[a].fields[b].lov[e],c.push(f));a=this.tuix.items[a].fields[b].type;!d||"select"!=a&&"centralised_select"!=a||c.push({id:"empty_value",label:"-- Select --",ord:-1})}c.sort(this.sortByOrd);return c};f.changeMadeToPanel=function(){this.changeDetected||
(this.changeDetected=!0,r.onbeforeunload=function(){return"You are currently editing this dataset. If you leave now you will lose any unsaved changes."},q._dI("Please either save your changes, or click Reset to discard them, before exiting the form editor."),q._sB())};f.saveChanges=function(){var a=this,b={mode:"save",data:JSON.stringify(this.tuix.items),pagesReordered:this.pagesReordered,deletedPages:JSON.stringify(this.deletedPages),deletedFields:JSON.stringify(this.deletedFields),currentPageId:this.currentPageId};
this.selectedPageId&&(b.selectedPageId=this.selectedPageId);this.selectedFieldId&&(b.selectedFieldId=this.selectedFieldId);(function(){n._nDS("saving",!0);a.sendAJAXRequest(b).after(function(b){if(b){b=JSON.parse(b);if(b.errors){for(var c="",e=0;e<b.errors.length;e++)c+=b.errors[e]+"<br>";c&&n._flBo(c)}a.currentPageId=b.currentPageId;a.selectedPageId=b.selectedPageId;a.selectedFieldId=b.selectedFieldId}n._nDS();r.onbeforeunload=!1;q._eI();a.changeDetected=!1;a.changesSaved=!0;q._r()})})()}},zenarioO.panelTypes);
