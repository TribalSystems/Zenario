zenario.lib(function(f,w,x,r,y,z,A,p,B,C,D,q,E,F,G,H,I,J,t,u,l,s,K,m,L,M,N,O,v){f=u(s.admin_box_builder=t(s.form_builder_base_class));f.showPanel=function(a,b,d){a.html("").hide();d.html("").show();a=this.loadPanelHTML();b.html(a).show();this.currentTabId||(b=this.getOrderedTabs(),0<b.length&&(this.currentTabId=b[0].name));this.deletedTabs=[];this.deletedFields=[];this.changeDetected=!1;this.maxNewCustomFieldValue=this.maxNewCustomField=this.maxNewCustomTab=1;this.selectedDetailsTab=this.selectedDetailsTab?
this.selectedDetailsTab:!1;this.selectedFieldId=this.selectedFieldId?this.selectedFieldId:!1;this.selectedTabId=this.selectedTabId?this.selectedTabId:!1;this.loadTabsList(this.currentTabId);this.loadFieldsList(this.currentTabId);this.selectedFieldId?(this.loadFieldDetailsPanel(this.selectedFieldId,!0),this.highlightField(this.selectedFieldId)):this.selectedTabId?this.loadTabDetailsPanel(this.selectedTabId,!0):this.loadNewFieldsPanel(!0);this.changesSaved&&(this.changesSaved=!1,p._t({message_type:"success",
message:"Your changes have been saved!"}))};f.loadPanelHTML=function(){return this.microTemplate(m+"organizer_admin_box_builder",{dataset_label:this.tuix.dataset.label})};f.loadFieldDetailsPanel=function(a,b){var d=this.tuix.items[this.currentTabId].fields[a],c={mode:"field_details",field_label:d.field_label,hide_tab_bar:this.tuix.field_details.hide_tab_bar};c.record_count="("+(d.record_count?d.record_count:0)+" record"+(1==d.record_count?"":"s")+")";c.type=this.getFieldReadableType(this.currentTabId,
a);d.is_system_field&&(c.type+=", system field");c=this.microTemplate(m+"organizer_admin_box_builder_left_panel",c);c=$("#organizer_admin_form_builder .form_fields_palette .form_fields_palette_outer").html(c);b||c.hide().show("drop",{direction:"left"},200);d=this.sortAndLoadTUIXTabs(this.tuix.field_details.tabs,d,this.selectedDetailsTab);c=this.getTUIXTabsHTML(d);$("#organizer_field_details_tabs").html(c);var e=this;$("#organizer_field_details_tabs .tab").on("click",function(){var b=$(this).data("name");
b&&b!=e.selectedDetailsTab&&(e.saveCurrentOpenDetails()||e.loadFieldDetailsTab(b,a))});this.loadFieldDetailsTab(this.selectedDetailsTab,a);$("#organizer_field_details_inner span.add_new_field").on("click",function(){e.saveCurrentOpenDetails()||(e.selectedFieldId=!1,e.loadNewFieldsPanel(),e.highlightField(!1))})};f.getFieldReadableType=function(a,b,d){a=this.tuix.items[a].fields[b];switch(a.type){case "group":return"Group";case "checkbox":return"Flag";case "checkboxes":return"Checkboxes";case "date":return"Date";
case "editor":return"Editor";case "radios":return"Radios";case "centralised_radios":return"Centralised radios";case "select":return"Select";case "centralised_select":return"Centralised select";case "text":return"Text";case "textarea":return"Textarea";case "url":return"URL";case "other_system_field":if(d)switch(a.tuix_type){case "html_snippet":return"HTML snippet";case "pick_items":return"Item picker";case "toggle":return"Toggle";case "grouping":return"Grouping";default:return"Unknown"}else return"Other system field";
case "dataset_select":return"Dataset select";case "dataset_picker":return"Dataset picker";case "file_picker":return"File picker";default:return"Unknown"}};f.highlightField=function(a){$("#organizer_form_fields .form_field .form_field_inline_buttons").hide();$("#organizer_form_fields .form_field").removeClass("selected");a&&($("#organizer_form_field_"+a).addClass("selected"),$("#organizer_form_field_"+a+" .form_field_inline_buttons").show())};f.loadFieldDetailsTab=function(a,b,d){this.selectedDetailsTab=
a;var c=this.tuix.items[this.currentTabId].fields[b],e=this.loadFields("field_details/"+a,this.tuix.field_details.tabs[a].fields,c),e=this.formatFieldDetails(e,c,"field",this.selectedDetailsTab),n=this.sortFields(e,c),h="";if(!_._isEm(d)){d=this.sortErrors(d);for(var k=0;k<d.length;k++)h+='<p class="error">'+d[k]+"</p>"}h+=this.getTUIXFieldsHTML(n);$("#organizer_field_details_form").html(h);$("#organizer_field_details_tabs .tab").removeClass("on");$("#field_tab__"+a).addClass("on");_._isEm(d)||$("#organizer_field_details_form").effect({effect:"bounce",
duration:125,direction:"right",times:2,distance:5,mode:"effect"});var g=this;"details"==a?($("#field__field_label").on("keyup",function(){$("#organizer_form_field_"+b+" .label, #zenario_field_details_header_content .field_name h5").text($(this).val());if(c.is_new_field){var a=$(this).val().toLowerCase().replace(/[\s-]+/g,"_").replace(/[^a-z_0-9]/g,"");$("#field__db_column").val(a)}}),$("#field__note_below").on("keyup",function(){var a=$(this).val().trim();$("#organizer_form_field_note_below_"+b+" div.zenario_note_content").text(a);
$("#organizer_form_field_note_below_"+b).toggle(""!==a)}),$("#field__side_note").on("keyup",function(){var a=$(this).val().trim();$("#organizer_form_field_side_note_"+b+" div.zenario_note_content").text(a);$("#organizer_form_field_side_note_"+b).toggle(""!==a)})):"values"==a&&e.values&&!e.values._hidden&&(d=this.getOrderedFieldValues(this.currentTabId,b),h=this.microTemplate(m+"organizer_admin_box_builder_field_value",d),$("#field_values_list").html(h).sortable({containment:"parent",tolerance:"pointer",
axis:"y",start:function(a,b){g.startIndex=b.item.index()},stop:function(a,c){g.startIndex!=c.item.index()&&(g.saveFieldListOfValues(b),g.loadFieldValuesListPreview(b),g.changeMadeToPanel())}}),$("#field_values_list input").on("keyup",function(){var a=$(this).data("id");$("#organizer_field_value_"+a+" label").text($(this).val());g.changeMadeToPanel()}),$("#organizer_add_a_field_value").on("click",function(){g.addFieldValue(c);g.saveItemTUIXTab("field_details",a,c);g.loadFieldDetailsTab(a,b);g.loadFieldValuesListPreview(b);
g.changeMadeToPanel()}),$("#field_values_list .delete_icon").on("click",function(){var d=$(this).data("id");c.lov[d]&&(c._deleted_lov||(c._deleted_lov=[]),c._deleted_lov.push(d),delete c.lov[d]);g.saveItemTUIXTab("field_details",a,c);g.loadFieldDetailsTab(a,b);g.loadFieldValuesListPreview(b);g.changeMadeToPanel()}))};f.loadFieldValuesListPreview=function(a){if(this.tuix.items[this.currentTabId]&&this.tuix.items[this.currentTabId].fields[a]){var b=this.tuix.items[this.currentTabId].fields[a],d=this.getOrderedFieldValues(this.currentTabId,
a,!0),c=!1;"select"==b.type||"centralised_select"==b.type?(c=this.microTemplate(m+"organizer_admin_box_builder_select_values",d),$("#organizer_form_field_"+a+" select").html(c)):"radios"==b.type||"centralised_radios"==b.type?(c=this.microTemplate(m+"organizer_admin_box_builder_radio_values_preview",d),$("#organizer_form_field_values_"+a).html(c)):"checkboxes"==b.type&&(c=this.microTemplate(m+"organizer_admin_box_builder_checkbox_values_preview",d),$("#organizer_form_field_values_"+a).html(c))}};f.saveCurrentOpenDetails=
function(a){var b=!1;this.selectedFieldId&&this.tuix.items[this.currentTabId]&&this.tuix.items[this.currentTabId].fields[this.selectedFieldId]?(b=this.tuix.items[this.currentTabId].fields[this.selectedFieldId],b=this.saveItemTUIXTab("field_details",this.selectedDetailsTab,b),a||_._isEm(b)||this.loadFieldDetailsTab(this.selectedDetailsTab,this.selectedFieldId,b)):this.selectedTabId&&this.tuix.items[this.selectedTabId]&&(b=this.tuix.items[this.selectedTabId],b=this.saveItemTUIXTab("tab_details",this.selectedDetailsTab,
b),a||_._isEm(b)||this.loadTabDetailsTab(this.selectedDetailsTab,this.selectedTabId,b));return!_._isEm(b)};f.validateFieldDetails=function(a,b,d,c,e){if("field_details"==d)if("details"==c){if(!b.is_system_field){if(b.db_column)if(b.db_column.match(/[^a-z0-9_-]/))e.db_column="Code name can only use characters a-z 0-9 _-.";else{a=!0;for(var n in this.tuix.items)if(l(this.tuix.items,n)&&(c=this.tuix.items[n],c.fields))for(var h in c.fields)if(l(c.fields,h)&&(d=c.fields[h],h!=b.id&&d.db_column==b.db_column)){a=
!1;break}a||(e.db_column='The code name "'+b.db_column+'" is already in use.')}else e.db_column="Please enter a code name.";b.admin_box_visibility&&"show_on_condition"==b.admin_box_visibility&&!b.parent_id&&(e.parent_id="Please select a conditional display field.");"file_picker"!=b.type||b.store_file||(e.store_file="Please select a file storage method.");"centralised_radios"!=b.type&&"centralised_select"!=b.type||b.values_source||(e.values_source="Please select a source for this list.")}}else"validation"!=
c||b.is_system_field||(b.required&&!b.required_message&&(e.required_message="Please enter a message if not complete."),b.validation&&"none"!=b.validation&&!b.validation_message&&(e.validation_message="Please enter a message if not valid."))};f.loadTabDetailsPanel=function(a,b){var d=this,c={mode:"tab_details",tab_label:this.getTabLabel(this.tuix.items[a].tab_label),is_system_field:this.tuix.items[a].is_system_field,hide_tab_bar:this.tuix.tab_details.hide_tab_bar},c=this.microTemplate(m+"organizer_admin_box_builder_left_panel",
c),c=$("#organizer_admin_form_builder .form_fields_palette .form_fields_palette_outer").html(c);b||c.hide().show("drop",{direction:"left"},200);c=this.sortAndLoadTUIXTabs(this.tuix.tab_details.tabs,this.tuix.items[a],this.selectedDetailsTab);c=this.getTUIXTabsHTML(c);$("#organizer_tab_details_tabs").html(c);$("#organizer_tab_details_tabs .tab").on("click",function(){var b=$(this).data("id");b&&b!=d.selectedDetailsTab&&(d.saveCurrentOpenDetails()||d.loadTabDetailsTab(b,a))});this.loadTabDetailsTab(this.selectedDetailsTab,
a);$("#organizer_tab_details_inner span.add_new_field").on("click",function(){d.saveCurrentOpenDetails()||d.loadNewFieldsPanel()});$("#organizer_remove_form_tab").on("click",function(a){if((a=d.tuix.items[d.selectedTabId])&&!a.is_system_field){var b=!1,c=0;if(a.fields)for(var k in a.fields)if(l(a.fields,k)){var g=a.fields[k];g.is_protected&&(b||(b=g),c++)}c?(k='<p>This tab has the protected field "'+b.field_label+'"',c--,0<c&&(k+=" and "+c+" other protected field"+(1==c?"":"s")),p._flBo(k+" on it and cannot be deleted.</p>",
!0,"warning",!0)):(k="<p>Are you sure you want to delete this Tab?</p>",_._isEm(a.fields)||(k+="<p>All fields on this tab will also be deleted.</p>"),p._flBo(k,"Delete","warning",!0,!1,function(){d.deleteTab(d.selectedTabId);d.changeMadeToPanel()}))}})};f.loadTabDetailsTab=function(a,b,d){this.selectedDetailsTab=a;var c=this.tuix.items[b],e=this.loadFields("tab_details/"+a,this.tuix.tab_details.tabs[a].fields,c);formattedFields=this.formatFieldDetails(e,c,"tab",this.selectedDetailsTab);sortedFields=
this.sortFields(formattedFields,c);c="";if(!_._isEm(d))for(d=this.sortErrors(d),e=0;e<d.length;e++)c+='<p class="error">'+d[e]+"</p>";c+=this.getTUIXFieldsHTML(sortedFields);$("#organizer_tab_details_form").html(c);$("#organizer_tab_details_tabs .tab").removeClass("on");$("#field_tab__"+a).addClass("on");_._isEm(d)||$("#organizer_tab_details_form").effect({effect:"bounce",duration:125,direction:"right",times:2,distance:5,mode:"effect"});var n=this;if("details"==a)$("#field__tab_label").on("keyup",
function(){var a=n.getTabLabel($(this).val());$(v+"tab_details_header_content .field_name h5, #organizer_form_tab_"+b+" span").text(a)})};f.formatFieldDetails=function(a,b,d,c){if("field"==d)if("details"==c)b.tuix_type&&(d=this.getFieldReadableType(this.currentTabId,b.id,!0),a.message.snippet.html='This is a field of type "'+d+"\". You cannot edit this field's details."),(d=a.values_source._value)&&this.tuix.centralised_lists.values[d]&&(d=this.tuix.centralised_lists.values[d],d.info.can_filter?a.values_source_filter.label=
d.info.filter_label:a.values_source_filter._hidden=!0),b.is_system_field&&(a.is_protected.note_below="System fields cannot be deleted",a.is_protected._disabled=!0,a.is_protected._value=!0),-1!=["editor","textarea","file_picker"].indexOf(b.type)&&(a.include_in_export.note_below="You cannot export this kind of field",a.include_in_export._disabled=!0,a.include_in_export._value=!1),b.is_system_field&&!b.allow_admin_to_change_visibility&&(a.admin_box_visibility.note_below="Only specific system fields marked with a special property can have their visibility changed.",
a.admin_box_visibility._disabled=!0);else if("organizer"==c)b.allow_admin_to_change_visibility||(a.hide_in_organizer.note_below="Only specific system fields marked with a special property can have their visibility changed.",a.hide_in_organizer._disabled=!0,a.hide_in_organizer._value=!1),-1!="checkbox group radios select dataset_select dataset_picker file_picker centralised_radios centralised_select".split(" ").indexOf(b.type)&&(a.create_index._value="index",a.create_index._disabled=!0);else if("values"==
c)if(b.is_system_field)a.message.snippet.html="You cannot change the values of a system field.";else if("centralised_radios"==b.type||"centralised_select"==b.type)a.message.snippet.html="You cannot change the values of a centralised list.";return a};f.fieldDetailsChanged=function(a,b){a=a.split("/");var d=a[0],c=a[1],e,n;c&&d&&this.tuix[d]&&this.tuix[d].tabs[c]&&this.tuix[d].tabs[c].fields[b]&&(this.changeMadeToPanel(),e=this.tuix[d].tabs[c].fields[b],e.format_onchange&&("field_details"==d?(e=this.tuix.items[this.currentTabId].fields[this.selectedFieldId],
this.saveItemTUIXTab(d,this.selectedDetailsTab,e),this.loadFieldDetailsTab(this.selectedDetailsTab,this.selectedFieldId),"details"==c&&"values_source"==b&&((d=$("#field__values_source").val())?(d={mode:"get_centralised_lov",method:d,filter:$("#field__values_source_filter").val()},n=this,this.sendAJAXRequest(d).after(function(a){a=JSON.parse(a);n.tuix.items[n.currentTabId].fields[n.selectedFieldId].lov=a;n.loadFieldValuesListPreview(n.selectedFieldId)})):(this.tuix.items[this.currentTabId].fields[this.selectedFieldId].lov=
{},this.loadFieldValuesListPreview(this.selectedFieldId)))):"tab_details"==d&&(e=this.tuix.items[this.selectedTabId],this.saveItemTUIXTab(d,this.selectedDetailsTab,e),this.loadTabDetailsTab(this.selectedDetailsTab,this.selectedTabId))))};f.getFieldValuesList=function(a){var b=[],d=a.id,c=a.values,e=a._value,n=a._disabled;if("object"==typeof c){var h=0,k;for(k in c)if(l(c,k)){var g=c[k],g={ord:++h,name:d,label:g.label,value:k,path:a.path};k==e&&(g.selected=!0);n&&(g.disabled=!0);b.push(g)}}else if("boolean_fields"==
c)for(h in this.tuix.items){if(l(this.tuix.items,h)&&(a=this.tuix.items[h],a.fields)){var d=[],f;for(f in a.fields)l(a.fields,f)&&(g=a.fields[f],!g.type||"checkbox"!=g.type&&"group"!=g.type||g.id==this.selectedFieldId||(g={ord:g.ord,label:g.field_label,value:f},f==e&&(g.selected=!0),d.push(g)));d.sort(this.sortByOrd);d.length&&b.push({ord:a.ord,label:a.tab_label,hasChildren:!0,options:d})}}else if("centralised_lists"==c){var h=0,m;for(m in this.tuix.centralised_lists.values)l(this.tuix.centralised_lists.values,
m)&&(g=this.tuix.centralised_lists.values[m],g={ord:++h,label:g.label,value:m},m==e&&(g.selected=!0),b.push(g))}else if("datasets"==c){var h=0,p;for(p in this.tuix.datasets)l(this.tuix.datasets,p)&&(g=this.tuix.datasets[p],g={ord:++h,label:g.label,value:p},p==e&&(g.selected=!0),b.push(g))}b.sort(this.sortByOrd);return b};f.loadNewFieldsPanel=function(a){this.selectedFieldId=this.selectedTabId=!1;var b=this.microTemplate(m+"organizer_admin_box_builder_left_panel",{mode:"new_fields",use_groups_field:this.tuix.use_groups_field}),
b=$("#organizer_admin_form_builder .form_fields_palette .form_fields_palette_outer").html(b);a||b.hide().show("drop",{direction:"right"},200);$("#organizer_field_type_list_outer div.field_type_list div.field_type").draggable({connectToSortable:"#organizer_form_fields .form_section",appendTo:"#organizer_admin_form_builder",helper:"clone"})};f.loadTabsList=function(a){for(var b in this.tuix.items)if(l(this.tuix.items,b)){var d=this.tuix.items[b];b==a?d._selected=!0:delete d._selected}a={tabs:this.getOrderedTabs()};
a=this.microTemplate(m+"organizer_admin_box_builder_tabs",a);$("#organizer_form_tabs").html(a);var c=this;$("#organizer_form_tabs .tab").on("click",function(){var a=$(this).data("id");c.tuix.items[a]&&c.clickTab(a)});$("#organizer_add_new_tab").on("click",function(){c.saveCurrentOpenDetails()||(c.addNewTab(),c.changeMadeToPanel())});$("#organizer_form_tabs").sortable({axis:"x",containment:"parent",tolerance:"pointer",items:"div.sort",start:function(a,b){c.startIndex=b.item.index()},stop:function(a,
b){c.startIndex!=b.item.index()&&($("#organizer_form_tabs .tab.sort").each(function(a){var b=$(this).data("id");c.tuix.items[b].ord=a+1}),c.changeMadeToPanel())}});$("#organizer_form_tabs .tab").droppable({accept:"div.is_sortable:not(.system_field)",greedy:!0,hoverClass:"ui-state-hover",tolerance:"pointer",drop:function(a,b){var d=$(this).data("id"),f=$(b.draggable).data("id");if(d!=c.currentTabId&&!c.tuix.items[c.currentTabId].fields[f].is_system_field){var g=1,l=c.getOrderedFields(d);l.length&&
(g=l[l.length-1].ord+1);c.tuix.items[d].fields[f]=c.tuix.items[c.currentTabId].fields[f];c.tuix.items[d].fields[f].ord=g;delete c.tuix.items[c.currentTabId].fields[f];f==c.selectedFieldId&&c.loadNewFieldsPanel();c.loadFieldsList(c.currentTabId);c.changeMadeToPanel()}}})};f.addNewTab=function(){var a="__custom_tab_t"+this.maxNewCustomTab++,b=1;for(name in this.tuix.items)l(this.tuix.items,name)&&++b;this.tuix.items[a]={ord:b,name:a,tab_label:"Untitled tab",fields:{},is_new_tab:!0};this.clickTab(a,
!0)};f.clickTab=function(a,b){if(this.selectedTabId!=a&&!this.saveCurrentOpenDetails())if(this.currentTabId==a)this.selectedFieldId=!1,this.selectedTabId=a,this.selectedDetailsTab=!1,this.loadTabDetailsPanel(a);else{var d=this.tuix.items[a];if(d.record_counts_fetched||d.is_new_tab)this.clickTab2(a,b);else{var c=this;this.sendAJAXRequest({mode:"get_tab_field_record_counts",tabId:a}).after(function(e){d.record_counts_fetched=!0;if(e=JSON.parse(e))for(fieldId in e)l(e,fieldId)&&(recordCount=e[fieldId],
d.fields&&d.fields[fieldId]&&(d.fields[fieldId].record_count=recordCount));c.clickTab2(a,b)})}}};f.clickTab2=function(a,b){this.currentTabId=a;if(b)this.selectedTabId=a,this.loadTabDetailsPanel(a);else{var d=!1;this.selectedFieldId||this.selectedTabId||(d=!0);this.loadNewFieldsPanel(d)}this.selectedFieldId=!1;this.loadTabsList(a);this.loadFieldsList(a)};f.clickField=function(a){this.selectedFieldId==a||this.saveCurrentOpenDetails()||(this.highlightField(a),this.selectedFieldId=a,this.selectedDetailsTab=
this.selectedTabId=!1,this.loadFieldDetailsPanel(a))};f.loadFieldsList=function(a){a={fields:this.getOrderedFields(a,!0,!0)};a=this.microTemplate(m+"organizer_admin_box_builder_section",a);$("#organizer_form_fields").html(a);var b=this;$("#organizer_form_fields div.form_field").on("click",function(){var a=$(this).data("id");b.tuix.items[b.currentTabId].fields[a]&&b.clickField(a)});$("#organizer_form_fields .form_section").sortable({items:"div.is_sortable",tolerance:"pointer",placeholder:"preview",
receive:function(a,c){$(this).find("div.field_type").each(function(){var a=$(this).data("type"),c=1,d=$(this).prev().data("id");d&&b.tuix.items[b.currentTabId].fields[d]&&(c=b.tuix.items[b.currentTabId].fields[d].ord+1);b.addNewField(a,c);b.changeMadeToPanel()})},start:function(a,c){b.startIndex=c.item.index()},stop:function(a,c){b.startIndex!=c.item.index()&&($("#organizer_form_fields div.is_sortable").each(function(a){var c=$(this).data("id");b.tuix.items[b.currentTabId].fields[c].ord=a+1}),b.changeMadeToPanel())}});
$("#organizer_form_fields .delete_icon").on("click",function(a){a.stopPropagation();var c=$(this).data("id");b.tuix.items[b.currentTabId].fields[c]&&(b.saveCurrentOpenDetails(!0),a=b.tuix.items[b.currentTabId].fields[c],a.is_protected?(message="<p>This field is protected, and might be important to your site!</p>",message+="<p>If you're sure you want to delete this field then first unprotect it.</p>",p._flBo(message,!0,"warning",!0)):(a.record_count&&1<=a.record_count?(message="<p>This field contains data on "+
a.record_count+" record"+(1==a.record_count?"":"s")+".</p>",message+="<p>When you save changes to this dataset, that data will be deleted.</p>"):message="<p>This field doesn't contain any data for any user/contact records.</p>",message+="<p>Delete this dataset field?</p>",p._flBo(message,"Delete","warning",!0,!1,function(){b.deleteField(c)})))})};f.deleteTab=function(a){for(var b=this.getOrderedTabs(),d=0,c=0;c<b.length;c++)if(b[c].name==a){d=0<c?c-1:1;this.deletedTabs.push(a);if(this.tuix.items[a].fields)for(var e in this.tuix.items[a].fields)l(this.tuix.items[a].fields,
e)&&(field=this.tuix.items[a].fields[e],this.deletedFields.push(e));delete this.tuix.items[a];this.clickTab(b[d].name)}};f.deleteField=function(a){tabId=this.currentTabId;if(this.tuix.items[tabId].fields[a]){this.changeMadeToPanel();this.deletedFields.push(a);for(var b=this.tuix.items[tabId].fields[a],d=this.getOrderedFields(tabId,!1,!0),c=!1,e=!1,f=e=!1,h=0;h<d.length;h++)if(d[h].id==b.id&&(c=h),!1!==c)if(0<c){f=c-1;e=d[c-1];break}else if(a!=d[h].id){f=h;e=d[h];break}delete this.tuix.items[tabId].fields[a];
e=e._fields&&e._fields.length?f<c?e._fields[e._fields.length-1].id:e._fields[0].id:e.id;this.loadFieldsList(tabId);e?this.clickField(e):this.loadNewFieldsPanel()}};f.addNewField=function(a,b){var d="t"+this.maxNewCustomField++,c={id:d,type:a,ord:b,field_label:"Untitled",is_new_field:!0};if("checkboxes"==a||"radios"==a||"select"==a){c.lov={};for(var e=1;3>=e;e++)this.addFieldValue(c,"Option "+e)}for(var f in this.tuix.items[this.currentTabId].fields)l(this.tuix.items[this.currentTabId].fields,f)&&
(e=this.tuix.items[this.currentTabId].fields[f],e.ord>=b&&e.ord++);this.tuix.items[this.currentTabId].fields[d]=c;this.loadFieldsList(this.currentTabId);this.clickField(d)};f.getOrderedTabs=function(){var a=[],b;for(b in this.tuix.items)l(this.tuix.items,b)&&a.push(this.tuix.items[b]);a.sort(this.sortByOrd);return a};f.getOrderedFields=function(a,b,d){var c=[],e=[],f={},h,k,g,m;if(this.tuix.items[a]&&this.tuix.items[a].fields)for(h in this.tuix.items[a].fields)l(this.tuix.items[a].fields,h)&&(k=this.tuix.items[a].fields[h],
g=_._cl(k),b&&(g.lov=this.getOrderedFieldValues(a,h,!0)),d&&k.grouping_name?(g._fields=[],f[k.grouping_name]=g):d&&k.grouping?e.push(g):(g._isSortable=!0,c.push(g)));if(0<e.length)for(a=0;a<e.length;a++)f[e[a].grouping]&&f[e[a].grouping]._fields.push(e[a]);for(m in f)l(f,m)&&(e=f[m],e._fields.sort(this.sortByOrd),e._fields.length&&(e._isSortable=!0,c.push(e)));c.sort(this.sortByOrd);return c};f.getOrderedFieldValues=function(a,b,d){var c=[],e,f;if(this.tuix.items[a]&&this.tuix.items[a].fields&&this.tuix.items[a].fields[b]&&
this.tuix.items[a].fields[b].lov){for(e in this.tuix.items[a].fields[b].lov)l(this.tuix.items[a].fields[b].lov,e)&&(f=this.tuix.items[a].fields[b].lov[e],c.push(f));a=this.tuix.items[a].fields[b].type;!d||"select"!=a&&"centralised_select"!=a||c.push({id:"empty_value",label:"-- Select --",ord:-1})}c.sort(this.sortByOrd);return c};f.changeMadeToPanel=function(){this.changeDetected||(this.changeDetected=!0,r.onbeforeunload=function(){return"You are currently editing this dataset. If you leave now you will lose any unsaved changes."},
q._dI("Please either save your changes, or click Reset to discard them, before exiting the form editor."),q._sB())};f.saveChanges=function(){var a=this,b={mode:"save",data:JSON.stringify(this.tuix.items),deletedTabs:JSON.stringify(this.deletedTabs),deletedFields:JSON.stringify(this.deletedFields),currentTabId:this.currentTabId};this.selectedTabId&&(b.selectedTabId=this.selectedTabId);this.selectedFieldId&&(b.selectedFieldId=this.selectedFieldId);this.sendAJAXRequest(b).after(function(b){if(b){b=JSON.parse(b);
if(b.errors){for(var c="",e=0;e<b.errors.length;e++)c+=b.errors[e]+"<br>";c&&p._flBo(c)}a.currentTabId=b.currentTabId;a.selectedTabId=b.selectedTabId;a.selectedFieldId=b.selectedFieldId}p._nDS();r.onbeforeunload=!1;q._eI();a.changeDetected=!1;a.changesSaved=!0;q._r()})}},zenarioO.panelTypes);
