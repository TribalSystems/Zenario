var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(k){var h=0;return function(){return h<k.length?{done:!1,value:k[h++]}:{done:!0}}};$jscomp.arrayIterator=function(k){return{next:$jscomp.arrayIteratorImpl(k)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(k,h,m){if(k==Array.prototype||k==Object.prototype)return k;k[h]=m.value;return k};$jscomp.getGlobal=function(k){k=["object"==typeof globalThis&&globalThis,k,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var h=0;h<k.length;++h){var m=k[h];if(m&&m.Math==Math)return m}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(k,h,m){if(!m||null!=k){m=$jscomp.propertyToPolyfillSymbol[h];if(null==m)return k[h];m=k[m];return void 0!==m?m:k[h]}};
$jscomp.polyfill=function(k,h,m,n){h&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(k,h,m,n):$jscomp.polyfillUnisolated(k,h,m,n))};$jscomp.polyfillUnisolated=function(k,h,m,n){m=$jscomp.global;k=k.split(".");for(n=0;n<k.length-1;n++){var q=k[n];if(!(q in m))return;m=m[q]}k=k[k.length-1];n=m[k];h=h(n);h!=n&&null!=h&&$jscomp.defineProperty(m,k,{configurable:!0,writable:!0,value:h})};
$jscomp.polyfillIsolated=function(k,h,m,n){var q=k.split(".");k=1===q.length;n=q[0];n=!k&&n in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var u=0;u<q.length-1;u++){var x=q[u];if(!(x in n))return;n=n[x]}q=q[q.length-1];m=$jscomp.IS_SYMBOL_NATIVE&&"es6"===m?n[q]:null;h=h(m);null!=h&&(k?$jscomp.defineProperty($jscomp.polyfills,q,{configurable:!0,writable:!0,value:h}):h!==m&&(void 0===$jscomp.propertyToPolyfillSymbol[q]&&(m=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[q]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(q):$jscomp.POLYFILL_PREFIX+m+"$"+q),$jscomp.defineProperty(n,$jscomp.propertyToPolyfillSymbol[q],{configurable:!0,writable:!0,value:h})))};$jscomp.initSymbol=function(){};$jscomp.iteratorPrototype=function(k){k={next:k};k[Symbol.iterator]=function(){return this};return k};
$jscomp.iteratorFromArray=function(k,h){k instanceof String&&(k+="");var m=0,n=!1,q={next:function(){if(!n&&m<k.length){var u=m++;return{value:h(u,k[u]),done:!1}}n=!0;return{done:!0,value:void 0}}};q[Symbol.iterator]=function(){return q};return q};$jscomp.polyfill("Array.prototype.values",function(k){return k?k:function(){return $jscomp.iteratorFromArray(this,function(h,m){return m})}},"es8","es3");
zenario.lib(function(k,h,m,n,q,u,x,t,A,D,E,w,F,y,G,H,I,J,K,B,C,v,z){h=C(z.admin_box_builder=B(z.form_builder_base_class));h.showPanel=function(b,a,c){b.html("").hide();c.html("").show();b=this.getMainPanelHTML();a.html(b).show();this.currentPageId=this.currentPageId?this.currentPageId:!1;this.editingThing=this.editingThing?this.editingThing:!1;this.editingThingId=this.editingThingId?this.editingThingId:!1;this.editingThingTUIXTabId=this.editingThingTUIXTabId?this.editingThingTUIXTabId:!1;this.deletedPages=
[];this.deletedFields=[];this.deletedValues=[];this.pagesReordered=this.changeMadeOnPanel=!1;this.newItemCount=0;this.fixTUIXData();this.loadPagesList();this.loadFieldsList(this.currentPageId);"field"==this.editingThing?this.openFieldEdit(this.editingThingId,this.editingThingTUIXTabId,!0):"page"==this.editingThing?this.openPageEdit(this.editingThingId,this.editingThingTUIXTabId,!0):this.loadNewFieldsPanel(!0);this.changesSaved&&(this.changesSaved=!1,t.toast({message_type:"success",message:"Your changes have been saved!"}))};
h.fixTUIXData=function(){for(var b in this.tuix.dataset_fields_in_forms)this.tuix.dataset_fields_in_forms[b]=A._mgu(this.tuix.dataset_fields_in_forms[b])};h.getMainPanelHTML=function(){return this.microTemplate("zenario_organizer_admin_box_builder",{dataset_label:this.tuix.dataset.label})};h.openEdit=function(b,a,c,d){var e=this,f=e.getItem(b,a),g=e.getTUIXModeForItemType(b);g=e.tuix[g];var l={hide_tab_bar:g.hide_tab_bar,is_system_field:f.is_system_field};"page"==b?(l.mode="edit_page",l.label=e.formatPageLabel(f.label)):
"field"==b&&(l.mode="edit_field",l.label=f.label,l.record_count="("+(f.record_count?f.record_count:0)+" record"+(1==f.record_count?"":"s")+")",l.type=e.getFieldReadableType(f.type),f.is_system_field&&(l.type+=", system field"));var p=e.microTemplate("zenario_organizer_admin_box_builder_left_panel",l);l=$("#organizer_admin_form_builder .form_fields_palette .form_fields_palette_outer").html(p);f=e.getTUIXTabs(g,c,f);c=e.editingThingTUIXTabId;p=e.getTUIXTabsHTML(f);$("#organizer_field_details_tabs").html(p);
e.openItemTUIXTab(b,a,c);d||l.hide().show("drop",{direction:"left"},200);$("#organizer_field_details_tabs .tab").on("click",function(){var r=$(this).data("id");r&&r!=c&&e.saveCurrentOpenDetails()&&e.openEdit(b,a,r,!0)});$("#organizer_field_details_inner span.add_new_field").on("click",function(){e.saveCurrentOpenDetails()&&(e.loadNewFieldsPanel(),e.loadFieldsList(e.currentPageId))})};h.addTUIXTabEvents=function(b,a,c){var d=this,e=d.getItem(b,a);if("page"==b)$("#organizer_remove_form_tab").on("click",
function(g){if(!e.is_system_field){var l=!1;g=0;for(var p=d.getOrderedFields(a),r=0;r<p.length;r++)p[r].is_protected&&(l||(l=p[r]),g++);g?(l='<p>This tab has the protected field "'+l.label+'"',g--,0<g&&(l+=" and "+g+" other protected field"+(1==g?"":"s")),t._g82(l+" on it and cannot be deleted.</p>",!0,"warning",!0)):(l="<p>Are you sure you want to delete this tab?</p>",0<p.length&&(l+="<p>All fields on this tab will also be deleted.</p>"),t._g82(l,"Delete tab","warning",!0,!1,k,k,function(){d.deletePage(a);
d.changeMadeToPanel()}))}}),$("#field__label").on("keyup",function(){var g=d.formatPageLabel($(this).val());$("#zenario_field_details_header_content .field_name h5, #organizer_form_tab_"+a+" span").text(g)});else if("field"==b)if("details"==c)$("#field__label").on("keyup",function(){$("#organizer_form_field_"+a+" .label, #zenario_field_details_header_content .field_name h5").text($(this).val());if(e._just_added){var g=$(this).val().toLowerCase().r(/[\s-]+/g,"_").r(/[^a-z_0-9]/g,"");$("#field__db_column").val(g)}}),
$("#field__note_below").on("keyup",function(){var g=$(this).val().trim();$("#organizer_form_field_note_below_"+a+" div.zenario_note_content").text(g);$("#organizer_form_field_note_below_"+a).toggle(""!==g)}),$("#field__side_note").on("keyup",function(){var g=$(this).val().trim();$("#organizer_form_field_side_note_"+a+" div.zenario_note_content").text(g);$("#organizer_form_field_side_note_"+a).toggle(""!==g)});else if("values"==c){var f=d.tuix[d.getTUIXModeForItemType(b)];$("#field_values_list").sortable({containment:"parent",
tolerance:"pointer",axis:"y",start:function(g,l){d.startIndex=l.item.index()},stop:function(g,l){d.startIndex!=l.item.index()&&(d.saveFieldListOfValues(a),d.loadFieldValuesListPreview(a),d.changeMadeToPanel())}});$("#field_values_list input").on("keyup",function(){var g=$(this).data("id");$("#organizer_field_value_"+g+" label").text($(this).val());d.changeMadeToPanel()});$("#organizer_add_a_field_value").on("click",function(){d.addFieldValue(e);d.saveTUIXTab(f,c,e);d.openItemTUIXTab(b,a,c);d.loadFieldValuesListPreview(a);
d.changeMadeToPanel()});$("#field_values_list .delete_icon").on("click",function(){var g=$(this).data("id");e.lov[g]&&(d.deletedValues.push(g),delete e.lov[g]);d.saveTUIXTab(f,c,e);d.openItemTUIXTab(b,a,c);d.loadFieldValuesListPreview(a);d.changeMadeToPanel()})}};h.loadNewFieldsPanel=function(b){this.editingThing=!1;var a=this.microTemplate("zenario_organizer_admin_box_builder_left_panel",{mode:"new_fields",use_groups_field:this.tuix.use_groups_field});a=$("#organizer_admin_form_builder .form_fields_palette .form_fields_palette_outer").html(a);
b||a.hide().show("drop",{direction:"right"},200);$("#organizer_field_type_list_outer div.field_type_list div.field_type").draggable({connectToSortable:"#organizer_form_fields .form_section",appendTo:"#organizer_admin_form_builder",helper:"clone"})};h.getTUIXModeForItemType=function(b){return"page"==b?"dataset_page_details":"field"==b?"dataset_field_details":!1};h.getFieldReadableType=function(b,a,c){switch(b){case "group":return"Group";case "checkbox":return"Checkbox";case "consent":return"Consent";
case "checkboxes":return"Checkbox group";case "date":return"Date";case "editor":return"Editor";case "radios":return"Radios";case "centralised_radios":return"Centralised radios";case "select":return"Select";case "centralised_select":return"Centralised select";case "text":return"Text";case "textarea":return"Textarea";case "url":return"URL";case "other_system_field":if(c)switch(a){case "html_snippet":return"HTML snippet";case "pick_items":return"Item picker";case "upload":return"Upload";case "toggle":return"Toggle";
case "grouping":return"Grouping";case "submit":return"Submit";case "hidden":return"Hidden";default:return this.getFieldReadableType(a)}else return"Other system field";case "dataset_select":return"Dataset select";case "dataset_picker":return"Dataset picker";case "file_picker":return"File picker";case "repeat_start":return"Start of repeating section";case "repeat_end":return"End of repeating section";default:return"Unknown"}};h.saveCurrentOpenDetails=function(b){var a=[],c=this.editingThing,d=this.editingThingId;
if(c&&d&&this.editingThingTUIXTabId){var e=this.getTUIXModeForItemType(c),f=this.tuix[e],g=this.getItem(c,d);if(g){this.saveTUIXTab(f,this.editingThingTUIXTabId,g);if(b)a=this.getDeleteErrors(c,d);else{b=this.getTUIXTags(e,g,c);this.validateTUIX(c,g,this.editingThingTUIXTabId,b);for(var l in b.tabs)if(v(b.tabs,l)){g=b.tabs[l];for(var p in g.fields)v(g.fields,p)&&(e=g.fields[p],e.error&&a.push(e.error))}}a.length&&this.openItemTUIXTab(c,d,this.editingThingTUIXTabId,a)}}return 0==a.length};h.displayPageFieldOrderErrors=
function(){if(!this.getItem("page",this.currentPageId))return!0;for(var b=[],a=this.getOrderedFields(this.currentPageId),c="checkbox group date radios select text textarea url".split(" "),d=!1,e=!1,f=0;f<a.length;f++){var g=a[f];if("repeat_start"!=g.type||d)if("repeat_end"==g.type)d?d=e=!1:b.push("Repeat ends must be placed after repeat starts.");else{if(d&&-1==c.indexOf(g.type)&&b.push('Field type "'+this.getFieldReadableType(g.type).toLowerCase()+'" is not allowed in a repeat block.'),this.tuix.dataset_fields_in_forms[g.id]&&
!d&&g.repeat_start_id&&g.repeat_start_id!=e){for(var l=this.tuix.dataset_fields_in_forms[g.id],p=[],r=0;r<l.length;r++)this.tuix.forms_with_dataset_fields[l[r]]&&p.push(this.tuix.forms_with_dataset_fields[l[r]]);b.push('The field "'+g.label+'" is used on '+l.length+" form"+(1==l.length?"":"s")+" ("+p.join(", ")+") in a dataset repeat block. You must remove this repeat block from forms before this field can be moved out.")}}else e=g.id,d=!0}a=0<b.length;c=$("#organizer_fields_error");c.html("");for(f=
0;f<b.length;f++)c.append('<p class="error">'+b[f]+"</p>");c.toggle(a);return!a};h.getDeleteErrors=function(b,a){var c=[];if("field"==b){this.getItem(b,a);var d=this.getOrderedPages();for(b=0;b<d.length;b++)d[b].parent_field_id==a&&c.push('Unable to delete the field because the tab "'+d[b].label+'" depends on it.');d=this.getOrderedFields();for(b=0;b<d.length;b++)a!=d[b].id&&a==d[b].parent_id&&c.push('Unable to delete the field because the field "'+d[b].label+'" depends on it.');if(this.tuix.dataset_fields_in_forms[a]){a=
this.tuix.dataset_fields_in_forms[a];d=[];for(b=0;b<a.length;b++)this.tuix.forms_with_dataset_fields[a[b]]&&d.push(this.tuix.forms_with_dataset_fields[a[b]]);c.push("This field is used on "+a.length+" form"+(1==a.length?"":"s")+" ("+d.join(", ")+"). You must remove this field from all forms before you can delete it.")}}return c};h.formatTUIX=function(b,a,c,d,e){var f=this;if("field"==b)if("details"==c){a.tuix_type&&(b=f.getFieldReadableType(a.type,a.tuix_type,!0),d.tabs[c].fields.message.snippet.html=
'This is a field of type "'+b+"\". You cannot edit this field's details.");if(a.is_protected||a.is_system_field)d.tabs[c].fields.db_column.readonly=!0;a.values_source&&f.tuix.centralised_lists.values[a.values_source]&&(b=f.tuix.centralised_lists.values[a.values_source],b.info.can_filter?d.tabs[c].fields.values_source_filter.label=b.info.filter_label:d.tabs[c].fields.values_source_filter.hidden=!0);"values_source"==e&&(a.values_source?(e={mode:"get_centralised_lov",method:a.values_source},f.tuix.centralised_lists.values[a.values_source].info.can_filter&&
(e.filter=a.values_source_filter),f.sendAJAXRequest(e,function(g){a.lov=g;f.loadFieldValuesListPreview(a.id)})):(a.lov={},f.loadFieldValuesListPreview(a.id)));a.is_system_field&&(d.tabs[c].fields.is_protected.label="Protected/system field",d.tabs[c].fields.is_protected.note_below="This is a system field and cannot be deleted or edited.",d.tabs[c].fields.is_protected.readonly=!0,d.tabs[c].fields.is_protected.value=!0);f.tuix.priv_protect||(d.tabs[c].fields.is_protected.readonly=!0);-1!=["editor","textarea",
"file_picker"].indexOf(a.type)&&(d.tabs[c].fields.include_in_export.note_below="You cannot export this kind of field",d.tabs[c].fields.include_in_export.readonly=!0,d.tabs[c].fields.include_in_export.value=!1);a.is_system_field&&!a.allow_admin_to_change_visibility&&(d.tabs[c].fields.admin_box_visibility.note_below="Only specific system fields marked with a special property can have their visibility changed.",d.tabs[c].fields.admin_box_visibility.hidden=!0);"repeat_start"==a.type&&(d.tabs[c].fields.label.label=
"Section heading:",d.tabs[c].fields.label.note_below="This will be the heading at the start of the repeating section.");f.loadFieldsList(f.currentPageId)}else if("organizer"==c)a.allow_admin_to_change_visibility||(d.tabs[c].fields.hide_in_organizer.note_below="Only specific system fields marked with a special property can have their visibility changed.",d.tabs[c].fields.hide_in_organizer.readonly=!0,d.tabs[c].fields.hide_in_organizer.value=!1),-1!="checkbox group radios select dataset_select dataset_picker file_picker centralised_radios centralised_select".split(" ").indexOf(a.type)&&
(d.tabs[c].fields.create_index.value="index",d.tabs[c].fields.create_index.readonly=!0);else if("values"==c)if(a.is_system_field)d.tabs[c].fields.message.snippet.html="You cannot change the values of a system field.";else if("centralised_radios"==a.type||"centralised_select"==a.type)d.tabs[c].fields.message.snippet.html="You cannot change the values of a centralised list."};h.validateTUIX=function(b,a,c,d){if("page"==b)"details"!=c||a.label.trim()||(d.tabs[c].fields.label.error="Please enter a label");
else if("field"==b)if("details"==c){if(!a.is_system_field){if("repeat_start"!=a.type)if(a.db_column)if(a.db_column.m(/[^a-z0-9_-]/))d.tabs[c].fields.db_column.error="Code name can only use characters a-z 0-9 _-.";else{b=!0;for(var e=this.getOrderedFields(),f=0;f<e.length;f++)if(e[f].id!=a.id&&e[f].db_column==a.db_column){b=!1;break}b?a.db_column.m(/__(\d+|rows)$/)&&(d.tabs[c].fields.db_column.error="That code name is invalid."):d.tabs[c].fields.db_column.error='The code name "'+a.db_column+'" is already in use.'}else d.tabs[c].fields.db_column.error=
"Please enter a code name.";a.admin_box_visibility&&"show_on_condition"==a.admin_box_visibility&&!a.parent_id&&(d.tabs[c].fields.parent_id.error="Please select a conditional display field.");"file_picker"!=a.type||a.store_file||(d.tabs[c].fields.store_file.error="Please select a file storage method.");"centralised_radios"!=a.type&&"centralised_select"!=a.type||a.values_source||(d.tabs[c].fields.values_source.error="Please select a source for this list.");if("repeat_start"==a.type)if(a.min_rows?+a.min_rows!=
a.min_rows?d.tabs[c].fields.min_rows.error="Please a valid number for mininum rows.":1>a.min_rows||10<a.min_rows?d.tabs[c].fields.min_rows.error="Mininum rows must be between 1 and 10.":+a.min_rows>+a.max_rows&&(d.tabs[c].fields.min_rows.error="Minimum rows cannot be greater than maximum rows."):d.tabs[c].fields.min_rows.error="Please enter the minimum rows.",!a.max_rows)d.tabs[c].fields.max_rows.error="Please enter the maximum rows.";else if(+a.max_rows!=a.max_rows)d.tabs[c].fields.max_rows.error=
"Please a valid number for maximum rows.";else if(2>a.max_rows||20<a.max_rows)d.tabs[c].fields.max_rows.error="Maximum rows must be between 2 and 20."}}else"validation"!=c||a.is_system_field||(a.required&&!a.required_message&&(d.tabs[c].fields.required_message.error="Please enter a message if not complete."),a.validation&&"none"!=a.validation&&!a.validation_message&&(d.tabs[c].fields.validation_message.error="Please enter a message if not valid."))};h.getTUIXFieldCustomValues=function(b){var a={};
if("centralised_lists"==b)a=JSON.parse(JSON.stringify(this.tuix.centralised_lists.values));else if("datasets"==b)a=JSON.parse(JSON.stringify(this.tuix.datasets));else if("boolean_fields"==b){b=this.getOrderedPages();for(var c=1<b.length,d=0,e=0;e<b.length;e++)for(var f=b[e],g=this.getOrderedFields(b[e].id),l=0;l<g.length;l++){var p=g[l];if(!("checkbox"!=p.type&&"group"!=p.type||"field"==this.editingThing&&p.id==this.editingThingId)&&(a[p.id]={label:p.label,ord:++d},c)){var r="page_"+f.id;a[p.id].parent=
r;a[r]||(a[r]={label:f.label,ord:++d})}}}return a};h.loadPagesList=function(){var b=this,a=b.getOrderedPages();!b.currentPageId&&0<a.length&&(b.currentPageId=a[0].id);for(var c=0;c<a.length;c++)b.currentPageId==a[c].id&&(a[c]._is_current_page=!0),a[c].label=b.formatPageLabel(a[c].label);a=b.microTemplate("zenario_organizer_admin_box_builder_tabs",{pages:a});$("#organizer_form_tabs").html(a);$("#organizer_form_tabs .tab").on("click",function(){var d=$(this).data("id");b.tuix.pages[d]&&b.clickPage(d)});
$("#organizer_add_new_tab").on("click",function(){if(b.saveCurrentOpenDetails()){var d=b.createPage();b.clickPage(d,!0);b.changeMadeToPanel()}});$("#organizer_form_tabs").sortable({containment:"parent",tolerance:"pointer",items:"div.sort",start:function(d,e){b.startIndex=e.item.index()},stop:function(d,e){b.startIndex!=e.item.index()&&($("#organizer_form_tabs .tab.sort").each(function(f){var g=$(this).data("id");b.tuix.pages[g].ord=f+1}),b.pagesReordered=!0,b.changeMadeToPanel())}});$("#organizer_form_tabs .tab").droppable({accept:"div.is_sortable:not(.system_field)",
greedy:!0,hoverClass:"ui-state-hover",tolerance:"pointer",drop:function(d,e){b.saveCurrentOpenDetails()&&(d=$(this).data("id"),e=$(e.draggable).data("id"),b.moveFieldToPage(b.currentPageId,d,e),"field"==b.editingThing&&b.editingThingId==e&&b.loadNewFieldsPanel(),b.loadFieldsList(b.currentPageId))}})};h.createPage=function(){var b="t"+this.newItemCount++,a=1,c=this.getOrderedPages();c.length&&(a=c[c.length-1].ord+1);c={};c.id=b;c.ord=a;c._just_added=!0;c.fields={};c.label="Untitled page";for(var d in this.tuix.dataset_page_details.tabs)if(v(this.tuix.dataset_page_details.tabs,
d)&&(a=this.tuix.dataset_page_details.tabs[d],a.fields))for(var e in a.fields)if(v(a.fields,e)){var f=a.fields[e];y(f.value)&&!y(c[e])&&(c[e]=f.value)}this.tuix.pages[b]=c;return b};h.clickPage=function(b,a){var c=this;if(("page"!=c.editingThing||c.editingThingId!=b)&&c.saveCurrentOpenDetails()&&c.displayPageFieldOrderErrors())if(c.currentPageId!=b){var d=!c.editingThing;c.currentPageId=b;c.editingThing=!1;c.loadPagesList();c.loadFieldsList(b);c.loadNewFieldsPanel(d);var e=c.getItem("page",b);a?c.clickPage(b):
e.record_counts_fetched||c.sendAJAXRequest({mode:"get_tab_field_record_counts",pageId:b},function(f){e.record_counts_fetched=!0;if(f)for(var g in f)if(v(f,g)){var l=f[g],p=c.getItem("field",g);p&&(p.record_count=l)}})}else c.editingThing="page",c.editingThingId=b,c.editingThingTUIXTabId=!1,c.openPageEdit(b)};h.clickField=function(b,a){if(("field"!=this.editingThing||this.editingThingId!=b)&&"repeat_end"!=this.tuix.items[b].type&&this.saveCurrentOpenDetails()){var c=this.getItem("field",b);!a&&c._just_added&&
delete c._just_added;this.editingThing="field";this.editingThingId=b;this.editingThingTUIXTabId=!1;this.loadFieldsList(this.currentPageId);this.openFieldEdit(b)}};h.loadFieldsList=function(b){var a=this,c={fields:a.getOrderedMergeFieldsForFields(b)};c=a.microTemplate("zenario_organizer_admin_box_builder_section",c);$("#organizer_form_fields").html(c);$("#organizer_form_fields div.form_field").on("click",function(){var d=$(this).data("id");a.tuix.items[d]&&a.clickField(d)});$("#organizer_form_fields .form_section").sortable({items:"div.is_sortable",
tolerance:"pointer",placeholder:"preview",receive:function(d,e){$(this).find("div.field_type").each(function(){var f=$(this).data("type"),g=.1,l=$(this).prev().data("id");l&&a.tuix.items[l]?g=a.tuix.items[l].ord+.1:(l=$(this).next().data("id"))&&a.tuix.items[l]&&(g=a.tuix.items[l].ord-.1);f=a.createField(f,g);a.clickField(f,!0);a.updateFieldOrds()})},start:function(d,e){a.startIndex=e.item.index()},stop:function(d,e){a.startIndex!=e.item.index()&&(a.tuix.pages[b].fields_reordered=!0,a.updateFieldOrds(),
a.loadFieldsList(b))}});$("#organizer_form_fields .delete_icon").on("click",function(d){d.stopPropagation();var e=$(this).data("id");a.saveCurrentOpenDetails(!0)&&(d=a.tuix.items[e],d.is_protected?t._g82("<p>This field is protected, and might be important to your site!</p><p>If you're sure you want to delete this field then first unprotect it.</p>",!0,"warning",!0):(d.record_count&&1<=d.record_count?(d="<p><strong>This field contains data on "+d.record_count+" record"+(1==d.record_count?"":"s")+".</strong></p>",
d+="<p>When you save changes to this dataset, this data will be deleted.</p>"):d="<p>This field isn't populated in any data records.</p>",t._g82(d+"<p>Delete this dataset field?</p>","Delete dataset field","warning",!0,!1,k,k,function(){a.deleteField(e,!0)})))})};h.checkParentHasParent=function(b,a){b=_.clone(this.tuix.items[b]);var c=a;b.parent_id&&a++;c!=a&&(a=this.checkParentHasParent(b.parent_id,a));return a};h.getOrderedMergeFieldsForFields=function(b){var a=[],c=[],d={},e;for(e in this.tuix.pages[b].fields)if(v(this.tuix.pages[b].fields,
e)){var f=_.clone(this.tuix.items[e]);f.lov=this.getOrderedFieldValues(e);"show"==f.admin_box_visibility?f.indent=0:f.parent_id&&"show_on_condition"==f.admin_box_visibility&&(f.indent=1,f.indent=this.checkParentHasParent(f.parent_id,f.indent));"field"==this.editingThing&&this.editingThingId==f.id&&(f._is_current_field=!0);f.grouping_name?(f.fields=[],d[f.grouping_name]=f):f.grouping?c.push(f):(f._is_sortable=!0,a.push(f))}if(0<c.length)for(b=0;b<c.length;b++)d[c[b].grouping]&&d[c[b].grouping].fields.push(c[b]);
for(var g in d)v(d,g)&&(c=d[g],c.fields.sort(this.sortByOrd),c.fields.length&&(c._is_sortable=!0,c.fields[0].first_in_grouping=!0,a.push(c)));a.sort(this.sortByOrd);d=!1;for(b=0;b<a.length;b++)"repeat_start"==a[b].type?d=!0:"repeat_end"==a[b].type?d=!1:d&&(a[b]._is_repeat_field=!0);return a};h.updateFieldOrds=function(){var b=this;$("#organizer_form_fields div.form_field").each(function(a){var c=$(this).data("id");b.tuix.items[c].ord=a+1});b.changeMadeToPanel()};h.deletePage=function(b){var a=this.getOrderedPages();
if(!(2>a.length))for(var c=this.getOrderedFields(b),d=0;d<a.length;d++)if(a[d].id==b){for(var e=0;e<c.length;e++)this.deleteField(c[e].id);a=a[d-1]?a[d-1].id:a[d+1].id;this.deletedPages.push(b);delete this.tuix.pages[b];this.clickPage(a);this.changeMadeToPanel();break}};h.deleteField=function(b,a){var c=this.tuix.items[b];if(c){var d=this.getOrderedFields(c.page_id);if("repeat_start"==c.type){var e=this.getMatchingRepeatEnd(b);if(e){var f=this.tuix.items[e];this.deletedFields.push(e);delete this.tuix.pages[f.page_id].fields[e];
delete this.tuix.items[e]}}f=e=!1;for(var g=0;g<d.length;g++)if(d[g].id==b&&(e=g),!1!==e)if(0<e){f=d[e-1].id;break}else if(b!=d[g].id){f=d[g].id;break}f&&"repeat_end"==this.tuix.items[f].type&&(f=!1);this.deletedFields.push(b);delete this.tuix.pages[c.page_id].fields[b];delete this.tuix.items[b];this.changeMadeToPanel();a&&(this.loadFieldsList(c.page_id),f?this.clickField(f):this.loadNewFieldsPanel())}};h.createField=function(b,a){var c="t"+ ++this.newItemCount,d={};d.id=c;d.page_id=this.currentPageId;
d.type=b;d.ord=a;d.label="Untitled";d._just_added=!0;if("checkboxes"==b||"radios"==b||"select"==b)for(d.lov={},b=1;3>=b;b++)this.addFieldValue(d,"Option "+b);else"repeat_start"==b&&this.createField("repeat_end",a+.01);this.tuix.pages[this.currentPageId].fields[c]=1;this.tuix.items[c]=d;this.loadFieldsList(this.currentPageId);return c};h.changeMadeToPanel=function(){this.changeMadeOnPanel||(this.changeMadeOnPanel=!0,n.onbeforeunload=function(){return"You are currently editing this dataset. If you leave now you will lose any unsaved changes."},
w._x6q("Please either save your changes, or click Reset to discard them, before exiting the form editor."),w._96o())};h.saveChanges=function(){var b=this,a={mode:"save",pages:JSON.stringify(b.tuix.pages),fields:JSON.stringify(b.tuix.items),pagesReordered:b.pagesReordered,deletedPages:JSON.stringify(b.deletedPages),deletedFields:JSON.stringify(b.deletedFields),deletedValues:JSON.stringify(b.deletedValues),currentPageId:b.currentPageId,editingThing:b.editingThing,editingThingId:b.editingThingId};t._8nu("saving",
!0);b.sendAJAXRequest(a,function(c){t._8nu();if(c){if(c.errors){for(var d="",e=0;e<c.errors.length;e++)d+=c.errors[e]+"<br>";d&&t._g82(d)}b.currentPageId=c.currentPageId;b.editingThing=c.editingThing;b.editingThingId=c.editingThingId}n.onbeforeunload=!1;w._rj7();b.changeMadeOnPanel=!1;b.changesSaved=!0;w._131()})}},zenarioO.panelTypes);
