zenario.lib(function(t,u,e,x,y,z,h,f,A,B,r,C,D,E,F,G,H,v,w,s){e=w(s.admin_box_builder=v(s.form_builder_base_class));e.init=function(){this.saveChangesWarningMessage="You are currently editing this dataset. If you leave now you will lose any unsaved changes.";this.changingForm=!1;this.formatOnChange=["values_source"];this.formFieldsSelector="#organizer_form_sections .form_field";this.formFieldInlineButtonsSelector="#organizer_form_sections .form_field_inline_buttons"};e.getOrderedItems=function(b){var a,
d,c,p,e,k,l,m,n,f,q=[];for(a in b)if(h.has(b,a)&&(d=b[a],!d.remove)){c=_.clone(d);if(c.fields){l=[];for(p in c.fields)if(h.has(c.fields,p)&&(e=c.fields[p],!d.remove)){k=_.clone(e);if(k.lov){f=[];for(m in k.lov)h.has(k.lov,m)&&(n=k.lov[m],n.remove||f.push(n));f.sort(this.sortByOrd);k.lov=f}l.push(e)}l.sort(this.sortByOrd);c.fields=l}else if(c.lov){f=[];for(m in c.lov)h.has(c.lov,m)&&(n=c.lov[m],n.remove||f.push(n));f.sort(this.sortByOrd);c.lov=f}q.push(c)}q.sort(this.sortByOrd);return q};e.showPanel=
function(b,a,d){b.html("").hide();var c=this;b=this.getOrderedItems(this.tuix.items);var e=f.microTemplate("zenario_organizer_admin_box_builder",{items:b}),g=!1;this.currentTab=this.currentTab?this.currentTab:!1;this.currentFieldTab="details";this.maxNewCustomFieldValue=this.maxNewCustomField=this.maxNewCustomTab=1;this.current={id:!1,type:!1};this.current_db_columns=this.tuix.existing_db_columns;this.deleting=!1;a.html(e).show();this.currentTab&&!this.tuix.items[this.currentTab]&&this.currentTabOrd&&
b[this.currentTabOrd]&&(this.currentTab=b[this.currentTabOrd].name);for(i in b)h.has(b,i)&&(item=b[i],a=$("#organizer_form_tab_"+item.name),$section=$("#organizer_section_"+item.name),this.initTab(a),this.initSection($section),!1!=this.currentTab?item.name!=this.currentTab?$section.hide().sortable("disable"):a.addClass("on"):1!=item.ord?$section.hide().sortable("disable"):(a.addClass("on"),g=item.name));g&&(this.currentTab=g);this.orderedItems=b;$("#organizer_field_type_list div.field_type, #organizer_centralised_field_type_list div.field_type").draggable({connectToSortable:"#organizer_form_sections div.form_section",
helper:function(){var a=$(this).data("type");return $("<div>[---PLACEHOLDER---]</div>").data("type",a).addClass("preview preview_"+a)}});$("#organizer_form_tabs").sortable({axis:"x",containment:"parent",items:"div.sort",start:function(a,b){c.startIndex=b.item.index()},stop:function(a,b){c.startIndex!=b.item.index()&&(c.currentTabOrd=b.item.index(),c.changeMadeToPanel())}});$("#organizer_add_new_tab").on("click",function(){var a=function(a){_.isEmpty(a)&&c.addNewTab()};(cb=c.validate())?cb.after(a):
a([])});$("#organizer_form_sections div.form_field").on("click",function(){c.fieldClick($(this))});this.initDeleteButtons();d.html("").show()};e.initDeleteButtons=function(){var b=this;$("#organizer_form_sections .delete_icon").off().on("click",function(a){b.deleting="field";f.showMessage("Are you sure you want to delete this Field?","Delete","warning",!0);b.listenForDelete($(this).data("id"));a.stopPropagation()})};e.listenForDelete=function(b){var a=this;$("#zenario_fbMessageButtons input.submit_selected").on("click",
function(){setTimeout(function(){"tab"==a.deleting?a.deleteTab():(a.deleting="field")&&a.deleteField(b);a.deleting=!1})})};e.deleteTab=function(){var b,a;this.tuix.items[this.current.id]={remove:!0};b=$("#organizer_form_tab_"+this.current.id);a=b.prev();0==a.length&&(a=b.next());b.remove();this.changeMadeToPanel();1==a.length&&this.tabClick(a)};e.deleteField=function(b){var a=this,d,c;b===t&&(b=this.current.id);if(!this.tuix.items[this.currentTab].fields[b]||0==this.tuix.items[this.currentTab].fields[b].is_system_field)if(this.tuix.items[this.currentTab].fields[b]=
{remove:!0},d=$("#organizer_form_field_"+b))c=this.selectNextField(d),this.changeMadeToPanel(),d.animate({height:0,opacity:0},500,function(){d.remove();!1===c&&a.showNoFieldsMessage()})};e.selectNextField=function(b){for($next=b.prev();1==$next.length;)if(this.tuix.items[this.currentTab].fields[$next.data("id")]&&this.tuix.items[this.currentTab].fields[$next.data("id")].remove)$next=$next.prev();else break;if(0==$next.length)for($next=b.next();1==$next.length;)if(this.tuix.items[this.currentTab].fields[$next.data("id")]&&
this.tuix.items[this.currentTab].fields[$next.data("id")].remove)$next=$next.next();else break;return 1==$next.length?(this.fieldClick($next),$next):!1};e.showNoFieldsMessage=function(){$("#organizer_section_"+this.currentTab).addClass("empty").html('<span class="no_fields_message">There are no fields on this tab</span>');this.showDetailsSection("organizer_field_type_list")};e.addNewTab=function(){var b="__custom_tab_t"+this.maxNewCustomTab++,a={name:b,label:"Untitled tab"},d=f.microTemplate("zenario_organizer_admin_box_builder_tab",
a);$("#organizer_add_new_tab").before(d);this.tuix.items[b]={label:"Untitled tab",is_new_tab:!0,is_system_field:0,fields:{}};d=f.microTemplate("zenario_organizer_admin_box_builder_section",a);$("#organizer_form_sections").append(d);a=$("#organizer_section_"+b);this.initSection(a);b=$("#organizer_form_tab_"+b);this.initTab(b);this.tabClick(b);this.changeMadeToPanel()};e.initTab=function(b){var a=this;b.on("click",function(){a.tabClick($(this))});b.droppable({accept:"div.form_field:not(.system_field)",
greedy:!0,hoverClass:"ui-state-hover",tolerance:"pointer",drop:function(b,c){var e=$(this).data("name"),g=$(c.draggable).data("id"),k=!0,f=function(){_.isEmpty||(k=!1)};"field"==a.current.type&&g==a.current.id&&(a.save(),(cb=a.validate())?cb.after(f):f([]));k&&setTimeout(function(){$(c.draggable).detach().appendTo("#organizer_section_"+e);a.tuix.items[e].fields[g]=a.tuix.items[a.currentTab].fields[g];delete a.tuix.items[a.currentTab].fields[g];"field"==a.current.type&&(a.current={type:"tab",id:a.currentTab},
a.tabClick($("#organizer_form_tab_"+a.currentTab)));0==_.size(a.tuix.items[a.currentTab].fields)&&a.showNoFieldsMessage();a.removeNoItemsMessage(e)})}})};e.initSection=function(b){var a=this;b.sortable({items:"div.form_field",receive:function(b,c){$(this).find("div.preview").each(function(){a.addNewField($(this))})},start:function(b,c){a.startIndex=c.item.index()},stop:function(b,c){a.startIndex!=c.item.index()&&a.changeMadeToPanel()}})};e.removeNoItemsMessage=function(b){$("#organizer_section_"+
b).removeClass("empty").find("span.no_fields_message").remove()};e.addNewField=function(b){var a="t"+this.maxNewCustomField++,d=b.data("type"),c={id:a,type:d,label:"Untitled"},e="";this.removeNoItemsMessage(this.currentTab);if(-1<$.inArray(d,["checkboxes","radios","select"])){c.lov=[];for(var g=1;3>=g;g++){var k={is_new_value:!0,id:"t"+this.maxNewCustomFieldValue++,ord:g,label:"Option "+g};c.lov[g]=k}}if("centralised_radios"==d){for(method in this.tuix.centralised_lists.values)if(h.has(this.tuix.centralised_lists.values,
method)){e=method;break}c.lov=_.toArray(this.tuix.centralised_lists.initial_lov)}d=f.microTemplate("zenario_organizer_admin_box_builder_field",c);b.replaceWith(d);$.extend(c,{is_protected:0,include_in_export:0,is_new_field:!0,just_added:!0,db_column:"",is_system_field:0,validation:"none",required:0,show_in_organizer:0,create_index:0,values_source:e,remove:!1});this.tuix.items[this.currentTab].fields[a]=c;b=$("#organizer_form_field_"+a);b.effect({effect:"highlight",duration:1E3});this.initField(b);
this.fieldClick(b)};e.tabClick=function(b){var a=this,d=function(c){_.isEmpty(c)&&($("#organizer_section_"+a.currentTab).sortable("disable"),a.currentTab=b.data("name"),a.currentTabOrd=b.index(),a.current={id:a.currentTab,type:"tab"},$("#organizer_section_"+a.currentTab).sortable("enable"),$("#organizer_form_tabs div.tab").removeClass("on"),b.addClass("on"),$("#organizer_form_sections div.form_section").hide(),values=a.tuix.items[a.currentTab]||{},a.setCurrentTabDetails(values),a.tuix.items[a.currentTab]&&
1==a.tuix.items[a.currentTab].is_system_field?$("#organizer_remove_form_tab").hide():$("#organizer_remove_form_tab").show(),a.showDetailsSection("organizer_tab_details"),$("#organizer_section_"+a.currentTab).show())};this.save();(cb=this.validate())?cb.after(d):d([])};e.setCurrentTabDetails=function(b){b=_.clone(b);b.parent_id_select_list=this.orderedItems;var a=this;html=f.microTemplate("zenario_organizer_admin_box_builder_tab_details",b);$("#organizer_tab_details_outer").html(html);$("#organizer_tab_details :input").off().on("change",
function(){a.changeMadeToPanel()});$('#organizer_tab_details input[type="text"]').on("keyup",function(){a.changeMadeToPanel()});$("#tab__label").on("keyup",function(){$("#organizer_form_tab_"+a.currentTab+" span").text($(this).val())});$("#organizer_remove_form_tab").on("click",function(){0==a.tuix.items[a.current.id].is_system_field&&(a.deleting="tab",f.showMessage("Are you sure you want to delete this Tab?<br><br>All fields on this tab will also be deleted.","Delete","warning",!0),a.listenForDelete())});
this.initAddNewFieldsButton()};e.getCurrentTabDetails=function(){var b={};b.label=$("#tab__label").val();b.parent_field_id=$("#tab__parent_field_id").val();return b};e.fieldClick=function(b){var a=this,d=function(c){_.isEmpty(c)&&(c=b.data("id"),a.current={type:"field",id:c},$(a.formFieldsSelector).removeClass("selected"),b.addClass("selected"),a.setCurrentFieldDetails(),a.showFieldDetailsSection("details",!0),$(a.formFieldInlineButtonsSelector).hide(),$("#organizer_form_field_inline_buttons_"+a.current.id).show(),
a.showDetailsSection("organizer_field_details"))};this.save();(cb=this.validate())?cb.after(d):d([])};e.setCurrentFieldDetails=function(){var b=this,a=_.clone(this.tuix.items[this.currentTab].fields[this.current.id]||{});a.dataset_label=this.tuix.dataset_label;a.is_text_field=-1<$.inArray(a.type,["date","editor","text","textarea","url"]);a.is_checkbox_field=-1<$.inArray(a.type,["group","checkbox"]);a.is_list_field=-1<$.inArray(a.type,["checkboxes","radios","centralised_radios","select","centralised_select"]);
a.show_searchable_field=a.is_text_field?a.show_in_organizer:a.show_in_organizer&&a.create_index;var d={},c=1;for(func in this.tuix.centralised_lists)h.has(this.tuix.centralised_lists,func)&&(details=this.tuix.centralised_lists[func],d[func]={ord:c++,label:details.label});a.values_source_options=this.createSelectList(d,a.values_source);d={};for(tabName in this.tuix.items)if(h.has(this.tuix.items,tabName)){tab=this.tuix.items[tabName];c={};for(fieldID in tab.fields)h.has(tab.fields,fieldID)&&(a=tab.fields[fieldID],
"group"===a.type||"checkbox"===a.type)&&(c[fieldID]={ord:a.ord,label:a.label});d[tabName]={label:tab.label,ord:tab.ord,childOptions:c}}a.parent_id_options=this.createSelectList(d,a.parent_id," -- No conditional display --",!0);a.width_options=this.createSelectList({1:{ord:1,label:"1 character (em)"},5:{ord:2,label:"5 characters (em)"},10:{ord:3,label:"10 characters (em)"},25:{ord:4,label:"25 characters (em)"},40:{ord:5,label:"40 characters (em)"},56:{ord:6,label:"56 characters (em)"}},a.width," -- Default width -- ");
a.height_options=this.createSelectList({3:{ord:1,label:"3 rows"},5:{ord:2,label:"5 rows"},10:{ord:3,label:"10 rows"},20:{ord:4,label:"20 rows"}},a.height," -- Default rows -- ");a.visibility_options=this.createSelectList({1:{ord:1,label:"Show by default"},2:{ord:1,label:"Always show"}},a.visibility,"Hide by default");d=f.microTemplate("zenario_organizer_admin_box_builder_field_details",a);$("#organizer_field_details_outer").html(d);d="";for(c=0;c<this.formatOnChange.length;c++)0!=c&&(d+=", "),d+=
"#field__"+this.formatOnChange[c]+" :input";$(d).on("change",function(){b.formatFieldDetails()});$("#organizer_field_details :input").off().on("change",function(){b.changeMadeToPanel()});$('#organizer_field_details input[type="text"]').on("keyup",function(){b.changeMadeToPanel()});$("#field__label").on("keyup",function(){$("#organizer_form_field_"+b.current.id+" .label").text($(this).val());if(a.just_added){var c=$(this).val().toLowerCase().replace(/[\s-]+/g,"_").replace(/[^a-z_0-9]/g,"");$("#field__db_column").val(c)}});
$("#field__is_protected").on("change",function(){a.is_new_field||$("#field__db_column").prop("readonly",$(this).prop("checked"))});$('input:radio[name="field__create_index"]').filter('[value="'+a.create_index+'"]').prop("checked",!0);a.is_system_field?$("#field__db_column").prop("readonly",!0):(d=a.always_show?2:a.show_by_default?1:"",$("#field__required").prop("checked",a.required),a.required&&$("#field__required_message").val(a.required_message),$("#field__required").on("change",function(){$("#field_container__required_message").toggle(this.checked)}),
$("#field__show_in_organizer").prop("checked",a.show_in_organizer),$("#field__show_in_organizer").on("change",function(){$("#field_container__visibility").toggle(this.checked);var b=!0==$('input:radio[name="field__create_index"]:checked').val();searchable=a.is_text_field?this.checked:b&&this.checked;$("#field_container__searchable").toggle(searchable);$("#field_container__sortable").toggle(b&&this.checked)}),$('input:radio[name="field__create_index"]').on("change",function(){var b=!0==$('input:radio[name="field__create_index"]:checked').val(),
c=$("#field__show_in_organizer").prop("checked"),d=a.is_text_field?c:b&&c;$("#field_container__searchable").toggle(d);$("#field_container__sortable").toggle(b&&c)}),$("#field__visibility").val(d));a.db_column&&$("#field__include_in_export").prop("checked",!0==a.include_in_export);switch(a.type){case "select":case "checkboxes":case "radios":d=this.getOrderedItems(a.lov);d=f.microTemplate("zenario_organizer_admin_box_builder_field_value",d);$("#field_values_list").html(d).sortable({start:function(a,
c){b.startIndex=c.item.index()},stop:function(a,c){b.save();b.setCurrentFieldValues();b.startIndex!=c.item.index()&&b.changeMadeToPanel()}});this.initFieldValues();this.initAddNewFieldValuesButton();break;case "centralised_select":case "centralised_radios":if(!a.is_system_field){var e=$("#field__values_source"),g=$("#field__values_source_filter"),k=$("#field_label__source_filter"),l=$("#field_container__values_source_filter");e.val(a.values_source);d=e.find(":selected").data("label");a.values_source&&
d&&k.html(d);a.values_source_filter&&g.val(a.values_source_filter);e.find(":selected").data("filter")&&l.show();"centralised_radios"==a.type&&(e.on("change",function(){var c=$(this).find(":selected");l.toggle(!0==c.data("filter"));c.data("label")&&k.html(c.data("label"));b.updateCentralisedRadioValues(e,g,l,a)}),g.on("blur",function(){b.updateCentralisedRadioValues(e,g,l,a)}))}break;case "text":a.is_system_field||(d=!1==a.validation?"none":a.validation,$("#field__validation__"+d).prop("checked",!0),
"none"!=d&&$("#field__validation_message").val(a.validation_message),$('#field_section__validation input:radio[name="field__validation"]').on("change",function(){$("#field_container__validation_message").toggle("field__validation__none"!=$(this).prop("id"))}))}this.initAddNewFieldsButton()};e.initAddNewFieldValuesButton=function(){var b=this;$("#organizer_add_a_field_value").on("click",function(){b.save();var a=b.tuix.items[b.currentTab].fields[b.current.id],d="t"+b.maxNewCustomFieldValue++,c={id:d,
label:"Untitled",ord:_.size(a.lov)+100,is_new_value:!0};a.lov[d]=c;b.setCurrentFieldValues();b.initFieldValues();b.changeMadeToPanel()})};e.updateCentralisedRadioValues=function(b,a,d,c){var e=r.getKey(),g="zenario/ajax.php?__pluginClassName__="+this.tuix.class_name+"&__path__="+r.path+"&method_call=handleOrganizerPanelAJAX";e.mode="get_centralised_lov";e.method=b.val();e.method&&d.is(":visible")&&(e.filter=a.val());h.ajax(u+g,e).after(function(a){a=JSON.parse(a);a=f.microTemplate("zenario_organizer_admin_box_builder_radio_values_disabled",
a);$("#organizer_form_field_values_"+c.id).html(a)})};e.setCurrentFieldValues=function(){var b=this.current.id,a=this.tuix.items[this.currentTab].fields[b],d=this.getOrderedItems(a.lov),c="",c=f.microTemplate("zenario_organizer_admin_box_builder_field_value",d);$("#field_values_list").html(c);-1<$.inArray(a.type,["checkboxes","radios"])&&("checkboxes"==a.type?c=f.microTemplate("zenario_organizer_admin_box_builder_checkbox_values",d):"radios"==a.type&&(c=f.microTemplate("zenario_organizer_admin_box_builder_radio_values_disabled",
d)),$("#organizer_form_field_values_"+b).html(c))};e.initFieldValues=function(){var b=this;$("#field_values_list div.remove").off().on("click",function(){var a=$(this).data("id");b.tuix.items[b.currentTab].fields[b.current.id].lov[a]={remove:!0};$("#organizer_field_value_"+a).remove();$(this).parent().remove();b.changeMadeToPanel()});$("#field_values_list input").off().on("keyup",function(){var a=$(this).data("id");$("#organizer_field_value_"+a+" label").text($(this).val());b.changeMadeToPanel()})};
e.getCurrentFieldDetails=function(){var b={},a=this.tuix.items[this.currentTab].fields[this.current.id];$.each($("#organizer_field_details_form").serializeArray(),function(a,c){b[c.name]=c.value});-1==["select","radios","checkboxes"].indexOf(a.type)||a.field_id||(b.lov=this.getCurrentFieldValues());return b};e.getCurrentFieldValues=function(b){b=this.tuix.items[this.currentTab].fields[this.current.id];lov=b.lov;$("#field_values_list div.field_value").each(function(a,d){var c=$(this).data("id");lov[c]=
{id:c,label:$(d).find("input").val(),ord:a+1};b.lov[c]&&b.lov[c].is_new_value&&(lov[c].is_new_value=!0)});return lov};e.save=function(){var b={};if(this.current.id&&this.current.type)if("tab"==this.current.type)for(id in b=this.getCurrentTabDetails(),this.tuix.items[this.current.id]||(this.tuix.items[this.current.id]={}),b)h.has(b,id)&&(value=b[id],this.tuix.items[this.current.id][id]=value);else if("field"==this.current.type)for(id in b=this.getCurrentFieldDetails(),this.tuix.items[this.currentTab].fields[this.current.id]||
(this.tuix.items[this.currentTab].fields[this.current.id]={}),b)h.has(b,id)&&(value=b[id],this.tuix.items[this.currentTab].fields[this.current.id][id]=value)};e.validate=function(){var b=this,a=new h.callback,d={mode:"validate",id:this.current.id,type:this.current.type,tab:this.currentTab,field_tab:this.currentFieldTab,items:JSON.stringify(this.tuix.items)};return this.current.id&&this.current.type&&"tab"!=this.current.type&&"field"==this.current.type&&!this.tuix.items[this.currentTab].fields[this.current.id].remove?
(this.sendAJAXRequest(d).after(function(c){c=JSON.parse(c);if(0<c.length){var d=$('<div id="organizer_form_field_error" class="error"></div>');for(index in c)h.has(c,index)&&(message=c[index],d.append("<p>"+message+"</p>"));$("#organizer_form_field_error").html("");$("#organizer_field_details").prepend(d)}else $("#organizer_form_field_error").remove(),delete b.tuix.items[b.currentTab].fields[b.current.id].just_added;a.call(c)}),a):!1};e.saveItemsOrder=function(){var b=this;$("#organizer_form_tabs div.tab.sort").each(function(a,
d){var c=$(d).data("name");b.tuix.items[c].ord=a+1;$("#organizer_section_"+c+" .form_field").each(function(a,d){var e=$(d).data("id");b.tuix.items[c].fields[e].ord=a+1;b.tuix.items[c].fields[e].tab_name=c})})}},zenarioO.panelTypes);
