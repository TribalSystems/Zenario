zenario.lib(function(g,v,w,r,x,y,z,m,A,B,C,q,D,E,F,G,H,I,J,t,u,l,s){g=u(s.admin_box_builder=t(s.form_builder_base_class));g.showPanel=function(a,b,c){a.html("").hide();c.html("").show();a=this.loadPanelHTML();b.html(a).show();this.currentPageId||(b=this.getOrderedPages(),0<b.length&&(this.currentPageId=b[0].name));this.pagesReordered=!1;this.deletedPages=[];this.deletedFields=[];this.changeDetected=!1;this.maxNewCustomFieldValue=this.maxNewCustomField=this.maxNewCustomPage=1;this.selectedDetailsPage=
this.selectedDetailsPage?this.selectedDetailsPage:!1;this.selectedFieldId=this.selectedFieldId?this.selectedFieldId:!1;this.selectedPageId=this.selectedPageId?this.selectedPageId:!1;this.loadPagesList(this.currentPageId);this.loadFieldsList(this.currentPageId);this.selectedFieldId?this.loadFieldDetailsPanel(this.selectedFieldId,!0):this.selectedPageId?this.loadPageDetailsPanel(this.selectedPageId,!0):this.loadNewFieldsPanel(!0);this.changesSaved&&(this.changesSaved=!1,m._t({message_type:"success",
message:"Your changes have been saved!"}))};g.loadPanelHTML=function(){return this.microTemplate("zenario_organizer_admin_box_builder",{dataset_label:this.tuix.dataset.label})};g.loadFieldDetailsPanel=function(a,b){var c=this,d=c.tuix.items[c.currentPageId].fields[a],e={mode:"field_details",field_label:d.field_label,hide_tab_bar:c.tuix.field_details.hide_tab_bar};e.record_count="("+(d.record_count?d.record_count:0)+" record"+(1==d.record_count?"":"s")+")";e.type=c.getFieldReadableType(d.type);d.is_system_field&&
(e.type+=", system field");e=c.microTemplate("zenario_organizer_admin_box_builder_left_panel",e);e=$("#organizer_admin_form_builder .form_fields_palette .form_fields_palette_outer").html(e);b||e.hide().show("drop",{direction:"left"},200);d=c.sortAndLoadTUIXPages(c.tuix.field_details.tabs,d,c.selectedDetailsPage);e=c.getTUIXPagesHTML(d);$("#organizer_field_details_tabs").html(e);$("#organizer_field_details_tabs .tab").on("click",function(){var b=$(this).data("name");b&&b!=c.selectedDetailsPage&&(c.saveCurrentOpenDetails()||
c.loadFieldDetailsPage(b,a))});c.loadFieldDetailsPage(c.selectedDetailsPage,a);$("#organizer_field_details_inner span.add_new_field").on("click",function(){c.saveCurrentOpenDetails()||(c.selectedFieldId=!1,c.loadNewFieldsPanel(),c.highlightField(!1))})};g.getFieldReadableType=function(a,b,c){switch(a){case "group":return"Group";case "checkbox":return"Flag";case "checkboxes":return"Checkboxes";case "date":return"Date";case "editor":return"Editor";case "radios":return"Radios";case "centralised_radios":return"Centralised radios";
case "select":return"Select";case "centralised_select":return"Centralised select";case "text":return"Text";case "textarea":return"Textarea";case "url":return"URL";case "other_system_field":if(c)switch(b){case "html_snippet":return"HTML snippet";case "pick_items":return"Item picker";case "upload":return"Upload";case "toggle":return"Toggle";case "grouping":return"Grouping";default:return this.getFieldReadableType(b)}else return"Other system field";case "dataset_select":return"Dataset select";case "dataset_picker":return"Dataset picker";
case "file_picker":return"File picker";case "repeat_start":return"Start of repeating section";case "repeat_end":return"End of repeating section";default:return"Unknown"}};g.highlightField=function(a){$("#organizer_form_fields .form_field .form_field_inline_buttons").hide();$("#organizer_form_fields .form_field").removeClass("selected");a&&($("#organizer_form_field_"+a).addClass("selected"),$("#organizer_form_field_"+a+" .form_field_inline_buttons").show())};g.loadFieldDetailsPage=function(a,b,c){var d=
this;d.selectedDetailsPage=a;var e=d.tuix.items[d.currentPageId].fields[b],f=d.loadFields("field_details/"+a,d.tuix.field_details.tabs[a].fields,e),f=d.formatFieldDetails(f,e,"field",d.selectedDetailsPage),n=d.sortFields(f,e),k="";if(!_._isEm(c)){c=d.sortErrors(c);for(var h=0;h<c.length;h++)k+='<p class="error">'+c[h]+"</p>"}k+=d.getTUIXFieldsHTML(n);$("#organizer_field_details_form").html(k);$("#organizer_field_details_tabs .tab").removeClass("on");$("#field_tab__"+a).addClass("on");_._isEm(c)||
$("#organizer_field_details_form").effect({effect:"bounce",duration:125,direction:"right",times:2,distance:5,mode:"effect"});"details"==a?($("#field__field_label").on("keyup",function(){$("#organizer_form_field_"+b+" .label, #zenario_field_details_header_content .field_name h5").text($(this).val());if(e._is_new){var a=$(this).val().toLowerCase().r(/[\s-]+/g,"_").r(/[^a-z_0-9]/g,"");$("#field__db_column").val(a)}}),$("#field__note_below").on("keyup",function(){var a=$(this).val().trim();$("#organizer_form_field_note_below_"+
b+" div.zenario_note_content").text(a);$("#organizer_form_field_note_below_"+b).toggle(""!==a)}),$("#field__side_note").on("keyup",function(){var a=$(this).val().trim();$("#organizer_form_field_side_note_"+b+" div.zenario_note_content").text(a);$("#organizer_form_field_side_note_"+b).toggle(""!==a)})):"values"==a&&f.values&&!f.values._hidden&&(c=d.getOrderedFieldValues(d.currentPageId,b),k=d.microTemplate("zenario_organizer_admin_box_builder_field_value",c),$("#field_values_list").html(k).sortable({containment:"parent",
tolerance:"pointer",axis:"y",start:function(a,b){d.startIndex=b.item.index()},stop:function(a,c){d.startIndex!=c.item.index()&&(d.saveFieldListOfValues(d.tuix.fields[b]),d.loadFieldValuesListPreview(b),d.changeMadeToPanel())}}),$("#field_values_list input").on("keyup",function(){var a=$(this).data("id");$("#organizer_field_value_"+a+" label").text($(this).val());d.changeMadeToPanel()}),$("#organizer_add_a_field_value").on("click",function(){d.addFieldValue(e);d.saveItemTUIXPage("field_details",a,
e);d.loadFieldDetailsPage(a,b);d.loadFieldValuesListPreview(b);d.changeMadeToPanel()}),$("#field_values_list .delete_icon").on("click",function(){var c=$(this).data("id");e.lov[c]&&(e._deleted_lov||(e._deleted_lov=[]),e._deleted_lov.push(c),delete e.lov[c]);d.saveItemTUIXPage("field_details",a,e);d.loadFieldDetailsPage(a,b);d.loadFieldValuesListPreview(b);d.changeMadeToPanel()}))};g.loadFieldValuesListPreview=function(a){if(this.tuix.items[this.currentPageId]&&this.tuix.items[this.currentPageId].fields[a]){var b=
this.tuix.items[this.currentPageId].fields[a],c=this.getOrderedFieldValues(this.currentPageId,a,!0),d=!1;"select"==b.type||"centralised_select"==b.type?(d=this.microTemplate("zenario_organizer_admin_box_builder_select_values",c),$("#organizer_form_field_"+a+" select").html(d)):"radios"==b.type||"centralised_radios"==b.type?(d=this.microTemplate("zenario_organizer_admin_box_builder_radio_values_preview",c),$("#organizer_form_field_values_"+a).html(d)):"checkboxes"==b.type&&(d=this.microTemplate("zenario_organizer_admin_box_builder_checkbox_values_preview",
c),$("#organizer_form_field_values_"+a).html(d))}};g.saveCurrentOpenDetails=function(a){var b=!1;this.selectedFieldId&&this.tuix.items[this.currentPageId]&&this.tuix.items[this.currentPageId].fields[this.selectedFieldId]?(a?b=this.getDeleteFieldErrors(this.selectedFieldId):(a=this.tuix.items[this.currentPageId].fields[this.selectedFieldId],b=this.saveItemTUIXPage("field_details",this.selectedDetailsPage,a)),_._isEm(b)||this.loadFieldDetailsPage(this.selectedDetailsPage,this.selectedFieldId,b)):this.selectedPageId&&
this.tuix.items[this.selectedPageId]&&(a=this.tuix.items[this.selectedPageId],b=this.saveItemTUIXPage("tab_details",this.selectedDetailsPage,a),_._isEm(b)||this.loadPageDetailsPage(this.selectedDetailsPage,this.selectedPageId,b));return!_._isEm(b)};g.displayPageFieldStructureErrors=function(a){var b=[],c=this.getOrderedFields(a),d=!1,e,f="checkbox group date radios select text textarea url".split(" ");for(a=0;a<c.length;a++)if(e=c[a],"repeat_start"!=e.type||d)if("repeat_end"==e.type)d?d=repeatStartFieldId=
!1:b.push("Repeat ends must be placed after repeat starts.");else{if(d&&-1==f.indexOf(e.type)&&b.push('Field type "'+this.getFieldReadableType(e.type).toLowerCase()+'" is not allowed in a repeat block.'),this.tuix.dataset_fields_in_forms[e.id]&&!d&&e.repeat_start_id&&e.repeat_start_id!=repeatStartFieldId){formIds=_._tA(this.tuix.dataset_fields_in_forms[e.id]);plural=1==formIds.length?"":"s";e='The field "'+e.field_label+'" is used on '+formIds.length+" form"+plural+" (";for(var n=[],k=0;k<formIds.length;k++)this.tuix.forms_with_dataset_fields[formIds[k]]&&
n.push(this.tuix.forms_with_dataset_fields[formIds[k]]);e+=n.join(", ")+") in a dataset repeat block. You must remove this repeat block from forms before this field can be moved out.";b.push(e)}}else repeatStartFieldId=e.id,d=!0;c=0<b.length;d=$("#organizer_fields_error");d.html("");for(a=0;a<b.length;a++)d.append('<p class="error">'+b[a]+"</p>");d.toggle(c);return c};g.getDeleteFieldErrors=function(a){var b={},c,d,e,f;for(c in this.tuix.items)if(l(this.tuix.items,c))for(e in d=this.tuix.items[c],
d.parent_field_id==a&&(b[c]='Unable to delete the field because the tab "'+d.tab_label+'" depends on it.'),d.fields)l(d.fields,e)&&(f=d.fields[e],a!=e&&f.parent_id==a&&(b[e]='Unable to delete the field because the field "'+f.field_label+'" depends on it.'));if(this.tuix.dataset_fields_in_forms[a]){formIds=_._tA(this.tuix.dataset_fields_in_forms[a]);plural=1==formIds.length?"":"s";b[a]="This field is used on "+formIds.length+" form"+plural+" (";formNames=[];for(c=0;c<formIds.length;c++)this.tuix.forms_with_dataset_fields[formIds[c]]&&
formNames.push(this.tuix.forms_with_dataset_fields[formIds[c]]);b[a]+=formNames.join(", ")+"). You must remove this field from all forms before you can delete it."}return b};g.validateFieldDetails=function(a,b,c,d,e){if("field_details"==c)if("details"==d){if(!b.is_system_field){if("repeat_start"!=b.type)if(b.db_column)if(b.db_column.m(/[^a-z0-9_-]/))e.db_column="Code name can only use characters a-z 0-9 _-.";else{a=!0;for(var f in this.tuix.items)if(l(this.tuix.items,f)&&(d=this.tuix.items[f],d.fields))for(var n in d.fields)if(l(d.fields,
n)&&(c=d.fields[n],n!=b.id&&c.db_column==b.db_column)){a=!1;break}a||(e.db_column='The code name "'+b.db_column+'" is already in use.');b.db_column.m(/\_\_(\d+|rows)$/)&&(e.db_column="That code name is invalid.")}else e.db_column="Please enter a code name.";b.admin_box_visibility&&"show_on_condition"==b.admin_box_visibility&&!b.parent_id&&(e.parent_id="Please select a conditional display field.");"file_picker"!=b.type||b.store_file||(e.store_file="Please select a file storage method.");"centralised_radios"!=
b.type&&"centralised_select"!=b.type||b.values_source||(e.values_source="Please select a source for this list.");if("repeat_start"==b.type){if(!b.min_rows)e.min_rows="Please enter the minimum rows.";else if(+b.min_rows!=b.min_rows)e.min_rows="Please a valid number for mininum rows.";else if(1>b.min_rows||10<b.min_rows)e.min_rows="Mininum rows must be between 1 and 10.";if(!b.max_rows)e.max_rows="Please enter the maximum rows.";else if(+b.max_rows!=b.max_rows)e.max_rows="Please a valid number for maximum rows.";
else if(2>b.max_rows||20<b.max_rows)e.max_rows="Maximum rows must be between 2 and 20.";!e.min_rows&&!e.max_rows&&+b.min_rows>+b.max_rows&&(e.min_rows="Minimum rows cannot be greater than maximum rows.")}}}else"validation"!=d||b.is_system_field||(b.required&&!b.required_message&&(e.required_message="Please enter a message if not complete."),b.validation&&"none"!=b.validation&&!b.validation_message&&(e.validation_message="Please enter a message if not valid."))};g.loadPageDetailsPanel=function(a,b){var c=
this,d={mode:"tab_details",tab_label:c.getPageLabel(c.tuix.items[a].tab_label),is_system_field:c.tuix.items[a].is_system_field,hide_tab_bar:c.tuix.tab_details.hide_tab_bar},d=c.microTemplate("zenario_organizer_admin_box_builder_left_panel",d),d=$("#organizer_admin_form_builder .form_fields_palette .form_fields_palette_outer").html(d);b||d.hide().show("drop",{direction:"left"},200);d=c.sortAndLoadTUIXPages(c.tuix.tab_details.tabs,c.tuix.items[a],c.selectedDetailsPage);d=c.getTUIXPagesHTML(d);$("#organizer_tab_details_tabs").html(d);
$("#organizer_tab_details_tabs .tab").on("click",function(){var b=$(this).data("id");b&&b!=c.selectedDetailsPage&&(c.saveCurrentOpenDetails()||c.loadPageDetailsPage(b,a))});c.loadPageDetailsPage(c.selectedDetailsPage,a);$("#organizer_tab_details_inner span.add_new_field").on("click",function(){c.saveCurrentOpenDetails()||c.loadNewFieldsPanel()});$("#organizer_remove_form_tab").on("click",function(a){if((a=c.tuix.items[c.selectedPageId])&&!a.is_system_field){var b=!1,d=0;if(a.fields)for(var k in a.fields)if(l(a.fields,
k)){var h=a.fields[k];h.is_protected&&(b||(b=h),d++)}d?(k='<p>This tab has the protected field "'+b.field_label+'"',d--,0<d&&(k+=" and "+d+" other protected field"+(1==d?"":"s")),m._flBo(k+" on it and cannot be deleted.</p>",!0,"warning",!0)):(k="<p>Are you sure you want to delete this tab?</p>",_._isEm(a.fields)||(k+="<p>All fields on this tab will also be deleted.</p>"),m._flBo(k,"Delete tab","warning",!0,!1,function(){c.deletePage(c.selectedPageId);c.changeMadeToPanel()}))}})};g.loadPageDetailsPage=
function(a,b,c){var d=this;d.selectedDetailsPage=a;var e=d.tuix.items[b],f=d.loadFields("tab_details/"+a,d.tuix.tab_details.tabs[a].fields,e);formattedFields=d.formatFieldDetails(f,e,"page",d.selectedDetailsPage);sortedFields=d.sortFields(formattedFields,e);e="";if(!_._isEm(c))for(c=d.sortErrors(c),f=0;f<c.length;f++)e+='<p class="error">'+c[f]+"</p>";e+=d.getTUIXFieldsHTML(sortedFields);$("#organizer_tab_details_form").html(e);$("#organizer_tab_details_tabs .tab").removeClass("on");$("#field_tab__"+
a).addClass("on");_._isEm(c)||$("#organizer_tab_details_form").effect({effect:"bounce",duration:125,direction:"right",times:2,distance:5,mode:"effect"});if("details"==a)$("#field__tab_label").on("keyup",function(){var a=d.getPageLabel($(this).val());$("#zenario_tab_details_header_content .field_name h5, #organizer_form_tab_"+b+" span").text(a)})};g.formatFieldDetails=function(a,b,c,d){if("field"==c)if("details"==d)b.tuix_type&&(c=this.getFieldReadableType(b.type,b.tuix_type,!0),a.message.snippet.html=
'This is a field of type "'+c+"\". You cannot edit this field's details."),(c=a.values_source._value)&&this.tuix.centralised_lists.values[c]&&(c=this.tuix.centralised_lists.values[c],c.info.can_filter?a.values_source_filter.label=c.info.filter_label:a.values_source_filter._hidden=!0),b.is_system_field&&(a.is_protected.note_below="System fields cannot be deleted",a.is_protected._disabled=!0,a.is_protected._value=!0),-1!=["editor","textarea","file_picker"].indexOf(b.type)&&(a.include_in_export.note_below=
"You cannot export this kind of field",a.include_in_export._disabled=!0,a.include_in_export._value=!1),b.is_system_field&&!b.allow_admin_to_change_visibility&&(a.admin_box_visibility.note_below="Only specific system fields marked with a special property can have their visibility changed.",a.admin_box_visibility._disabled=!0),"repeat_start"==b.type&&(a.field_label.label="Section heading:",a.field_label.note_below="This will be the heading at the start of the repeating section.");else if("organizer"==
d)b.allow_admin_to_change_visibility||(a.hide_in_organizer.note_below="Only specific system fields marked with a special property can have their visibility changed.",a.hide_in_organizer._disabled=!0,a.hide_in_organizer._value=!1),-1!="checkbox group radios select dataset_select dataset_picker file_picker centralised_radios centralised_select".split(" ").indexOf(b.type)&&(a.create_index._value="index",a.create_index._disabled=!0);else if("values"==d)if(b.is_system_field)a.message.snippet.html="You cannot change the values of a system field.";
else if("centralised_radios"==b.type||"centralised_select"==b.type)a.message.snippet.html="You cannot change the values of a centralised list.";return a};g.fieldDetailsChanged=function(a,b){var c=this;a=a.s("/");var d=a[0],e=a[1],f;e&&d&&c.tuix[d]&&c.tuix[d].tabs[e]&&c.tuix[d].tabs[e].fields[b]&&(c.changeMadeToPanel(),f=c.tuix[d].tabs[e].fields[b],f.format_onchange&&("field_details"==d?(f=c.tuix.items[c.currentPageId].fields[c.selectedFieldId],c.saveItemTUIXPage(d,c.selectedDetailsPage,f),c.loadFieldDetailsPage(c.selectedDetailsPage,
c.selectedFieldId),"details"==e&&"values_source"==b&&((d=$("#field__values_source").val())?(d={mode:"get_centralised_lov",method:d,filter:$("#field__values_source_filter").val()},c.sendAJAXRequest(d).after(function(a){c.tuix.items[c.currentPageId].fields[c.selectedFieldId].lov=a;c.loadFieldValuesListPreview(c.selectedFieldId)})):(c.tuix.items[c.currentPageId].fields[c.selectedFieldId].lov={},c.loadFieldValuesListPreview(c.selectedFieldId)))):"tab_details"==d&&(f=c.tuix.items[c.selectedPageId],c.saveItemTUIXPage(d,
c.selectedDetailsPage,f),c.loadPageDetailsPage(c.selectedDetailsPage,c.selectedPageId))))};g.getFieldValuesList=function(a){var b=[],c=a.id,d=a.values,e=a._value,f=a._disabled;if("object"==typeof d){var n=0,k;for(k in d)if(l(d,k)){var h=d[k],h={ord:++n,name:c,label:h.label,value:k,path:a.path};k==e&&(h.selected=!0);f&&(h.disabled=!0);b.push(h)}}else if("boolean_fields"==d)for(n in this.tuix.items){if(l(this.tuix.items,n)&&(a=this.tuix.items[n],a.fields)){var c=[],g;for(g in a.fields)l(a.fields,g)&&
(h=a.fields[g],!h.type||"checkbox"!=h.type&&"group"!=h.type||h.id==this.selectedFieldId||(h={ord:h.ord,label:h.field_label,value:g},g==e&&(h.selected=!0),c.push(h)));c.sort(this.sortByOrd);c.length&&b.push({ord:a.ord,label:a.tab_label,hasChildren:!0,options:c})}}else if("centralised_lists"==d){var n=0,p;for(p in this.tuix.centralised_lists.values)l(this.tuix.centralised_lists.values,p)&&(h=this.tuix.centralised_lists.values[p],h={ord:++n,label:h.label,value:p},p==e&&(h.selected=!0),b.push(h))}else if("datasets"==
d){var n=0,m;for(m in this.tuix.datasets)l(this.tuix.datasets,m)&&(h=this.tuix.datasets[m],h={ord:++n,label:h.label,value:m},m==e&&(h.selected=!0),b.push(h))}b.sort(this.sortByOrd);return b};g.loadNewFieldsPanel=function(a){this.selectedFieldId=this.selectedPageId=!1;var b=this.microTemplate("zenario_organizer_admin_box_builder_left_panel",{mode:"new_fields",use_groups_field:this.tuix.use_groups_field}),b=$("#organizer_admin_form_builder .form_fields_palette .form_fields_palette_outer").html(b);a||
b.hide().show("drop",{direction:"right"},200);$("#organizer_field_type_list_outer div.field_type_list div.field_type").draggable({connectToSortable:"#organizer_form_fields .form_section",appendTo:"#organizer_admin_form_builder",helper:"clone"})};g.loadPagesList=function(a){var b=this,c;for(c in b.tuix.items)if(l(b.tuix.items,c)){var d=b.tuix.items[c];c==a?d._selected=!0:delete d._selected}a={tabs:b.getOrderedPages()};a=b.microTemplate("zenario_organizer_admin_box_builder_tabs",a);$("#organizer_form_tabs").html(a);
$("#organizer_form_tabs .tab").on("click",function(){var a=$(this).data("id");b.tuix.items[a]&&b.clickPage(a)});$("#organizer_add_new_tab").on("click",function(){b.saveCurrentOpenDetails()||(b.addNewPage(),b.changeMadeToPanel())});$("#organizer_form_tabs").sortable({axis:"x",containment:"parent",tolerance:"pointer",items:"div.sort",start:function(a,c){b.startIndex=c.item.index()},stop:function(a,c){b.startIndex!=c.item.index()&&($("#organizer_form_tabs .tab.sort").each(function(a){var c=$(this).data("id");
b.tuix.items[c].ord=a+1}),b.pagesReordered=!0,b.changeMadeToPanel())}});$("#organizer_form_tabs .tab").droppable({accept:"div.is_sortable:not(.system_field)",greedy:!0,hoverClass:"ui-state-hover",tolerance:"pointer",drop:function(a,c){if(!b.saveCurrentOpenDetails()){var d=$(this).data("id"),k=$(c.draggable).data("id");d==b.currentPageId||b.tuix.items[b.currentPageId].fields[k].is_system_field||(b.moveFieldToPage(b.currentPageId,d,k),k==b.selectedFieldId&&b.loadNewFieldsPanel(),b.loadFieldsList(b.currentPageId))}}})};
g.moveFieldToPage=function(a,b,c,d){if(a!=b&&this.tuix.items[b]&&this.tuix.items[a]&&this.tuix.items[a].fields[c]&&"repeat_end"!=this.tuix.items[a].fields[c].type){this.tuix.items[b]._tabFieldsReordered=!0;this.tuix.items[a]._tabFieldsReordered=!0;var e=1,f=this.getOrderedFields(b);f.length&&(e=d?f[0].ord-1:f[f.length-1].ord+1);"repeat_start"==this.tuix.items[a].fields[c].type&&(d=this.getMatchingRepeatEnd(c),this.tuix.items[b].fields[d]=this.tuix.items[a].fields[d],this.tuix.items[b].fields[d].ord=
e+0.001,delete this.tuix.items[a].fields[d]);this.tuix.items[b].fields[c]=this.tuix.items[a].fields[c];this.tuix.items[b].fields[c].ord=e;delete this.tuix.items[a].fields[c];this.changeMadeToPanel()}};g.addNewPage=function(){var a="__custom_tab_t"+this.maxNewCustomPage++,b=1;for(name in this.tuix.items)l(this.tuix.items,name)&&++b;this.tuix.items[a]={ord:b,name:a,tab_label:"Untitled page",fields:{},_is_new:!0};this.clickPage(a,!0)};g.clickPage=function(a,b){var c=this;if(c.selectedPageId!=a){var d=
c.saveCurrentOpenDetails(),e=c.displayPageFieldStructureErrors(c.currentPageId);if(!d&&!e)if(c.currentPageId==a)c.selectedFieldId=!1,c.selectedPageId=a,c.selectedDetailsPage=!1,c.loadPageDetailsPanel(a);else{var f=c.tuix.items[a];f.record_counts_fetched||f._is_new?c.clickPage2(a,b):c.sendAJAXRequest({mode:"get_tab_field_record_counts",pageId:a}).after(function(d){f.record_counts_fetched=!0;if(d)for(fieldId in d)l(d,fieldId)&&(recordCount=d[fieldId],f.fields&&f.fields[fieldId]&&(f.fields[fieldId].record_count=
recordCount));c.clickPage2(a,b)})}}};g.clickPage2=function(a,b){this.currentPageId=a;if(b)this.selectedPageId=a,this.loadPageDetailsPanel(a);else{var c=!1;this.selectedFieldId||this.selectedPageId||(c=!0);this.loadNewFieldsPanel(c)}this.selectedFieldId=!1;this.loadPagesList(a);this.loadFieldsList(a)};g.clickField=function(a){this.selectedFieldId!=a&&this.tuix.items[this.currentPageId]&&this.tuix.items[this.currentPageId].fields[a]&&"repeat_end"!=this.tuix.items[this.currentPageId].fields[a].type&&
!this.saveCurrentOpenDetails()&&(this.highlightField(a),this.selectedFieldId=a,this.selectedDetailsPage=this.selectedPageId=!1,this.loadFieldDetailsPanel(a))};g.loadFieldsList=function(a){var b=this,c={fields:b.getOrderedFields(a,!0,!0)},c=b.microTemplate("zenario_organizer_admin_box_builder_section",c);$("#organizer_form_fields").html(c);b.selectedFieldId&&b.highlightField(b.selectedFieldId);$("#organizer_form_fields div.form_field").on("click",function(){var a=$(this).data("id");b.tuix.items[b.currentPageId].fields[a]&&
b.clickField(a)});$("#organizer_form_fields .form_section").sortable({items:"div.is_sortable",tolerance:"pointer",placeholder:"preview",receive:function(a,c){$(this).find("div.field_type").each(function(){var a=$(this).data("type"),c=1,d=$(this).prev().data("id");d&&b.tuix.items[b.currentPageId].fields[d]&&(c=b.tuix.items[b.currentPageId].fields[d].ord+1);b.addNewField(a,c);b.updateFieldOrds()})},start:function(a,c){b.startIndex=c.item.index()},stop:function(c,e){b.startIndex!=e.item.index()&&(b.tuix.items[a]._tabFieldsReordered=
!0,b.updateFieldOrds(),b.loadFieldsList(a))}});$("#organizer_form_fields .delete_icon").on("click",function(a){a.stopPropagation();var c=$(this).data("id");if(b.tuix.items[b.currentPageId].fields[c]&&!b.saveCurrentOpenDetails(!0)){a=b.tuix.items[b.currentPageId].fields[c];var f;a.is_protected?(message="<p>This field is protected, and might be important to your site!</p>",message+="<p>If you're sure you want to delete this field then first unprotect it.</p>",m._flBo(message,!0,"warning",!0)):(a.record_count&&
1<=a.record_count?(f=1==a.record_count?"":"s",message="<p><strong>This field contains data on "+a.record_count+" record"+f+".</strong></p>",message+="<p>When you save changes to this dataset, this data will be deleted.</p>"):message="<p>This field doesn't contain any data for any user/contact records.</p>",message+="<p>Delete this dataset field?</p>",m._flBo(message,"Delete dataset field","warning",!0,!1,function(){b.deleteField(c)}))}})};g.updateFieldOrds=function(){var a=this;$("#organizer_form_fields div.is_sortable").each(function(b){var c=
$(this).data("id");a.tuix.items[a.currentPageId].fields[c].ord=b+1});a.changeMadeToPanel()};g.deletePage=function(a){for(var b=this.getOrderedPages(),c=0,d=0;d<b.length;d++)if(b[d].name==a){c=0<d?d-1:1;this.deletedPages.push(a);if(this.tuix.items[a].fields)for(var e in this.tuix.items[a].fields)l(this.tuix.items[a].fields,e)&&(field=this.tuix.items[a].fields[e],this.deletedFields.push(e));delete this.tuix.items[a];this.clickPage(b[c].name)}};g.deleteField=function(a){pageId=this.currentPageId;if(this.tuix.items[pageId].fields[a]){this.changeMadeToPanel();
this.deletedFields.push(a);var b=this.tuix.items[pageId].fields[a];if("repeat_start"==b.type){var c=this.getMatchingRepeatEnd(a);c&&(this.deletedFields.push(c),delete this.tuix.items[pageId].fields[c])}for(var c=this.getOrderedFields(pageId,!1,!0),d=!1,e=!1,f=e=!1,g=0;g<c.length;g++)if(c[g].id==b.id&&(d=g),!1!==d)if(0<d){f=d-1;e=c[d-1];break}else if(a!=c[g].id){f=g;e=c[g];break}delete this.tuix.items[pageId].fields[a];(e=e._fields&&e._fields.length?f<d?e._fields[e._fields.length-1].id:e._fields[0].id:
e.id)&&"repeat_end"==this.tuix.items[pageId].fields[e].type&&(e=!1);this.loadFieldsList(pageId);e?this.clickField(e):this.loadNewFieldsPanel()}};g.addNewField=function(a,b){var c="t"+this.maxNewCustomField++,d={id:c,type:a,ord:b,field_label:"Untitled",_is_new:!0},e;for(e in this.tuix.items[this.currentPageId].fields)if(l(this.tuix.items[this.currentPageId].fields,e)){var f=this.tuix.items[this.currentPageId].fields[e];f.ord>=b&&f.ord++}if("checkboxes"==a||"radios"==a||"select"==a)for(d.lov={},e=1;3>=
e;e++)this.addFieldValue(d,"Option "+e);else"repeat_start"==a&&this.addNewField("repeat_end",b+0.01);this.tuix.items[this.currentPageId].fields[c]=d;this.loadFieldsList(this.currentPageId);this.clickField(c)};g.getOrderedPages=function(){var a=[],b;for(b in this.tuix.items)l(this.tuix.items,b)&&a.push(this.tuix.items[b]);a.sort(this.sortByOrd);return a};g.getOrderedFields=function(a,b,c){var d=[],e=[],f={},g,k,h,m,p=!1;if(this.tuix.items[a]&&this.tuix.items[a].fields)for(g in this.tuix.items[a].fields)l(this.tuix.items[a].fields,
g)&&(k=this.tuix.items[a].fields[g],h=_._cl(k),b&&(h.lov=this.getOrderedFieldValues(a,g,!0)),c&&k.grouping_name?(h._fields=[],f[k.grouping_name]=h):c&&k.grouping?e.push(h):(h._isSortable=!0,d.push(h)));if(0<e.length)for(a=0;a<e.length;a++)f[e[a].grouping]&&f[e[a].grouping]._fields.push(e[a]);for(m in f)l(f,m)&&(e=f[m],e._fields.sort(this.sortByOrd),e._fields.length&&(e._isSortable=!0,e._fields[0].first_in_grouping=!0,d.push(e)));d.sort(this.sortByOrd);for(a=0;a<d.length;a++)"repeat_start"==d[a].type?
p=!0:"repeat_end"==d[a].type?p=!1:p&&(d[a]._inRepeat=!0);return d};g.getOrderedFieldValues=function(a,b,c){var d=[],e,f;if(this.tuix.items[a]&&this.tuix.items[a].fields&&this.tuix.items[a].fields[b]&&this.tuix.items[a].fields[b].lov){for(e in this.tuix.items[a].fields[b].lov)l(this.tuix.items[a].fields[b].lov,e)&&(f=this.tuix.items[a].fields[b].lov[e],d.push(f));a=this.tuix.items[a].fields[b].type;!c||"select"!=a&&"centralised_select"!=a||d.push({id:"empty_value",label:"-- Select --",ord:-1})}d.sort(this.sortByOrd);
return d};g.changeMadeToPanel=function(){this.changeDetected||(this.changeDetected=!0,r.onbeforeunload=function(){return"You are currently editing this dataset. If you leave now you will lose any unsaved changes."},q._dI("Please either save your changes, or click Reset to discard them, before exiting the form editor."),q._sB())};g.saveChanges=function(){var a=this,b={mode:"save",data:JSON.stringify(a.tuix.items),pagesReordered:a.pagesReordered,deletedPages:JSON.stringify(a.deletedPages),deletedFields:JSON.stringify(a.deletedFields),
currentPageId:a.currentPageId};a.selectedPageId&&(b.selectedPageId=a.selectedPageId);a.selectedFieldId&&(b.selectedFieldId=a.selectedFieldId);(function(){m._nDS("saving",!0);a.sendAJAXRequest(b).after(function(b){if(b){if(b.errors){for(var d="",e=0;e<b.errors.length;e++)d+=b.errors[e]+"<br>";d&&m._flBo(d)}a.currentPageId=b.currentPageId;a.selectedPageId=b.selectedPageId;a.selectedFieldId=b.selectedFieldId}m._nDS();r.onbeforeunload=!1;q._eI();a.changeDetected=!1;a.changesSaved=!0;q._r()})})()}},zenarioO.panelTypes);
