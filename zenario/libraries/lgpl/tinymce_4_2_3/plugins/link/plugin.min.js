tinymce.PluginManager.add("link",function(a){function k(g){return function(){var d=a.settings.link_list;"string"==typeof d?tinymce.util.XHR.send({url:d,success:function(a){g(tinymce.util.JSON.parse(a))}}):"function"==typeof d?d(g):g(d)}}function p(a,d,f){function b(a,e){e=e||[];tinymce.each(a,function(a){var c={text:a.text||a.title};a.menu?c.menu=b(a.menu):(c.value=a.value,d&&d(c));e.push(c)});return e}return b(a,f||[])}function f(g){function d(a){var b=q.find("#text");(!b.value()||a.lastControl&&
b.value()==a.lastControl.text())&&b.value(a.control.text());q.find("#href").value(a.control.value())}function f(){!r&&0===b.text.length&&m&&this.parent().parent().find("#text")[0].value(this.value())}var b={},k=a.selection,e=a.dom,l,c,r,q,m,s,n,t,u,v;l=k.getNode();c=e.getParent(l,"a[href]");m=function(a){var b=k.getContent();if(/</.test(b)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(b)||-1==b.indexOf("href=")))return!1;if(a){a=a.childNodes;if(0===a.length)return!1;for(b=a.length-1;0<=b;b--)if(3!=a[b].nodeType)return!1}return!0}();
b.text=r=c?c.innerText||c.textContent:k.getContent({format:"text"});b.href=c?e.getAttrib(c,"href"):"";c?b.target=e.getAttrib(c,"target"):a.settings.default_link_target&&(b.target=a.settings.default_link_target);if(l=e.getAttrib(c,"rel"))b.rel=l;if(l=e.getAttrib(c,"class"))b["class"]=l;if(l=e.getAttrib(c,"title"))b.title=l;m&&(s={name:"text",type:"textbox",size:40,label:"Text to display",classes:"link_text_to_display",onchange:function(){b.text=this.value()}});g&&(n={type:"listbox",label:"Link list",
values:p(g,function(b){b.value=a.convertURL(b.value||b.url,"href")},[{text:"None",value:""}]),onselect:d,value:a.convertURL(b.href,"href"),onPostRender:function(){n=this}});!1!==a.settings.target_list&&(a.settings.target_list||(a.settings.target_list=[{text:"None",value:""},{text:"New window",value:"_blank"}]),u={name:"target",type:"listbox",label:"Target",values:p(a.settings.target_list)});a.settings.rel_list&&(t={name:"rel",type:"listbox",label:"Rel",values:p(a.settings.rel_list)});g=a.settings.link_class_list?
{name:"class",type:"listbox",label:"Class",values:p(a.settings.link_class_list,function(b){b.value&&(b.textStyle=function(){return a.formatter.getCssText({inline:"a",classes:[b.value]})})})}:{name:"class",type:"textbox",size:40,label:"CSS class name(s)"};!1!==a.settings.link_title&&(v={name:"title",type:"textbox",label:"Title",value:b.title});q=a.windowManager.open({title:"Insert link",data:b,body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:!0,label:"Url",classes:"zenario_link_picker",
onchange:function(b){var c=b.meta||{};n&&n.value(a.convertURL(this.value(),"href"));tinymce.each(b.meta,function(a,b){q.find("#"+b).value(a)});c.text||f.call(this)},onkeyup:f},s,v,function(b){var c=[];tinymce.each(a.dom.select("a:not([href])"),function(a){(a=a.name||a.id)&&c.push({text:a,value:"#"+a,selected:-1!=b.indexOf("#"+a)})});if(c.length)return c.unshift({text:"None",value:""}),{name:"anchor",type:"listbox",label:"Anchors",values:c,onselect:d}}(b.href),n,t,u,g],onSubmit:function(d){function f(b,
c){var e=a.selection.getRng();window.setTimeout(function(){a.windowManager.confirm(b,function(b){a.selection.setRng(e);c(b)})},0)}function g(){var d={href:h,target:b.target?b.target:null,rel:b.rel?b.rel:null,"class":b["class"]?b["class"]:null,title:b.title?b.title:null};c?(a.focus(),m&&b.text!=r&&("innerText"in c?c.innerText=b.text:c.textContent=b.text),e.setAttribs(c,d),k.select(c),a.undoManager.add()):m?a.insertContent(e.createHTML("a",d,e.encode(b.text))):a.execCommand("mceInsertLink",!1,d)}var h;
b=tinymce.extend(b,d.data);(h=b.href)?0<h.indexOf("@")&&-1==h.indexOf("//")&&-1==h.indexOf("mailto:")?f("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(a){a&&(h="mailto:"+h);g()}):a.settings.link_assume_external_targets&&!/^\w+:/i.test(h)||!a.settings.link_assume_external_targets&&/^\s*www\./i.test(h)?f("The URL you entered seems to be an external link. Do you want to add the required http:// prefix?",function(a){a&&(h="http://"+h);g()}):
g():a.execCommand("unlink")}});zenarioA.setLinkPickerOnTinyMCE()}a.addButton("link",{icon:"link",tooltip:"Insert/edit link",shortcut:"Meta+K",onclick:k(f),stateSelector:"a[href]"});a.addButton("unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink",stateSelector:"a[href]"});a.addShortcut("Meta+K","",k(f));a.addCommand("mceLink",k(f));this.showDialog=f;a.addMenuItem("link",{icon:"link",text:"Insert/edit link",shortcut:"Meta+K",onclick:k(f),stateSelector:"a[href]",context:"insert",prependToContext:!0})});
