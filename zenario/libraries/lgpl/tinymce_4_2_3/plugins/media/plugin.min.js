tinymce.PluginManager.add("media",function(c,w){function s(a){a=a.toLowerCase();return-1!=a.indexOf(".mp3")?"audio/mpeg":-1!=a.indexOf(".wav")?"audio/wav":-1!=a.indexOf(".mp4")?"video/mp4":-1!=a.indexOf(".webm")?"video/webm":-1!=a.indexOf(".ogg")?"video/ogg":-1!=a.indexOf(".swf")?"application/x-shockwave-flash":""}function r(a){var b=c.settings.media_scripts;if(b)for(var h=0;h<b.length;h++)if(-1!==a.indexOf(b[h].filter))return b[h]}function t(){function a(a){var e,f,c,d;e=b.find("#width")[0];f=b.find("#height")[0];
c=e.value();d=f.value();b.find("#constrain")[0].checked()&&h&&m&&c&&d&&(a.control==e?(d=Math.round(c/h*d),isNaN(d)||f.value(d)):(c=Math.round(d/m*c),isNaN(c)||e.value(c)));h=c;m=d}var b,h,m,d,f=[{name:"source1",type:"filepicker",filetype:"media",size:40,autofocus:!0,label:"Source",onchange:function(a){tinymce.each(a.meta,function(a,h){b.find("#"+h).value(a)})}}];!1!==c.settings.media_alt_source&&f.push({name:"source2",type:"filepicker",filetype:"media",size:40,label:"Alternative source"});!1!==c.settings.media_poster&&
f.push({name:"poster",type:"filepicker",filetype:"image",size:40,label:"Poster"});!1!==c.settings.media_dimensions&&f.push({type:"container",label:"Dimensions",layout:"flex",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:a,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:a,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]});d=x(c.selection.getNode());h=d.width;
m=d.height;var g;g=c.selection.getNode().getAttribute("data-mce-object")?c.selection.getContent():void 0;g={id:"mcemediasource",type:"textbox",flex:1,name:"embed",value:g,multiline:!0,label:"Source"};g[y]=function(){d=q(this.value());this.parent().parent().fromJSON(d)};b=c.windowManager.open({title:"Insert/edit video",data:d,bodyType:"tabpanel",body:[{title:"General",type:"form",onShowTab:function(){d=q(this.next().find("#embed").value());this.fromJSON(d)},items:f},{title:"Embed",type:"container",
layout:"flex",direction:"column",align:"stretch",padding:10,spacing:10,onShowTab:function(){this.find("#embed").value(u(this.parent().toJSON()))},items:[{type:"label",text:"Paste your embed code below:",forId:"mcemediasource"},g]}],onSubmit:function(){var a,b,h,d;a=c.dom.select("img[data-mce-object]");c.insertContent(u(this.toJSON()));b=c.dom.select("img[data-mce-object]");for(h=0;h<a.length;h++)for(d=b.length-1;0<=d;d--)a[h]==b[d]&&b.splice(d,1);c.selection.select(b[0]);c.nodeChanged()}})}function u(a){var b=
"";if(!a.source1&&(tinymce.extend(a,q(a.embed)),!a.source1))return"";a.source2||(a.source2="");a.poster||(a.poster="");a.source1=c.convertURL(a.source1,"source");a.source2=c.convertURL(a.source2,"source");a.source1mime=s(a.source1);a.source2mime=s(a.source2);a.poster=c.convertURL(a.poster,"poster");a.flashPlayerUrl=c.convertURL(w+"/moxieplayer.swf","movie");tinymce.each(z,function(b){var h,c,g;if(h=b.regex.exec(a.source1)){g=b.url;for(c=0;h[c];c++)g=g.replace("$"+c,function(){return h[c]});a.source1=
g;a.type=b.type;a.width=a.width||b.w;a.height=a.height||b.h}});if(a.embed)b=v(a.embed,a,!0);else{var h=r(a.source1);h&&(a.type="script",a.width=h.width,a.height=h.height);a.width=a.width||300;a.height=a.height||150;tinymce.each(a,function(b,h){a[h]=c.dom.encode(b)});"iframe"==a.type?b+='<iframe src="'+a.source1+'" width="'+a.width+'" height="'+a.height+'"></iframe>':"application/x-shockwave-flash"==a.source1mime?(b+='<object data="'+a.source1+'" width="'+a.width+'" height="'+a.height+'" type="application/x-shockwave-flash">',
a.poster&&(b+='<img src="'+a.poster+'" width="'+a.width+'" height="'+a.height+'" />'),b+="</object>"):b=-1!=a.source1mime.indexOf("audio")?c.settings.audio_template_callback?c.settings.audio_template_callback(a):b+('<audio controls="controls" src="'+a.source1+'">'+(a.source2?'\n<source src="'+a.source2+'"'+(a.source2mime?' type="'+a.source2mime+'"':"")+" />\n":"")+"</audio>"):"script"==a.type?b+('<script src="'+a.source1+'">\x3c/script>'):c.settings.video_template_callback?c.settings.video_template_callback(a):
'<video width="'+a.width+'" height="'+a.height+'"'+(a.poster?' poster="'+a.poster+'"':"")+' controls="controls">\n<source src="'+a.source1+'"'+(a.source1mime?' type="'+a.source1mime+'"':"")+" />\n"+(a.source2?'<source src="'+a.source2+'"'+(a.source2mime?' type="'+a.source2mime+'"':"")+" />\n":"")+"</video>"}return b}function q(a){var b={};(new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,special:"script,noscript",start:function(a,c){b.source1||"param"!=a||(b.source1=c.map.movie);
if("iframe"==a||"object"==a||"embed"==a||"video"==a||"audio"==a)b.type||(b.type=a),b=tinymce.extend(c.map,b);if("script"==a){var d=r(c.map.src);if(!d)return;b={type:"script",source1:c.map.src,width:d.width,height:d.height}}"source"==a&&(b.source1?b.source2||(b.source2=c.map.src):b.source1=c.map.src);"img"!=a||b.poster||(b.poster=c.map.src)}})).parse(a);b.source1=b.source1||b.src||b.data;b.source2=b.source2||"";b.poster=b.poster||"";return b}function x(a){return a.getAttribute("data-mce-object")?q(c.serializer.serialize(a,
{selection:!0})):{}}function A(a){if(!1===c.settings.media_filter_html)return a;var b=new tinymce.html.Writer;(new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!1,special:"script,noscript",comment:function(a){b.comment(a)},cdata:function(a){b.cdata(a)},text:function(a,c){b.text(a,c)},start:function(a,c,d){if("script"!=a&&"noscript"!=a){for(var f=0;f<c.length;f++)if(0===c[f].name.indexOf("on"))return;b.start(a,c,d)}},end:function(a){"script"!=a&&"noscript"!=a&&b.end(a)}},new tinymce.html.Schema({}))).parse(a);
return b.getContent()}function v(a,b,c){function m(a,b){var c,d,h,f;for(c in b)if(h=""+b[c],a.map[c])for(d=a.length;d--;)f=a[d],f.name==c&&(h?(a.map[c]=h,f.value=h):(delete a.map[c],a.splice(d,1)));else h&&(a.push({name:c,value:h}),a.map[c]=h)}var d=new tinymce.html.Writer,f=0,g;(new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,special:"script,noscript",comment:function(a){d.comment(a)},cdata:function(a){d.cdata(a)},text:function(a,b){d.text(a,b)},start:function(a,e,k){switch(a){case "video":case "object":case "embed":case "img":case "iframe":m(e,
{width:b.width,height:b.height})}if(c)switch(a){case "video":m(e,{poster:b.poster,src:""});b.source2&&m(e,{src:""});break;case "iframe":m(e,{src:b.source1});break;case "source":f++;if(2>=f&&(m(e,{src:b["source"+f],type:b["source"+f+"mime"]}),!b["source"+f]))return;break;case "img":if(!b.poster)return;g=!0}d.start(a,e,k)},end:function(a){if("video"==a&&c)for(var e=1;2>=e;e++)if(b["source"+e]){var k=[];k.map={};f<e&&(m(k,{src:b["source"+e],type:b["source"+e+"mime"]}),d.start("source",k,!0))}b.poster&&
"object"==a&&c&&!g&&(e=[],e.map={},m(e,{src:b.poster,width:b.width,height:b.height}),d.start("img",e,!0));d.end(a)}},new tinymce.html.Schema({}))).parse(a);return d.getContent()}var z=[{regex:/youtu\.be\/([\w\-.]+)/,type:"iframe",w:425,h:350,url:"//www.youtube.com/embed/$1"},{regex:/youtube\.com(.+)v=([^&]+)/,type:"iframe",w:425,h:350,url:"//www.youtube.com/embed/$2"},{regex:/vimeo\.com\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc"},
{regex:/vimeo\.com\/(.*)\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$2?title=0&amp;byline=0"},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:"iframe",w:425,h:350,url:'//maps.google.com/maps/ms?msid=$2&output=embed"'}],y=tinymce.Env.ie&&8>=tinymce.Env.ie?"onChange":"onInput";c.on("ResolveName",function(a){var b;1==a.target.nodeType&&(b=a.target.getAttribute("data-mce-object"))&&(a.name=b)});c.on("preInit",function(){var a=c.schema.getSpecialElements();tinymce.each(["video",
"audio","iframe","object"],function(b){a[b]=RegExp("</"+b+"[^>]*>","gi")});var b=c.schema.getBoolAttrs();tinymce.each(["webkitallowfullscreen","mozallowfullscreen","allowfullscreen"],function(a){b[a]={}});c.parser.addNodeFilter("iframe,video,audio,object,embed,script",function(a,b){for(var d=a.length,f,g,l,e,k,n,p;d--;)if(g=a[d],g.parent){if("script"==g.name&&(p=r(g.attr("src")),!p))continue;l=new tinymce.html.Node("img",1);l.shortEnded=!0;p&&(p.width&&g.attr("width",p.width.toString()),p.height&&
g.attr("height",p.height.toString()));n=g.attributes;for(f=n.length;f--;)if(e=n[f].name,k=n[f].value,"width"!==e&&"height"!==e&&"style"!==e){if("data"==e||"src"==e)k=c.convertURL(k,e);l.attr("data-mce-p-"+e,k)}if(f=g.firstChild&&g.firstChild.value)l.attr("data-mce-html",escape(f)),l.firstChild=null;l.attr({width:g.attr("width")||"300",height:g.attr("height")||("audio"==b?"30":"150"),style:g.attr("style"),src:tinymce.Env.transparentSrc,"data-mce-object":b,"class":"mce-object mce-object-"+b});g.replace(l)}});
c.serializer.addAttributeFilter("data-mce-object",function(a,b){for(var c=a.length,f,g,l,e,k;c--;)if(f=a[c],f.parent){k=f.attr(b);g=new tinymce.html.Node(k,1);"audio"!=k&&"script"!=k&&g.attr({width:f.attr("width"),height:f.attr("height")});g.attr({style:f.attr("style")});e=f.attributes;for(l=e.length;l--;){var n=e[l].name;0===n.indexOf("data-mce-p-")&&g.attr(n.substr(11),e[l].value)}"script"==k&&g.attr("type","text/javascript");if(l=f.attr("data-mce-html"))e=new tinymce.html.Node("#text",3),e.raw=
!0,e.value=A(unescape(l)),g.append(e);f.replace(g)}})});c.on("ObjectSelected",function(a){var b=a.target.getAttribute("data-mce-object");"audio"!=b&&"script"!=b||a.preventDefault()});c.on("objectResized",function(a){var b=a.target,c;b.getAttribute("data-mce-object")&&(c=b.getAttribute("data-mce-html"))&&(c=unescape(c),b.setAttribute("data-mce-html",escape(v(c,{width:a.width,height:a.height}))))});c.addButton("media",{tooltip:"Insert/edit video",onclick:t,stateSelector:["img[data-mce-object=video]",
"img[data-mce-object=iframe]"]});c.addMenuItem("media",{icon:"media",text:"Insert/edit video",onclick:t,context:"insert",prependToContext:!0})});
