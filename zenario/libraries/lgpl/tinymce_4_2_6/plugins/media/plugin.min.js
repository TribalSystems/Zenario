tinymce.PluginManager.add("media",function(c,w){function t(a){a=a.toLowerCase();return-1!=a.indexOf(".mp3")?"audio/mpeg":-1!=a.indexOf(".wav")?"audio/wav":-1!=a.indexOf(".mp4")?"video/mp4":-1!=a.indexOf(".webm")?"video/webm":-1!=a.indexOf(".ogg")?"video/ogg":-1!=a.indexOf(".swf")?"application/x-shockwave-flash":""}function s(a){var b=c.settings.media_scripts;if(b)for(var g=0;g<b.length;g++)if(-1!==a.indexOf(b[g].filter))return b[g]}function q(){function a(a){var e,f,d,c;e=b.find("#width")[0];f=b.find("#height")[0];
d=e.value();c=f.value();b.find("#constrain")[0].checked()&&g&&m&&d&&c&&(a.control==e?(c=Math.round(d/g*c),isNaN(c)||f.value(c)):(d=Math.round(c/m*d),isNaN(d)||e.value(d)));g=d;m=c}var b,g,m,f,h=[{name:"source1",type:"filepicker",filetype:"media",size:40,autofocus:!0,label:"Source",onchange:function(a){tinymce.each(a.meta,function(a,d){b.find("#"+d).value(a)})}}];!1!==c.settings.media_alt_source&&h.push({name:"source2",type:"filepicker",filetype:"media",size:40,label:"Alternative source"});!1!==c.settings.media_poster&&
h.push({name:"poster",type:"filepicker",filetype:"image",size:40,label:"Poster"});!1!==c.settings.media_dimensions&&h.push({type:"container",label:"Dimensions",layout:"flex",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:a,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:a,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]});f=x(c.selection.getNode());g=f.width;
m=f.height;var d;d=c.selection.getNode().getAttribute("data-mce-object")?c.selection.getContent():void 0;d={id:"mcemediasource",type:"textbox",flex:1,name:"embed",value:d,multiline:!0,label:"Source"};d[y]=function(){f=r(this.value());this.parent().parent().fromJSON(f)};b=c.windowManager.open({title:"Insert/edit video",data:f,bodyType:"tabpanel",body:[{title:"General",type:"form",onShowTab:function(){f=r(this.next().find("#embed").value());this.fromJSON(f)},items:h},{title:"Embed",type:"container",
layout:"flex",direction:"column",align:"stretch",padding:10,spacing:10,onShowTab:function(){this.find("#embed").value(u(this.parent().toJSON()))},items:[{type:"label",text:"Paste your embed code below:",forId:"mcemediasource"},d]}],onSubmit:function(){var a,b,d,g;a=c.dom.select("img[data-mce-object]");c.insertContent(u(this.toJSON()));b=c.dom.select("img[data-mce-object]");for(d=0;d<a.length;d++)for(g=b.length-1;0<=g;g--)a[d]==b[g]&&b.splice(g,1);c.selection.select(b[0]);c.nodeChanged()}})}function u(a){var b=
"";if(!a.source1&&(tinymce.extend(a,r(a.embed)),!a.source1))return"";a.source2||(a.source2="");a.poster||(a.poster="");a.source1=c.convertURL(a.source1,"source");a.source2=c.convertURL(a.source2,"source");a.source1mime=t(a.source1);a.source2mime=t(a.source2);a.poster=c.convertURL(a.poster,"poster");a.flashPlayerUrl=c.convertURL(w+"/moxieplayer.swf","movie");tinymce.each(z,function(b){var g,c,d;if(g=b.regex.exec(a.source1)){d=b.url;for(c=0;g[c];c++)d=d.replace("$"+c,function(){return g[c]});a.source1=
d;a.type=b.type;a.allowFullscreen=b.allowFullscreen;a.width=a.width||b.w;a.height=a.height||b.h}});if(a.embed)b=v(a.embed,a,!0);else{var g=s(a.source1);g&&(a.type="script",a.width=g.width,a.height=g.height);a.width=a.width||300;a.height=a.height||150;tinymce.each(a,function(b,g){a[g]=c.dom.encode(b)});"iframe"==a.type?b+='<iframe src="'+a.source1+'" width="'+a.width+'" height="'+a.height+'"'+(a.allowFullscreen?' allowFullscreen="1"':"")+"></iframe>":"application/x-shockwave-flash"==a.source1mime?
(b+='<object data="'+a.source1+'" width="'+a.width+'" height="'+a.height+'" type="application/x-shockwave-flash">',a.poster&&(b+='<img src="'+a.poster+'" width="'+a.width+'" height="'+a.height+'" />'),b+="</object>"):b=-1!=a.source1mime.indexOf("audio")?c.settings.audio_template_callback?c.settings.audio_template_callback(a):b+('<audio controls="controls" src="'+a.source1+'">'+(a.source2?'\n<source src="'+a.source2+'"'+(a.source2mime?' type="'+a.source2mime+'"':"")+" />\n":"")+"</audio>"):"script"==
a.type?b+('<script src="'+a.source1+'">\x3c/script>'):c.settings.video_template_callback?c.settings.video_template_callback(a):'<video width="'+a.width+'" height="'+a.height+'"'+(a.poster?' poster="'+a.poster+'"':"")+' controls="controls">\n<source src="'+a.source1+'"'+(a.source1mime?' type="'+a.source1mime+'"':"")+" />\n"+(a.source2?'<source src="'+a.source2+'"'+(a.source2mime?' type="'+a.source2mime+'"':"")+" />\n":"")+"</video>"}return b}function r(a){var b={};(new tinymce.html.SaxParser({validate:!1,
allow_conditional_comments:!0,special:"script,noscript",start:function(a,c){b.source1||"param"!=a||(b.source1=c.map.movie);if("iframe"==a||"object"==a||"embed"==a||"video"==a||"audio"==a)b.type||(b.type=a),b=tinymce.extend(c.map,b);if("script"==a){var f=s(c.map.src);if(!f)return;b={type:"script",source1:c.map.src,width:f.width,height:f.height}}"source"==a&&(b.source1?b.source2||(b.source2=c.map.src):b.source1=c.map.src);"img"!=a||b.poster||(b.poster=c.map.src)}})).parse(a);b.source1=b.source1||b.src||
b.data;b.source2=b.source2||"";b.poster=b.poster||"";return b}function x(a){return a.getAttribute("data-mce-object")?r(c.serializer.serialize(a,{selection:!0})):{}}function A(a){if(!1===c.settings.media_filter_html)return a;var b=new tinymce.html.Writer,g;(new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!1,special:"script,noscript",comment:function(a){b.comment(a)},cdata:function(a){b.cdata(a)},text:function(a,c){b.text(a,c)},start:function(a,f,h){g=!0;if("script"!=a&&"noscript"!=
a){for(var d=0;d<f.length;d++){if(0===f[d].name.indexOf("on"))return;"style"==f[d].name&&(f[d].value=c.dom.serializeStyle(c.dom.parseStyle(f[d].value),a))}b.start(a,f,h);g=!1}},end:function(a){g||b.end(a)}},new tinymce.html.Schema({}))).parse(a);return b.getContent()}function v(a,b,c){function m(a,b){var c,d,g,f;for(c in b)if(g=""+b[c],a.map[c])for(d=a.length;d--;)f=a[d],f.name==c&&(g?(a.map[c]=g,f.value=g):(delete a.map[c],a.splice(d,1)));else g&&(a.push({name:c,value:g}),a.map[c]=g)}var f=new tinymce.html.Writer,
h=0,d;(new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,special:"script,noscript",comment:function(a){f.comment(a)},cdata:function(a){f.cdata(a)},text:function(a,b){f.text(a,b)},start:function(a,e,k){switch(a){case "video":case "object":case "embed":case "img":case "iframe":m(e,{width:b.width,height:b.height})}if(c)switch(a){case "video":m(e,{poster:b.poster,src:""});b.source2&&m(e,{src:""});break;case "iframe":m(e,{src:b.source1});break;case "source":h++;if(2>=h&&(m(e,{src:b["source"+
h],type:b["source"+h+"mime"]}),!b["source"+h]))return;break;case "img":if(!b.poster)return;d=!0}f.start(a,e,k)},end:function(a){if("video"==a&&c)for(var e=1;2>=e;e++)if(b["source"+e]){var k=[];k.map={};h<e&&(m(k,{src:b["source"+e],type:b["source"+e+"mime"]}),f.start("source",k,!0))}b.poster&&"object"==a&&c&&!d&&(e=[],e.map={},m(e,{src:b.poster,width:b.width,height:b.height}),f.start("img",e,!0));f.end(a)}},new tinymce.html.Schema({}))).parse(a);return f.getContent()}var z=[{regex:/youtu\.be\/([\w\-.]+)/,
type:"iframe",w:425,h:350,url:"//www.youtube.com/embed/$1",allowFullscreen:!0},{regex:/youtube\.com(.+)v=([^&]+)/,type:"iframe",w:425,h:350,url:"//www.youtube.com/embed/$2",allowFullscreen:!0},{regex:/vimeo\.com\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc",allowfullscreen:!0},{regex:/vimeo\.com\/(.*)\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$2?title=0&amp;byline=0",allowfullscreen:!0},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,
type:"iframe",w:425,h:350,url:'//maps.google.com/maps/ms?msid=$2&output=embed"',allowFullscreen:!1}],y=tinymce.Env.ie&&8>=tinymce.Env.ie?"onChange":"onInput";c.on("ResolveName",function(a){var b;1==a.target.nodeType&&(b=a.target.getAttribute("data-mce-object"))&&(a.name=b)});c.on("preInit",function(){var a=c.schema.getSpecialElements();tinymce.each(["video","audio","iframe","object"],function(b){a[b]=RegExp("</"+b+"[^>]*>","gi")});var b=c.schema.getBoolAttrs();tinymce.each(["webkitallowfullscreen",
"mozallowfullscreen","allowfullscreen"],function(a){b[a]={}});c.parser.addNodeFilter("iframe,video,audio,object,embed,script",function(a,b){for(var f=a.length,h,d,l,e,k,n,p;f--;)if(d=a[f],d.parent){if("script"==d.name&&(p=s(d.attr("src")),!p))continue;l=new tinymce.html.Node("img",1);l.shortEnded=!0;p&&(p.width&&d.attr("width",p.width.toString()),p.height&&d.attr("height",p.height.toString()));n=d.attributes;for(h=n.length;h--;)if(e=n[h].name,k=n[h].value,"width"!==e&&"height"!==e&&"style"!==e){if("data"==
e||"src"==e)k=c.convertURL(k,e);l.attr("data-mce-p-"+e,k)}if(h=d.firstChild&&d.firstChild.value)l.attr("data-mce-html",escape(h)),l.firstChild=null;l.attr({width:d.attr("width")||"300",height:d.attr("height")||("audio"==b?"30":"150"),style:d.attr("style"),src:tinymce.Env.transparentSrc,"data-mce-object":b,"class":"mce-object mce-object-"+b});d.replace(l)}});c.serializer.addAttributeFilter("data-mce-object",function(a,b){for(var c=a.length,h,d,l,e,k;c--;)if(h=a[c],h.parent){k=h.attr(b);d=new tinymce.html.Node(k,
1);"audio"!=k&&"script"!=k&&d.attr({width:h.attr("width"),height:h.attr("height")});d.attr({style:h.attr("style")});e=h.attributes;for(l=e.length;l--;){var n=e[l].name;0===n.indexOf("data-mce-p-")&&d.attr(n.substr(11),e[l].value)}"script"==k&&d.attr("type","text/javascript");if(l=h.attr("data-mce-html"))e=new tinymce.html.Node("#text",3),e.raw=!0,e.value=A(unescape(l)),d.append(e);h.replace(d)}})});c.on("ObjectSelected",function(a){var b=a.target.getAttribute("data-mce-object");"audio"!=b&&"script"!=
b||a.preventDefault()});c.on("objectResized",function(a){var b=a.target,c;b.getAttribute("data-mce-object")&&(c=b.getAttribute("data-mce-html"))&&(c=unescape(c),b.setAttribute("data-mce-html",escape(v(c,{width:a.width,height:a.height}))))});c.addButton("media",{tooltip:"Insert/edit video",onclick:q,stateSelector:["img[data-mce-object=video]","img[data-mce-object=iframe]"]});c.addMenuItem("media",{icon:"media",text:"Insert/edit video",onclick:q,context:"insert",prependToContext:!0});c.addCommand("mceMedia",
q);this.showDialog=q});
