tinymce.PluginManager.add("image",function(b){function w(b,k){function n(b,g){f.parentNode&&f.parentNode.removeChild(f);k({width:b,height:g})}var f=document.createElement("img");f.onload=function(){n(Math.max(f.width,f.clientWidth),Math.max(f.height,f.clientHeight))};f.onerror=function(){n()};var l=f.style;l.visibility="hidden";l.position="fixed";l.bottom=l.left=0;l.width=l.height="auto";document.body.appendChild(f);f.src=b}function u(b,k,n){function f(b,g){g=g||[];tinymce.each(b,function(b){var e=
{text:b.text||b.title};b.menu?e.menu=f(b.menu):(e.value=b.value,k(e));g.push(e)});return g}return f(b,n||[])}function q(g){return function(){var k=b.settings.image_list;"string"==typeof k?tinymce.util.XHR.send({url:k,success:function(b){g(tinymce.util.JSON.parse(b))}}):"function"==typeof k?k(g):g(k)}}function r(g){function k(){var a,b,c,d;a=e.find("#width")[0];b=e.find("#height")[0];a&&b&&(c=a.value(),d=b.value(),e.find("#constrain")[0].checked()&&m&&p&&c&&d&&(m!=c?(d=Math.round(c/m*d),isNaN(d)||
b.value(d)):(c=Math.round(d/p*c),isNaN(c)||a.value(c))),m=c,p=d)}function n(){function a(a){function d(){a.onload=a.onerror=null;b.selection&&(b.selection.select(a),b.nodeChanged())}a.onload=function(){c.width||c.height||!t||h.setAttribs(a,{width:a.clientWidth,height:a.clientHeight});d()};a.onerror=d}q();k();c=tinymce.extend(c,e.toJSON());c.alt||(c.alt="");c.title||(c.title="");""===c.width&&(c.width=null);""===c.height&&(c.height=null);c.style||(c.style=null);""===c.align&&(c.align=null);c={src:c.src,
alt:c.alt,title:c.title,width:c.width,height:c.height,style:c.style,"class":c["class"],align:c.align};b.undoManager.transact(function(){c.src?(""===c.title&&(c.title=null),d?(h.setAttribs(d,c),b.editorUpload.uploadImagesAuto()):(c.id="__mcenew",b.focus(),b.selection.setContent(h.createHTML("img",c)),d=h.get("__mcenew"),h.setAttrib(d,"id",null)),a(d)):d&&(h.remove(d),b.focus(),b.nodeChanged())});var x=zenario.scrollTop();setTimeout(function(){zenario.scrollTop(x)},0)}function f(a){a&&(a=a.replace(/px$/,
""));return a}function l(a){if(a.margin){var b=a.margin.split(" ");switch(b.length){case 1:a["margin-top"]=a["margin-top"]||b[0];a["margin-right"]=a["margin-right"]||b[0];a["margin-bottom"]=a["margin-bottom"]||b[0];a["margin-left"]=a["margin-left"]||b[0];break;case 2:a["margin-top"]=a["margin-top"]||b[0];a["margin-right"]=a["margin-right"]||b[1];a["margin-bottom"]=a["margin-bottom"]||b[0];a["margin-left"]=a["margin-left"]||b[1];break;case 3:a["margin-top"]=a["margin-top"]||b[0];a["margin-right"]=
a["margin-right"]||b[1];a["margin-bottom"]=a["margin-bottom"]||b[2];a["margin-left"]=a["margin-left"]||b[1];break;case 4:a["margin-top"]=a["margin-top"]||b[0],a["margin-right"]=a["margin-right"]||b[1],a["margin-bottom"]=a["margin-bottom"]||b[2],a["margin-left"]=a["margin-left"]||b[3]}delete a.margin}return a}function q(){function a(a){0<a.length&&/^[0-9]+$/.test(a)&&(a+="px");return a}if(b.settings.image_advtab){var c=e.toJSON(),d=h.parseStyle(c.style),d=l(d);c.vspace&&(d["margin-top"]=d["margin-bottom"]=
a(c.vspace));c.hspace&&(d["margin-left"]=d["margin-right"]=a(c.hspace));c.border&&(d["border-width"]=a(c.border));e.find("#style").value(h.serializeStyle(h.parseStyle(h.serializeStyle(d))))}}function r(){if(b.settings.image_advtab){var a=e.toJSON(),a=h.parseStyle(a.style);e.find("#vspace").value("");e.find("#hspace").value("");a=l(a);if(a["margin-top"]&&a["margin-bottom"]||a["margin-right"]&&a["margin-left"])a["margin-top"]===a["margin-bottom"]?e.find("#vspace").value(f(a["margin-top"])):e.find("#vspace").value(""),
a["margin-right"]===a["margin-left"]?e.find("#hspace").value(f(a["margin-right"])):e.find("#hspace").value("");a["border-width"]&&e.find("#border").value(f(a["border-width"]));e.find("#style").value(h.serializeStyle(h.parseStyle(h.serializeStyle(a))))}}var e,c={},h=b.dom,d=b.selection.getNode(),m,p,s,v,t=!1!==b.settings.image_dimensions;m=h.getAttrib(d,"width");p=h.getAttrib(d,"height");"IMG"!=d.nodeName||d.getAttribute("data-mce-object")||d.getAttribute("data-mce-placeholder")?d=null:c={src:h.getAttrib(d,
"src"),alt:h.getAttrib(d,"alt"),align:h.getAttrib(d,"align"),title:h.getAttrib(d,"title"),"class":h.getAttrib(d,"class"),width:m,height:p};g&&(s={type:"listbox",label:"Image list",values:u(g,function(a){a.value=b.convertURL(a.value||a.url,"src")},[{text:"None",value:""}]),value:c.src&&b.convertURL(c.src,"src"),onselect:function(a){var b=e.find("#alt");(!b.value()||a.lastControl&&b.value()==a.lastControl.text())&&b.value(a.control.text());e.find("#src").value(a.control.value()).fire("change")},onPostRender:function(){s=
this}});!1!==b.settings.image_class&&(v=b.settings.image_class_list?{name:"class",type:"listbox",label:"Class",values:u(b.settings.image_class_list,function(a){a.value&&(a.textStyle=function(){return b.formatter.getCssText({inline:"img",classes:[a.value]})})})}:{name:"class",type:"textbox",size:40,label:"CSS class name(s)"});g=[{name:"src",type:"filepicker",filetype:"image",label:"Source",autofocus:!0,onchange:function(a){var c,d;a=a.meta||{};s&&s.value(b.convertURL(this.value(),"src"));tinymce.each(a,
function(a,b){e.find("#"+b).value(a)});a.width||a.height||(a=b.convertURL(this.value(),"src"),c=b.settings.image_prepend_url,d=/^(?:[a-z]+:)?\/\//i,c&&!d.test(a)&&a.substring(0,c.length)!==c&&(a=c+a),this.value(a),w(b.documentBaseURI.toAbsolute(this.value()),function(a){a.width&&a.height&&t&&(m=a.width,p=a.height,e.find("#width").value(m),e.find("#height").value(p))}))}},s];!1!==b.settings.image_description&&g.push({name:"alt",type:"textbox",label:"Image alt tag",classes:"image_alt"});b.settings.image_title&&
g.push({name:"title",type:"textbox",label:"Image Title"});t&&g.push({type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:k,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:k,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]});g.push(v);!1!==b.settings.image_alignment&&g.push({type:"listbox",name:"align",
label:"Alignment",values:[{text:"-- Not Set --",value:""},{text:"Left",value:"left"},{text:"Right",value:"right"},{text:"Middle",value:"middle"},{text:"Top",value:"top"},{text:"Bottom",value:"bottom"}]});b.settings.image_advtab?(d&&(d.style.marginLeft&&d.style.marginRight&&d.style.marginLeft===d.style.marginRight&&(c.hspace=f(d.style.marginLeft)),d.style.marginTop&&d.style.marginBottom&&d.style.marginTop===d.style.marginBottom&&(c.vspace=f(d.style.marginTop)),d.style.borderWidth&&(c.border=f(d.style.borderWidth)),
c.style=b.dom.serializeStyle(b.dom.parseStyle(b.dom.getAttrib(d,"style")))),e=b.windowManager.open({title:"Insert/edit image",data:c,bodyType:"tabpanel",body:[{title:"General",type:"form",items:g},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox",onchange:r},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:q},items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",
name:"hspace"},{label:"Border",name:"border"}]}]}],onSubmit:n})):e=b.windowManager.open({title:"Insert/edit image",data:c,body:g,onSubmit:n})}b.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:q(r),stateSelector:"img:not([data-mce-object],[data-mce-placeholder])"});b.addMenuItem("image",{icon:"image",text:"Insert/edit image",onclick:q(r),context:"insert",prependToContext:!0});b.addCommand("mceImage",q(r))});
