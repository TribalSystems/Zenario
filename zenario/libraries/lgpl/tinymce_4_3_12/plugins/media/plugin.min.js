tinymce.PluginManager.add("media",function(c,v){function r(a){a=a.toLowerCase();return-1!=a.indexOf(".mp3")?"audio/mpeg":-1!=a.indexOf(".wav")?"audio/wav":-1!=a.indexOf(".mp4")?"video/mp4":-1!=a.indexOf(".webm")?"video/webm":-1!=a.indexOf(".ogg")?"video/ogg":-1!=a.indexOf(".swf")?"application/x-shockwave-flash":""}function q(a){var b=c.settings.media_scripts;if(b)for(var f=0;f<b.length;f++)if(-1!==a.indexOf(b[f].filter))return b[f]}function n(){function a(a){var d,e,c,g;d=b.find("#width")[0];e=b.find("#height")[0];
c=d.value();g=e.value();b.find("#constrain")[0].checked()&&f&&m&&c&&g&&(a.control==d?(g=Math.round(c/f*g),isNaN(g)||e.value(g)):(c=Math.round(g/m*c),isNaN(c)||d.value(c)));f=c;m=g}var b,f,m,d,e=[{name:"source1",type:"filepicker",filetype:"media",size:40,autofocus:!0,label:"Source",onchange:function(a){tinymce.each(a.meta,function(a,f){b.find("#"+f).value(a)})}}];!1!==c.settings.media_alt_source&&e.push({name:"source2",type:"filepicker",filetype:"media",size:40,label:"Alternative source"});!1!==c.settings.media_poster&&
e.push({name:"poster",type:"filepicker",filetype:"image",size:40,label:"Poster"});!1!==c.settings.media_dimensions&&e.push({type:"container",label:"Dimensions",layout:"flex",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:a,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:a,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]});d=w(c.selection.getNode());f=d.width;
m=d.height;var g;g=c.selection.getNode().getAttribute("data-mce-object")?c.selection.getContent():void 0;g={id:"mcemediasource",type:"textbox",flex:1,name:"embed",value:g,multiline:!0,label:"Source"};g[x]=function(){d=p(this.value());this.parent().parent().fromJSON(d)};b=c.windowManager.open({title:"Insert/edit video",data:d,bodyType:"tabpanel",body:[{title:"General",type:"form",onShowTab:function(){d=p(this.next().find("#embed").value());this.fromJSON(d)},items:e},{title:"Embed",type:"container",
layout:"flex",direction:"column",align:"stretch",padding:10,spacing:10,onShowTab:function(){this.find("#embed").value(s(this.parent().toJSON()))},items:[{type:"label",text:"Paste your embed code below:",forId:"mcemediasource"},g]}],onSubmit:function(){var a,b,f,d;a=c.dom.select("img[data-mce-object]");c.insertContent(s(this.toJSON()));b=c.dom.select("img[data-mce-object]");for(f=0;f<a.length;f++)for(d=b.length-1;0<=d;d--)a[f]==b[d]&&b.splice(d,1);c.selection.select(b[0]);c.nodeChanged()}})}function s(a){var b=
"";if(!a.source1&&(tinymce.extend(a,p(a.embed)),!a.source1))return"";a.source2||(a.source2="");a.poster||(a.poster="");a.source1=c.convertURL(a.source1,"source");a.source2=c.convertURL(a.source2,"source");a.source1mime=r(a.source1);a.source2mime=r(a.source2);a.poster=c.convertURL(a.poster,"poster");a.flashPlayerUrl=c.convertURL(v+"/moxieplayer.swf","movie");tinymce.each(y,function(b){var f,e,c;if(f=b.regex.exec(a.source1)){c=b.url;for(e=0;f[e];e++)c=c.replace("$"+e,function(){return f[e]});a.source1=
c;a.type=b.type;a.allowFullscreen=b.allowFullscreen;a.width=a.width||b.w;a.height=a.height||b.h}});if(a.embed)b=t(a.embed,a,!0);else{var f=q(a.source1);f&&(a.type="script",a.width=f.width,a.height=f.height);a.width=a.width||300;a.height=a.height||150;tinymce.each(a,function(b,f){a[f]=c.dom.encode(b)});"iframe"==a.type?b+='<iframe src="'+a.source1+'" width="'+a.width+'" height="'+a.height+'"'+(a.allowFullscreen?' allowFullscreen="1"':"")+"></iframe>":"application/x-shockwave-flash"==a.source1mime?
(b+='<object data="'+a.source1+'" width="'+a.width+'" height="'+a.height+'" type="application/x-shockwave-flash">',a.poster&&(b+='<img src="'+a.poster+'" width="'+a.width+'" height="'+a.height+'" />'),b+="</object>"):b=-1!=a.source1mime.indexOf("audio")?c.settings.audio_template_callback?c.settings.audio_template_callback(a):b+('<audio controls="controls" src="'+a.source1+'">'+(a.source2?'\n<source src="'+a.source2+'"'+(a.source2mime?' type="'+a.source2mime+'"':"")+" />\n":"")+"</audio>"):"script"==
a.type?b+('<script src="'+a.source1+'">\x3c/script>'):c.settings.video_template_callback?c.settings.video_template_callback(a):'<video width="'+a.width+'" height="'+a.height+'"'+(a.poster?' poster="'+a.poster+'"':"")+' controls="controls">\n<source src="'+a.source1+'"'+(a.source1mime?' type="'+a.source1mime+'"':"")+" />\n"+(a.source2?'<source src="'+a.source2+'"'+(a.source2mime?' type="'+a.source2mime+'"':"")+" />\n":"")+"</video>"}return b}function p(a){var b={};(new tinymce.html.SaxParser({validate:!1,
allow_conditional_comments:!0,special:"script,noscript",start:function(a,c){b.source1||"param"!=a||(b.source1=c.map.movie);if("iframe"==a||"object"==a||"embed"==a||"video"==a||"audio"==a)b.type||(b.type=a),b=tinymce.extend(c.map,b);if("script"==a){var d=q(c.map.src);if(!d)return;b={type:"script",source1:c.map.src,width:d.width,height:d.height}}"source"==a&&(b.source1?b.source2||(b.source2=c.map.src):b.source1=c.map.src);"img"!=a||b.poster||(b.poster=c.map.src)}})).parse(a);b.source1=b.source1||b.src||
b.data;b.source2=b.source2||"";b.poster=b.poster||"";return b}function w(a){return a.getAttribute("data-mce-object")?p(c.serializer.serialize(a,{selection:!0})):{}}function z(a){if(!1===c.settings.media_filter_html)return a;var b=new tinymce.html.Writer,f;(new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!1,special:"script,noscript",comment:function(a){b.comment(a)},cdata:function(a){b.cdata(a)},text:function(a,c){b.text(a,c)},start:function(a,d,e){f=!0;if("script"!=a&&"noscript"!=
a){for(var g=0;g<d.length;g++){if(0===d[g].name.indexOf("on"))return;"style"==d[g].name&&(d[g].value=c.dom.serializeStyle(c.dom.parseStyle(d[g].value),a))}b.start(a,d,e);f=!1}},end:function(a){f||b.end(a)}},new tinymce.html.Schema({}))).parse(a);return b.getContent()}function t(a,b,c){function m(a,b){var c,f,d,e;for(c in b)if(d=""+b[c],a.map[c])for(f=a.length;f--;)e=a[f],e.name==c&&(d?(a.map[c]=d,e.value=d):(delete a.map[c],a.splice(f,1)));else d&&(a.push({name:c,value:d}),a.map[c]=d)}var d=new tinymce.html.Writer,
e=0,g;(new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,special:"script,noscript",comment:function(a){d.comment(a)},cdata:function(a){d.cdata(a)},text:function(a,b){d.text(a,b)},start:function(a,h,l){switch(a){case "video":case "object":case "embed":case "img":case "iframe":m(h,{width:b.width,height:b.height})}if(c)switch(a){case "video":m(h,{poster:b.poster,src:""});b.source2&&m(h,{src:""});break;case "iframe":m(h,{src:b.source1});break;case "source":e++;if(2>=e&&(m(h,{src:b["source"+
e],type:b["source"+e+"mime"]}),!b["source"+e]))return;break;case "img":if(!b.poster)return;g=!0}d.start(a,h,l)},end:function(a){if("video"==a&&c)for(var h=1;2>=h;h++)if(b["source"+h]){var l=[];l.map={};e<h&&(m(l,{src:b["source"+h],type:b["source"+h+"mime"]}),d.start("source",l,!0))}b.poster&&"object"==a&&c&&!g&&(h=[],h.map={},m(h,{src:b.poster,width:b.width,height:b.height}),d.start("img",h,!0));d.end(a)}},new tinymce.html.Schema({}))).parse(a);return d.getContent()}function u(a,b){var f,m,d,e;d=
a.attributes;for(e=d.length;e--;)if(f=d[e].name,m=d[e].value,"width"!==f&&"height"!==f&&"style"!==f){if("data"==f||"src"==f)m=c.convertURL(m,f);b.attr("data-mce-p-"+f,m)}if(f=a.firstChild&&a.firstChild.value)b.attr("data-mce-html",escape(f)),b.firstChild=null}var y=[{regex:/youtu\.be\/([\w\-.]+)/,type:"iframe",w:560,h:314,url:"//www.youtube.com/embed/$1",allowFullscreen:!0},{regex:/youtube\.com(.+)v=([^&]+)/,type:"iframe",w:560,h:314,url:"//www.youtube.com/embed/$2",allowFullscreen:!0},{regex:/youtube.com\/embed\/([a-z0-9\-_]+)/i,
type:"iframe",w:560,h:314,url:"//www.youtube.com/embed/$1",allowFullscreen:!0},{regex:/vimeo\.com\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc",allowfullscreen:!0},{regex:/vimeo\.com\/(.*)\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$2?title=0&amp;byline=0",allowfullscreen:!0},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:"iframe",w:425,h:350,url:'//maps.google.com/maps/ms?msid=$2&output=embed"',
allowFullscreen:!1},{regex:/dailymotion\.com\/video\/([^_]+)/,type:"iframe",w:480,h:270,url:"//www.dailymotion.com/embed/video/$1",allowFullscreen:!0}],x=tinymce.Env.ie&&8>=tinymce.Env.ie?"onChange":"onInput";c.on("ResolveName",function(a){var b;1==a.target.nodeType&&(b=a.target.getAttribute("data-mce-object"))&&(a.name=b)});c.on("preInit",function(){var a=c.schema.getSpecialElements();tinymce.each(["video","audio","iframe","object"],function(b){a[b]=RegExp("</"+b+"[^>]*>","gi")});var b=c.schema.getBoolAttrs();
tinymce.each(["webkitallowfullscreen","mozallowfullscreen","allowfullscreen"],function(a){b[a]={}});c.parser.addNodeFilter("iframe,video,audio,object,embed,script",function(a){for(var b=a.length,d,e,g;b--;)if(d=a[b],d.parent&&!d.parent.attr("data-mce-object")){if("script"==d.name&&(g=q(d.attr("src")),!g))continue;g&&(g.width&&d.attr("width",g.width.toString()),g.height&&d.attr("height",g.height.toString()));if("iframe"==d.name&&!1!==c.settings.media_live_embeds&&tinymce.Env.ceFalse){e=d;var k=void 0,
h=void 0,l=void 0,l=e.name,k=new tinymce.html.Node("span",1);k.attr({contentEditable:"false",style:e.attr("style"),"data-mce-object":l,"class":"mce-preview-object mce-object-"+l});u(e,k);h=new tinymce.html.Node(l,1);h.attr({src:e.attr("src"),allowfullscreen:e.attr("allowfullscreen"),width:e.attr("width")||"300",height:e.attr("height")||("audio"==l?"30":"150"),frameborder:"0"});l=new tinymce.html.Node("span",1);l.attr("class","mce-shim");k.append(h);k.append(l)}else e=d,k=void 0,h=e.name,k=new tinymce.html.Node("img",
1),k.shortEnded=!0,u(e,k),k.attr({width:e.attr("width")||"300",height:e.attr("height")||("audio"==h?"30":"150"),style:e.attr("style"),src:tinymce.Env.transparentSrc,"data-mce-object":h,"class":"mce-object mce-object-"+h});e=k;d.replace(e)}});c.serializer.addAttributeFilter("data-mce-object",function(a,b){for(var c=a.length,e,g,k,h,l;c--;)if(e=a[c],e.parent){l=e.attr(b);g=new tinymce.html.Node(l,1);"audio"!=l&&"script"!=l&&((k=e.attr("class"))&&-1!==k.indexOf("mce-preview-object")?g.attr({width:e.firstChild.attr("width"),
height:e.firstChild.attr("height")}):g.attr({width:e.attr("width"),height:e.attr("height")}));g.attr({style:e.attr("style")});h=e.attributes;for(k=h.length;k--;){var n=h[k].name;0===n.indexOf("data-mce-p-")&&g.attr(n.substr(11),h[k].value)}"script"==l&&g.attr("type","text/javascript");if(l=e.attr("data-mce-html"))k=new tinymce.html.Node("#text",3),k.raw=!0,k.value=z(unescape(l)),g.append(k);e.replace(g)}})});c.on("click keyup",function(){var a=c.selection.getNode();a&&c.dom.hasClass(a,"mce-preview-object")&&
c.dom.getAttrib(a,"data-mce-selected")&&a.setAttribute("data-mce-selected","2")});c.on("ObjectSelected",function(a){var b=a.target.getAttribute("data-mce-object");"audio"!=b&&"script"!=b||a.preventDefault()});c.on("objectResized",function(a){var b=a.target,c;b.getAttribute("data-mce-object")&&(c=b.getAttribute("data-mce-html"))&&(c=unescape(c),b.setAttribute("data-mce-html",escape(t(c,{width:a.width,height:a.height}))))});c.addButton("media",{tooltip:"Insert/edit video",onclick:n,stateSelector:["img[data-mce-object]",
"span[data-mce-object]"]});c.addMenuItem("media",{icon:"media",text:"Insert/edit video",onclick:n,context:"insert",prependToContext:!0});c.on("setContent",function(){c.$("span.mce-preview-object").each(function(a,b){var f=c.$(b);0===f.find("span.mce-shim",b).length&&f.append('<span class="mce-shim"></span>')})});c.addCommand("mceMedia",n);this.showDialog=n});
