(function(E){E.initForm=function(b,x,y,v,w,Q,R,S,I,O,T,C,J,L){function F(a,h){return a.ord<h.ord?-1:a.ord>h.ord?1:0}this.ajaxURL=y;this.containerId=b;var D=this;C=JSON.parse(C);T&&$("#"+b+"_user_form").effect("shake",{distance:10,times:3,duration:300});$("#"+b+"_user_form form").on("submit",function(){window.onbeforeunload=null});zenario.isPublic||zenario._3fp(this,6E5);if(O){if(1<I&&(window.onbeforeunload=function(){return!0},void 0!==zenario_conductor)){var U=this.phrase("Changes you made may not be saved.");
zenario_conductor._pf0(b,function(){return!0},function(a){confirm(U)&&a()},U)}w&&(window.onbeforeunload=null)}if(R)$("#"+b+" .page_switcher li.step").on("click",function(){var a=$(this).data("page");a<=I&&a!=S&&(window.onbeforeunload=null,D.submitForm(b,{target_page:a},!0))});v&&($.colorbox({transition:"none",html:v,escKey:!1,overlayClose:!1,onOpen:function(){var a=get("colorbox");a.className=E.moduleClassName;$(a).hide().fadeIn()}}),zenario._bly());$("#"+b+"_user_form .form_buttons .next.submit").on("click",
function(){D.submitForm(b,{submitForm:!0},!0)});$("#"+b+"_user_form .form_buttons .next:not(.submit)").on("click",function(){D.submitForm(b,{next:!0},!0)});$("#"+b+"_user_form .form_buttons .previous").on("click",function(){D.submitForm(b,{previous:!0},!0)});$("#"+b+" input.saveLater").on("click",function(){var a=$(this).data("message");confirm(a)&&D.submitForm(b,{saveLater:!0})});$("#"+b+"_user_form .field_attachment .remove_attachment").on("click",function(){var a=$(this).data("id"),h={};h["remove_attachment_"+
a]=!0;D.submitForm(b,h)});$("#"+b+"_print_page").on("click",function(){D.printFormPage(b)});var V=$("#"+b+"_fullscreen"),Y=$("#"+b+' input[name="inFullScreen"]');V.on("click",function(){$("#ui-datepicker-div").detach().appendTo("#"+b);zenario._awe($("#"+b)[0])});$(document).on(zenario.fullScreenChangeEvent,function(){var a=zenario._5cs();V.toggle(!a);Y.val(a?1:0);$("#"+b+"_form_wrapper").toggleClass("in_fullscreen",a)});w&&zenario._3gi();$("#"+b+"_user_form input.jquery_form_datepicker").each(function(a,
h){if(h.id){h.value=$.datepicker.formatDate(zenario.dpf,$.datepicker.parseDate("yy-mm-dd",get(h.id+"__0").value));a={dateFormat:zenario.dpf,altField:"#"+h.id+"__0",altFormat:"yy-mm-dd",showOn:"focus",onClose:function(g,f){get(h.id+"__0");f=$.datepicker.formatDate(zenario.dpf,$.datepicker.parseDate("yy-mm-dd",get(h.id+"__0").value));g&&f?g&&f&&(h.value=f):m.datepicker("setDate",null)}};$(this).data("selectors")&&(a.changeMonth=!0,a.changeYear=!0,a.yearRange="c-100:c+5");$(this).data("no_past_dates")&&
(a.minDate=new Date);$(this).data("no_future_dates")&&(a.maxDate=new Date);var m=$("#"+h.id);m.datepicker(a);$("#"+h.id+"__clear").on("click",function(){m.datepicker("setDate",null)});Q&&zenario._5cs()&&$("#ui-datepicker-div").detach().appendTo("#"+b)}});$("#"+b+"_user_form select.source_field").on("change",function(){E.submitForm(b,{filter:1})});$("#"+b+"_user_form .form_field.visible_on_condition, #"+b+"_user_form .repeat_block.visible_on_condition, .page_switcher li.visible_on_condition").each(function(a,
h){var m=this,g=$(this).data("cfields");$(this).data("id");if(g.length)for(a=0;a<g.length;a++){var f=g[a];(function(d){$("#"+b+"_field_"+f.id+" :input").on("change",function(){for(var c=!0,n=d;n<g.length;n++){var k=g[n],l=$("#"+b+"_field_"+k.id+" :input");if("checkboxes"==k.type){var q=[];l.each(function(){$(this).is(":checked")&&q.push($(this).data("value"))});l=k.value?_.map(k.value.toString().split(","),Number):[];if("AND"==k.operator)c=_._ngm(q,l),c=_._ngm(q,c),c=_._3d(c,l);else{c=!1;for(var u=
0;u<q.length;u++)if(-1!=l.indexOf(q[u])){c=!0;break}}}else l=l.is(":checkbox")?l.is(":checked"):"radios"==k.type||"centralised_radios"==k.type?l.filter(":checked").val():l.val(),c="string"==typeof k.value&&1<k.value.split(",").length?-1!==k.value.split(",").indexOf(l):!!(""===k.value&&l||""!==k.value&&k.value==l);c=k.invert?!c:c;if(!c||n==g.length-1){$(m).toggle(c);break}}})})(a)}});$("#"+b+"_user_form .form_field.restatement").each(function(a,h){var m=this;if(a=$(this).data("fieldid"))if(a=$("#"+
b+'_user_form .form_field :input[name="field_'+a+'"]'),0<a.length)if(a.is("input"))a.on("keyup",function(){$(m).find(":input").val($(this).val())});else if(a.is("select"))a.on("change",function(){$(m).find(":input").val(""===$(this).val()?"":$(this).find("option:selected").text())})});var W=function(a){return""===a||isNaN(a)||-1<a.toString().toLowerCase().indexOf("e")};$("#"+b+"_user_form .form_field.calculated").each(function(a,h){var m=$(this).find("input"),g=$(this).data("prefix"),f=$(this).data("postfix"),
d=m.data("repeated"),c=m.data("repeated_row"),n=m.data("repeat_id"),k=$("#"+b+"_field_"+$(h).data("id")+"_calculation_code").text();if(k){k=JSON.parse(k);var l={},q="";if(k&&(q=D.buildFieldCalculation(b,k,l))){var u={};for(a in l){var z=$("#"+b+'_user_form .form_field input[name="field_'+a+'"]');if(0<z.length){if(z.data("repeated")&&d&&z.data("repeat_id")==n){if(1<c&&(z=$("#"+b+'_user_form .form_field input[name="field_'+a+"_"+c+'"]'),0==z.length))continue}else z.data("repeated")&&(z._repeatedFields=
[],k=$("#"+b+"_user_form .form_field.field_"+a+"_repeat input"),k.each(function(e,r){z._repeatedFields.push($(this));u[a+"_"+e]=$(this)}));u[a]=z}else q=q.replace("[[FIELD_"+a+"]]",+l[a])}var t,A,M;for(a in u)u[a].on("keyup",function(){var e=q,r=!1,p=0;for(t in u){(A=u[t].val())||(A=0);if(W(A)){r=!0;break}if(u[t]._repeatedFields&&u[t]._repeatedFields.length){for(var G=[A],B=0;B<u[t]._repeatedFields.length;B++){var N=u[t]._repeatedFields[B].val();N||(N=0);if(W(N)){r=!0;break}G.push(N)}A="("+G.join(" + ")+
")"}M="\\[\\[FIELD_"+t+"\\]\\]";e=e.replace(new RegExp(M,"g"),A)}!r&&(p=Parser.evaluate(e),!_._fl3(p)||999999999999999<p||-999999999999999>p)&&(r=!0);r?p="NaN":(p=+p.toFixed(2),g&&(p=g+""+p),f&&(p=p+""+f));m.val(p);$("#"+b+'_user_form .form_field.restatement[data-fieldid="'+$(h).data("id")+'"] :input').val(p)})}}});$("#"+b+"_user_form .repeat_block").each(function(a,h){var m=$(this).data("id");$(this).find("div.add").on("click",function(){E.submitForm(b,{add_repeat_row:m})});$(this).find("div.delete").on("click",
function(){var g=$(this).data("row");E.submitForm(b,{delete_repeat_row:m,row:g})})});$("#"+b+"_user_form .suggested_values_json").each(function(){var a=this,h=JSON.parse($(this).text());if(h){for(var m=[],g=0;g<h.length;g++)m.push({value:h[g].v,label:h[g].l});$(this).prev().autocomplete({minLength:0,source:m,select:function(f,d){f.preventDefault();var c=f="";d.item&&(f=d.item.label,c=d.item.value);$(a).next().val(c);$(a).prev().val(f);$(a).data("source_field")&&E.submitForm(b,{filter:1})},focus:function(f,
d){this.value=d.item.label;f.preventDefault()},change:function(f,d){if(!d.item){var c=$(this).val();((f=m.find(function(n){return n.label.toLowerCase()===c.toLowerCase()}))||$(a).data("force_suggested_values"))&&$(this).data("ui-autocomplete")._trigger("select","autocompleteselect",{item:f})}},open:function(f,d){var c=this;$("#"+b+"_user_form").scroll(function(){$(c).autocomplete("close")})}}).on("click",function(){if(0==m.length){var f=$(a).data("filter_placeholder");f&&$(this).prop("placeholder",
f)}$(this).autocomplete("search","")})}});(function(){function a(g,f){var d=h(f);d=zenario._sbf("file_upload_row",d);var c=$("#"+b+"_field_"+g+" .files");c.html(d);c.find(".file_row .delete").on("click",function(){if(confirm(C.delete_file)){var n=$(this).parent().data("id");delete f[n];a(g,f)}});$('input[name="field_'+g+'"]').val(JSON.stringify(f))}function h(g){var f=[],d;for(d in g)f.push(g[d]);f.sort(F);return f}function m(g,f,d,c){$("#"+b+"_field_"+g+NaN).toggle(c).find(".progress_bar").css("width",
d+"%")}$("#"+b+"_user_form .field_file_picker:not(.readonly)").each(function(){var g=$(this).data("id"),f=JSON.parse($('input[name="field_'+g+'"]').val());f||(f={});a(g,f);$(this).find(".file_picker_field").fileupload({url:y+"&fileUpload=1",dataType:"json",maxFileSize:J,messages:{maxFileSize:"The max file size limit is "+L+"."},start:function(d){m(g,0,!0)},progressall:function(d,c){d=parseInt(c.loaded/c.total*100,10);m(g,d,!0)},done:function(d,c){d=h(f);var n=d.length&&d[d.length-1].ord?d[d.length-
1].ord:1;$.each(c.result.files,function(k,l){n++;l.id="t"+n;l.ord=n;f[l.id]=l});a(g,f)},stop:function(d){m(g,0,!1)}})})})();(function(){function a(d,c){var n=m(c);n=zenario._sbf("document_upload_row",n);var k=$("#"+b+"_field_"+d+" .popup_1 .files");k.html(n);k.find(".file_row .delete").on("click",function(){if(confirm(C.delete_file)){var l=$(this).parent().data("id");delete c[l];a(d,c);l=$("#"+b+"__field_"+d+"__files_upload_error");l.html("");l.hide()}})}function h(d,c){var n=m(c),k=zenario._sbf("document_upload_uploaded_file",
n),l=$("#"+b+"_field_"+d+" .popup_2 .files");l.html(k);l.find(".file_row .delete").on("click",function(){if(confirm(C.delete_file)){var q=$(this).parent().data("id");delete c[q];h(d,c)}});l.find(".file_row .rotate").on("click",function(){var q=$(this).parent().data("id");c[q].rotate||(c[q].rotate=0);c[q].rotate=(c[q].rotate+90)%360;JSON.stringify(c[q]);l.find(".file_"+q+" .icon img").css({transform:"rotate("+c[q].rotate+"deg)","-ms-transform":"rotate("+c[q].rotate+"deg)","-moz-transform":"rotate("+
c[q].rotate+"deg)","-webkit-transform":"rotate("+c[q].rotate+"deg)","-o-transform":"rotate("+c[q].rotate+"deg)"})});n.length&&l.sortable({containment:"parent",tolerance:"pointer",items:"div.file_row",start:function(q,u){D.startIndex=u.item.index()},stop:function(q,u){D.startIndex!=u.item.index()&&l.find(".file_row").each(function(z){var t=$(this).data("id");c[t].ord=z+1})}})}function m(d){var c=[],n;for(n in d)c.push(d[n]);c.sort(F);return c}function g(d,c,n,k){$("#"+b+"_field_"+d+" ."+c+" .progress").toggle(k).find(".progress_bar").css("width",
n+"%")}function f(d,c){m(c).length?confirm(C.are_you_sure_message)&&d.hide():d.hide()}$("#"+b+"_user_form .field_document_upload").each(function(){var d=this,c=$(this).data("id"),n=$(this).find(".overlay_1"),k=$(this).find(".overlay_2"),l=$(this).find(".popup_1 .files"),q=$(this).find(".popup_2 .files"),u=$(this).find('input[name="field_'+c+'"]'),z=$(this).data("filename"),t={},A={};$(this).find(".open_popup_1").on("click",function(){u.val()&&(t=JSON.parse(u.val()));t||(t={});a(c,t);n.show()});$(this).find(".open_popup_2").on("click",
function(){A={};h(c,A);k.show()});$(this).find(".popup_1 .close").on("click",function(){f(n,t)});$(this).find(".popup_2 .close").on("click",function(){f(k,A)});window.onclick=function(){event.target==n[0]?f(n,t):event.target==k[0]&&f(k,A)};var M=!1;$(this).find(".popup_1 .upload_complete_files").fileupload({url:y+"&fileUpload=1",dataType:"json",dropZone:l,maxFileSize:J,messages:{maxFileSize:"The max file size limit is "+L+"."},processstart:function(e){M||(M=!0,e=$("#"+b+"__field_"+c+"__files_upload_error"),
e.html(""),e.hide(),setTimeout(function(){M=!1},1E4))},start:function(e){g(c,"popup_1",0,!0)},progressall:function(e,r){e=parseInt(r.loaded/r.total*100,10);g(c,"popup_1",e,!0)},done:function(e,r){e=m(t);var p=e.length&&e[e.length-1].ord?e[e.length-1].ord:1;$.each(r.result.files,function(G,B){p++;B.id="t"+p;B.ord=p;t[B.id]=B});a(c,t)},stop:function(e){g(c,"popup_1",0,!1)},processfail:function(e,r){e=$("#"+b+"__field_"+c+"__files_upload_error");e.append('<p>The file "'+r.files[0].name+'" could not be uploaded. '+
r.files[0].error+"</p>");e.show()}});$(this).find(".popup_1 .save").on("click",function(){var e=m(t),r=[],p;for(p=0;p<e.length;p++){var G=e[p];r.push('<a href="'+G.path+'" target="_blank">'+G.name+"</a>")}e=r.join(", ");$(d).find(".files_preview").html(e);u.val(JSON.stringify(t));n.hide();k.hide()});$(this).find(".popup_2 .upload_file_fragments").fileupload({url:y+"&fileUpload=1&thumbnail=1",dataType:"json",dropZone:q,maxFileSize:J,messages:{maxFileSize:"The max file size limit is "+L+"."},start:function(e){g(c,
"popup_2",0,!0)},progressall:function(e,r){e=parseInt(r.loaded/r.total*100,10);g(c,"popup_2",e,!0)},done:function(e,r){e=m(A);var p=e.length&&e[e.length-1].ord?e[e.length-1].ord:1;$.each(r.result.files,function(G,B){p++;B.id="t"+p;B.ord=p;A[B.id]=B});h(c,A)},stop:function(e){g(c,"popup_2",0,!1)}});$(this).find(".popup_2 .combine").on("click",function(){var e=m(A);if(e.length){var r=this;$(r).val(C.combining);if(z){var p=z;var G=1,B=m(t),N=new RegExp(p+"(?:_(\\d+))?.pdf$"),X=!1,P;for(P=0;P<B.length;P++)(X=
B[P].name.match(N))&&(G=+X[1]+1);p+="_"+G}else p=$(d).find(".filename").val();e={name:p,files:JSON.stringify(e)};zenario.ajax(y+"&combineFiles=1",e).after(function(K){if((K=JSON.parse(K))&&K.path){var H=m(t);H=H.length&&H[H.length-1].ord?H[H.length-1].ord:1;H++;K.id="t"+H;K.ord=H;t[K.id]=K;a(c,t);$(d).find(".filename").val(z?z:"my-combined-file");k.hide();A={};h(c,[])}$(r).val(C.combine)})}})})})();$("#"+b+"_user_form input.set_predefined_text").on("click",function(){var a=$(this).data("id"),h=!0;
$("#"+b+"_field_"+a+" textarea").val()&&(h=confirm(C.set_predefined_text_warning));h&&(h={},h["set_predefined_text_"+a]=!0,D.submitForm(b,h))});$(function(){$("#"+b+"_sortable1, #"+b+"_sortable2").sortable({connectWith:".connectedSortable",update:function(a,h){a=$("#"+b+"_sortable1");a=String(a.sortable("toArray",{attribute:"data-value"}));$("#"+b+"_sortable1_values").val(a);a=$("#"+b+"_sortable2").sortable("toArray",{attribute:"data-value"});$("#"+b+"_sortable2_values").val(a)}}).disableSelection()})};
E.printFormPage=function(){var b=$("#"+this.containerId+" .form_fields").html(),x=window.screenX+$(window).width()/2,y=window.open("","Print-Window","width=300,height=300,left="+x+",top="+window.screenY);y.document.open();y.document.write('<html><body onload="window.print()">'+b+"</body></html>");y.document.close();setTimeout(function(){y.close()},10)};E.buildFieldCalculation=function(b,x,y){for(var v="",w=0;w<x.length;w++)switch(x[w].type){case "static_value":v+=+x[w].value;break;case "field":if("NaN"==
x[w].v&&0>=$("#"+b+'_user_form .form_field input[name="field_'+x[w].value+'"]').length)return!1;y[x[w].value]=x[w].v;v+="[[FIELD_"+x[w].value+"]]";break;case "parentheses_open":v+="(";break;case "parentheses_close":v+=")";break;case "operation_addition":v+="+";break;case "operation_subtraction":v+="-";break;case "operation_multiplication":v+="*";break;case "operation_division":v+="/"}return v};E.validateFormFieldJs=function(b,x,y,v,w,Q,R,S,I,O,T){var C=document.getElementById(v);v=document.getElementById(w);
var J=document.getElementById(w+"__error_message");if(C&&v){switch(Q){case "group":case "checkbox":var L=v.checked?1:0;break;case "url":case "text":case "textarea":L=v.value}if(I)if(b="radios"==O||"centralised_radios"==O?b+"_field_"+I:b+"__field_"+I,w=document.getElementById(b))switch(O){case "group":case "checkbox":var F=w.checked?1:0;break;case "restatement":case "calculated":case "url":case "text":case "textarea":case "select":case "centralised_select":F=w.value;break;case "radios":case "centralised_radios":try{F=
document.querySelector('input[name="field_'+I+'"]:checked').value}catch(D){F=""}break;case "date":F=document.getElementById(b+"__0").value}else F=null;else F="";x={formId:x,fieldId:y,fieldValue:L};x.conditionalFieldValue=F;zenario.ajax(this.ajaxURL+"&validateFormFieldJs=1",x).after(function(D){J.innerHTML=htmlspecialchars(D);D?(C.classList.remove("no_error"),C.classList.add("has_error"),J.style.display="block"):(C.classList.add("no_error"),C.classList.remove("has_error"),J.style.display="none")})}};
E.submitForm=function(b,x,y){var v=$("#"+b+"_user_form form");y||(zenario.blockScrollToTop=!0);if(x)for(var w in x)v.append('<input type="hidden" name="'+w+'" value="'+x[w]+'"/>');$("#"+b+"_user_form .field_document_upload, #"+b+"_user_form .field_file_picker").each(function(){$(this).find('input[type="file"]').remove()});v.submit()};E.toggleForm=function(b){$("#"+b).toggleClass("show").toggleClass("hide")}})(zenario_user_forms);
