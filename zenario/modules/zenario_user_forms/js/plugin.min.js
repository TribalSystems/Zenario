'use strict';(function(E){E.initForm=function(c,y,C,z,A,Q,R,S,L,T,U,F){function M(a,g){return a.ord<g.ord?-1:a.ord>g.ord?1:0}this.containerId=c;var D=this;F=JSON.parse(F);U&&$("#"+c+"_user_form").effect("shake",{distance:10,times:3,duration:300});$("#"+c+"_user_form form").on("submit",function(){window.onbeforeunload=null});zenario.isPublic||zenario.startPoking(this,6E5);if(T){if(1<L&&(window.onbeforeunload=function(){return!0},void 0!==zenario_conductor)){var N=this.phrase("Changes you made may not be saved.");
zenario_conductor._cOC(c,function(){return!0},function(a){confirm(N)&&a()},N)}A&&(window.onbeforeunload=null)}if(R)$("#"+c+" .page_switcher li.step").on("click",function(){var a=$(this).data("page");a<=L&&a!=S&&(window.onbeforeunload=null,D.submitForm(c,{target_page:a},!0))});z&&($.colorbox({transition:"none",html:z,escKey:!1,overlayClose:!1,onOpen:function(){var a=get("colorbox");a.className=E.moduleClassName;$(a).hide().fadeIn()}}),zenario._rC());$("#"+c+"_user_form .form_buttons .next.submit").on("click",
function(){D.submitForm(c,{submitForm:!0},!0)});$("#"+c+"_user_form .form_buttons .next:not(.submit)").on("click",function(){D.submitForm(c,{next:!0},!0)});$("#"+c+"_user_form .form_buttons .previous").on("click",function(){D.submitForm(c,{previous:!0},!0)});$("#"+c+" input.saveLater").on("click",function(){var a=$(this).data("message");confirm(a)&&D.submitForm(c,{saveLater:!0})});$("#"+c+"_user_form .field_attachment .remove_attachment").on("click",function(){var a=$(this).data("id"),g={};g["remove_attachment_"+
a]=!0;D.submitForm(c,g)});$("#"+c+"_print_page").on("click",function(){D.printFormPage(c)});var O=$("#"+c+"_fullscreen"),V=$("#"+c+' input[name="inFullScreen"]');O.on("click",function(){$("#ui-datepicker-div").detach().appendTo("#"+c);zenario._eFS($("#"+c)[0])});$(document).on(zenario.fullScreenChangeEvent,function(){var a=zenario._iFS();O.toggle(!a);V.val(a?1:0);$("#"+c+"_form_wrapper").toggleClass("in_fullscreen",a)});A&&zenario._exFuSc();$("#"+c+"_user_form input.jquery_form_datepicker").each(function(a,
g){if(g.id){g.value=$.datepicker.formatDate(zenario.dpf,$.datepicker.parseDate("yy-mm-dd",get(g.id+"__0").value));a={dateFormat:zenario.dpf,altField:"#"+g.id+"__0",altFormat:"yy-mm-dd",showOn:"focus",onClose:function(f,e){get(g.id+"__0");e=$.datepicker.formatDate(zenario.dpf,$.datepicker.parseDate("yy-mm-dd",get(g.id+"__0").value));f&&e?f&&e&&(g.value=e):l.datepicker("setDate",null)}};$(this).data("selectors")&&(a.changeMonth=!0,a.changeYear=!0,a.yearRange="c-100:c+5");$(this).data("no_past_dates")&&
(a.minDate=new Date);$(this).data("no_future_dates")&&(a.maxDate=new Date);var l=$("#"+g.id);l.datepicker(a);$("#"+g.id+"__clear").on("click",function(){l.datepicker("setDate",null)});Q&&zenario._iFS()&&$("#ui-datepicker-div").detach().appendTo("#"+c)}});$("#"+c+"_user_form select.source_field").on("change",function(){E.submitForm(c,{filter:1})});$("#"+c+"_user_form .form_field.visible_on_condition, #"+c+"_user_form .repeat_block.visible_on_condition, .page_switcher li.visible_on_condition").each(function(a,
g){var l=this,f=$(this).data("cfields");$(this).data("id");if(f.length)for(a=0;a<f.length;a++){var e=f[a];(function(d){$("#"+c+"_field_"+e.id+" :input").on("change",function(){for(var b=!0,n=d;n<f.length;n++){var h=f[n],m=$("#"+c+"_field_"+h.id+" :input");if("checkboxes"==h.type){var p=[];m.each(function(){$(this).is(":checked")&&p.push($(this).data("value"))});m=h.value?_._m(h.value.toString().split(","),Number):[];if("AND"==h.operator)b=_.intersection(p,m),b=_.intersection(p,b),b=_._isEq(b,m);else{b=
!1;for(var t=0;t<p.length;t++)if(-1!=m.indexOf(p[t])){b=!0;break}}}else m=m.is(":checkbox")?m.is(":checked"):"radios"==h.type||"centralised_radios"==h.type?m.filter(":checked").val():m.val(),b="string"==typeof h.value&&1<h.value.split(",").length?-1!==h.value.split(",").indexOf(m):!!(""===h.value&&m||""!==h.value&&h.value==m);b=h.invert?!b:b;if(!b||n==f.length-1){$(l).toggle(b);break}}})})(a)}});$("#"+c+"_user_form .form_field.restatement").each(function(a,g){var l=this;if(a=$(this).data("fieldid"))if(a=
$("#"+c+'_user_form .form_field :input[name="field_'+a+'"]'),0<a.length)if(a.is("input"))a.on("keyup",function(){$(l).find(":input").val($(this).val())});else if(a.is("select"))a.on("change",function(){$(l).find(":input").val(""===$(this).val()?"":$(this).find("option:selected").text())})});var P=function(a){return""===a||isNaN(a)||-1<a.toString().toLowerCase().indexOf("e")};$("#"+c+"_user_form .form_field.calculated").each(function(a,g){var l=$(this).find("input"),f=$(this).data("prefix"),e=$(this).data("postfix"),
d=l.data("repeated"),b=l.data("repeated_row"),n=l.data("repeat_id"),h=$("#"+c+"_field_"+$(g).data("id")+"_calculation_code").text();if(h){h=JSON.parse(h);var m={},p="";if(h&&(p=D.buildFieldCalculation(c,h,m))){var t={};for(a in m){var w=$("#"+c+'_user_form .form_field input[name="field_'+a+'"]');if(0<w.length){if(w.data("repeated")&&d&&w.data("repeat_id")==n){if(1<b&&(w=$("#"+c+'_user_form .form_field input[name="field_'+a+"_"+b+'"]'),0==w.length))continue}else w.data("repeated")&&(w._repeatedFields=
[],h=$("#"+c+"_user_form .form_field.field_"+a+"_repeat input"),h.each(function(u,r){w._repeatedFields.push($(this));t[a+"_"+u]=$(this)}));t[a]=w}else p=p.replace("[[FIELD_"+a+"]]",+m[a])}var q,x,k;for(a in t)t[a].on("keyup",function(){var u=p,r=!1,v=0;for(q in t){(x=t[q].val())||(x=0);if(P(x)){r=!0;break}if(t[q]._repeatedFields&&t[q]._repeatedFields.length){for(var B=[x],J=0;J<t[q]._repeatedFields.length;J++){var H=t[q]._repeatedFields[J].val();H||(H=0);if(P(H)){r=!0;break}B.push(H)}x="("+B.join(" + ")+
")"}k="\\[\\[FIELD_"+q+"\\]\\]";u=u.replace(new RegExp(k,"g"),x)}!r&&(v=Parser.evaluate(u),!_._iF(v)||999999999999999<v||-999999999999999>v)&&(r=!0);r?v="NaN":(v=+v.toFixed(2),f&&(v=f+""+v),e&&(v=v+""+e));l.val(v);$("#"+c+'_user_form .form_field.restatement[data-fieldid="'+$(g).data("id")+'"] :input').val(v)})}}});$("#"+c+"_user_form .repeat_block").each(function(a,g){var l=$(this).data("id");$(this).find("div.add").on("click",function(){E.submitForm(c,{add_repeat_row:l})});$(this).find("div.delete").on("click",
function(){var f=$(this).data("row");E.submitForm(c,{delete_repeat_row:l,row:f})})});$("#"+c+"_user_form .suggested_values_json").each(function(){var a=this,g=JSON.parse($(this).text());if(g){for(var l=[],f=0;f<g.length;f++)l.push({value:g[f].v,label:g[f].l});$(this).prev().autocomplete({minLength:0,source:l,select:function(e,d){e.preventDefault();var b=e="";d.item&&(e=d.item.label,b=d.item.value);$(a).next().val(b);$(a).prev().val(e);$(a).data("source_field")&&E.submitForm(c,{filter:1})},focus:function(e,
d){this.value=d.item.label;e.preventDefault()},change:function(e,d){if(!d.item){var b=$(this).val();((e=l.find(function(n){return n.label.toLowerCase()===b.toLowerCase()}))||$(a).data("force_suggested_values"))&&$(this).data("ui-autocomplete")._trigger("select","autocompleteselect",{item:e})}},open:function(e,d){var b=this;$("#"+c+"_user_form").scroll(function(){$(b).autocomplete("close")})}}).on("click",function(){if(0==l.length){var e=$(a).data("filter_placeholder");e&&$(this).prop("placeholder",
e)}$(this).autocomplete("search","")})}});(function(){function a(f,e){var d=g(e);d=zenario._mT("file_upload_row",d);var b=$("#"+c+"_field_"+f+" .files");b.html(d);b.find(".file_row .delete").on("click",function(){if(confirm(F.delete_file)){var n=$(this).parent().data("id");delete e[n];a(f,e)}});$('input[name="field_'+f+'"]').val(JSON.stringify(e))}function g(f){var e=[],d;for(d in f)e.push(f[d]);e.sort(M);return e}function l(f,e,d,b){$("#"+c+"_field_"+f+NaN).toggle(b).find(".progress_bar").css("width",
d+"%")}$("#"+c+"_user_form .field_file_picker:not(.readonly)").each(function(){var f=$(this).data("id"),e=JSON.parse($('input[name="field_'+f+'"]').val());e||(e={});a(f,e);$(this).find(".file_picker_field").fileupload({url:C+"&fileUpload=1",dataType:"json",start:function(d){l(f,0,!0)},progressall:function(d,b){d=parseInt(b.loaded/b.total*100,10);l(f,d,!0)},done:function(d,b){d=g(e);var n=d.length&&d[d.length-1].ord?d[d.length-1].ord:1;$.each(b.result.files,function(h,m){n++;m.id="t"+n;m.ord=n;e[m.id]=
m});a(f,e)},stop:function(d){l(f,0,!1)}})})})();(function(){function a(d,b){var n=l(b);n=zenario._mT("document_upload_row",n);var h=$("#"+c+"_field_"+d+" .popup_1 .files");h.html(n);h.find(".file_row .delete").on("click",function(){if(confirm(F.delete_file)){var m=$(this).parent().data("id");delete b[m];a(d,b)}})}function g(d,b){var n=l(b),h=zenario._mT("document_upload_uploaded_file",n),m=$("#"+c+"_field_"+d+" .popup_2 .files");m.html(h);m.find(".file_row .delete").on("click",function(){if(confirm(F.delete_file)){var p=
$(this).parent().data("id");delete b[p];g(d,b)}});m.find(".file_row .rotate").on("click",function(){var p=$(this).parent().data("id");b[p].rotate||(b[p].rotate=0);b[p].rotate=(b[p].rotate+90)%360;JSON.stringify(b[p]);m.find(".file_"+p+" .icon img").css({transform:"rotate("+b[p].rotate+"deg)","-ms-transform":"rotate("+b[p].rotate+"deg)","-moz-transform":"rotate("+b[p].rotate+"deg)","-webkit-transform":"rotate("+b[p].rotate+"deg)","-o-transform":"rotate("+b[p].rotate+"deg)"})});n.length&&m.sortable({containment:"parent",
tolerance:"pointer",items:"div.file_row",start:function(p,t){D.startIndex=t.item.index()},stop:function(p,t){D.startIndex!=t.item.index()&&m.find(".file_row").each(function(w){var q=$(this).data("id");b[q].ord=w+1})}})}function l(d){var b=[],n;for(n in d)b.push(d[n]);b.sort(M);return b}function f(d,b,n,h){$("#"+c+"_field_"+d+" ."+b+" .progress").toggle(h).find(".progress_bar").css("width",n+"%")}function e(d,b){l(b).length?confirm(F.are_you_sure_message)&&d.hide():d.hide()}$("#"+c+"_user_form .field_document_upload").each(function(){var d=
this,b=$(this).data("id"),n=$(this).find(".overlay_1"),h=$(this).find(".overlay_2"),m=$(this).find(".popup_1 .files"),p=$(this).find(".popup_2 .files"),t=$(this).find('input[name="field_'+b+'"]'),w=$(this).data("filename"),q={},x={};$(this).find(".open_popup_1").on("click",function(){t.val()&&(q=JSON.parse(t.val()));q||(q={});a(b,q);n.show()});$(this).find(".open_popup_2").on("click",function(){x={};g(b,x);h.show()});$(this).find(".popup_1 .close").on("click",function(){e(n,q)});$(this).find(".popup_2 .close").on("click",
function(){e(h,x)});window.onclick=function(){event.target==n[0]?e(n,q):event.target==h[0]&&e(h,x)};$(this).find(".popup_1 .upload_complete_files").fileupload({url:C+"&fileUpload=1",dataType:"json",dropZone:m,start:function(k){f(b,"popup_1",0,!0)},progressall:function(k,u){k=parseInt(u.loaded/u.total*100,10);f(b,"popup_1",k,!0)},done:function(k,u){k=l(q);var r=k.length&&k[k.length-1].ord?k[k.length-1].ord:1;$.each(u.result.files,function(v,B){r++;B.id="t"+r;B.ord=r;q[B.id]=B});a(b,q)},stop:function(k){f(b,
"popup_1",0,!1)}});$(this).find(".popup_1 .save").on("click",function(){var k=l(q),u=[],r;for(r=0;r<k.length;r++){var v=k[r];u.push('<a href="'+v.path+'" target="_blank">'+v.name+"</a>")}k=u.join(", ");$(d).find(".files_preview").html(k);t.val(JSON.stringify(q));n.hide();h.hide()});$(this).find(".popup_2 .upload_file_fragments").fileupload({url:C+"&fileUpload=1&thumbnail=1",dataType:"json",dropZone:p,start:function(k){f(b,"popup_2",0,!0)},progressall:function(k,u){k=parseInt(u.loaded/u.total*100,
10);f(b,"popup_2",k,!0)},done:function(k,u){k=l(x);var r=k.length&&k[k.length-1].ord?k[k.length-1].ord:1;$.each(u.result.files,function(v,B){r++;B.id="t"+r;B.ord=r;x[B.id]=B});g(b,x)},stop:function(k){f(b,"popup_2",0,!1)}});$(this).find(".popup_2 .combine").on("click",function(){var k=l(x);if(k.length){var u=this;$(u).val(F.combining);if(w){var r=w;var v=1,B=l(q),J=new RegExp(r+"(?:_(\\d+))?.pdf$"),H=!1,K;for(K=0;K<B.length;K++)(H=B[K].name.match(J))&&(v=+H[1]+1);r+="_"+v}else r=$(d).find(".filename").val();
k={name:r,files:JSON.stringify(k)};zenario._a(C+"&combineFiles=1",k).after(function(I){if((I=JSON.parse(I))&&I.path){var G=l(q);G=G.length&&G[G.length-1].ord?G[G.length-1].ord:1;G++;I.id="t"+G;I.ord=G;q[I.id]=I;a(b,q);$(d).find(".filename").val(w?w:"my-combined-file");h.hide();x={};g(b,[])}$(u).val(F.combine)})}})})})();$("#"+c+"_user_form input.set_predefined_text").on("click",function(){var a=$(this).data("id"),g=!0;$("#"+c+"_field_"+a+" textarea").val()&&(g=confirm(F.set_predefined_text_warning));
g&&(g={},g["set_predefined_text_"+a]=!0,D.submitForm(c,g))})};E.printFormPage=function(){var c=$("#"+this.containerId+" .form_fields").html(),y=window.screenX+$(window).width()/2,C=window.open("","Print-Window","width=300,height=300,left="+y+",top="+window.screenY);C.document.open();C.document.write('<html><body onload="window.print()">'+c+"</body></html>");C.document.close();setTimeout(function(){C.close()},10)};E.buildFieldCalculation=function(c,y,C){for(var z="",A=0;A<y.length;A++)switch(y[A].type){case "static_value":z+=
+y[A].value;break;case "field":if("NaN"==y[A].v&&0>=$("#"+c+'_user_form .form_field input[name="field_'+y[A].value+'"]').length)return!1;C[y[A].value]=y[A].v;z+="[[FIELD_"+y[A].value+"]]";break;case "parentheses_open":z+="(";break;case "parentheses_close":z+=")";break;case "operation_addition":z+="+";break;case "operation_subtraction":z+="-";break;case "operation_multiplication":z+="*";break;case "operation_division":z+="/"}return z};E.submitForm=function(c,y,C){var z=$("#"+c+"_user_form form");C||
(zenario.blockScrollToTop=!0);if(y)for(var A in y)z.append('<input type="hidden" name="'+A+'" value="'+y[A]+'"/>');$("#"+c+"_user_form .field_document_upload, #"+c+"_user_form .field_file_picker").each(function(){$(this).find('input[type="file"]').remove()});z.submit()};E.toggleForm=function(c){$("#"+c).toggleClass("show").toggleClass("hide")}})(zenario_user_forms);
