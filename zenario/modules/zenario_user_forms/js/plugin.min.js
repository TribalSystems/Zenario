(function(f){f.initForm=function(a,c,p,b,h,v,w,x,t,y){this.containerId=a;var q=this;$("#"+a+"_user_form form").on("submit",function(){window.onbeforeunload=null});this.startPoking();y&&(1<t&&(window.onbeforeunload=function(){return!0}),h&&(window.onbeforeunload=null));if(w)$("#"+a+" .page_switcher li.step").on("click",function(){var e=$(this).data("page");e<=t&&e!=x&&(window.onbeforeunload=null,q.submitForm(a,c,{target_page:e},!0))});b&&($.colorbox({transition:"none",html:b,escKey:!1,overlayClose:!1,
onOpen:function(){var a=get("colorbox");a.className=f.moduleClassName;$(a).hide().fadeIn()}}),zenario.resizeColorbox());$("#"+a+"_print_page").on("click",function(){q.printFormPage(a)});var r=$("#"+a+"_fullscreen"),z=$("#"+a+' input[name="inFullScreen"]');r.on("click",function(){$("#ui-datepicker-div").detach().appendTo("#"+a);zenario.enableFullScreen($("#"+a)[0])});$(document).on(zenario.fullScreenChangeEvent,function(){var e=zenario.isFullScreen();r.toggle(!e);z.val(e?1:0);$("#"+a+"_form_wrapper").toggleClass("in_fullscreen",
e)});h&&zenario.exitFullScreen();$("#"+a+"_user_form input.jquery_form_datepicker").each(function(e,m){zenario.loadDatePicker();if(m.id){m.value=$.datepicker.formatDate(zenario.dpf,$.datepicker.parseDate("yy-mm-dd",get(m.id+"__0").value));var k={dateFormat:zenario.dpf,altField:"#"+m.id+"__0",altFormat:"yy-mm-dd",showOn:"focus",onClose:function(a,d){get(m.id+"__0");var e=$.datepicker.formatDate(zenario.dpf,$.datepicker.parseDate("yy-mm-dd",get(m.id+"__0").value));a&&e?a&&e&&(m.value=e):g.datepicker("setDate",
null)}};$(this).data("selectors")&&(k.changeMonth=!0,k.changeYear=!0,k.yearRange="c-100:c+5");var g=$("#"+m.id);g.datepicker(k);$("#"+m.id+"__clear").on("click",function(){g.datepicker("setDate",null)});v&&zenario.isFullScreen()&&$("#ui-datepicker-div").detach().appendTo("#"+a)}});$("#"+a+"_user_form select.source_field").on("change",function(){f.submitForm(a,c,{filter:1})});$("#"+a+"_user_form .form_field.visible_on_condition").each(function(e,m){var k=$(this).data("cfieldid"),g=$(this).data("cfieldvalue"),
b=$(this).data("id");if(k)$("#"+a+"_field_"+k+" :input").on("change",function(){var d;d=$(this).is(":checkbox")?$(this).is(":checked"):$(this).val();!g&&d||g&&g==d?$("#"+a+"_field_"+b).show():$("#"+a+"_field_"+b).hide()})});$("#"+a+"_user_form .repeat_block.visible_on_condition").each(function(e,m){var k=$(this).data("cfieldid"),g=$(this).data("cfieldvalue"),b=$(this).data("id");if(k)$("#"+a+"_field_"+k+" :input").on("change",function(){var d;d=$(this).is(":checkbox")?$(this).is(":checked"):$(this).val();
!g&&d||g&&g==d?$("#"+a+"_repeat_block_"+b).show():$("#"+a+"_repeat_block_"+b).hide()})});$("#"+a+"_user_form .form_field.restatement").each(function(e,b){var k=this,g=$(this).data("fieldid");if(g&&(g=$("#"+a+'_user_form .form_field :input[name="field_'+g+'"]'),0<g.length))if(g.is("input"))g.on("keyup",function(){$(k).find(":input").val($(this).val())});else if(g.is("select"))g.on("change",function(){$(k).find(":input").val(""===$(this).val()?"":$(this).find("option:selected").text())})});$("#"+a+
"_user_form .form_field.calculated").each(function(e,b){var k=$(this).find("input"),g=$(this).data("prefix"),f=$(this).data("postfix"),d=$("#"+a+"_field_"+$(b).data("id")+"_calculation_code").text();if(d){var d=JSON.parse(d),c={},h="";if(d&&(h=q.buildFieldCalculation(a,d,c))){var p={};for(e in c)d=$("#"+a+'_user_form .form_field input[name="field_'+e+'"]'),0<d.length?p[e]=d:h=h.replace("[[FIELD_"+e+"]]",+c[e]);var l,n,s;for(e in p)p[e].on("keyup",function(){var d=h,e=!1,c=0;for(l in p){n=p[l].val();
if(""==n||isNaN(n)||-1<n.toLowerCase().indexOf("e")){e=!0;break}s="\\[\\[FIELD_"+l+"\\]\\]";d=d.replace(RegExp(s,"g"),n)}!e&&(c=Parser.evaluate(d),!_.isFinite(c)||999999999999999<c||-999999999999999>c)&&(e=!0);e?c="NaN":(c=+c.toFixed(2),g&&(c=g+""+c),f&&(c=c+""+f));k.val(c);$("#"+a+'_user_form .form_field.restatement[data-fieldid="'+$(b).data("id")+'"] :input').val(c)})}}});$("#"+a+"_user_form .repeat_block").each(function(e,b){var k=$(this).data("id");$(this).find("div.add").on("click",function(){f.submitForm(a,
c,{add_repeat_row:k})});$(this).find("div.delete").on("click",function(){var e=$(this).data("row");f.submitForm(a,c,{delete_repeat_row:k,row:e})})});$("#"+a+"_user_form .autocomplete_json").each(function(){var e=this,b=JSON.parse($(this).text());if(b){for(var k=[],g=0;g<b.length;g++)k.push({value:b[g].v,label:b[g].l});$(this).prev().autocomplete({minLength:0,source:k,select:function(b,d){b.preventDefault();var g="",k="";d.item&&(g=d.item.label,k=d.item.value);$(e).next().val(k);$(e).prev().val(g);
$(e).data("source_field")&&f.submitForm(a,c,{filter:1})},focus:function(a,b){this.value=b.item.label;a.preventDefault()},change:function(a,b){if(!b.item){var e=$(this).val(),c=k.find(function(a){return a.label.toLowerCase()===e.toLowerCase()});$(this).data("ui-autocomplete")._trigger("select","autocompleteselect",{item:c})}},open:function(b,e){var c=this;$("#"+a+"_user_form").scroll(function(){$(c).autocomplete("close")})}}).on("click",function(){if(0==k.length){var a=$(e).data("auto_placeholder");
a&&$(this).prop("placeholder",a)}$(this).autocomplete("search","")})}});$("#"+a+"_user_form .field_file_picker").each(function(){var a=this,b=$(this).find(".file_picker_field"),c=$(this).find(".progress_bar"),g=$(this).find(".file_upload_button"),f=b.data("limit"),d=b.data("extensions"),h=0,q=0,a=this,t=$(this).data("id"),l=void 0;if(d){for(var l="\\.(",n=d.split(","),s=[],u=0;u<n.length;u++){var r=n[u].replace(/\./i,"").trim();r&&s.push(r)}l+=s.join("|");l=RegExp(l+")$","i")}c.progressbar();b.fileupload({url:p+
"&filePickerUpload=1",dataType:"json",maxFileSize:1E7,acceptFileTypes:l,maxNumberOfFiles:f,getNumberOfFiles:function(){return h},submit:function(a,b){h++},start:function(a){c.show()},done:function(b,c){$.each(c.result.files,function(b,c){var d;d='<div class="file_row">';d=c.download_link?d+('<p><a href="'+c.download_link+'" target="_blank">'+c.name+"</a></p>"):d+("<p>"+c.name+"</p>");d+='<input name="field_'+t+"_"+ ++q+'" type="hidden" value="'+c.id+'" />';d+='<span class="delete_file_button">'+zenario.phrase("zenario_user_forms",
"Delete")+"</span>";d+="</div>";$(a).find(".files").append($(d));h>=f&&g.hide()});$(a).find(".delete_file_button").off().on("click",function(){$(this).parent().remove();h--;h<f&&g.show()})},always:function(a,b){c.hide()},processfail:function(a,b){alert(b.files[b.index].error)},progressall:function(a,b){var d=parseInt(100*(b.loaded/b.total),10);c.progressbar("option","value",d)},messages:{acceptFileTypes:zenario.phrase("zenario_user_forms","Allowed file types: [[types]]",{types:d}),maxFileSize:zenario.phrase("zenario_user_forms",
"File exceeds maximum allowed size of 10MB"),maxNumberOfFiles:zenario.phrase("zenario_user_forms","Maximum number of files exceeded")}});d={};l=$(this).find(".loaded_files").text();d.files=JSON.parse(l);0<d.files.length&&(h=d.files.length,b.fileupload("option","done").call(b,$.Event("done"),{result:d}))})};f.printFormPage=function(){var a=$("#"+this.containerId+" .form_fields").html(),c=window.screenX+$(window).width()/2,f=window.open("","Print-Window","width=300,height=300,left="+c+",top="+window.screenY);
f.document.open();f.document.write('<html><body onload="window.print()">'+a+"</body></html>");f.document.close();setTimeout(function(){f.close()},10)};f.buildFieldCalculation=function(a,c,f){for(var b="",h=0;h<c.length;h++)switch(c[h].type){case "static_value":b+=+c[h].value;break;case "field":if("NaN"==c[h].v&&0>=$("#"+a+'_user_form .form_field input[name="field_'+c[h].value+'"]').length)return!1;f[c[h].value]=c[h].v;b+="[[FIELD_"+c[h].value+"]]";break;case "parentheses_open":b+="(";break;case "parentheses_close":b+=
")";break;case "operation_addition":b+="+";break;case "operation_subtraction":b+="-";break;case "operation_multiplication":b+="*";break;case "operation_division":b+="/"}return b};f.submitForm=function(a,c,f,b){a=$("#"+a+"_user_form form");b||(zenario.blockScrollToTop=!0);if(f)for(var h in f)a.append('<input type="hidden" name="'+h+'" value="'+f[h]+'"/>');a.submit()};f.stopPoking=function(){f.poking&&clearInterval(f.poking);f.poking=!1};f.startPoking=function(){f.poking||(f.poking=setInterval(f.poke,
12E4))};f.poke=function(){zenario.ajax(URLBasePath+"zenario/admin/quick_ajax.php?keep_session_alive=1")}})(zenario_user_forms);zenario_user_forms.recaptchaCallback=function(){recaptchaCallback()};
