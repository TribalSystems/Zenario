(function(e){e.initForm=function(a,c,n,b,h,u,w,x,q,y){this.containerId=a;var r=this;$("#"+a+"_user_form form").on("submit",function(){window.onbeforeunload=null});this.startPoking();y&&(1<q&&(window.onbeforeunload=function(){return!0}),h&&(window.onbeforeunload=null));if(w)$("#"+a+" .page_switcher li.step").on("click",function(){var f=$(this).data("page");f<=q&&f!=x&&(window.onbeforeunload=null,r.submitForm(a,c,{target_page:f},!0))});b&&($.colorbox({transition:"none",html:b,escKey:!1,overlayClose:!1,
onOpen:function(){var a=get("colorbox");a.className=e.moduleClassName;$(a).hide().fadeIn()}}),zenario.resizeColorbox());$("#"+a+"_print_page").on("click",function(){r.printFormPage(a)});var v=$("#"+a+"_fullscreen"),z=$("#"+a+' input[name="inFullScreen"]');v.on("click",function(){zenario.enableFullScreen($("#"+a)[0])});$(document).on(zenario.fullScreenChangeEvent,function(){var f=zenario.isFullScreen();v.toggle(!f);z.val(f?1:0);$("#"+a+"_form_wrapper").toggleClass("in_fullscreen",f)});h&&zenario.exitFullScreen();
$("#"+a+"_user_form input.jquery_form_datepicker").each(function(a,p){zenario.loadDatePicker();if(p.id){p.value=$.datepicker.formatDate(zenario.dpf,$.datepicker.parseDate("yy-mm-dd",get(p.id+"__0").value));var k={dateFormat:zenario.dpf,altField:"#"+p.id+"__0",altFormat:"yy-mm-dd",showOn:"focus"};$(this).data("selectors")&&(k.changeMonth=!0,k.changeYear=!0,k.yearRange="c-100:c+5");var g=$("#"+p.id);g.datepicker(k);$("#"+p.id+"__clear").on("click",function(){g.datepicker("setDate",null)})}});$("#"+
a+"_user_form select.source_field").on("change",function(){e.submitForm(a,c,{filter:1})});$("#"+a+"_user_form .form_field.visible_on_condition").each(function(f,p){var k=$(this).data("cfieldid"),g=$(this).data("cfieldvalue"),b=$(this).data("id");if(k)$("#"+a+"_field_"+k+" :input").on("change",function(){var d;d=$(this).is(":checkbox")?$(this).is(":checked"):$(this).val();null===g&&""!==d||d==g?$("#"+a+"_field_"+b).show():$("#"+a+"_field_"+b).hide()})});$("#"+a+"_user_form .repeat_block.visible_on_condition").each(function(f,
b){var k=$(this).data("cfieldid"),g=$(this).data("cfieldvalue"),e=$(this).data("id");if(k)$("#"+a+"_field_"+k+" :input").on("change",function(){var d;d=$(this).is(":checkbox")?$(this).is(":checked"):$(this).val();null===g&&""!==d||d==g?$("#"+a+"_repeat_block_"+e).show():$("#"+a+"_repeat_block_"+e).hide()})});$("#"+a+"_user_form .form_field.restatement").each(function(f,b){var k=this,g=$(this).data("fieldid");if(g&&(g=$("#"+a+'_user_form .form_field :input[name="field_'+g+'"]'),0<g.length))if(g.is("input"))g.on("keyup",
function(){$(k).find(":input").val($(this).val())});else if(g.is("select"))g.on("change",function(){$(k).find(":input").val(""===$(this).val()?"":$(this).find("option:selected").text())})});$("#"+a+"_user_form .form_field.calculated").each(function(f,b){var k=$(this).find("input"),g=$(this).data("prefix"),e=$(this).data("postfix"),d=$("#"+a+"_field_"+$(b).data("id")+"_calculation_code").text();if(d){var d=JSON.parse(d),c={},h="";if(d&&(h=r.buildFieldCalculation(a,d,c))){var n={};for(f in c)d=$("#"+
a+'_user_form .form_field input[name="field_'+f+'"]'),0<d.length?n[f]=d:h=h.replace("[[FIELD_"+f+"]]",+c[f]);var l,m,s;for(f in n)n[f].on("keyup",function(){var d=h,f=!1,c=0;for(l in n){m=n[l].val();if(""==m||isNaN(m)||-1<m.toLowerCase().indexOf("e")){f=!0;break}s="\\[\\[FIELD_"+l+"\\]\\]";d=d.replace(RegExp(s,"g"),m)}!f&&(c=Parser.evaluate(d),!_.isFinite(c)||999999999999999<c||-999999999999999>c)&&(f=!0);f?c="NaN":(c=+c.toFixed(2),g&&(c=g+""+c),e&&(c=c+""+e));k.val(c);$("#"+a+'_user_form .form_field.restatement[data-fieldid="'+
$(b).data("id")+'"] :input').val(c)})}}});$("#"+a+"_user_form .repeat_block").each(function(f,b){var k=$(this).data("id");$(this).find("div.add").on("click",function(){e.submitForm(a,c,{add_repeat_row:k})});$(this).find("div.delete").on("click",function(){var f=$(this).data("row");e.submitForm(a,c,{delete_repeat_row:k,row:f})})});$("#"+a+"_user_form .autocomplete_json").each(function(){var f=this,b=JSON.parse($(this).text());if(b){for(var k=[],g=0;g<b.length;g++)k.push({value:b[g].v,label:b[g].l});
$(this).prev().autocomplete({minLength:0,source:k,select:function(b,d){b.preventDefault();var k="",g="";d.item&&(k=d.item.label,g=d.item.value);$(f).next().val(g);$(f).prev().val(k);$(f).data("source_field")&&e.submitForm(a,c,{filter:1})},focus:function(a,b){this.value=b.item.label;a.preventDefault()},change:function(a,b){if(!b.item){var c=$(this).val(),f=k.find(function(a){return a.label.toLowerCase()===c.toLowerCase()});$(this).data("ui-autocomplete")._trigger("select","autocompleteselect",{item:f})}},
open:function(b,c){var f=this;$("#"+a+"_user_form").scroll(function(){$(f).autocomplete("close")})}}).on("click",function(){if(0==k.length){var a=$(f).data("auto_placeholder");a&&$(this).prop("placeholder",a)}$(this).autocomplete("search","")})}});$("#"+a+"_user_form .field_file_picker").each(function(){var a=this,b=$(this).find(".file_picker_field"),c=$(this).find(".progress_bar"),g=$(this).find(".file_upload_button"),e=b.data("limit"),d=b.data("extensions"),h=0,r=0,a=this,u=$(this).data("id"),l=
void 0;if(d){for(var l="\\.(",m=d.split(","),s=[],t=0;t<m.length;t++){var q=m[t].replace(/\./i,"").trim();q&&s.push(q)}l+=s.join("|");l=RegExp(l+")$","i")}c.progressbar();b.fileupload({url:n+"&filePickerUpload=1",dataType:"json",maxFileSize:1E7,acceptFileTypes:l,maxNumberOfFiles:e,getNumberOfFiles:function(){return h},submit:function(a,b){h++},start:function(a){c.show()},done:function(b,c){$.each(c.result.files,function(b,c){var d;d='<div class="file_row">';d=c.download_link?d+('<p><a href="'+c.download_link+
'" target="_blank">'+c.name+"</a></p>"):d+("<p>"+c.name+"</p>");d+='<input name="field_'+u+"_"+ ++r+'" type="hidden" value="'+c.id+'" />';d+='<span class="delete_file_button">'+zenario.phrase("zenario_user_forms","Delete")+"</span>";d+="</div>";$(a).find(".files").append($(d));h>=e&&g.hide()});$(a).find(".delete_file_button").off().on("click",function(){$(this).parent().remove();h--;h<e&&g.show()})},always:function(a,b){c.hide()},processfail:function(a,b){alert(b.files[b.index].error)},progressall:function(a,
b){var d=parseInt(100*(b.loaded/b.total),10);c.progressbar("option","value",d)},messages:{acceptFileTypes:zenario.phrase("zenario_user_forms","Allowed file types: [[types]]",{types:d}),maxFileSize:zenario.phrase("zenario_user_forms","File exceeds maximum allowed size of 10MB"),maxNumberOfFiles:zenario.phrase("zenario_user_forms","Maximum number of files exceeded")}});d={};l=$(this).find(".loaded_files").text();d.files=JSON.parse(l);0<d.files.length&&(h=d.files.length,b.fileupload("option","done").call(b,
$.Event("done"),{result:d}))})};e.printFormPage=function(){var a=$("#"+this.containerId+" .form_fields").html(),c=window.screenX+$(window).width()/2,e=window.open("","Print-Window","width=300,height=300,left="+c+",top="+window.screenY);e.document.open();e.document.write('<html><body onload="window.print()">'+a+"</body></html>");e.document.close();setTimeout(function(){e.close()},10)};e.buildFieldCalculation=function(a,c,e){for(var b="",h=0;h<c.length;h++)switch(c[h].type){case "static_value":b+=+c[h].value;
break;case "field":if("NaN"==c[h].v&&0>=$("#"+a+'_user_form .form_field input[name="field_'+c[h].value+'"]').length)return!1;e[c[h].value]=c[h].v;b+="[[FIELD_"+c[h].value+"]]";break;case "parentheses_open":b+="(";break;case "parentheses_close":b+=")";break;case "operation_addition":b+="+";break;case "operation_subtraction":b+="-";break;case "operation_multiplication":b+="*";break;case "operation_division":b+="/"}return b};e.submitForm=function(a,c,e,b){a=$("#"+a+"_user_form form");b||a.removeAttr("onsubmit").submit(function(a){a.preventDefault();
return zenario.formSubmit(this,0,1,c)});if(e)for(var h in e)a.append('<input type="hidden" name="'+h+'" value="'+e[h]+'"/>');a.submit()};e.stopPoking=function(){e.poking&&clearInterval(e.poking);e.poking=!1};e.startPoking=function(){e.poking||(e.poking=setInterval(e.poke,12E4))};e.poke=function(){zenario.ajax(URLBasePath+"zenario/admin/quick_ajax.php?keep_session_alive=1")}})(zenario_user_forms);
