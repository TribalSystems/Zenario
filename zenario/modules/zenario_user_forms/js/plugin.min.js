(function(v){v.initForm=function(a,n,u,d,p,F,G,H,z,I,J,x){function A(a,e){return a.ord<e.ord?-1:a.ord>e.ord?1:0}this.containerId=a;var r=this;x=JSON.parse(x);J&&$("#"+a+"_user_form").effect("shake",{distance:10,times:3,duration:300});$("#"+a+"_user_form form").on("submit",function(){window.onbeforeunload=null});zenario.isPublic||zenario.startPoking(this,6E5);if(I){if(1<z&&(window.onbeforeunload=function(){return!0},void 0!==zenario_conductor)){var B=this.phrase("Changes you made may not be saved.");
zenario_conductor._cOC(a,function(){return!0},function(a){confirm(B)&&a()},B)}p&&(window.onbeforeunload=null)}if(G)$("#"+a+" .page_switcher li.step").on("click",function(){var b=$(this).data("page");b<=z&&b!=H&&(window.onbeforeunload=null,r.submitForm(a,{target_page:b},!0))});d&&($.colorbox({transition:"none",html:d,escKey:!1,overlayClose:!1,onOpen:function(){var a=get("colorbox");a.className=v.moduleClassName;$(a).hide().fadeIn()}}),zenario._rC());$("#"+a+"_user_form .form_buttons .next.submit").on("click",
function(){r.submitForm(a,{submitForm:!0},!0)});$("#"+a+"_user_form .form_buttons .next:not(.submit)").on("click",function(){r.submitForm(a,{next:!0},!0)});$("#"+a+"_user_form .form_buttons .previous").on("click",function(){r.submitForm(a,{previous:!0},!0)});$("#"+a+" input.saveLater").on("click",function(){var b=$(this).data("message");confirm(b)&&r.submitForm(a,{saveLater:!0})});$("#"+a+"_user_form .field_attachment .remove_attachment").on("click",function(){var b=$(this).data("id"),e={};e["remove_attachment_"+
b]=!0;r.submitForm(a,e)});$("#"+a+"_print_page").on("click",function(){r.printFormPage(a)});var C=$("#"+a+"_fullscreen"),K=$("#"+a+' input[name="inFullScreen"]');C.on("click",function(){$("#ui-datepicker-div").detach().appendTo("#"+a);zenario._eFS($("#"+a)[0])});$(document).on(zenario.fullScreenChangeEvent,function(){var b=zenario._iFS();C.toggle(!b);K.val(b?1:0);$("#"+a+"_form_wrapper").toggleClass("in_fullscreen",b)});p&&zenario._exFuSc();$("#"+a+"_user_form input.jquery_form_datepicker").each(function(b,
e){if(e.id){e.value=$.datepicker.formatDate(zenario.dpf,$.datepicker.parseDate("yy-mm-dd",get(e.id+"__0").value));var k={dateFormat:zenario.dpf,altField:"#"+e.id+"__0",altFormat:"yy-mm-dd",showOn:"focus",onClose:function(a,b){get(e.id+"__0");var c=$.datepicker.formatDate(zenario.dpf,$.datepicker.parseDate("yy-mm-dd",get(e.id+"__0").value));a&&c?a&&c&&(e.value=c):g.datepicker("setDate",null)}};$(this).data("selectors")&&(k.changeMonth=!0,k.changeYear=!0,k.yearRange="c-100:c+5");$(this).data("no_past_dates")&&
(k.minDate=new Date);$(this).data("no_future_dates")&&(k.maxDate=new Date);var g=$("#"+e.id);g.datepicker(k);$("#"+e.id+"__clear").on("click",function(){g.datepicker("setDate",null)});F&&zenario._iFS()&&$("#ui-datepicker-div").detach().appendTo("#"+a)}});$("#"+a+"_user_form select.source_field").on("change",function(){v.submitForm(a,{filter:1})});$("#"+a+"_user_form .form_field.visible_on_condition, #"+a+"_user_form .repeat_block.visible_on_condition, .page_switcher li.visible_on_condition").each(function(b,
e){var k=this,g=$(this).data("cfields");$(this).data("id");if(g.length)for(b=0;b<g.length;b++){var h=g[b];(function(b){$("#"+a+"_field_"+h.id+" :input").on("change",function(){for(var c=!0,e=b;e<g.length;e++){var f=g[e],h=$("#"+a+"_field_"+f.id+" :input");if("checkboxes"==f.type){var w=[];h.each(function(){$(this).is(":checked")&&w.push($(this).data("value"))});h=f.value?_._m(f.value.toString().split(","),Number):[];if("AND"==f.operator)c=_.intersection(w,h),c=_.intersection(w,c),c=_._isEq(c,h);else for(var c=
!1,d=0;d<w.length;d++)if(-1!=h.indexOf(w[d])){c=!0;break}}else h=h.is(":checkbox")?h.is(":checked"):"radios"==f.type||"centralised_radios"==f.type?h.filter(":checked").val():h.val(),c="string"==typeof f.value&&1<f.value.split(",").length?-1!==f.value.split(",").indexOf(h):Boolean(""===f.value&&h||""!==f.value&&f.value==h);c=f.invert?!c:c;if(!c||e==g.length-1){$(k).toggle(c);break}}})})(b)}});$("#"+a+"_user_form .form_field.restatement").each(function(b,e){var k=this,g=$(this).data("fieldid");if(g&&
(g=$("#"+a+'_user_form .form_field :input[name="field_'+g+'"]'),0<g.length))if(g.is("input"))g.on("keyup",function(){$(k).find(":input").val($(this).val())});else if(g.is("select"))g.on("change",function(){$(k).find(":input").val(""===$(this).val()?"":$(this).find("option:selected").text())})});var D=function(a){return""===a||isNaN(a)||-1<a.toString().toLowerCase().indexOf("e")};$("#"+a+"_user_form .form_field.calculated").each(function(b,e){var k=$(this).find("input"),g=$(this).data("prefix"),h=
$(this).data("postfix"),y=k.data("repeated"),c=k.data("repeated_row"),l=k.data("repeat_id"),f=$("#"+a+"_field_"+$(e).data("id")+"_calculation_code").text();if(f){var f=JSON.parse(f),d={},w="";if(f&&(w=r.buildFieldCalculation(a,f,d))){var q,t={};for(b in d)if(q=$("#"+a+'_user_form .form_field input[name="field_'+b+'"]'),0<q.length){if(q.data("repeated")&&y&&q.data("repeat_id")==l){if(1<c&&(q=$("#"+a+'_user_form .form_field input[name="field_'+b+"_"+c+'"]'),0==q.length))continue}else q.data("repeated")&&
(q._repeatedFields=[],f=$("#"+a+"_user_form .form_field.field_"+b+"_repeat input"),f.each(function(a,c){q._repeatedFields.push($(this));t[b+"_"+a]=$(this)}));t[b]=q}else w=w.replace("[[FIELD_"+b+"]]",+d[b]);var m,s,E;for(b in t)t[b].on("keyup",function(){var c=w,b=!1,f=0;for(m in t){(s=t[m].val())||(s=0);if(D(s)){b=!0;break}if(t[m]._repeatedFields&&t[m]._repeatedFields.length){for(var y=[s],l=0;l<t[m]._repeatedFields.length;l++){var d=t[m]._repeatedFields[l].val();d||(d=0);if(D(d)){b=!0;break}y.push(d)}s=
"("+y.join(" + ")+")"}E="\\[\\[FIELD_"+m+"\\]\\]";c=c.replace(RegExp(E,"g"),s)}!b&&(f=Parser.evaluate(c),!_._iF(f)||999999999999999<f||-999999999999999>f)&&(b=!0);b?f="NaN":(f=+f.toFixed(2),g&&(f=g+""+f),h&&(f=f+""+h));k.val(f);$("#"+a+'_user_form .form_field.restatement[data-fieldid="'+$(e).data("id")+'"] :input').val(f)})}}});$("#"+a+"_user_form .repeat_block").each(function(b,e){var k=$(this).data("id");$(this).find("div.add").on("click",function(){v.submitForm(a,{add_repeat_row:k})});$(this).find("div.delete").on("click",
function(){var b=$(this).data("row");v.submitForm(a,{delete_repeat_row:k,row:b})})});$("#"+a+"_user_form .suggested_values_json").each(function(){var b=this,e=JSON.parse($(this).text());if(e){for(var k=[],g=0;g<e.length;g++)k.push({value:e[g].v,label:e[g].l});$(this).prev().autocomplete({minLength:0,source:k,select:function(g,e){g.preventDefault();var c="",l="";e.item&&(c=e.item.label,l=e.item.value);$(b).next().val(l);$(b).prev().val(c);$(b).data("source_field")&&v.submitForm(a,{filter:1})},focus:function(a,
b){this.value=b.item.label;a.preventDefault()},change:function(a,g){if(!g.item){var c=$(this).val(),e=k.find(function(a){return a.label.toLowerCase()===c.toLowerCase()});(e||$(b).data("force_suggested_values"))&&$(this).data("ui-autocomplete")._trigger("select","autocompleteselect",{item:e})}},open:function(b,g){var c=this;$("#"+a+"_user_form").scroll(function(){$(c).autocomplete("close")})}}).on("click",function(){if(0==k.length){var a=$(b).data("filter_placeholder");a&&$(this).prop("placeholder",
a)}$(this).autocomplete("search","")})}});(function(){function b(g,h){var k=e(h),k=zenario._mT("file_upload_row",k),c=$("#"+a+"_field_"+g+" .files");c.html(k);c.find(".file_row .delete").on("click",function(){if(confirm(x.delete_file)){var a=$(this).parent().data("id");delete h[a];b(g,h)}});$('input[name="field_'+g+'"]').val(JSON.stringify(h))}function e(a){var b=[],e;for(e in a)b.push(a[e]);b.sort(A);return b}function k(b,e,k,c){$("#"+a+"_field_"+b+NaN).toggle(c).find(".progress_bar").css("width",
k+"%")}$("#"+a+"_user_form .field_file_picker:not(.readonly)").each(function(){var a=$(this).data("id"),d=JSON.parse($('input[name="field_'+a+'"]').val());d||(d={});b(a,d);$(this).find(".file_picker_field").fileupload({url:u+"&fileUpload=1",dataType:"json",start:function(b){k(a,0,!0)},progressall:function(b,c){var e=parseInt(100*(c.loaded/c.total),10);k(a,e,!0)},done:function(k,c){var l=e(d),f=l.length&&l[l.length-1].ord?l[l.length-1].ord:1;$.each(c.result.files,function(a,c){f++;c.id="t"+f;c.ord=
f;d[c.id]=c});b(a,d)},stop:function(b){k(a,0,!1)}})})})();(function(){function b(e,c){var d=k(c),d=zenario._mT("document_upload_row",d),f=$("#"+a+"_field_"+e+" .popup_1 .files");f.html(d);f.find(".file_row .delete").on("click",function(){if(confirm(x.delete_file)){var a=$(this).parent().data("id");delete c[a];b(e,c)}})}function e(b,c){var d=k(c),f=zenario._mT("document_upload_uploaded_file",d),g=$("#"+a+"_field_"+b+" .popup_2 .files");g.html(f);g.find(".file_row .delete").on("click",function(){if(confirm(x.delete_file)){var a=
$(this).parent().data("id");delete c[a];e(b,c)}});g.find(".file_row .rotate").on("click",function(){var a=$(this).parent().data("id");c[a].rotate||(c[a].rotate=0);c[a].rotate=(c[a].rotate+90)%360;JSON.stringify(c[a]);g.find(".file_"+a+" .icon img").css({transform:"rotate("+c[a].rotate+"deg)","-ms-transform":"rotate("+c[a].rotate+"deg)","-moz-transform":"rotate("+c[a].rotate+"deg)","-webkit-transform":"rotate("+c[a].rotate+"deg)","-o-transform":"rotate("+c[a].rotate+"deg)"})});d.length&&g.sortable({containment:"parent",
tolerance:"pointer",items:"div.file_row",start:function(a,c){r.startIndex=c.item.index()},stop:function(a,b){r.startIndex!=b.item.index()&&g.find(".file_row").each(function(a){var b=$(this).data("id");c[b].ord=a+1})}})}function k(a){var c=[],b;for(b in a)c.push(a[b]);c.sort(A);return c}function d(b,c,e,f){$("#"+a+"_field_"+b+" ."+c+" .progress").toggle(f).find(".progress_bar").css("width",e+"%")}function h(a,c){k(c).length?confirm(x.are_you_sure_message)&&a.hide():a.hide()}$("#"+a+"_user_form .field_document_upload").each(function(){var a=
this,c=$(this).data("id"),l=$(this).find(".overlay_1"),f=$(this).find(".overlay_2"),n=$(this).find(".popup_1 .files"),p=$(this).find(".popup_2 .files"),q=$(this).find('input[name="field_'+c+'"]'),t=$(this).data("filename"),m={},s={};$(this).find(".open_popup_1").on("click",function(){q.val()&&(m=JSON.parse(q.val()));m||(m={});b(c,m);l.show()});$(this).find(".open_popup_2").on("click",function(){s={};e(c,s);f.show()});$(this).find(".popup_1 .close").on("click",function(){h(l,m)});$(this).find(".popup_2 .close").on("click",
function(){h(f,s)});window.onclick=function(){event.target==l[0]?h(l,m):event.target==f[0]&&h(f,s)};$(this).find(".popup_1 .upload_complete_files").fileupload({url:u+"&fileUpload=1",dataType:"json",dropZone:n,start:function(a){d(c,"popup_1",0,!0)},progressall:function(a,b){var e=parseInt(100*(b.loaded/b.total),10);d(c,"popup_1",e,!0)},done:function(a,e){var d=k(m),f=d.length&&d[d.length-1].ord?d[d.length-1].ord:1;$.each(e.result.files,function(a,c){f++;c.id="t"+f;c.ord=f;m[c.id]=c});b(c,m)},stop:function(a){d(c,
"popup_1",0,!1)}});$(this).find(".popup_1 .save").on("click",function(){var c=k(m),b="",b=[],e,d;for(e=0;e<c.length;e++)d=c[e],b.push('<a href="'+d.path+'" target="_blank">'+d.name+"</a>");b=b.join(", ");$(a).find(".files_preview").html(b);q.val(JSON.stringify(m));l.hide();f.hide()});$(this).find(".popup_2 .upload_file_fragments").fileupload({url:u+"&fileUpload=1&thumbnail=1",dataType:"json",dropZone:p,start:function(a){d(c,"popup_2",0,!0)},progressall:function(a,b){var e=parseInt(100*(b.loaded/b.total),
10);d(c,"popup_2",e,!0)},done:function(a,b){var d=k(s),f=d.length&&d[d.length-1].ord?d[d.length-1].ord:1;$.each(b.result.files,function(a,b){f++;b.id="t"+f;b.ord=f;s[b.id]=b});e(c,s)},stop:function(a){d(c,"popup_2",0,!1)}});$(this).find(".popup_2 .combine").on("click",function(){var d=k(s);if(d.length){var g=this,h;$(g).val(x.combining);if(t){h=t;var l=1,n=k(m),p=RegExp(h+"(?:_(\\d+))?.pdf$"),q=!1,r;for(r=0;r<n.length;r++)(q=n[r].name.match(p))&&(l=+q[1]+1);h+="_"+l}else h=$(a).find(".filename").val();
d={name:h,files:JSON.stringify(d)};zenario._a(u+"&combineFiles=1",d).after(function(d){if((d=JSON.parse(d))&&d.path){var h=k(m),h=h.length&&h[h.length-1].ord?h[h.length-1].ord:1;h++;d.id="t"+h;d.ord=h;m[d.id]=d;b(c,m);$(a).find(".filename").val(t?t:"my-combined-file");f.hide();s={};e(c,[])}$(g).val(x.combine)})}})})})();$("#"+a+"_user_form input.set_predefined_text").on("click",function(){var b=$(this).data("id"),d=!0;$("#"+a+"_field_"+b+" textarea").val()&&(d=confirm(x.set_predefined_text_warning));
d&&(d={},d["set_predefined_text_"+b]=!0,r.submitForm(a,d))})};v.printFormPage=function(){var a=$("#"+this.containerId+" .form_fields").html(),n=window.screenX+$(window).width()/2,u=window.open("","Print-Window","width=300,height=300,left="+n+",top="+window.screenY);u.document.open();u.document.write('<html><body onload="window.print()">'+a+"</body></html>");u.document.close();setTimeout(function(){u.close()},10)};v.buildFieldCalculation=function(a,n,u){for(var d="",p=0;p<n.length;p++)switch(n[p].type){case "static_value":d+=
+n[p].value;break;case "field":if("NaN"==n[p].v&&0>=$("#"+a+'_user_form .form_field input[name="field_'+n[p].value+'"]').length)return!1;u[n[p].value]=n[p].v;d+="[[FIELD_"+n[p].value+"]]";break;case "parentheses_open":d+="(";break;case "parentheses_close":d+=")";break;case "operation_addition":d+="+";break;case "operation_subtraction":d+="-";break;case "operation_multiplication":d+="*";break;case "operation_division":d+="/"}return d};v.submitForm=function(a,n,u){var d=$("#"+a+"_user_form form");u||
(zenario.blockScrollToTop=!0);if(n)for(var p in n)d.append('<input type="hidden" name="'+p+'" value="'+n[p]+'"/>');$("#"+a+"_user_form .field_document_upload, #"+a+"_user_form .field_file_picker").each(function(){$(this).find('input[type="file"]').remove()});d.submit()};v.toggleForm=function(a){$("#"+a).toggleClass("show").toggleClass("hide")}})(zenario_user_forms);
