(function(F){F.initForm=function(b,y,z,u,v,Q,R,S,I,N,T,C,J,M){function G(a,g){return a.ord<g.ord?-1:a.ord>g.ord?1:0}this.ajaxURL=z;this.containerId=b;var E=this;C=JSON.parse(C);T&&$("#"+b+"_user_form").effect("shake",{distance:10,times:3,duration:300});$("#"+b+"_user_form form").on("submit",function(){window.onbeforeunload=null});zenario.isPublic||zenario._3fp(this,6E5);if(N){if(1<I&&(window.onbeforeunload=function(){return!0},void 0!==zenario_conductor)){var U=this.phrase("Changes you made may not be saved.");
zenario_conductor._pf0(b,function(){return!0},function(a){confirm(U)&&a()},U)}v&&(window.onbeforeunload=null)}if(R)$("#"+b+" .page_switcher li.step").on("click",function(){var a=$(this).data("page");a<=I&&a!=S&&(window.onbeforeunload=null,E.submitForm(b,{target_page:a},!0))});u&&($.colorbox({transition:"none",html:u,escKey:!1,overlayClose:!1,onOpen:function(){var a=get("colorbox");a.className=F.moduleClassName;$(a).hide().fadeIn()}}),zenario._bly());$("#"+b+"_user_form .form_buttons .next.submit").on("click",
function(){E.submitForm(b,{submitForm:!0},!0)});$("#"+b+"_user_form .form_buttons .next:not(.submit)").on("click",function(){E.submitForm(b,{next:!0},!0)});$("#"+b+"_user_form .form_buttons .previous").on("click",function(){E.submitForm(b,{previous:!0},!0)});$("#"+b+" input.saveLater").on("click",function(){var a=$(this).data("message");confirm(a)&&E.submitForm(b,{saveLater:!0})});$("#"+b+"_user_form .field_attachment .remove_attachment").on("click",function(){var a=$(this).data("id"),g={};g["remove_attachment_"+
a]=!0;E.submitForm(b,g)});$("#"+b+"_print_page").on("click",function(){E.printFormPage(b)});var V=$("#"+b+"_fullscreen"),X=$("#"+b+' input[name="inFullScreen"]');V.on("click",function(){$("#ui-datepicker-div").detach().appendTo("#"+b);zenario._awe($("#"+b)[0])});$(document).on(zenario.fullScreenChangeEvent,function(){var a=zenario._5cs();V.toggle(!a);X.val(a?1:0);$("#"+b+"_form_wrapper").toggleClass("in_fullscreen",a)});v&&zenario._3gi();$("#"+b+"_user_form input.jquery_form_datepicker").each(function(a,
g){if(g.id){g.value=$.datepicker.formatDate(zenario.dpf,$.datepicker.parseDate("yy-mm-dd",get(g.id+"__0").value));a={dateFormat:zenario.dpf,altField:"#"+g.id+"__0",altFormat:"yy-mm-dd",showOn:"focus",onClose:function(f,e){get(g.id+"__0");e=$.datepicker.formatDate(zenario.dpf,$.datepicker.parseDate("yy-mm-dd",get(g.id+"__0").value));f&&e?f&&e&&(g.value=e):l.datepicker("setDate",null)}};$(this).data("selectors")&&(a.changeMonth=!0,a.changeYear=!0,a.yearRange="c-100:c+5");$(this).data("no_past_dates")&&
(a.minDate=new Date);$(this).data("no_future_dates")&&(a.maxDate=new Date);var l=$("#"+g.id);l.datepicker(a);$("#"+g.id+"__clear").on("click",function(){l.datepicker("setDate",null)});Q&&zenario._5cs()&&$("#ui-datepicker-div").detach().appendTo("#"+b)}});$("#"+b+"_user_form select.source_field").on("change",function(){F.submitForm(b,{filter:1})});$("#"+b+"_user_form .form_field.visible_on_condition, #"+b+"_user_form .repeat_block.visible_on_condition, .page_switcher li.visible_on_condition").each(function(a,
g){var l=this,f=$(this).data("cfields");$(this).data("id");if(f.length)for(a=0;a<f.length;a++){var e=f[a];(function(d){$("#"+b+"_field_"+e.id+" :input").on("change",function(){for(var c=!0,n=d;n<f.length;n++){var h=f[n],m=$("#"+b+"_field_"+h.id+" :input");if("checkboxes"==h.type){var p=[];m.each(function(){$(this).is(":checked")&&p.push($(this).data("value"))});m=h.value?_.map(h.value.toString().split(","),Number):[];if("AND"==h.operator)c=_._ngm(p,m),c=_._ngm(p,c),c=_._3d(c,m);else{c=!1;for(var t=
0;t<p.length;t++)if(-1!=m.indexOf(p[t])){c=!0;break}}}else m=m.is(":checkbox")?m.is(":checked"):"radios"==h.type||"centralised_radios"==h.type?m.filter(":checked").val():m.val(),c="string"==typeof h.value&&1<h.value.split(",").length?-1!==h.value.split(",").indexOf(m):!!(""===h.value&&m||""!==h.value&&h.value==m);c=h.invert?!c:c;if(!c||n==f.length-1){$(l).toggle(c);break}}})})(a)}});$("#"+b+"_user_form .form_field.restatement").each(function(a,g){var l=this;if(a=$(this).data("fieldid"))if(a=$("#"+
b+'_user_form .form_field :input[name="field_'+a+'"]'),0<a.length)if(a.is("input"))a.on("keyup",function(){$(l).find(":input").val($(this).val())});else if(a.is("select"))a.on("change",function(){$(l).find(":input").val(""===$(this).val()?"":$(this).find("option:selected").text())})});var W=function(a){return""===a||isNaN(a)||-1<a.toString().toLowerCase().indexOf("e")};$("#"+b+"_user_form .form_field.calculated").each(function(a,g){var l=$(this).find("input"),f=$(this).data("prefix"),e=$(this).data("postfix"),
d=l.data("repeated"),c=l.data("repeated_row"),n=l.data("repeat_id"),h=$("#"+b+"_field_"+$(g).data("id")+"_calculation_code").text();if(h){h=JSON.parse(h);var m={},p="";if(h&&(p=E.buildFieldCalculation(b,h,m))){var t={};for(a in m){var A=$("#"+b+'_user_form .form_field input[name="field_'+a+'"]');if(0<A.length){if(A.data("repeated")&&d&&A.data("repeat_id")==n){if(1<c&&(A=$("#"+b+'_user_form .form_field input[name="field_'+a+"_"+c+'"]'),0==A.length))continue}else A.data("repeated")&&(A._repeatedFields=
[],h=$("#"+b+"_user_form .form_field.field_"+a+"_repeat input"),h.each(function(w,r){A._repeatedFields.push($(this));t[a+"_"+w]=$(this)}));t[a]=A}else p=p.replace("[[FIELD_"+a+"]]",+m[a])}var q,B,k;for(a in t)t[a].on("keyup",function(){var w=p,r=!1,x=0;for(q in t){(B=t[q].val())||(B=0);if(W(B)){r=!0;break}if(t[q]._repeatedFields&&t[q]._repeatedFields.length){for(var D=[B],O=0;O<t[q]._repeatedFields.length;O++){var K=t[q]._repeatedFields[O].val();K||(K=0);if(W(K)){r=!0;break}D.push(K)}B="("+D.join(" + ")+
")"}k="\\[\\[FIELD_"+q+"\\]\\]";w=w.replace(new RegExp(k,"g"),B)}!r&&(x=Parser.evaluate(w),!_._fl3(x)||999999999999999<x||-999999999999999>x)&&(r=!0);r?x="NaN":(x=+x.toFixed(2),f&&(x=f+""+x),e&&(x=x+""+e));l.val(x);$("#"+b+'_user_form .form_field.restatement[data-fieldid="'+$(g).data("id")+'"] :input').val(x)})}}});$("#"+b+"_user_form .repeat_block").each(function(a,g){var l=$(this).data("id");$(this).find("div.add").on("click",function(){F.submitForm(b,{add_repeat_row:l})});$(this).find("div.delete").on("click",
function(){var f=$(this).data("row");F.submitForm(b,{delete_repeat_row:l,row:f})})});$("#"+b+"_user_form .suggested_values_json").each(function(){var a=this,g=JSON.parse($(this).text());if(g){for(var l=[],f=0;f<g.length;f++)l.push({value:g[f].v,label:g[f].l});$(this).prev().autocomplete({minLength:0,source:l,select:function(e,d){e.preventDefault();var c=e="";d.item&&(e=d.item.label,c=d.item.value);$(a).next().val(c);$(a).prev().val(e);$(a).data("source_field")&&F.submitForm(b,{filter:1})},focus:function(e,
d){this.value=d.item.label;e.preventDefault()},change:function(e,d){if(!d.item){var c=$(this).val();((e=l.find(function(n){return n.label.toLowerCase()===c.toLowerCase()}))||$(a).data("force_suggested_values"))&&$(this).data("ui-autocomplete")._trigger("select","autocompleteselect",{item:e})}},open:function(e,d){var c=this;$("#"+b+"_user_form").scroll(function(){$(c).autocomplete("close")})}}).on("click",function(){if(0==l.length){var e=$(a).data("filter_placeholder");e&&$(this).prop("placeholder",
e)}$(this).autocomplete("search","")})}});(function(){function a(f,e){var d=g(e);d=zenario._sbf("file_upload_row",d);var c=$("#"+b+"_field_"+f+" .files");c.html(d);c.find(".file_row .delete").on("click",function(){if(confirm(C.delete_file)){var n=$(this).parent().data("id");delete e[n];a(f,e)}});$('input[name="field_'+f+'"]').val(JSON.stringify(e))}function g(f){var e=[],d;for(d in f)e.push(f[d]);e.sort(G);return e}function l(f,e,d,c){$("#"+b+"_field_"+f+NaN).toggle(c).find(".progress_bar").css("width",
d+"%")}$("#"+b+"_user_form .field_file_picker:not(.readonly)").each(function(){var f=$(this).data("id"),e=JSON.parse($('input[name="field_'+f+'"]').val());e||(e={});a(f,e);$(this).find(".file_picker_field").fileupload({url:z+"&fileUpload=1",dataType:"json",maxFileSize:J,messages:{maxFileSize:"Exceeded filesize limit of "+M+"."},start:function(d){l(f,0,!0)},progressall:function(d,c){d=parseInt(c.loaded/c.total*100,10);l(f,d,!0)},done:function(d,c){d=g(e);var n=d.length&&d[d.length-1].ord?d[d.length-
1].ord:1;$.each(c.result.files,function(h,m){n++;m.id="t"+n;m.ord=n;e[m.id]=m});a(f,e)},stop:function(d){l(f,0,!1)}})})})();(function(){function a(d,c){var n=l(c);n=zenario._sbf("document_upload_row",n);var h=$("#"+b+"_field_"+d+" .popup_1 .files");h.html(n);h.find(".file_row .delete").on("click",function(){if(confirm(C.delete_file)){var m=$(this).parent().data("id");delete c[m];a(d,c)}})}function g(d,c){var n=l(c),h=zenario._sbf("document_upload_uploaded_file",n),m=$("#"+b+"_field_"+d+" .popup_2 .files");
m.html(h);m.find(".file_row .delete").on("click",function(){if(confirm(C.delete_file)){var p=$(this).parent().data("id");delete c[p];g(d,c)}});m.find(".file_row .rotate").on("click",function(){var p=$(this).parent().data("id");c[p].rotate||(c[p].rotate=0);c[p].rotate=(c[p].rotate+90)%360;JSON.stringify(c[p]);m.find(".file_"+p+" .icon img").css({transform:"rotate("+c[p].rotate+"deg)","-ms-transform":"rotate("+c[p].rotate+"deg)","-moz-transform":"rotate("+c[p].rotate+"deg)","-webkit-transform":"rotate("+
c[p].rotate+"deg)","-o-transform":"rotate("+c[p].rotate+"deg)"})});n.length&&m.sortable({containment:"parent",tolerance:"pointer",items:"div.file_row",start:function(p,t){E.startIndex=t.item.index()},stop:function(p,t){E.startIndex!=t.item.index()&&m.find(".file_row").each(function(A){var q=$(this).data("id");c[q].ord=A+1})}})}function l(d){var c=[],n;for(n in d)c.push(d[n]);c.sort(G);return c}function f(d,c,n,h){$("#"+b+"_field_"+d+" ."+c+" .progress").toggle(h).find(".progress_bar").css("width",
n+"%")}function e(d,c){l(c).length?confirm(C.are_you_sure_message)&&d.hide():d.hide()}$("#"+b+"_user_form .field_document_upload").each(function(){var d=this,c=$(this).data("id"),n=$(this).find(".overlay_1"),h=$(this).find(".overlay_2"),m=$(this).find(".popup_1 .files"),p=$(this).find(".popup_2 .files"),t=$(this).find('input[name="field_'+c+'"]'),A=$(this).data("filename"),q={},B={};$(this).find(".open_popup_1").on("click",function(){t.val()&&(q=JSON.parse(t.val()));q||(q={});a(c,q);n.show()});$(this).find(".open_popup_2").on("click",
function(){B={};g(c,B);h.show()});$(this).find(".popup_1 .close").on("click",function(){e(n,q)});$(this).find(".popup_2 .close").on("click",function(){e(h,B)});window.onclick=function(){event.target==n[0]?e(n,q):event.target==h[0]&&e(h,B)};$(this).find(".popup_1 .upload_complete_files").fileupload({url:z+"&fileUpload=1",dataType:"json",dropZone:m,maxFileSize:J,messages:{maxFileSize:"Exceeded filesize limit of "+M+"."},start:function(k){f(c,"popup_1",0,!0)},progressall:function(k,w){k=parseInt(w.loaded/
w.total*100,10);f(c,"popup_1",k,!0)},done:function(k,w){k=l(q);var r=k.length&&k[k.length-1].ord?k[k.length-1].ord:1;$.each(w.result.files,function(x,D){r++;D.id="t"+r;D.ord=r;q[D.id]=D});a(c,q)},stop:function(k){f(c,"popup_1",0,!1)}});$(this).find(".popup_1 .save").on("click",function(){var k=l(q),w=[],r;for(r=0;r<k.length;r++){var x=k[r];w.push('<a href="'+x.path+'" target="_blank">'+x.name+"</a>")}k=w.join(", ");$(d).find(".files_preview").html(k);t.val(JSON.stringify(q));n.hide();h.hide()});$(this).find(".popup_2 .upload_file_fragments").fileupload({url:z+
"&fileUpload=1&thumbnail=1",dataType:"json",dropZone:p,maxFileSize:J,messages:{maxFileSize:"Exceeded filesize limit of "+M+"."},start:function(k){f(c,"popup_2",0,!0)},progressall:function(k,w){k=parseInt(w.loaded/w.total*100,10);f(c,"popup_2",k,!0)},done:function(k,w){k=l(B);var r=k.length&&k[k.length-1].ord?k[k.length-1].ord:1;$.each(w.result.files,function(x,D){r++;D.id="t"+r;D.ord=r;B[D.id]=D});g(c,B)},stop:function(k){f(c,"popup_2",0,!1)}});$(this).find(".popup_2 .combine").on("click",function(){var k=
l(B);if(k.length){var w=this;$(w).val(C.combining);if(A){var r=A;var x=1,D=l(q),O=new RegExp(r+"(?:_(\\d+))?.pdf$"),K=!1,P;for(P=0;P<D.length;P++)(K=D[P].name.match(O))&&(x=+K[1]+1);r+="_"+x}else r=$(d).find(".filename").val();k={name:r,files:JSON.stringify(k)};zenario.ajax(z+"&combineFiles=1",k).after(function(L){if((L=JSON.parse(L))&&L.path){var H=l(q);H=H.length&&H[H.length-1].ord?H[H.length-1].ord:1;H++;L.id="t"+H;L.ord=H;q[L.id]=L;a(c,q);$(d).find(".filename").val(A?A:"my-combined-file");h.hide();
B={};g(c,[])}$(w).val(C.combine)})}})})})();$("#"+b+"_user_form input.set_predefined_text").on("click",function(){var a=$(this).data("id"),g=!0;$("#"+b+"_field_"+a+" textarea").val()&&(g=confirm(C.set_predefined_text_warning));g&&(g={},g["set_predefined_text_"+a]=!0,E.submitForm(b,g))});$(function(){$("#"+b+"_sortable1, #"+b+"_sortable2").sortable({connectWith:".connectedSortable",update:function(a,g){a=$("#"+b+"_sortable1");a=String(a.sortable("toArray",{attribute:"data-value"}));$("#"+b+"_sortable1_values").val(a);
a=$("#"+b+"_sortable2").sortable("toArray",{attribute:"data-value"});$("#"+b+"_sortable2_values").val(a)}}).disableSelection()})};F.printFormPage=function(){var b=$("#"+this.containerId+" .form_fields").html(),y=window.screenX+$(window).width()/2,z=window.open("","Print-Window","width=300,height=300,left="+y+",top="+window.screenY);z.document.open();z.document.write('<html><body onload="window.print()">'+b+"</body></html>");z.document.close();setTimeout(function(){z.close()},10)};F.buildFieldCalculation=
function(b,y,z){for(var u="",v=0;v<y.length;v++)switch(y[v].type){case "static_value":u+=+y[v].value;break;case "field":if("NaN"==y[v].v&&0>=$("#"+b+'_user_form .form_field input[name="field_'+y[v].value+'"]').length)return!1;z[y[v].value]=y[v].v;u+="[[FIELD_"+y[v].value+"]]";break;case "parentheses_open":u+="(";break;case "parentheses_close":u+=")";break;case "operation_addition":u+="+";break;case "operation_subtraction":u+="-";break;case "operation_multiplication":u+="*";break;case "operation_division":u+=
"/"}return u};F.validateFormFieldJs=function(b,y,z,u,v,Q,R,S,I,N,T){var C=document.getElementById(u);u=document.getElementById(v);var J=document.getElementById(v+"__error_message");if(C&&u){switch(Q){case "group":case "checkbox":var M=u.checked?1:0;break;case "url":case "text":case "textarea":M=u.value}if(I)if(b="radios"==N||"centralised_radios"==N?b+"_field_"+I:b+"__field_"+I,v=document.getElementById(b))switch(N){case "group":case "checkbox":var G=v.checked?1:0;break;case "restatement":case "calculated":case "url":case "text":case "textarea":case "select":case "centralised_select":G=
v.value;break;case "radios":case "centralised_radios":try{G=document.querySelector('input[name="field_'+I+'"]:checked').value}catch(E){G=""}break;case "date":G=document.getElementById(b+"__0").value}else G=null;else G="";y={formId:y,fieldId:z,fieldValue:M};y.conditionalFieldValue=G;zenario.ajax(this.ajaxURL+"&validateFormFieldJs=1",y).after(function(E){(J.innerHTML=E)?(C.classList.remove("no_error"),C.classList.add("has_error"),J.style.display="block"):(C.classList.add("no_error"),C.classList.remove("has_error"),
J.style.display="none")})}};F.submitForm=function(b,y,z){var u=$("#"+b+"_user_form form");z||(zenario.blockScrollToTop=!0);if(y)for(var v in y)u.append('<input type="hidden" name="'+v+'" value="'+y[v]+'"/>');$("#"+b+"_user_form .field_document_upload, #"+b+"_user_form .field_file_picker").each(function(){$(this).find('input[type="file"]').remove()});u.submit()};F.toggleForm=function(b){$("#"+b).toggleClass("show").toggleClass("hide")}})(zenario_user_forms);
