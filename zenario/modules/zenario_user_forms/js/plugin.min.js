(function(e){e.initForm=function(a,v,u,d,p,E,F,G,y,H,I,w){function z(a,f){return a.ord<f.ord?-1:a.ord>f.ord?1:0}this.containerId=a;var q=this;w=JSON.parse(w);I&&$("#"+a+"_user_form").effect("shake",{distance:10,times:3,duration:300});$("#"+a+"_user_form form").on("submit",function(){window.onbeforeunload=null});this.startPoking();if(H){if(1<y&&(window.onbeforeunload=function(){return!0},void 0!==zenario_conductor)){var A=this.phrase("Changes you made may not be saved.");zenario_conductor._cOC(a,function(){return!0},
function(a){confirm(A)&&a()},A)}p&&(window.onbeforeunload=null)}if(F)$("#"+a+" .page_switcher li.step").on("click",function(){var b=$(this).data("page");b<=y&&b!=G&&(window.onbeforeunload=null,q.submitForm(a,{target_page:b},!0))});d&&($.colorbox({transition:"none",html:d,escKey:!1,overlayClose:!1,onOpen:function(){var a=get("colorbox");a.className=e.moduleClassName;$(a).hide().fadeIn()}}),zenario._rC());$("#"+a+"_user_form .form_buttons .next.submit").on("click",function(){q.submitForm(a,{submitForm:!0},
!0)});$("#"+a+"_user_form .form_buttons .next:not(.submit)").on("click",function(){q.submitForm(a,{next:!0},!0)});$("#"+a+"_user_form .form_buttons .previous").on("click",function(){q.submitForm(a,{previous:!0},!0)});$("#"+a+" input.saveLater").on("click",function(){var b=$(this).data("message");confirm(b)&&q.submitForm(a,{saveLater:!0})});$("#"+a+"_user_form .field_attachment .remove_attachment").on("click",function(){var b=$(this).data("id"),f={};f["remove_attachment_"+b]=!0;q.submitForm(a,f)});
$("#"+a+"_print_page").on("click",function(){q.printFormPage(a)});var B=$("#"+a+"_fullscreen"),J=$("#"+a+' input[name="inFullScreen"]');B.on("click",function(){$("#ui-datepicker-div").detach().appendTo("#"+a);zenario._eFS($("#"+a)[0])});$(document).on(zenario.fullScreenChangeEvent,function(){var b=zenario._iFS();B.toggle(!b);J.val(b?1:0);$("#"+a+"_form_wrapper").toggleClass("in_fullscreen",b)});p&&zenario._exFuSc();$("#"+a+"_user_form input.jquery_form_datepicker").each(function(b,f){if(f.id){f.value=
$.datepicker.formatDate(zenario.dpf,$.datepicker.parseDate("yy-mm-dd",get(f.id+"__0").value));var h={dateFormat:zenario.dpf,altField:"#"+f.id+"__0",altFormat:"yy-mm-dd",showOn:"focus",onClose:function(a,b){get(f.id+"__0");var c=$.datepicker.formatDate(zenario.dpf,$.datepicker.parseDate("yy-mm-dd",get(f.id+"__0").value));a&&c?a&&c&&(f.value=c):g.datepicker("setDate",null)}};$(this).data("selectors")&&(h.changeMonth=!0,h.changeYear=!0,h.yearRange="c-100:c+5");$(this).data("no_past_dates")&&(h.minDate=
new Date);$(this).data("no_future_dates")&&(h.maxDate=new Date);var g=$("#"+f.id);g.datepicker(h);$("#"+f.id+"__clear").on("click",function(){g.datepicker("setDate",null)});E&&zenario._iFS()&&$("#ui-datepicker-div").detach().appendTo("#"+a)}});$("#"+a+"_user_form select.source_field").on("change",function(){e.submitForm(a,{filter:1})});$("#"+a+"_user_form .form_field.visible_on_condition, #"+a+"_user_form .repeat_block.visible_on_condition, .page_switcher li.visible_on_condition").each(function(b,
f){var h=this,g=$(this).data("cfields");$(this).data("id");if(g.length)for(b=0;b<g.length;b++){var m=g[b];(function(b){$("#"+a+"_field_"+m.id+" :input").on("change",function(){for(var c=!0,f=b;f<g.length;f++){var k=g[f],m=$("#"+a+"_field_"+k.id+" :input");if("checkboxes"==k.type){var r=[];m.each(function(){$(this).is(":checked")&&r.push($(this).data("value"))});m=k.value?_._m(k.value.toString().split(","),Number):[];if("AND"==k.operator)c=_.intersection(r,m),c=_.intersection(r,c),c=_._isEq(c,m);else for(var c=
!1,d=0;d<r.length;d++)if(-1!=m.indexOf(r[d])){c=!0;break}}else m=m.is(":checkbox")?m.is(":checked"):"radios"==k.type?m.filter(":checked").val():m.val(),c="string"==typeof k.value&&1<k.value.split(",").length?-1!==k.value.split(",").indexOf(m):Boolean(""===k.value&&m||""!==k.value&&k.value==m);c=k.invert?!c:c;if(!c||f==g.length-1){$(h).toggle(c);break}}})})(b)}});$("#"+a+"_user_form .form_field.restatement").each(function(b,f){var h=this,g=$(this).data("fieldid");if(g&&(g=$("#"+a+'_user_form .form_field :input[name="field_'+
g+'"]'),0<g.length))if(g.is("input"))g.on("keyup",function(){$(h).find(":input").val($(this).val())});else if(g.is("select"))g.on("change",function(){$(h).find(":input").val(""===$(this).val()?"":$(this).find("option:selected").text())})});var C=function(a){return""===a||isNaN(a)||-1<a.toString().toLowerCase().indexOf("e")};$("#"+a+"_user_form .form_field.calculated").each(function(b,f){var h=$(this).find("input"),g=$(this).data("prefix"),m=$(this).data("postfix"),l=h.data("repeated"),c=h.data("repeated_row"),
x=h.data("repeat_id"),k=$("#"+a+"_field_"+$(f).data("id")+"_calculation_code").text();if(k){var k=JSON.parse(k),d={},r="";if(k&&(r=q.buildFieldCalculation(a,k,d))){var e,t={};for(b in d)if(e=$("#"+a+'_user_form .form_field input[name="field_'+b+'"]'),0<e.length){if(e.data("repeated")&&l&&e.data("repeat_id")==x){if(1<c&&(e=$("#"+a+'_user_form .form_field input[name="field_'+b+"_"+c+'"]'),0==e.length))continue}else e.data("repeated")&&(e._repeatedFields=[],k=$("#"+a+"_user_form .form_field.field_"+
b+"_repeat input"),k.each(function(a,c){e._repeatedFields.push($(this));t[b+"_"+a]=$(this)}));t[b]=e}else r=r.replace("[[FIELD_"+b+"]]",+d[b]);var n,s,D;for(b in t)t[b].on("keyup",function(){var c=r,b=!1,l=0;for(n in t){(s=t[n].val())||(s=0);if(C(s)){b=!0;break}if(t[n]._repeatedFields&&t[n]._repeatedFields.length){for(var k=[s],x=0;x<t[n]._repeatedFields.length;x++){var d=t[n]._repeatedFields[x].val();d||(d=0);if(C(d)){b=!0;break}k.push(d)}s="("+k.join(" + ")+")"}D="\\[\\[FIELD_"+n+"\\]\\]";c=c.replace(RegExp(D,
"g"),s)}!b&&(l=Parser.evaluate(c),!_._iF(l)||999999999999999<l||-999999999999999>l)&&(b=!0);b?l="NaN":(l=+l.toFixed(2),g&&(l=g+""+l),m&&(l=l+""+m));h.val(l);$("#"+a+'_user_form .form_field.restatement[data-fieldid="'+$(f).data("id")+'"] :input').val(l)})}}});$("#"+a+"_user_form .repeat_block").each(function(b,f){var h=$(this).data("id");$(this).find("div.add").on("click",function(){e.submitForm(a,{add_repeat_row:h})});$(this).find("div.delete").on("click",function(){var b=$(this).data("row");e.submitForm(a,
{delete_repeat_row:h,row:b})})});$("#"+a+"_user_form .autocomplete_json").each(function(){var b=this,f=JSON.parse($(this).text());if(f){for(var h=[],g=0;g<f.length;g++)h.push({value:f[g].v,label:f[g].l});$(this).prev().autocomplete({minLength:0,source:h,select:function(g,l){g.preventDefault();var c="",f="";l.item&&(c=l.item.label,f=l.item.value);$(b).next().val(f);$(b).prev().val(c);$(b).data("source_field")&&e.submitForm(a,{filter:1})},focus:function(a,b){this.value=b.item.label;a.preventDefault()},
change:function(a,b){if(!b.item){var c=$(this).val(),g=h.find(function(a){return a.label.toLowerCase()===c.toLowerCase()});$(this).data("ui-autocomplete")._trigger("select","autocompleteselect",{item:g})}},open:function(b,g){var c=this;$("#"+a+"_user_form").scroll(function(){$(c).autocomplete("close")})}}).on("click",function(){if(0==h.length){var a=$(b).data("auto_placeholder");a&&$(this).prop("placeholder",a)}$(this).autocomplete("search","")})}});$("#"+a+"_user_form .suggested_values_json").each(function(){var a=
JSON.parse($(this).text());if(a)$(this).prev().autocomplete({minLength:0,source:a}).on("click",function(){$(this).autocomplete("search","")})});(function(){function b(g,m){var l=f(m),l=zenario._mT("file_upload_row",l),c=$("#"+a+"_field_"+g+" .files");c.html(l);c.find(".file_row .delete").on("click",function(){if(confirm(w.delete_file)){var a=$(this).parent().data("id");delete m[a];b(g,m)}});$('input[name="field_'+g+'"]').val(JSON.stringify(m))}function f(a){var b=[],l;for(l in a)b.push(a[l]);b.sort(z);
return b}function h(b,f,l,c){$("#"+a+"_field_"+b+NaN).toggle(c).find(".progress_bar").css("width",l+"%")}$("#"+a+"_user_form .field_file_picker:not(.readonly)").each(function(){var a=$(this).data("id"),d=JSON.parse($('input[name="field_'+a+'"]').val());d||(d={});b(a,d);$(this).find(".file_picker_field").fileupload({url:u+"&fileUpload=1",dataType:"json",start:function(b){h(a,0,!0)},progressall:function(b,c){var f=parseInt(100*(c.loaded/c.total),10);h(a,f,!0)},done:function(l,c){var h=f(d),k=h.length&&
h[h.length-1].ord?h[h.length-1].ord:1;$.each(c.result.files,function(a,c){k++;c.id="t"+k;c.ord=k;d[c.id]=c});b(a,d)},stop:function(b){h(a,0,!1)}})})})();(function(){function b(f,c){var d=h(c),d=zenario._mT("document_upload_row",d),k=$("#"+a+"_field_"+f+" .popup_1 .files");k.html(d);k.find(".file_row .delete").on("click",function(){if(confirm(w.delete_file)){var a=$(this).parent().data("id");delete c[a];b(f,c)}})}function f(b,c){var d=h(c),k=zenario._mT("document_upload_uploaded_file",d),g=$("#"+a+
"_field_"+b+" .popup_2 .files");g.html(k);g.find(".file_row .delete").on("click",function(){if(confirm(w.delete_file)){var a=$(this).parent().data("id");delete c[a];f(b,c)}});g.find(".file_row .rotate").on("click",function(){var a=$(this).parent().data("id");c[a].rotate||(c[a].rotate=0);c[a].rotate=(c[a].rotate+90)%360;JSON.stringify(c[a]);g.find(".file_"+a+" .icon img").css({transform:"rotate("+c[a].rotate+"deg)","-ms-transform":"rotate("+c[a].rotate+"deg)","-moz-transform":"rotate("+c[a].rotate+
"deg)","-webkit-transform":"rotate("+c[a].rotate+"deg)","-o-transform":"rotate("+c[a].rotate+"deg)"})});d.length&&g.sortable({containment:"parent",tolerance:"pointer",items:"div.file_row",start:function(a,c){q.startIndex=c.item.index()},stop:function(a,b){q.startIndex!=b.item.index()&&g.find(".file_row").each(function(a){var b=$(this).data("id");c[b].ord=a+1})}})}function h(a){var c=[],b;for(b in a)c.push(a[b]);c.sort(z);return c}function d(b,c,f,h){$("#"+a+"_field_"+b+" ."+c+" .progress").toggle(h).find(".progress_bar").css("width",
f+"%")}function e(a,c){h(c).length?confirm(w.are_you_sure_message)&&a.hide():a.hide()}$("#"+a+"_user_form .field_document_upload").each(function(){var a=this,c=$(this).data("id"),v=$(this).find(".overlay_1"),k=$(this).find(".overlay_2"),p=$(this).find(".popup_1 .files"),r=$(this).find(".popup_2 .files"),q=$(this).find('input[name="field_'+c+'"]'),t=$(this).data("filename"),n={},s={};$(this).find(".open_popup_1").on("click",function(){q.val()&&(n=JSON.parse(q.val()));n||(n={});b(c,n);v.show()});$(this).find(".open_popup_2").on("click",
function(){s={};f(c,s);k.show()});$(this).find(".popup_1 .close").on("click",function(){e(v,n)});$(this).find(".popup_2 .close").on("click",function(){e(k,s)});window.onclick=function(){event.target==v[0]?e(v,n):event.target==k[0]&&e(k,s)};$(this).find(".popup_1 .upload_complete_files").fileupload({url:u+"&fileUpload=1",dataType:"json",dropZone:p,start:function(a){d(c,"popup_1",0,!0)},progressall:function(a,b){var f=parseInt(100*(b.loaded/b.total),10);d(c,"popup_1",f,!0)},done:function(a,f){var d=
h(n),g=d.length&&d[d.length-1].ord?d[d.length-1].ord:1;$.each(f.result.files,function(a,c){g++;c.id="t"+g;c.ord=g;n[c.id]=c});b(c,n)},stop:function(a){d(c,"popup_1",0,!1)}});$(this).find(".popup_1 .save").on("click",function(){var c=h(n),b="",b=[],d,f;for(d=0;d<c.length;d++)f=c[d],b.push('<a href="'+f.path+'" target="_blank">'+f.name+"</a>");b=b.join(", ");$(a).find(".files_preview").html(b);q.val(JSON.stringify(n));v.hide();k.hide()});$(this).find(".popup_2 .upload_file_fragments").fileupload({url:u+
"&fileUpload=1&thumbnail=1",dataType:"json",dropZone:r,start:function(a){d(c,"popup_2",0,!0)},progressall:function(a,b){var f=parseInt(100*(b.loaded/b.total),10);d(c,"popup_2",f,!0)},done:function(a,b){var d=h(s),g=d.length&&d[d.length-1].ord?d[d.length-1].ord:1;$.each(b.result.files,function(a,b){g++;b.id="t"+g;b.ord=g;s[b.id]=b});f(c,s)},stop:function(a){d(c,"popup_2",0,!1)}});$(this).find(".popup_2 .combine").on("click",function(){var d=h(s);if(d.length){var g=this,e;$(g).val(w.combining);if(t){e=
t;var m=1,v=h(n),p=RegExp(e+"(?:_(\\d+))?.pdf$"),q=!1,r;for(r=0;r<v.length;r++)(q=v[r].name.match(p))&&(m=+q[1]+1);e+="_"+m}else e=$(a).find(".filename").val();d={name:e,files:JSON.stringify(d)};zenario._a(u+"&combineFiles=1",d).after(function(d){if((d=JSON.parse(d))&&d.path){var e=h(n),e=e.length&&e[e.length-1].ord?e[e.length-1].ord:1;e++;d.id="t"+e;d.ord=e;n[d.id]=d;b(c,n);$(a).find(".filename").val(t?t:"my-combined-file");k.hide();s={};f(c,[])}$(g).val(w.combine)})}})})})();$("#"+a+"_user_form input.set_predefined_text").on("click",
function(){var b=$(this).data("id"),d=!0;$("#"+a+"_field_"+b+" textarea").val()&&(d=confirm(w.set_predefined_text_warning));d&&(d={},d["set_predefined_text_"+b]=!0,q.submitForm(a,d))})};e.printFormPage=function(){var a=$("#"+this.containerId+" .form_fields").html(),e=window.screenX+$(window).width()/2,u=window.open("","Print-Window","width=300,height=300,left="+e+",top="+window.screenY);u.document.open();u.document.write('<html><body onload="window.print()">'+a+"</body></html>");u.document.close();
setTimeout(function(){u.close()},10)};e.buildFieldCalculation=function(a,e,u){for(var d="",p=0;p<e.length;p++)switch(e[p].type){case "static_value":d+=+e[p].value;break;case "field":if("NaN"==e[p].v&&0>=$("#"+a+'_user_form .form_field input[name="field_'+e[p].value+'"]').length)return!1;u[e[p].value]=e[p].v;d+="[[FIELD_"+e[p].value+"]]";break;case "parentheses_open":d+="(";break;case "parentheses_close":d+=")";break;case "operation_addition":d+="+";break;case "operation_subtraction":d+="-";break;
case "operation_multiplication":d+="*";break;case "operation_division":d+="/"}return d};e.submitForm=function(a,e,u){var d=$("#"+a+"_user_form form");u||(zenario.blockScrollToTop=!0);if(e)for(var p in e)d.append('<input type="hidden" name="'+p+'" value="'+e[p]+'"/>');$("#"+a+"_user_form .field_document_upload, #"+a+"_user_form .field_file_picker").each(function(){$(this).find('input[type="file"]').remove()});d.submit()};e.stopPoking=function(){e.poking&&clearInterval(e.poking);e.poking=!1};e.startPoking=
function(){e.poking||(e.poking=setInterval(e.poke,12E4))};e.poke=function(){zenario._a(URLBasePath+"zenario/admin/quick_ajax.php?keep_session_alive=1")};e.toggleForm=function(a){$("#"+a).toggleClass("show").toggleClass("hide")}})(zenario_user_forms);
