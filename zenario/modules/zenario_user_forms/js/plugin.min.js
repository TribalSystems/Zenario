(function(f){f.initForm=function(a,w,t,d,p,E,F,G,y,H,I,v){function z(a,e){return a.ord<e.ord?-1:a.ord>e.ord?1:0}this.containerId=a;var q=this;v=JSON.parse(v);I&&$("#"+a+"_user_form").effect("shake",{distance:10,times:3,duration:300});$("#"+a+"_user_form form").on("submit",function(){window.onbeforeunload=null});this.startPoking();if(H){if(1<y&&(window.onbeforeunload=function(){return!0},void 0!==zenario_conductor)){var A=this.phrase("Changes you made may not be saved.");zenario_conductor._cOC(a,function(){return!0},
function(a){confirm(A)&&a()},A)}p&&(window.onbeforeunload=null)}if(F)$("#"+a+" .page_switcher li.step").on("click",function(){var b=$(this).data("page");b<=y&&b!=G&&(window.onbeforeunload=null,q.submitForm(a,{target_page:b},!0))});d&&($.colorbox({transition:"none",html:d,escKey:!1,overlayClose:!1,onOpen:function(){var a=get("colorbox");a.className=f.moduleClassName;$(a).hide().fadeIn()}}),zenario._rC());$("#"+a+"_user_form .form_buttons .next.submit").on("click",function(){q.submitForm(a,{submitForm:!0},
!0)});$("#"+a+"_user_form .form_buttons .next:not(.submit)").on("click",function(){q.submitForm(a,{next:!0},!0)});$("#"+a+"_user_form .form_buttons .previous").on("click",function(){q.submitForm(a,{previous:!0},!0)});$("#"+a+" input.saveLater").on("click",function(){var b=$(this).data("message");confirm(b)&&q.submitForm(a,{saveLater:!0})});$("#"+a+"_user_form .field_attachment .remove_attachment").on("click",function(){var b=$(this).data("id"),e={};e["remove_attachment_"+b]=!0;q.submitForm(a,e)});
$("#"+a+"_print_page").on("click",function(){q.printFormPage(a)});var B=$("#"+a+"_fullscreen"),J=$("#"+a+' input[name="inFullScreen"]');B.on("click",function(){$("#ui-datepicker-div").detach().appendTo("#"+a);zenario._eFS($("#"+a)[0])});$(document).on(zenario.fullScreenChangeEvent,function(){var b=zenario._iFS();B.toggle(!b);J.val(b?1:0);$("#"+a+"_form_wrapper").toggleClass("in_fullscreen",b)});p&&zenario._exFuSc();$("#"+a+"_user_form input.jquery_form_datepicker").each(function(b,e){if(e.id){e.value=
$.datepicker.formatDate(zenario.dpf,$.datepicker.parseDate("yy-mm-dd",get(e.id+"__0").value));var k={dateFormat:zenario.dpf,altField:"#"+e.id+"__0",altFormat:"yy-mm-dd",showOn:"focus",onClose:function(a,b){get(e.id+"__0");var c=$.datepicker.formatDate(zenario.dpf,$.datepicker.parseDate("yy-mm-dd",get(e.id+"__0").value));a&&c?a&&c&&(e.value=c):h.datepicker("setDate",null)}};$(this).data("selectors")&&(k.changeMonth=!0,k.changeYear=!0,k.yearRange="c-100:c+5");$(this).data("no_past_dates")&&(k.minDate=
new Date);$(this).data("no_future_dates")&&(k.maxDate=new Date);var h=$("#"+e.id);h.datepicker(k);$("#"+e.id+"__clear").on("click",function(){h.datepicker("setDate",null)});E&&zenario._iFS()&&$("#ui-datepicker-div").detach().appendTo("#"+a)}});$("#"+a+"_user_form select.source_field").on("change",function(){f.submitForm(a,{filter:1})});$("#"+a+"_user_form .form_field.visible_on_condition, #"+a+"_user_form .repeat_block.visible_on_condition, .page_switcher li.visible_on_condition").each(function(b,
e){var k=this,h=$(this).data("cfields");$(this).data("id");if(h.length)for(b=0;b<h.length;b++){var l=h[b];(function(b){$("#"+a+"_field_"+l.id+" :input").on("change",function(){for(var c=!0,e=b;e<h.length;e++){var g=h[e],l=$("#"+a+"_field_"+g.id+" :input");if("checkboxes"==g.type){var u=[];l.each(function(){$(this).is(":checked")&&u.push($(this).data("value"))});l=g.value?_._m(g.value.toString().split(","),Number):[];if("AND"==g.operator)c=_.intersection(u,l),c=_.intersection(u,c),c=_._isEq(c,l);else for(var c=
!1,d=0;d<u.length;d++)if(-1!=l.indexOf(u[d])){c=!0;break}}else l=l.is(":checkbox")?l.is(":checked"):"radios"==g.type||"centralised_radios"==g.type?l.filter(":checked").val():l.val(),c="string"==typeof g.value&&1<g.value.split(",").length?-1!==g.value.split(",").indexOf(l):Boolean(""===g.value&&l||""!==g.value&&g.value==l);c=g.invert?!c:c;if(!c||e==h.length-1){$(k).toggle(c);break}}})})(b)}});$("#"+a+"_user_form .form_field.restatement").each(function(b,e){var k=this,h=$(this).data("fieldid");if(h&&
(h=$("#"+a+'_user_form .form_field :input[name="field_'+h+'"]'),0<h.length))if(h.is("input"))h.on("keyup",function(){$(k).find(":input").val($(this).val())});else if(h.is("select"))h.on("change",function(){$(k).find(":input").val(""===$(this).val()?"":$(this).find("option:selected").text())})});var C=function(a){return""===a||isNaN(a)||-1<a.toString().toLowerCase().indexOf("e")};$("#"+a+"_user_form .form_field.calculated").each(function(b,e){var k=$(this).find("input"),h=$(this).data("prefix"),l=
$(this).data("postfix"),x=k.data("repeated"),c=k.data("repeated_row"),m=k.data("repeat_id"),g=$("#"+a+"_field_"+$(e).data("id")+"_calculation_code").text();if(g){var g=JSON.parse(g),d={},u="";if(g&&(u=q.buildFieldCalculation(a,g,d))){var f,s={};for(b in d)if(f=$("#"+a+'_user_form .form_field input[name="field_'+b+'"]'),0<f.length){if(f.data("repeated")&&x&&f.data("repeat_id")==m){if(1<c&&(f=$("#"+a+'_user_form .form_field input[name="field_'+b+"_"+c+'"]'),0==f.length))continue}else f.data("repeated")&&
(f._repeatedFields=[],g=$("#"+a+"_user_form .form_field.field_"+b+"_repeat input"),g.each(function(a,c){f._repeatedFields.push($(this));s[b+"_"+a]=$(this)}));s[b]=f}else u=u.replace("[[FIELD_"+b+"]]",+d[b]);var n,r,D;for(b in s)s[b].on("keyup",function(){var c=u,b=!1,g=0;for(n in s){(r=s[n].val())||(r=0);if(C(r)){b=!0;break}if(s[n]._repeatedFields&&s[n]._repeatedFields.length){for(var x=[r],m=0;m<s[n]._repeatedFields.length;m++){var d=s[n]._repeatedFields[m].val();d||(d=0);if(C(d)){b=!0;break}x.push(d)}r=
"("+x.join(" + ")+")"}D="\\[\\[FIELD_"+n+"\\]\\]";c=c.replace(RegExp(D,"g"),r)}!b&&(g=Parser.evaluate(c),!_._iF(g)||999999999999999<g||-999999999999999>g)&&(b=!0);b?g="NaN":(g=+g.toFixed(2),h&&(g=h+""+g),l&&(g=g+""+l));k.val(g);$("#"+a+'_user_form .form_field.restatement[data-fieldid="'+$(e).data("id")+'"] :input').val(g)})}}});$("#"+a+"_user_form .repeat_block").each(function(b,e){var k=$(this).data("id");$(this).find("div.add").on("click",function(){f.submitForm(a,{add_repeat_row:k})});$(this).find("div.delete").on("click",
function(){var b=$(this).data("row");f.submitForm(a,{delete_repeat_row:k,row:b})})});$("#"+a+"_user_form .suggested_values_json").each(function(){var b=this,e=JSON.parse($(this).text());if(e){for(var k=[],h=0;h<e.length;h++)k.push({value:e[h].v,label:e[h].l});$(this).prev().autocomplete({minLength:0,source:k,select:function(h,e){h.preventDefault();var c="",m="";e.item&&(c=e.item.label,m=e.item.value);$(b).next().val(m);$(b).prev().val(c);$(b).data("source_field")&&f.submitForm(a,{filter:1})},focus:function(a,
b){this.value=b.item.label;a.preventDefault()},change:function(a,h){if(!h.item){var c=$(this).val(),e=k.find(function(a){return a.label.toLowerCase()===c.toLowerCase()});(e||$(b).data("force_suggested_values"))&&$(this).data("ui-autocomplete")._trigger("select","autocompleteselect",{item:e})}},open:function(b,h){var c=this;$("#"+a+"_user_form").scroll(function(){$(c).autocomplete("close")})}}).on("click",function(){if(0==k.length){var a=$(b).data("filter_placeholder");a&&$(this).prop("placeholder",
a)}$(this).autocomplete("search","")})}});(function(){function b(h,l){var k=e(l),k=zenario._mT("file_upload_row",k),c=$("#"+a+"_field_"+h+" .files");c.html(k);c.find(".file_row .delete").on("click",function(){if(confirm(v.delete_file)){var a=$(this).parent().data("id");delete l[a];b(h,l)}});$('input[name="field_'+h+'"]').val(JSON.stringify(l))}function e(a){var b=[],e;for(e in a)b.push(a[e]);b.sort(z);return b}function k(b,e,k,c){$("#"+a+"_field_"+b+NaN).toggle(c).find(".progress_bar").css("width",
k+"%")}$("#"+a+"_user_form .field_file_picker:not(.readonly)").each(function(){var a=$(this).data("id"),d=JSON.parse($('input[name="field_'+a+'"]').val());d||(d={});b(a,d);$(this).find(".file_picker_field").fileupload({url:t+"&fileUpload=1",dataType:"json",start:function(b){k(a,0,!0)},progressall:function(b,c){var e=parseInt(100*(c.loaded/c.total),10);k(a,e,!0)},done:function(k,c){var m=e(d),g=m.length&&m[m.length-1].ord?m[m.length-1].ord:1;$.each(c.result.files,function(a,c){g++;c.id="t"+g;c.ord=
g;d[c.id]=c});b(a,d)},stop:function(b){k(a,0,!1)}})})})();(function(){function b(e,c){var d=k(c),d=zenario._mT("document_upload_row",d),g=$("#"+a+"_field_"+e+" .popup_1 .files");g.html(d);g.find(".file_row .delete").on("click",function(){if(confirm(v.delete_file)){var a=$(this).parent().data("id");delete c[a];b(e,c)}})}function e(b,c){var d=k(c),g=zenario._mT("document_upload_uploaded_file",d),h=$("#"+a+"_field_"+b+" .popup_2 .files");h.html(g);h.find(".file_row .delete").on("click",function(){if(confirm(v.delete_file)){var a=
$(this).parent().data("id");delete c[a];e(b,c)}});h.find(".file_row .rotate").on("click",function(){var a=$(this).parent().data("id");c[a].rotate||(c[a].rotate=0);c[a].rotate=(c[a].rotate+90)%360;JSON.stringify(c[a]);h.find(".file_"+a+" .icon img").css({transform:"rotate("+c[a].rotate+"deg)","-ms-transform":"rotate("+c[a].rotate+"deg)","-moz-transform":"rotate("+c[a].rotate+"deg)","-webkit-transform":"rotate("+c[a].rotate+"deg)","-o-transform":"rotate("+c[a].rotate+"deg)"})});d.length&&h.sortable({containment:"parent",
tolerance:"pointer",items:"div.file_row",start:function(a,c){q.startIndex=c.item.index()},stop:function(a,b){q.startIndex!=b.item.index()&&h.find(".file_row").each(function(a){var b=$(this).data("id");c[b].ord=a+1})}})}function k(a){var c=[],b;for(b in a)c.push(a[b]);c.sort(z);return c}function d(b,c,e,g){$("#"+a+"_field_"+b+" ."+c+" .progress").toggle(g).find(".progress_bar").css("width",e+"%")}function f(a,c){k(c).length?confirm(v.are_you_sure_message)&&a.hide():a.hide()}$("#"+a+"_user_form .field_document_upload").each(function(){var a=
this,c=$(this).data("id"),m=$(this).find(".overlay_1"),g=$(this).find(".overlay_2"),w=$(this).find(".popup_1 .files"),p=$(this).find(".popup_2 .files"),q=$(this).find('input[name="field_'+c+'"]'),s=$(this).data("filename"),n={},r={};$(this).find(".open_popup_1").on("click",function(){q.val()&&(n=JSON.parse(q.val()));n||(n={});b(c,n);m.show()});$(this).find(".open_popup_2").on("click",function(){r={};e(c,r);g.show()});$(this).find(".popup_1 .close").on("click",function(){f(m,n)});$(this).find(".popup_2 .close").on("click",
function(){f(g,r)});window.onclick=function(){event.target==m[0]?f(m,n):event.target==g[0]&&f(g,r)};$(this).find(".popup_1 .upload_complete_files").fileupload({url:t+"&fileUpload=1",dataType:"json",dropZone:w,start:function(a){d(c,"popup_1",0,!0)},progressall:function(a,b){var e=parseInt(100*(b.loaded/b.total),10);d(c,"popup_1",e,!0)},done:function(a,e){var d=k(n),g=d.length&&d[d.length-1].ord?d[d.length-1].ord:1;$.each(e.result.files,function(a,c){g++;c.id="t"+g;c.ord=g;n[c.id]=c});b(c,n)},stop:function(a){d(c,
"popup_1",0,!1)}});$(this).find(".popup_1 .save").on("click",function(){var c=k(n),b="",b=[],e,d;for(e=0;e<c.length;e++)d=c[e],b.push('<a href="'+d.path+'" target="_blank">'+d.name+"</a>");b=b.join(", ");$(a).find(".files_preview").html(b);q.val(JSON.stringify(n));m.hide();g.hide()});$(this).find(".popup_2 .upload_file_fragments").fileupload({url:t+"&fileUpload=1&thumbnail=1",dataType:"json",dropZone:p,start:function(a){d(c,"popup_2",0,!0)},progressall:function(a,b){var e=parseInt(100*(b.loaded/b.total),
10);d(c,"popup_2",e,!0)},done:function(a,b){var d=k(r),g=d.length&&d[d.length-1].ord?d[d.length-1].ord:1;$.each(b.result.files,function(a,b){g++;b.id="t"+g;b.ord=g;r[b.id]=b});e(c,r)},stop:function(a){d(c,"popup_2",0,!1)}});$(this).find(".popup_2 .combine").on("click",function(){var d=k(r);if(d.length){var h=this,f;$(h).val(v.combining);if(s){f=s;var l=1,m=k(n),w=RegExp(f+"(?:_(\\d+))?.pdf$"),p=!1,q;for(q=0;q<m.length;q++)(p=m[q].name.match(w))&&(l=+p[1]+1);f+="_"+l}else f=$(a).find(".filename").val();
d={name:f,files:JSON.stringify(d)};zenario._a(t+"&combineFiles=1",d).after(function(d){if((d=JSON.parse(d))&&d.path){var f=k(n),f=f.length&&f[f.length-1].ord?f[f.length-1].ord:1;f++;d.id="t"+f;d.ord=f;n[d.id]=d;b(c,n);$(a).find(".filename").val(s?s:"my-combined-file");g.hide();r={};e(c,[])}$(h).val(v.combine)})}})})})();$("#"+a+"_user_form input.set_predefined_text").on("click",function(){var b=$(this).data("id"),d=!0;$("#"+a+"_field_"+b+" textarea").val()&&(d=confirm(v.set_predefined_text_warning));
d&&(d={},d["set_predefined_text_"+b]=!0,q.submitForm(a,d))})};f.printFormPage=function(){var a=$("#"+this.containerId+" .form_fields").html(),f=window.screenX+$(window).width()/2,t=window.open("","Print-Window","width=300,height=300,left="+f+",top="+window.screenY);t.document.open();t.document.write('<html><body onload="window.print()">'+a+"</body></html>");t.document.close();setTimeout(function(){t.close()},10)};f.buildFieldCalculation=function(a,f,t){for(var d="",p=0;p<f.length;p++)switch(f[p].type){case "static_value":d+=
+f[p].value;break;case "field":if("NaN"==f[p].v&&0>=$("#"+a+'_user_form .form_field input[name="field_'+f[p].value+'"]').length)return!1;t[f[p].value]=f[p].v;d+="[[FIELD_"+f[p].value+"]]";break;case "parentheses_open":d+="(";break;case "parentheses_close":d+=")";break;case "operation_addition":d+="+";break;case "operation_subtraction":d+="-";break;case "operation_multiplication":d+="*";break;case "operation_division":d+="/"}return d};f.submitForm=function(a,f,t){var d=$("#"+a+"_user_form form");t||
(zenario.blockScrollToTop=!0);if(f)for(var p in f)d.append('<input type="hidden" name="'+p+'" value="'+f[p]+'"/>');$("#"+a+"_user_form .field_document_upload, #"+a+"_user_form .field_file_picker").each(function(){$(this).find('input[type="file"]').remove()});d.submit()};f.stopPoking=function(){f.poking&&clearInterval(f.poking);f.poking=!1};f.startPoking=function(){f.poking||(f.poking=setInterval(f.poke,12E4))};f.poke=function(){zenario._a(URLBasePath+"zenario/admin/quick_ajax.php?keep_session_alive=1")};
f.toggleForm=function(a){$("#"+a).toggleClass("show").toggleClass("hide")}})(zenario_user_forms);
