tinymce.PluginManager.add("toc",function(c){function l(){var a=this;a.disabled(c.readonly||!(d&&k(d).length));c.on("LoadContent SetContent change",function(){a.disabled(c.readonly||!(d&&k(d).length))})}function n(a){var b,c=[];for(b=1;b<=a;b++)c.push("h"+b);return c.join(",")}function k(a){var b=n(a.depth),b=h(b);b.length&&/^h[1-9]$/i.test(a.headerTag)&&(b=b.filter(function(b,e){return!c.dom.hasClass(e.parentNode,a.className)}));return tinymce.map(b,function(a){a.id||(a.id=p());return{id:a.id,level:parseInt(a.nodeName.replace(/^H/i,
""),10),title:h.text(a)}})}function q(a){var b=m(a);return'<div class="'+a.className+'" contenteditable="false">'+b+"</div>"}function m(a){var b="",d=k(a),e;a:{var f=9;for(e=0;e<d.length;e++)if(d[e].level<f&&(f=d[e].level),1==f){e=f;break a}e=f}e-=1;var g;if(!d.length)return"";a=a.headerTag;f=tinymce.translate("Table of Contents");g="</"+a+">";a="<"+a+' contenteditable="true">'+c.dom.encode(f)+g;b+=a;for(a=0;a<d.length;a++){f=d[a];g=d[a+1]&&d[a+1].level;if(e===f.level)b+="<li>";else for(;e<f.level;e++)b+=
"<ul><li>";b+='<a href="#'+f.id+'">'+f.title+"</a>";if(g!==f.level&&g)for(e=f.level;e>g;e--)b+="</li></ul><li>";else b+="</li>",g||(b+="</ul>");e=f.level}return b}var h=c.$,d,p=function(a){var b=0;return function(){var c=(new Date).getTime().toString(32);return a+c+(b++).toString(32)}}("mcetoc_");c.on("PreInit",function(){var a=c.settings,b=parseInt(a.toc_depth,10)||0;d={depth:1<=b&&9>=b?b:3,headerTag:c.schema.isValidChild("div",a.toc_header)?a.toc_header:"h2",className:a.toc_class?c.dom.encode(a.toc_class):
"mce-toc"}});c.on("PreProcess",function(a){a=h("."+d.className,a.node);a.length&&(a.removeAttr("contentEditable"),a.find("[contenteditable]").removeAttr("contentEditable"))});c.on("SetContent",function(){var a=h("."+d.className);a.length&&(a.attr("contentEditable",!1),a.children(":first-child").attr("contentEditable",!0))});c.addCommand("mceInsertToc",function(){var a=h("."+d.className);!a.length||0<c.dom.getParents(a[0],".mce-offscreen-selection").length?c.insertContent(q(d)):c.execCommand("mceUpdateToc")});
c.addCommand("mceUpdateToc",function(){var a=h("."+d.className);a.length&&c.undoManager.transact(function(){a.html(m(d))})});c.addButton("toc",{tooltip:"Table of Contents",cmd:"mceInsertToc",icon:"toc",onPostRender:l});c.addButton("tocupdate",{tooltip:"Update",cmd:"mceUpdateToc",icon:"reload"});c.addContextToolbar(function(a){return a&&c.dom.is(a,"."+d.className)&&c.getBody().contains(a)},"tocupdate");c.addMenuItem("toc",{text:"Table of Contents",context:"insert",cmd:"mceInsertToc",onPostRender:l})});
