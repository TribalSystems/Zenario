/*
     http://www.opensource.org/licenses/BSD-3-Clause New BSD license
 @version     2.6
*/
'use strict';(function(c,n){var k=null,m=function(a,b){b.data("tokenize")||(a=new c.tokenize(c.extend({},c.fn.tokenize.defaults,a)),b.data("tokenize",a),a.init(b));return b.data("tokenize")};c.tokenize=function(a){void 0==a&&(a=c.fn.tokenize.defaults);this.options=a};c.extend(c.tokenize.prototype,{init:function(a){var b=this;this.select=a.attr("multiple","multiple").css({margin:0,padding:0,border:0}).hide();this.container=c("<div />").attr("class",this.select.attr("class")).addClass("Tokenize");1==
this.options.maxElements&&this.container.addClass("OnlyOne");this.dropdown=c("<ul />").addClass("Dropdown");this.tokensContainer=c("<ul />").addClass("TokensContainer");this.options.autosize&&this.tokensContainer.addClass("Autosize");this.searchToken=c("<li />").addClass("TokenSearch").appendTo(this.tokensContainer);this.searchInput=c("<input />").appendTo(this.searchToken);0<this.options.searchMaxLength&&this.searchInput.attr("maxlength",this.options.searchMaxLength);this.select.prop("disabled")&&
this.disable();this.options.sortable&&("undefined"!=typeof c.ui?this.tokensContainer.sortable({items:"li.Token",cursor:"move",placeholder:"Token MovingShadow",forcePlaceholderSize:!0,update:function(){b.updateOrder()},start:function(){b.searchToken.hide()},stop:function(){b.searchToken.show()}}).disableSelection():(this.options.sortable=!1,console.error("jQuery UI is not loaded, sortable option has been disabled")));this.container.append(this.tokensContainer).append(this.dropdown).insertAfter(this.select);
this.tokensContainer.on("click",function(d){d.stopImmediatePropagation();b.searchInput.get(0).focus();b.updatePlaceholder();b.dropdown.is(":hidden")&&""!=b.searchInput.val()&&b.search()});this.searchInput.on("blur",function(){b.tokensContainer.removeClass("Focused")});this.searchInput.on("focus click",function(){b.tokensContainer.addClass("Focused");b.options.displayDropdownOnFocus&&"select"==b.options.datas&&b.search()});this.searchInput.on("keydown",function(d){b.resizeSearchInput();b.keydown(d)});
this.searchInput.on("keyup",function(d){b.keyup(d)});this.searchInput.on("keypress",function(d){b.keypress(d)});this.searchInput.on("paste",function(){setTimeout(function(){b.resizeSearchInput()},10);setTimeout(function(){var d=[];d=Array.isArray(b.options.delimiter)?b.searchInput.val().split(new RegExp(b.options.delimiter.join("|"),"g")):b.searchInput.val().split(b.options.delimiter);1<d.length&&c.each(d,function(f,e){b.tokenAdd(e.trim(),"")})},20)});c(document).on("click",function(){b.dropdownHide();
1==b.options.maxElements&&b.searchInput.val()&&b.tokenAdd(b.searchInput.val(),"")});this.resizeSearchInput();this.remap(!0);this.updatePlaceholder()},updateOrder:function(){if(this.options.sortable){var a,b,d=this;c.each(this.tokensContainer.sortable("toArray",{attribute:"data-value"}),function(f,e){b=c('option[value="'+e+'"]',d.select);void 0==a?b.prependTo(d.select):a.after(b);a=b});this.options.onReorder(this)}},updatePlaceholder:function(){this.options.placeholder&&(void 0==this.placeholder&&
(this.placeholder=c("<li />").addClass("Placeholder").html(this.options.placeholder),this.placeholder.insertBefore(c("li:first-child",this.tokensContainer))),0==this.searchInput.val().length&&0==c("li.Token",this.tokensContainer).length?this.placeholder.show():this.placeholder.hide())},dropdownShow:function(){this.dropdown.show();this.options.onDropdownShow(this)},dropdownPrev:function(){0<c("li.Hover",this.dropdown).length?c("li.Hover",this.dropdown).is("li:first-child")?(c("li.Hover",this.dropdown).removeClass("Hover"),
c("li:last-child",this.dropdown).addClass("Hover")):c("li.Hover",this.dropdown).removeClass("Hover").prev().addClass("Hover"):c("li:first",this.dropdown).addClass("Hover")},dropdownNext:function(){0<c("li.Hover",this.dropdown).length?c("li.Hover",this.dropdown).is("li:last-child")?(c("li.Hover",this.dropdown).removeClass("Hover"),c("li:first-child",this.dropdown).addClass("Hover")):c("li.Hover",this.dropdown).removeClass("Hover").next().addClass("Hover"):c("li:first",this.dropdown).addClass("Hover")},
dropdownAddItem:function(a,b,d){d=d||b;if(!c('li[data-value="'+a+'"]',this.tokensContainer).length){var f=this,e=c("<li />").attr("data-value",a).attr("data-text",b).html(d).on("click",function(g){g.stopImmediatePropagation();f.tokenAdd(c(this).attr("data-value"),c(this).attr("data-text"))}).on("mouseover",function(){c(this).addClass("Hover")}).on("mouseout",function(){c("li",f.dropdown).removeClass("Hover")});this.dropdown.append(e);this.options.onDropdownAddItem(a,b,d,this)}return this},dropdownHide:function(){this.dropdownReset();
this.dropdown.hide()},dropdownReset:function(){this.dropdown.html("")},resizeSearchInput:function(){this.searchInput.attr("size",Number(this.searchInput.val().length)+5);this.updatePlaceholder()},resetSearchInput:function(){this.searchInput.val("");this.resizeSearchInput()},resetPendingTokens:function(){c("li.PendingDelete",this.tokensContainer).removeClass("PendingDelete")},keypress:function(a){var b=!1;Array.isArray(this.options.delimiter)?0<=this.options.delimiter.indexOf(String.fromCharCode(a.which))&&
(b=!0):String.fromCharCode(a.which)==this.options.delimiter&&(b=!0);b&&(a.preventDefault(),this.tokenAdd(this.searchInput.val(),""))},keydown:function(a){switch(a.keyCode){case 8:0==this.searchInput.val().length&&(a.preventDefault(),c("li.Token.PendingDelete",this.tokensContainer).length?this.tokenRemove(c("li.Token.PendingDelete").attr("data-value")):c("li.Token:last",this.tokensContainer).addClass("PendingDelete"),this.dropdownHide());break;case 9:case 13:if(c("li.Hover",this.dropdown).length){var b=
c("li.Hover",this.dropdown);a.preventDefault();this.tokenAdd(b.attr("data-value"),b.attr("data-text"))}else this.searchInput.val()&&(a.preventDefault(),this.tokenAdd(this.searchInput.val(),""));this.resetPendingTokens();break;case 27:this.resetSearchInput();this.dropdownHide();this.resetPendingTokens();break;case 38:a.preventDefault();this.dropdownPrev();break;case 40:a.preventDefault();this.dropdownNext();break;default:0<this.options.maxElements&&c("li.Token",this.tokensContainer).length>=this.options.maxElements&&
a.preventDefault(),this.resetPendingTokens()}},keyup:function(a){this.updatePlaceholder();switch(a.keyCode){case 9:case 13:case 27:case 38:case 40:break;case 8:this.searchInput.val()?this.search():this.dropdownHide();break;default:this.searchInput.val()&&this.search()}},search:function(){var a=this,b=1;if(0<this.options.maxElements&&c("li.Token",this.tokensContainer).length>=this.options.maxElements||this.searchInput.val().length<this.options.searchMinLength)return!1;if("select"==this.options.datas){var d=
!1,f=new RegExp(this.searchInput.val().replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i");this.dropdownReset();c("option",this.select).not(":selected, :disabled").each(function(){if(b<=a.options.nbDropdownElements)f.test(c(this).html())&&(a.dropdownAddItem(c(this).attr("value"),c(this).html()),d=!0,b++);else return!1});d?(c("li:first",this.dropdown).addClass("Hover"),this.dropdownShow()):this.dropdownHide()}else this.debounce(function(){void 0!==this.ajax&&this.ajax.abort();this.ajax=c.ajax({url:a.options.datas,
data:a.options.searchParam+"="+encodeURIComponent(a.searchInput.val()),dataType:a.options.dataType,success:function(e){if(e&&(a.options.parseData&&(e=a.options.parseData(e)),a.dropdownReset(),c.each(e,function(g,h){if(b<=a.options.nbDropdownElements){var l;h[a.options.htmlField]&&(l=h[a.options.htmlField]);a.dropdownAddItem(h[a.options.valueField],h[a.options.textField],l);b++}else return!1}),c("li",a.dropdown).length))return c("li:first",a.dropdown).addClass("Hover"),a.dropdownShow(),!0;a.dropdownHide()},
error:function(e,g){a.options.onAjaxError(a,e,g)}})},this.options.debounce)},debounce:function(a,b){var d=this,f=arguments;k&&clearTimeout(k);k=setTimeout(function(){a.apply(d,f);k=null},b||this.options.debounce)},tokenAdd:function(a,b,d){a=this.escape(a).trim();if(void 0==a||""==a)return this;b=b||a;d=d||!1;var f=this.options.formatTokenHTML?this.options.formatTokenHTML(a,b):"<span>"+b+"</span>";if(!1===f||0<this.options.maxElements&&c("li.Token",this.tokensContainer).length>=this.options.maxElements)return this.resetSearchInput(),
this;var e=this,g=c("<a />").addClass("Close").html("&#215;").on("click",function(l){l.stopImmediatePropagation();e.tokenRemove(a)});if(c('option[value="'+a+'"]',this.select).length){if(!d&&(!0===c('option[value="'+a+'"]',this.select).attr("selected")||!0===c('option[value="'+a+'"]',this.select).prop("selected")))this.options.onDuplicateToken(a,b,this);c('option[value="'+a+'"]',this.select).attr("selected",!0).prop("selected",!0)}else if(this.options.newElements||!this.options.newElements&&0<c('li[data-value="'+
a+'"]',this.dropdown).length){var h=c("<option />").attr("selected",!0).attr("value",a).attr("data-type","custom").prop("selected",!0).html(b);this.select.append(h)}else return this.resetSearchInput(),this;if(0<c('li.Token[data-value="'+a+'"]',this.tokensContainer).length)return this;c("<li />").addClass("Token").attr("data-value",a).append(f).prepend(g).insertBefore(this.searchToken);if(!d)this.options.onAddToken(a,b,this);this.resetSearchInput();this.dropdownHide();this.updateOrder();return this},
tokenRemove:function(a){var b=c('option[value="'+a+'"]',this.select);"custom"==b.attr("data-type")?b.remove():b.removeAttr("selected").prop("selected",!1);c('li.Token[data-value="'+a+'"]',this.tokensContainer).remove();this.options.onRemoveToken(a,this);this.resizeSearchInput();this.dropdownHide();this.updateOrder();return this},clear:function(){var a=this;c("li.Token",this.tokensContainer).each(function(){a.tokenRemove(c(this).attr("data-value"))});this.options.onClear(this);this.dropdownHide();
return this},disable:function(){this.select.prop("disabled",!0);this.searchInput.prop("disabled",!0);this.container.addClass("Disabled");this.options.sortable&&this.tokensContainer.sortable("disable");return this},disableTypeAhead:function(){this.select.prop("disabled",!0);this.searchInput.prop("disabled",!0);return this},enable:function(){this.select.prop("disabled",!1);this.searchInput.prop("disabled",!1);this.container.removeClass("Disabled");this.options.sortable&&this.tokensContainer.sortable("enable");
return this},remap:function(a){var b=this,d=c("option:selected",this.select);a=a||!1;this.clear();d.each(function(){b.tokenAdd(c(this).val(),c(this).html(),a)});return this},toArray:function(){var a=[];c("option:selected",this.select).each(function(){a.push(c(this).val())});return a},escape:function(a){var b=document.createElement("div");b.innerHTML=a;a=b.textContent||b.innerText||"";return String(a).replace(/["]/g,function(){return""})}});c.fn.tokenize=function(a){a=a||{};var b=this.filter("select");
if(1<b.length){var d=[];b.each(function(){d.push(m(a,c(this)))});return d}return m(a,c(this))};c.fn.tokenize.defaults={datas:"select",placeholder:!1,searchParam:"search",searchMaxLength:0,searchMinLength:0,debounce:0,delimiter:",",newElements:!0,autosize:!1,nbDropdownElements:10,displayDropdownOnFocus:!1,maxElements:0,sortable:!1,dataType:"json",valueField:"value",textField:"text",htmlField:"html",onAddToken:function(a,b,d){},onRemoveToken:function(a,b){},onClear:function(a){},onReorder:function(a){},
onDropdownAddItem:function(a,b,d,f){},onDropdownShow:function(a){},onDuplicateToken:function(a,b,d){},onAjaxError:function(a,b,d){}}})(jQuery,"tokenize");
