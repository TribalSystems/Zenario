/*
     http://www.opensource.org/licenses/BSD-3-Clause New BSD license
 @version     2.6
*/
(function(b,k){var f=null,h=function(a,c){if(!c.data("tokenize")){var d=new b.tokenize(b.extend({},b.fn.tokenize.defaults,a));c.data("tokenize",d);d.init(c)}return c.data("tokenize")};b.tokenize=function(a){void 0==a&&(a=b.fn.tokenize.defaults);this.options=a};b.extend(b.tokenize.prototype,{init:function(a){var c=this;this.select=a.attr("multiple","multiple").css({margin:0,padding:0,border:0}).hide();this.container=b("<div />").attr("class",this.select.attr("class")).addClass("Tokenize");1==this.options.maxElements&&
this.container.addClass("OnlyOne");this.dropdown=b("<ul />").addClass("Dropdown");this.tokensContainer=b("<ul />").addClass("TokensContainer");this.options.autosize&&this.tokensContainer.addClass("Autosize");this.searchToken=b("<li />").addClass("TokenSearch").appendTo(this.tokensContainer);this.searchInput=b("<input />").appendTo(this.searchToken);0<this.options.searchMaxLength&&this.searchInput.attr("maxlength",this.options.searchMaxLength);this.select.prop("disabled")&&this.disable();this.options.sortable&&
("undefined"!=typeof b.ui?this.tokensContainer.sortable({items:"li.Token",cursor:"move",placeholder:"Token MovingShadow",forcePlaceholderSize:!0,update:function(){c.updateOrder()},start:function(){c.searchToken.hide()},stop:function(){c.searchToken.show()}}).disableSelection():(this.options.sortable=!1,console.error("jQuery UI is not loaded, sortable option has been disabled")));this.container.append(this.tokensContainer).append(this.dropdown).insertAfter(this.select);this.tokensContainer.on("click",
function(a){a.stopImmediatePropagation();c.searchInput.get(0).focus();c.updatePlaceholder();c.dropdown.is(":hidden")&&""!=c.searchInput.val()&&c.search()});this.searchInput.on("blur",function(){c.tokensContainer.removeClass("Focused")});this.searchInput.on("focus click",function(){c.tokensContainer.addClass("Focused");c.options.displayDropdownOnFocus&&"select"==c.options.datas&&c.search()});this.searchInput.on("keydown",function(a){c.resizeSearchInput();c.keydown(a)});this.searchInput.on("keyup",
function(a){c.keyup(a)});this.searchInput.on("keypress",function(a){c.keypress(a)});this.searchInput.on("paste",function(){setTimeout(function(){c.resizeSearchInput()},10);setTimeout(function(){var a=[],a=Array.isArray(c.options.delimiter)?c.searchInput.val().split(RegExp(c.options.delimiter.join("|"),"g")):c.searchInput.val().split(c.options.delimiter);1<a.length&&b.each(a,function(a,b){c.tokenAdd(b.trim(),"")})},20)});b(document).on("click",function(){c.dropdownHide();1==c.options.maxElements&&
c.searchInput.val()&&c.tokenAdd(c.searchInput.val(),"")});this.resizeSearchInput();this.remap(!0);this.updatePlaceholder()},updateOrder:function(){if(this.options.sortable){var a,c,d=this;b.each(this.tokensContainer.sortable("toArray",{attribute:"data-value"}),function(e,g){c=b('option[value="'+g+'"]',d.select);void 0==a?c.prependTo(d.select):a.after(c);a=c});this.options.onReorder(this)}},updatePlaceholder:function(){this.options.placeholder&&(void 0==this.placeholder&&(this.placeholder=b("<li />").addClass("Placeholder").html(this.options.placeholder),
this.placeholder.insertBefore(b("li:first-child",this.tokensContainer))),0==this.searchInput.val().length&&0==b("li.Token",this.tokensContainer).length?this.placeholder.show():this.placeholder.hide())},dropdownShow:function(){this.dropdown.show();this.options.onDropdownShow(this)},dropdownPrev:function(){0<b("li.Hover",this.dropdown).length?b("li.Hover",this.dropdown).is("li:first-child")?(b("li.Hover",this.dropdown).removeClass("Hover"),b("li:last-child",this.dropdown).addClass("Hover")):b("li.Hover",
this.dropdown).removeClass("Hover").prev().addClass("Hover"):b("li:first",this.dropdown).addClass("Hover")},dropdownNext:function(){0<b("li.Hover",this.dropdown).length?b("li.Hover",this.dropdown).is("li:last-child")?(b("li.Hover",this.dropdown).removeClass("Hover"),b("li:first-child",this.dropdown).addClass("Hover")):b("li.Hover",this.dropdown).removeClass("Hover").next().addClass("Hover"):b("li:first",this.dropdown).addClass("Hover")},dropdownAddItem:function(a,c,d){d=d||c;if(!b('li[data-value="'+
a+'"]',this.tokensContainer).length){var e=this,g=b("<li />").attr("data-value",a).attr("data-text",c).html(d).on("click",function(a){a.stopImmediatePropagation();e.tokenAdd(b(this).attr("data-value"),b(this).attr("data-text"))}).on("mouseover",function(){b(this).addClass("Hover")}).on("mouseout",function(){b("li",e.dropdown).removeClass("Hover")});this.dropdown.append(g);this.options.onDropdownAddItem(a,c,d,this)}return this},dropdownHide:function(){this.dropdownReset();this.dropdown.hide()},dropdownReset:function(){this.dropdown.html("")},
resizeSearchInput:function(){this.searchInput.attr("size",Number(this.searchInput.val().length)+5);this.updatePlaceholder()},resetSearchInput:function(){this.searchInput.val("");this.resizeSearchInput()},resetPendingTokens:function(){b("li.PendingDelete",this.tokensContainer).removeClass("PendingDelete")},keypress:function(a){var c=!1;Array.isArray(this.options.delimiter)?0<=this.options.delimiter.indexOf(String.fromCharCode(a.which))&&(c=!0):String.fromCharCode(a.which)==this.options.delimiter&&
(c=!0);c&&(a.preventDefault(),this.tokenAdd(this.searchInput.val(),""))},keydown:function(a){switch(a.keyCode){case 8:0==this.searchInput.val().length&&(a.preventDefault(),b("li.Token.PendingDelete",this.tokensContainer).length?this.tokenRemove(b("li.Token.PendingDelete").attr("data-value")):b("li.Token:last",this.tokensContainer).addClass("PendingDelete"),this.dropdownHide());break;case 9:case 13:if(b("li.Hover",this.dropdown).length){var c=b("li.Hover",this.dropdown);a.preventDefault();this.tokenAdd(c.attr("data-value"),
c.attr("data-text"))}else this.searchInput.val()&&(a.preventDefault(),this.tokenAdd(this.searchInput.val(),""));this.resetPendingTokens();break;case 27:this.resetSearchInput();this.dropdownHide();this.resetPendingTokens();break;case 38:a.preventDefault();this.dropdownPrev();break;case 40:a.preventDefault();this.dropdownNext();break;default:0<this.options.maxElements&&b("li.Token",this.tokensContainer).length>=this.options.maxElements&&a.preventDefault(),this.resetPendingTokens()}},keyup:function(a){this.updatePlaceholder();
switch(a.keyCode){case 9:case 13:case 27:case 38:case 40:break;case 8:this.searchInput.val()?this.search():this.dropdownHide();break;default:this.searchInput.val()&&this.search()}},search:function(){var a=this,c=1;if(0<this.options.maxElements&&b("li.Token",this.tokensContainer).length>=this.options.maxElements||this.searchInput.val().length<this.options.searchMinLength)return!1;if("select"==this.options.datas){var d=!1,e=RegExp(this.searchInput.val().replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i");
this.dropdownReset();b("option",this.select).not(":selected, :disabled").each(function(){if(c<=a.options.nbDropdownElements)e.test(b(this).html())&&(a.dropdownAddItem(b(this).attr("value"),b(this).html()),d=!0,c++);else return!1});d?(b("li:first",this.dropdown).addClass("Hover"),this.dropdownShow()):this.dropdownHide()}else this.debounce(function(){void 0!==this.ajax&&this.ajax.abort();this.ajax=b.ajax({url:a.options.datas,data:a.options.searchParam+"="+encodeURIComponent(a.searchInput.val()),dataType:a.options.dataType,
success:function(d){if(d&&(a.options.parseData&&(d=a.options.parseData(d)),a.dropdownReset(),b.each(d,function(b,d){if(c<=a.options.nbDropdownElements){var e;d[a.options.htmlField]&&(e=d[a.options.htmlField]);a.dropdownAddItem(d[a.options.valueField],d[a.options.textField],e);c++}else return!1}),b("li",a.dropdown).length))return b("li:first",a.dropdown).addClass("Hover"),a.dropdownShow(),!0;a.dropdownHide()},error:function(c,b){a.options.onAjaxError(a,c,b)}})},this.options.debounce)},debounce:function(a,
c){var b=this,e=arguments;f&&clearTimeout(f);f=setTimeout(function(){a.apply(b,e);f=null},c||this.options.debounce)},tokenAdd:function(a,c,d){a=this.escape(a).trim();if(void 0==a||""==a)return this;c=c||a;d=d||!1;var e;e=this.options.formatTokenHTML?this.options.formatTokenHTML(a,c):"<span>"+c+"</span>";if(!1===e||0<this.options.maxElements&&b("li.Token",this.tokensContainer).length>=this.options.maxElements)return this.resetSearchInput(),this;var g=this,f=b("<a />").addClass("Close").html("&#215;").on("click",
function(b){b.stopImmediatePropagation();g.tokenRemove(a)});if(b('option[value="'+a+'"]',this.select).length){if(!d&&(!0===b('option[value="'+a+'"]',this.select).attr("selected")||!0===b('option[value="'+a+'"]',this.select).prop("selected")))this.options.onDuplicateToken(a,c,this);b('option[value="'+a+'"]',this.select).attr("selected",!0).prop("selected",!0)}else if(this.options.newElements||!this.options.newElements&&0<b('li[data-value="'+a+'"]',this.dropdown).length){var h=b("<option />").attr("selected",
!0).attr("value",a).attr("data-type","custom").prop("selected",!0).html(c);this.select.append(h)}else return this.resetSearchInput(),this;if(0<b('li.Token[data-value="'+a+'"]',this.tokensContainer).length)return this;b("<li />").addClass("Token").attr("data-value",a).append(e).prepend(f).insertBefore(this.searchToken);if(!d)this.options.onAddToken(a,c,this);this.resetSearchInput();this.dropdownHide();this.updateOrder();return this},tokenRemove:function(a){var c=b('option[value="'+a+'"]',this.select);
"custom"==c.attr("data-type")?c.remove():c.removeAttr("selected").prop("selected",!1);b('li.Token[data-value="'+a+'"]',this.tokensContainer).remove();this.options.onRemoveToken(a,this);this.resizeSearchInput();this.dropdownHide();this.updateOrder();return this},clear:function(){var a=this;b("li.Token",this.tokensContainer).each(function(){a.tokenRemove(b(this).attr("data-value"))});this.options.onClear(this);this.dropdownHide();return this},disable:function(){this.select.prop("disabled",!0);this.searchInput.prop("disabled",
!0);this.container.addClass("Disabled");this.options.sortable&&this.tokensContainer.sortable("disable");return this},disableTypeAhead:function(){this.select.prop("disabled",!0);this.searchInput.prop("disabled",!0);return this},enable:function(){this.select.prop("disabled",!1);this.searchInput.prop("disabled",!1);this.container.removeClass("Disabled");this.options.sortable&&this.tokensContainer.sortable("enable");return this},remap:function(a){var c=this,d=b("option:selected",this.select);a=a||!1;
this.clear();d.each(function(){c.tokenAdd(b(this).val(),b(this).html(),a)});return this},toArray:function(){var a=[];b("option:selected",this.select).each(function(){a.push(b(this).val())});return a},escape:function(a){var b=document.createElement("div");b.innerHTML=a;a=b.textContent||b.innerText||"";return String(a).replace(/["]/g,function(){return""})}});b.fn.tokenize=function(a){a=a||{};var c=this.filter("select");if(1<c.length){var d=[];c.each(function(){d.push(h(a,b(this)))});return d}return h(a,
b(this))};b.fn.tokenize.defaults={datas:"select",placeholder:!1,searchParam:"search",searchMaxLength:0,searchMinLength:0,debounce:0,delimiter:",",newElements:!0,autosize:!1,nbDropdownElements:10,displayDropdownOnFocus:!1,maxElements:0,sortable:!1,dataType:"json",valueField:"value",textField:"text",htmlField:"html",onAddToken:function(a,b,d){},onRemoveToken:function(a,b){},onClear:function(a){},onReorder:function(a){},onDropdownAddItem:function(a,b,d,e){},onDropdownShow:function(a){},onDuplicateToken:function(a,
b,d){},onAjaxError:function(a,b,d){}}})(jQuery,"tokenize");
